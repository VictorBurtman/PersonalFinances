<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monthly Expenses Tracker</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="translations.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            padding: 10px;
            color: #333;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: -1;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            position: relative; /* Pour positionner le bouton */
        }
        
        .settings-btn-header {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            line-height: 1;
        }

        
        .settings-btn-header:hover {
            transform: translateY(-50%) scale(1.15);
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
        }
        
        @media (max-width: 600px) {
            .settings-btn-header {
                font-size: 1.5em;
                right: 10px;
            }
        }

        .header h1 {
            text-align: left; /* Aligner √† gauche */
            margin: 0;
            padding-right: 50px; /* Espace pour le bouton settings */
        }

        .header p {
            font-size: 1em;
            opacity: 0.9;
        }

        .dashboard {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .total-section {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            margin-bottom: 20px;
        }

        .total-section h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
            font-weight: 500;
        }

        .total-amount {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .chart-section {
            margin-bottom: 20px;
        }

        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }

        .chart-toggle-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chart-toggle-btn:hover {
            background: #f0f0f0;
        }

        .chart-toggle-btn.active {
            background: #667eea;
            color: white;
        }

        .color-customize-btn {
            padding: 10px 20px;
            border: 2px solid #28a745;
            background: white;
            color: #28a745;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-customize-btn:hover {
            background: #28a745;
            color: white;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 30px auto; /* R√©duit de 50px √† 30px */
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: calc(100vh - 80px); /* Plus d'espace (100px ‚Üí 80px) */
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative; /* Important pour le positionnement */
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            font-size: 1.5em;
            color: #667eea;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .color-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .color-item:hover {
            background: #e9ecef;
        }

        .color-item-name {
            font-weight: 500;
            color: #495057;
            flex: 1;
        }

        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-preview {
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            cursor: pointer;
        }

        input[type="color"] {
            width: 50px;
            height: 35px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .modal-footer {
            padding: 20px;
            border-top: 2px solid #f0f0f0;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-button.primary {
            background: #667eea;
            color: white;
        }

        .modal-button.primary:hover {
            background: #5568d3;
        }

        .modal-button.secondary {
            background: #e9ecef;
            color: #495057;
        }

        .modal-button.secondary:hover {
            background: #dee2e6;
        }

        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 20px;
        }

        .expenses-list {
            display: grid;
            gap: 10px;
        }

        .category-section {
            margin-bottom: 15px;
        }

        .category-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }

        .category-stats {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .category-stats .amount {
            color: #667eea;
            font-weight: 600;
        }

        .category-stats .percentage {
            color: #999;
            margin-left: 8px;
        }

        .expense-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .expense-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .expense-name {
            font-weight: 500;
            color: #495057;
            flex: 1;
        }

        .expense-input {
            width: 120px;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            text-align: right;
            transition: all 0.3s ease;
            background: white;
        }

        .expense-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .expense-delete-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: all 0.3s ease;
            border-radius: 5px;
        }

        .expense-delete-btn:hover {
            opacity: 1;
            background: #fee;
        }

        .currency {
            margin-left: 8px;
            color: #667eea;
            font-weight: 600;
        }

        .reset-button {
            width: 100%;
            padding: 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .reset-button:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 2em;
            }
            
            .total-amount {
                font-size: 2.5em;
            }

            .dashboard {
                padding: 20px;
            }

            .expense-input {
                width: 100px;
            }
             .modal-content {
                margin: 10px auto; /* Encore moins d'espace en haut */
                width: 95%;
                max-height: calc(100vh - 40px); /* Maximum d'espace vertical */
            }
        }

        /* Auth Screen Styles */
        #authScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }

        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
        }

        .auth-title {
            text-align: center;
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }

        .auth-subtitle {
            text-align: center;
            color: #6c757d;
            margin-bottom: 30px;
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-input {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .auth-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-button {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #6c757d;
        }

        .auth-toggle button {
            background: none;
            border: none;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }

        .auth-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 15px;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.9em;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Edit Mode Styles */
        .edit-mode-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            margin-left: -20px;
            margin-right: -20px;
            margin-top: -20px;
            padding: 12px 20px;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 2px solid #f0f0f0;
            z-index: 100;
            align-items: center;
        }
        
        /* Groupe les boutons edit/add √† gauche */
        .edit-mode-controls > :nth-child(1),
        .edit-mode-controls > :nth-child(2) {
            flex-shrink: 0;
        }
        
        /* Spacer flexible pour pousser Settings √† droite */
        .edit-mode-controls > :nth-child(3) {
            flex: 1;
            min-width: 20px;
        }
        
        /* Settings reste toujours √† droite */
        .edit-mode-controls > :nth-child(4) {
            flex-shrink: 0;
            margin-left: auto;
        }
        
        @media (max-width: 600px) {
            .edit-mode-controls {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
        }

        .edit-mode-btn {
            padding: 8px 16px;
            border: 2px solid #fd7e14;
            background: white;
            color: #fd7e14;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        @media (max-width: 768px) {
            .edit-mode-btn {
                padding: 6px 12px;
                font-size: 0.75em;
                white-space: nowrap;
            }
            
            .edit-mode-controls {
                gap: 6px;
                padding: 10px 15px;
            }
        }
        
        @media (max-width: 480px) {
            .edit-mode-btn {
                padding: 5px 8px;
                font-size: 0.7em;
            }
            
            .edit-mode-controls {
                gap: 4px;
                padding: 8px 10px;
            }
        }

        .edit-mode-btn:hover {
            background: #fd7e14;
            color: white;
        }

        .edit-mode-btn.active {
            background: #fd7e14;
            color: white;
        }

        .category-controls {
            display: none;
            margin-top: 10px;
            gap: 5px;
        }

        .category-controls.show {
            display: flex;
        }

        .category-btn {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            background: white;
            color: #495057;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .category-btn:hover {
            background: #f8f9fa;
        }

        .category-btn.danger {
            color: #dc3545;
            border-color: #dc3545;
        }

        .category-btn.danger:hover {
            background: #dc3545;
            color: white;
        }

        .rename-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9em;
            padding: 2px 6px;
            margin-left: 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .rename-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .settings-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .settings-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .settings-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1em;
        }

        .settings-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        .settings-description {
            margin-top: 8px;
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
        }

        .item-move-btns {
            display: none;
            gap: 5px;
            margin-left: 8px;
        }

        .item-move-btns.show {
            display: flex;
        }

        .item-move-btn {
            background: none;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .item-move-btn:hover {
            background: #f8f9fa;
        }

        .item-rename-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 1em;
            padding: 2px 6px;
            margin-left: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: none;
        }

        .item-rename-btn.show {
            display: inline-block;
        }

        .item-rename-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        #appScreen {
            display: none;
        }

        #appScreen.show {
            display: block;
        }
    </style>
    <link rel="stylesheet" href="css/tabs.css">
</head>
<body>
    <div id="authScreen">
        <div class="auth-container">
            <h1 class="auth-title">Expense Tracker</h1>
            <p class="auth-subtitle">Sign in to sync your expenses</p>
            
            <div class="auth-error" id="authError"></div>
            
            <form class="auth-form" id="authForm" onsubmit="handleAuth(event)">
                <input 
                    type="email" 
                    id="authEmail" 
                    class="auth-input" 
                    placeholder="Email" 
                    required
                />
                <input 
                    type="password" 
                    id="authPassword" 
                    class="auth-input" 
                    placeholder="Password (min 6 characters)" 
                    minlength="6"
                    required
                />
                <button type="submit" class="auth-button" id="authSubmitBtn">
                    Sign In
                </button>
            </form> 
            
            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <button onclick="toggleAuthMode()" id="authToggleBtn">Sign Up</button>
            </div>
        </div>
    </div>

    <div id="appScreen">
    <div class="container">
        <div class="header">
            <h1 id="appTitle">Monthly Expenses</h1>
            <button class="settings-btn-header" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
        </div>
        
        <!-- ONGLETS -->
        <div class="app-tabs">
            <button class="app-tab active" data-tab="budget" onclick="switchTab('budget')">
                üí∞ Budget
            </button>
            <button class="app-tab" data-tab="transactions" onclick="switchTab('transactions')">
                üí≥ Transactions
            </button>
        </div>

            <div class="dashboard">
                <!-- ========================================
                    ONGLET BUDGET
                    ======================================== -->
                <div id="budgetTab" class="tab-content active">
                    <div class="edit-mode-controls">
                        <button class="edit-mode-btn" id="editModeBtn" onclick="toggleEditMode()">
                            ‚úèÔ∏è <span id="editBtnText">Edit Categories</span>
                        </button>
                        <button class="edit-mode-btn" id="compareBtn" onclick="toggleCompareMode()" style="border-color: #667eea; color: #667eea;">
                            üìä Compare
                        </button>
                        <select id="compareMonth" onchange="loadRealSpending()" style="display: none; padding: 10px 14px; border: 2px solid #667eea; border-radius: 10px; font-size: 0.85em; cursor: pointer; font-weight: 600; color: #667eea; background: white;">
                        </select>
                    </div>

                    <div class="total-section">
                        <div id="incomeDisplay" style="display: none; margin-bottom: 15px; opacity: 0.9;">
                            <h3 style="font-size: 1em; margin-bottom: 5px;">Total Income</h3>
                            <div style="font-size: 1.8em; font-weight: 600;" id="totalIncome">‚Ç™0</div>
                        </div>
                        <h2>Total Monthly Expenses</h2>
                        <div class="total-amount" id="totalAmount">‚Ç™0</div>
                        <div id="remainingDisplay" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.3);">
                            <h3 style="font-size: 1em; margin-bottom: 5px;">Remaining</h3>
                            <div style="font-size: 2em; font-weight: 700;" id="remainingAmount">‚Ç™0</div>
                            <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;" id="remainingPercentage"></div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <div class="chart-controls">
                            <button class="chart-toggle-btn active" data-type="doughnut">üç© Pie Chart</button>
                            <button class="chart-toggle-btn" data-type="bar">üìä Bar Chart</button>
                            <button class="color-customize-btn" onclick="openColorEditor()">üé® Colors</button>
                        </div>
                        <div class="chart-container">
                            <canvas id="expensesChart"></canvas>
                        </div>
                    </div>

                    <div class="expenses-list" id="expensesList">
                        <div class="category-section income-category" id="category-income" style="display: none;">
                            <div class="category-title" style="color: #28a745; border-color: #28a745;">
                                Income
                                <button class="rename-btn rename-btn-income" onclick="renameCategory('income')" style="display: none;">‚úèÔ∏è</button>
                            </div>
                            <div class="category-stats" id="incomeStats" style="color: #28a745;"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="addItemToCategory('income')">‚ûï Add Item</button>
                            </div>
                            <div id="incomeExpenses"></div>
                        </div>

                        <div class="category-section" id="category-housing">
                            <div class="category-title">
                                üè† Housing
                                <button class="rename-btn" onclick="renameCategory('housing')" style="display: none;">‚úèÔ∏è</button>
                            </div>
                            <div class="category-stats" id="housingStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('housing')">‚Üë Move Up</button>
                                <button class="category-btn" onclick="moveCategoryDown('housing')">‚Üì Move Down</button>
                                <button class="category-btn" onclick="addItemToCategory('housing')">‚ûï Add Item</button>
                                <button class="category-btn danger" onclick="deleteCategory('housing')">üóëÔ∏è Delete Category</button>
                            </div>
                            <div id="housingExpenses"></div>
                        </div>

                        <div class="category-section" id="category-tech">
                            <div class="category-title">
                                üì± Communications & Tech
                                <button class="rename-btn" onclick="renameCategory('tech')" style="display: none;">‚úèÔ∏è</button>
                            </div>
                            <div class="category-stats" id="techStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('tech')">‚Üë Move Up</button>
                                <button class="category-btn" onclick="moveCategoryDown('tech')">‚Üì Move Down</button>
                                <button class="category-btn" onclick="addItemToCategory('tech')">‚ûï Add Item</button>
                                <button class="category-btn danger" onclick="deleteCategory('tech')">üóëÔ∏è Delete Category</button>
                            </div>
                            <div id="techExpenses"></div>
                        </div>

                        <div class="category-section" id="category-pet">
                            <div class="category-title">
                                üê± Pet Care
                                <button class="rename-btn" onclick="renameCategory('pet')" style="display: none;">‚úèÔ∏è</button>
                            </div>
                            <div class="category-stats" id="petStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('pet')">‚Üë Move Up</button>
                                <button class="category-btn" onclick="moveCategoryDown('pet')">‚Üì Move Down</button>
                                <button class="category-btn" onclick="addItemToCategory('pet')">‚ûï Add Item</button>
                                <button class="category-btn danger" onclick="deleteCategory('pet')">üóëÔ∏è Delete Category</button>
                            </div>
                            <div id="petExpenses"></div>
                        </div>

                        <div class="category-section" id="category-subscriptions">
                            <div class="category-title">
                                üé¨ Subscriptions
                                <button class="rename-btn" onclick="renameCategory('subscriptions')" style="display: none;">‚úèÔ∏è</button>
                            </div>
                            <div class="category-stats" id="subscriptionsStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('subscriptions')">‚Üë Move Up</button>
                                <button class="category-btn" onclick="moveCategoryDown('subscriptions')">‚Üì Move Down</button>
                                <button class="category-btn" onclick="addItemToCategory('subscriptions')">‚ûï Add Item</button>
                                <button class="category-btn danger" onclick="deleteCategory('subscriptions')">üóëÔ∏è Delete Category</button>
                            </div>
                            <div id="subscriptionsExpenses"></div>
                        </div>

                        <div class="category-section" id="category-groceries">
                            <div class="category-title">
                                üõí Groceries
                                <button class="rename-btn" onclick="renameCategory('groceries')" style="display: none;">‚úèÔ∏è</button>
                            </div>
                            <div class="category-stats" id="groceriesStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('groceries')">‚Üë Move Up</button>
                                <button class="category-btn" onclick="moveCategoryDown('groceries')">‚Üì Move Down</button>
                                <button class="category-btn" onclick="addItemToCategory('groceries')">‚ûï Add Item</button>
                                <button class="category-btn danger" onclick="deleteCategory('groceries')">üóëÔ∏è Delete Category</button>
                            </div>
                            <div id="groceriesExpenses"></div>
                        </div>

                        <div class="category-section" id="category-other">
                            <div class="category-title">
                                üí∏ Other Expenses
                                <button class="rename-btn" onclick="renameCategory('other')" style="display: none;">‚úèÔ∏è</button>
                            </div>
                            <div class="category-stats" id="otherStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('other')">‚Üë Move Up</button>
                                <button class="category-btn" onclick="moveCategoryDown('other')">‚Üì Move Down</button>
                                <button class="category-btn" onclick="addItemToCategory('other')">‚ûï Add Item</button>
                                <button class="category-btn danger" onclick="deleteCategory('other')">üóëÔ∏è Delete Category</button>
                            </div>
                            <div id="otherExpenses"></div>
                        </div>
                    </div>

                    <button class="reset-button" onclick="resetExpenses()">Reset All Expenses</button>
                </div>
                <!-- FIN DE L'ONGLET BUDGET -->

                <!-- ========================================
                    ONGLET TRANSACTIONS
                    ======================================== -->
                <div id="transactionsTab" class="tab-content">
                    <!-- Charg√© dynamiquement depuis partials/transactions-tab.html -->
                </div>
                <!-- FIN DE L'ONGLET TRANSACTIONS -->

            </div>
            <!-- FIN DE DASHBOARD -->

                
        </div> <!-- Fin container -->
    </div> <!-- Fin appScreen -->

    <!-- Color Editor Modal -->
    <div id="colorEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé® Customize Colors</h2>
                <button class="modal-close" onclick="closeColorEditor()">‚úï</button>
            </div>
            <div class="modal-body" id="colorEditorBody">
                <!-- Color items will be generated here -->
            </div>
            <div class="modal-footer">
                <button class="modal-button secondary" onclick="resetColors()">Reset to Default</button>
                <button class="modal-button primary" onclick="closeColorEditor()">Done</button>
            </div>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="settings-section">
                    <h3>Account</h3>
                    <p id="settingsUserEmail" style="color: #6c757d; margin-bottom: 10px;"></p>
                    <button class="modal-button secondary" onclick="handleLogout()">Logout</button>
                </div>
                
                <div class="settings-section">
                    <h3>Language / Langue / Idioma / –Ø–∑—ã–∫ / ◊©◊§◊î / ŸÑÿ∫ÿ©</h3>
                    <select class="settings-select" id="languageSelect" onchange="changeLanguage(this.value)">
                        <option value="en">English</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="es">Espa√±ol</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="he">◊¢◊ë◊®◊ô◊™</option>
                        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    </select>
                </div>
                
                <div class="settings-section">
                    <h3>Currency</h3>
                    <select class="settings-select" id="currencySelect" onchange="updateCurrency(this.value)">
                        <option value="ILS">Israeli Shekel (‚Ç™)</option>
                        <option value="USD">US Dollar ($)</option>
                        <option value="EUR">Euro (‚Ç¨)</option>
                        <option value="GBP">British Pound (¬£)</option>
                        <option value="JPY">Japanese Yen (¬•)</option>
                        <option value="RUB">Russian Ruble (‚ÇΩ)</option>
                        <option value="CNY">Chinese Yuan (¬•)</option>
                        <option value="EGP">Egyptian Pound (E¬£)</option>
                        <option value="LBP">Lebanese Pound (L¬£)</option>
                        <option value="SYP">Syrian Pound (S¬£)</option>
                        <option value="JOD">Jordanian Dinar (ÿØ.ÿß)</option>
                        <option value="INR">Indian Rupee (‚Çπ)</option>
                        <option value="THB">Thai Baht (‡∏ø)</option>
                    </select>
                </div>
                
                <div class="settings-section">
                    <h3>Income Tracking</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="useIncomeCheckbox" onchange="toggleIncomeFeature(this.checked)" />
                        <span>Track monthly income</span>
                    </label>
                </div>
                
                <div class="settings-section" id="percentageModeSection" style="display: none;">
                    <h3>Percentage Calculation</h3>
                    <select class="settings-select" id="percentageModeSelect" onchange="updatePercentageMode(this.value)">
                        <option value="expenses">Based on total expenses</option>
                        <option value="income">Based on total income</option>
                    </select>
                    <p class="settings-description">Choose how category percentages are calculated</p>
                </div>

                <!-- Clear Transactions -->
                <div class="settings-section">
                    <h3>üóëÔ∏è Clear Data</h3>
                    <button class="settings-btn danger" onclick="clearAllTransactions()">
                        Clear All Transactions
                    </button>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #6c757d;">
                        Remove all synced transactions from the database. This cannot be undone.
                    </p>
                </div>
                <!-- About Section -->
                <div class="settings-section" style="border-top: 2px solid #e9ecef; margin-top: 30px; padding-top: 20px; text-align: center; font-size: 0.85em; color: #6c757d;">
                    <p style="margin: 5px 0; font-weight: 600;">Made by Victor Burtman</p>
                    <p style="margin: 5px 0;">For any bug report, ideas or suggestions:</p>
                    <a href="mailto:victorburtman@gmail.com" style="color: #667eea; text-decoration: none; font-weight: 600;">victorburtman@gmail.com</a>
                </div>   
            </div>
            <div class="modal-footer">
                <button class="modal-button primary" onclick="closeSettings()">Done</button>
            </div>
        </div>
    </div>


    
    <script>
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Error caught:', e.message);
            // Don't let errors break the app
            e.preventDefault();
        });

        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBQ817hUTznf99z7ZFhVla39rnyjGibTWo",
          authDomain: "expense-tracker-b086e.firebaseapp.com",
          projectId: "expense-tracker-b086e",
          storageBucket: "expense-tracker-b086e.firebasestorage.app",
          messagingSenderId: "958947625850",
          appId: "1:958947625850:web:a67c87046977c909bfa4c3"
        };

        // Initialize Firebase
        let app, auth, db, functions;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            functions = firebase.functions();
            window.functions = functions;
            console.log('Firebase initialized successfully');
        } catch (error) {  // ‚Üê AJOUTE CETTE LIGNE
            console.error('Firebase initialization error:', error);
        }

        // Global variables
        let currentUser = null;
        let isSignUpMode = false;
        let isEditMode = false;
        let categoryOrder = ['income', 'housing', 'tech', 'pet', 'subscriptions', 'groceries', 'other'];
        let useIncome = true;
        let currency = '‚Ç™'; // Default currency symbol
        let currencyOptions = {
            'ILS': '‚Ç™',
            'USD': '$',
            'EUR': '‚Ç¨',
            'GBP': '¬£',
            'JPY': '¬•',
            'RUB': '‚ÇΩ',
            'CNY': '¬•',
            'EGP': 'E¬£',
            'LBP': 'L¬£',
            'SYP': 'S¬£',
            'JOD': 'ÿØ.ÿß',
            'INR': '‚Çπ',
            'THB': '‡∏ø'
        };
        let percentageMode = 'expenses'; // 'expenses' or 'income'

        // Store category metadata (emoji, display name)
        let categoryMetadata = {};

        let currentLanguage = 'en'; // Variable pour la langue actuelle

        // Fonction pour obtenir une traduction
        function t(key) {
            return translations[currentLanguage][key] || key;
        }
        
        // Fonction pour changer de langue
        function changeLanguage(lang) {
            currentLanguage = lang;
            
            // Sauvegarder la langue choisie
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({
                    language: lang
                }, { merge: true });
            } else {
                localStorage.setItem('preferredLanguage', lang);
            }
            
            // Mettre √† jour l'attribut dir pour RTL (arabe et h√©breu)
            if (lang === 'ar' || lang === 'he') {
                document.documentElement.setAttribute('dir', 'rtl');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
            }
            
            // Recharger l'interface avec les nouvelles traductions
            updateUILanguage();
        }
        
        // Fonction pour mettre √† jour toute l'interface
        function updateUILanguage() {
            // V√©rifier que les √©l√©ments existent avant de les modifier
            const authTitle = document.querySelector('.auth-title');
            if (!authTitle) return; // Sortir si les √©l√©ments ne sont pas encore charg√©s
            // Auth screen
            document.querySelector('.auth-title').textContent = t('appTitle');
            document.querySelector('.auth-subtitle').textContent = t('authSubtitle');
            document.getElementById('authEmail').placeholder = t('email');
            document.getElementById('authPassword').placeholder = t('password');
            
            const isSignUp = document.getElementById('authSubmitBtn').textContent.includes('Sign Up') || 
                             document.getElementById('authSubmitBtn').textContent.includes('S\'inscrire') ||
                             document.getElementById('authSubmitBtn').textContent.includes('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è') ||
                             document.getElementById('authSubmitBtn').textContent.includes('◊î◊ô◊®◊©◊ù') ||
                             document.getElementById('authSubmitBtn').textContent.includes('Registrarse') ||
                             document.getElementById('authSubmitBtn').textContent.includes('ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®');
            
            document.getElementById('authSubmitBtn').textContent = isSignUp ? t('signUp') : t('signIn');
            document.getElementById('authToggleText').textContent = isSignUp ? t('hasAccount') : t('noAccount');
            document.getElementById('authToggleBtn').textContent = isSignUp ? t('signIn') : t('signUp');
            
            // Main app header
            document.querySelector('.header h1').textContent = t('monthlyExpenses');
            
            // Edit mode buttons
            const editBtn = document.getElementById('editModeBtn');
            if (editBtn.classList.contains('active')) {
                editBtn.textContent = t('doneEditing');
            } else {
                editBtn.textContent = t('editCategories');
            }
            
            document.querySelector('[onclick="addNewCategory()"]').textContent = t('addCategory');
            document.querySelector('[onclick="openSettings()"]').textContent = t('settings');
            
            // Total section
            document.querySelector('.total-section h2').textContent = t('totalExpenses');
            const incomeH3 = document.querySelector('#incomeDisplay h3');
            if (incomeH3) incomeH3.textContent = t('totalIncome');
            const remainingH3 = document.querySelector('#remainingDisplay h3');
            if (remainingH3) remainingH3.textContent = t('remaining');
            
            // Chart buttons
            const chartButtons = document.querySelectorAll('.chart-toggle-btn');
            chartButtons[0].textContent = t('pieChart');
            chartButtons[1].textContent = t('barChart');
            document.querySelector('.color-customize-btn').textContent = t('colors');
            
            // Reset button
            document.querySelector('.reset-button').textContent = t('resetAll');
            
            // Modals
            document.querySelector('#colorEditorModal .modal-header h2').textContent = t('customizeColors');
            document.querySelector('#colorEditorModal .modal-footer .secondary').textContent = t('resetToDefault');
            document.querySelector('#colorEditorModal .modal-footer .primary').textContent = t('done');
            
            document.querySelector('#settingsModal .modal-header h2').textContent = t('settingsTitle');
            document.querySelector('#settingsModal .modal-footer .primary').textContent = t('done');
            
            // Settings sections
            const settingsSections = document.querySelectorAll('#settingsModal .settings-section h3');
            settingsSections[0].textContent = t('account');
            settingsSections[1].textContent = t('currency');
            settingsSections[2].textContent = t('incomeTracking');
            if (settingsSections[3]) settingsSections[3].textContent = t('percentageCalculation');
            
            document.querySelector('#settingsModal .settings-section button').textContent = t('logout');
            
            const settingsDescriptions = document.querySelectorAll('.settings-description');
            if (settingsDescriptions[0]) settingsDescriptions[0].textContent = t('percentageDesc');
            
            const trackIncomeSpan = document.querySelector('#useIncomeCheckbox + span');
            if (trackIncomeSpan) {
                trackIncomeSpan.textContent = t('trackIncome');
            }
            
            // Percentage mode options
            const percentageOptions = document.querySelectorAll('#percentageModeSelect option');
            if (percentageOptions.length > 0) {
                percentageOptions[0].textContent = t('basedOnExpenses');
                percentageOptions[1].textContent = t('basedOnIncome');
            }
            
            // Update category controls if in edit mode
            if (isEditMode) {
                document.querySelectorAll('.category-controls').forEach(controls => {
                    const buttons = controls.querySelectorAll('.category-btn');
                    if (buttons.length >= 4) {
                        buttons[0].innerHTML = t('moveUp');
                        buttons[1].innerHTML = t('moveDown');
                        buttons[2].innerHTML = t('addItem');
                        buttons[3].innerHTML = t('deleteCategory');
                    }
                });
            }
            
            // Update display to refresh category names and stats
            updateDisplay();
            updateTransactionsLanguage();
        }


        /**
         * Update translations for transactions tab
         */
        function updateTransactionsLanguage() {
            // Traduire les √©l√©ments avec data-translate
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });
            
            // Traduire les placeholders
            const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
            placeholderElements.forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.placeholder = translations[currentLanguage][key];
                }
            });
        }

        
        // NOUVELLE FONCTION - Cleanup category order
        function cleanupCategoryOrder() {
            // Enlever les cat√©gories qui n'existent plus dans expenses
            categoryOrder = categoryOrder.filter(categoryKey => expenses.hasOwnProperty(categoryKey));
            
            // Ajouter les cat√©gories manquantes
            Object.keys(expenses).forEach(categoryKey => {
                if (!categoryOrder.includes(categoryKey)) {
                    categoryOrder.push(categoryKey);
                }
            });
            
            // S'assurer qu'income est toujours en premier si elle existe
            if (categoryOrder.includes('income') && categoryOrder[0] !== 'income') {
                categoryOrder = ['income', ...categoryOrder.filter(c => c !== 'income')];
            }
            
            console.log('Category order cleaned:', categoryOrder);
        }

        // Authentication functions
        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            const submitBtn = document.getElementById('authSubmitBtn');
            const toggleText = document.getElementById('authToggleText');
            const toggleBtn = document.getElementById('authToggleBtn');
            
            if (isSignUpMode) {
                submitBtn.textContent = 'Sign Up';
                toggleText.textContent = 'Already have an account?';
                toggleBtn.textContent = 'Sign In';
            } else {
                submitBtn.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account?";
                toggleBtn.textContent = 'Sign Up';
            }
        }

        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }

        async function handleAuth(event) {
            event.preventDefault();
            
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const submitBtn = document.getElementById('authSubmitBtn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = isSignUpMode ? 'Creating account...' : 'Signing in...';
            
            try {
                if (isSignUpMode) {
                    await auth.createUserWithEmailAndPassword(email, password);
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                }
            } catch (error) {
                console.error('Auth error:', error);
                let errorMessage = 'An error occurred. Please try again.';
                
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'This email is already in use. Try signing in instead.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password should be at least 6 characters.';
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = 'Invalid email or password.';
                }
                
                showAuthError(errorMessage);
                submitBtn.disabled = false;
                submitBtn.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
            }
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                closeSettings();
                auth.signOut();
            }
        }

        // Auth state observer
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                window.currentUser = user;  // ‚Üê AJOUTE
                document.getElementById('authScreen').style.display = 'none';
                document.getElementById('appScreen').classList.add('show');
                
                // Load user data from Firestore
                await loadUserData();
            } else {
                currentUser = null;
                window.currentUser = null;  // ‚Üê AJOUTE
    
                // Charger la langue pr√©f√©r√©e m√™me sans connexion
                const savedLang = localStorage.getItem('preferredLanguage') || 'en';
                currentLanguage = savedLang;
                
                // ‚úÖ V√©rifier que l'√©l√©ment existe avant de le modifier
                const langSelect = document.getElementById('languageSelect');
                if (langSelect) {
                    langSelect.value = savedLang;
                }
                
                if (currentLanguage === 'ar' || currentLanguage === 'he') {
                    document.documentElement.setAttribute('dir', 'rtl');
                } else {
                    document.documentElement.setAttribute('dir', 'ltr');
                }
                
                // ‚úÖ Appeler updateUILanguage() avec un petit d√©lai pour √™tre s√ªr que le DOM est pr√™t
                setTimeout(() => {
                    updateUILanguage();
                }, 100);
                
                document.getElementById('authScreen').style.display = 'flex';
                document.getElementById('appScreen').classList.remove('show');
            }
        });

        const defaultExpenses = {
            income: [
                { name: 'Salary', amount: 0 }
            ],
            housing: [
                { name: 'Rent', amount: 0 },
                { name: 'Arnona', amount: 0 },
                { name: 'Electricity', amount: 0 },
                { name: 'Gas', amount: 0 },
                { name: 'Water', amount: 0 }
            ],
            tech: [
                { name: 'Phone Plan', amount: 0 },
                { name: 'Internet', amount: 0 },
                { name: 'iCloud', amount: 0 }
            ],
            pet: [
                { name: 'Cat Food', amount: 0 },
                { name: 'Litter', amount: 0 }
            ],
            subscriptions: [
                { name: 'YouTube Premium', amount: 0 },
                { name: 'Claude Pro', amount: 0 },
                { name: 'Therapist', amount: 0 }
            ],
            groceries: [
                { name: 'Food', amount: 0 },
                { name: 'Household Products', amount: 0 },
                { name: 'Personal Care', amount: 0 }
            ],
            other: [
                { name: 'Other Expenses', amount: 0 }
            ]
        };

        
        // Data variables
        let expenses = JSON.parse(JSON.stringify(defaultExpenses));
        let chart = null;
        let currentChartType = 'doughnut';
        let hiddenItems = {};
        let customColors = {};

        // Firestore functions
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const data = userDoc.data();
                    expenses = data.expenses || JSON.parse(JSON.stringify(defaultExpenses));
                    customColors = data.customColors || {};
                    currentChartType = data.chartType || 'doughnut';
                    categoryOrder = data.categoryOrder || ['income', 'housing', 'tech', 'pet', 'subscriptions', 'groceries', 'other'];
                    useIncome = data.useIncome !== undefined ? data.useIncome : true;
                    currency = data.currency || '‚Ç™';
                    percentageMode = data.percentageMode || 'expenses';
                    categoryMetadata = data.categoryMetadata || {};
                    
                    // Charger la langue pr√©f√©r√©e
                    currentLanguage = data.language || localStorage.getItem('preferredLanguage') || 'en';
                    document.getElementById('languageSelect').value = currentLanguage;
                    
                    // Appliquer RTL si n√©cessaire
                    if (currentLanguage === 'ar' || currentLanguage === 'he') {
                        document.documentElement.setAttribute('dir', 'rtl');
                    } else {
                        document.documentElement.setAttribute('dir', 'ltr');
                    }
                    
                    // NOUVEAU : Nettoyer et synchroniser categoryOrder
                    cleanupCategoryOrder();
                    
                    console.log('Loaded from Firebase:', {
                        expenseCategories: Object.keys(expenses),
                        categoryOrder: categoryOrder
                    });
                    
                    // Hide default categories that were deleted by the user
                    const defaultCategories = ['income', 'housing', 'tech', 'pet', 'subscriptions', 'groceries', 'other'];
                    defaultCategories.forEach(categoryKey => {
                        const section = document.getElementById(`category-${categoryKey}`);
                        if (section) {
                            if (!expenses[categoryKey]) {
                                // Category was deleted - hide it
                                console.log(`Hiding deleted default category: ${categoryKey}`);
                                section.style.display = 'none';
                            } else {
                                // Category exists - show it
                                section.style.display = 'block';
                            }
                        }
                    });
                    
                    // Recreate HTML for custom categories that don't exist in the default list
                    const expensesList = document.getElementById('expensesList');
                    
                    Object.keys(expenses).forEach(categoryKey => {
                        // Skip default categories - they already have HTML
                        if (defaultCategories.includes(categoryKey)) return;
                        
                        // Check if HTML element exists
                        if (document.getElementById(`category-${categoryKey}`)) return;
                        
                        console.log(`Creating HTML for custom category: ${categoryKey}`);
                        
                        // Get metadata for this category
                        const meta = categoryMetadata[categoryKey] || {
                            emoji: 'üìã',
                            displayName: categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1)
                        };
                        
                        // Create HTML for this custom category
                        const statsId = `${categoryKey}Stats`;
                        const expensesId = `${categoryKey}Expenses`;
                        
                        const categorySection = document.createElement('div');
                        categorySection.className = 'category-section';
                        categorySection.id = `category-${categoryKey}`;
                        categorySection.innerHTML = `
                            <div class="category-title">
                                ${meta.emoji} ${meta.displayName}
                                <button class="rename-btn" onclick="renameCategory('${categoryKey}')" style="display: none;">‚úèÔ∏è</button>
                            </div>
                            <div class="category-stats" id="${statsId}"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('${categoryKey}')">‚Üë Move Up</button>
                                <button class="category-btn" onclick="moveCategoryDown('${categoryKey}')">‚Üì Move Down</button>
                                <button class="category-btn" onclick="addItemToCategory('${categoryKey}')">‚ûï Add Item</button>
                                <button class="category-btn danger" onclick="deleteCategory('${categoryKey}')">üóëÔ∏è Delete Category</button>
                            </div>
                            <div id="${expensesId}"></div>
                        `;
                        
                        expensesList.appendChild(categorySection);
                    });
                    
                    // Reorder categories according to categoryOrder
                    renderCategoriesInOrder();
                } else {
                    // First time user - use defaults
                    expenses = JSON.parse(JSON.stringify(defaultExpenses));
                    await saveUserData();
                }
                // Mettre √† jour l'interface avec la langue charg√©e
                updateUILanguage();
                updateDisplay();
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }


        // AJOUTE ICI : Language change handler
        document.getElementById('languageSelect')?.addEventListener('change', async function(e) {
            currentLanguage = e.target.value;
            localStorage.setItem('preferredLanguage', currentLanguage);
            
            // Appliquer RTL si n√©cessaire
            if (currentLanguage === 'ar' || currentLanguage === 'he') {
                document.documentElement.setAttribute('dir', 'rtl');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
            }
            
            updateUILanguage();
            
            // Traduire l'onglet Transactions si visible
            if (typeof updateTransactionsLanguage === 'function') {
                updateTransactionsLanguage();
            }
            
            // Sauvegarder dans Firebase
            if (currentUser) {
                await saveUserData();
            }
        });


        
        async function saveUserData() {
            if (!currentUser) return;
            
            try {
                const dataToSave = {
                    expenses: expenses,
                    customColors: customColors,
                    chartType: currentChartType,
                    categoryOrder: categoryOrder,
                    useIncome: useIncome,
                    currency: currency,
                    percentageMode: percentageMode,
                    categoryMetadata: categoryMetadata,
                    language: currentLanguage,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log('Saving to Firebase:', {
                    expenseCategories: Object.keys(expenses),
                    categoryOrder: categoryOrder
                });
                
                // IMPORTANT : Ne PAS utiliser merge pour que les cl√©s supprim√©es disparaissent vraiment
                await db.collection('users').doc(currentUser.uid).set(dataToSave);
                console.log('Save successful');
            } catch (error) {
                console.error('Error saving user data:', error);
                throw error;
            }
        }

        function saveExpenses() {
            saveUserData();
            updateDisplay();
        }


        const colors = [
            '#667eea', '#764ba2', '#f093fb', '#4facfe',
            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
            '#a8edea', '#fed6e3', '#c471f5', '#12c2e9'
        ];

        function calculateTotal() {
            let total = 0;
            Object.keys(expenses).forEach(categoryKey => {
                // Skip income category when calculating expenses
                if (categoryKey === 'income') return;
                
                expenses[categoryKey].forEach(expense => {
                    total += parseFloat(expense.amount) || 0;
                });
            });
            return total;
        }

        function calculateIncome() {
            if (!expenses.income) return 0;
            let total = 0;
            expenses.income.forEach(item => {
                total += parseFloat(item.amount) || 0;
            });
            return total;
        }

        function calculateCategoryTotal(categoryKey) {
            let categoryTotal = 0;
            if (expenses[categoryKey]) {
                expenses[categoryKey].forEach(expense => {
                    categoryTotal += parseFloat(expense.amount) || 0;
                });
            }
            return categoryTotal;
        }

        function getCategoryStats(categoryKey) {
            const categoryTotal = calculateCategoryTotal(categoryKey);
            
            // Calculate base depending on percentage mode
            let base;
            if (percentageMode === 'income' && useIncome) {
                base = calculateIncome();
            } else {
                base = categoryKey === 'income' ? calculateIncome() : calculateTotal();
            }
            
            const percentage = base > 0 ? ((categoryTotal / base) * 100).toFixed(1) : 0;
            return {
                total: categoryTotal,
                percentage: percentage
            };
        }

        function calculateVisibleTotal(chartInstance) {
            if (!chartInstance || !chartInstance.data) return calculateTotal();
            
            let visibleTotal = 0;
            const data = chartInstance.data.datasets[0].data;
            const labels = chartInstance.data.labels;
            
            data.forEach((value, index) => {
                // Check if this data point is visible
                const meta = chartInstance.getDatasetMeta(0);
                if (meta.data[index] && !meta.data[index].hidden) {
                    visibleTotal += value;
                }
            });
            
            return visibleTotal;
        }

        function renderExpenseItem(expense, category, index) {
            const deleteBtn = isEditMode ? 
                `<button class="expense-delete-btn" onclick="deleteExpenseItem('${category}', ${index})" title="Delete item">üóëÔ∏è</button>` : '';
            
            const moveUpBtn = isEditMode ? 
                `<button class="item-move-btn" onclick="moveItemUp('${category}', ${index})" title="Move up">‚Üë</button>` : '';
            
            const moveDownBtn = isEditMode ? 
                `<button class="item-move-btn" onclick="moveItemDown('${category}', ${index})" title="Move down">‚Üì</button>` : '';
            
            const renameBtn = isEditMode ? 
                `<button class="item-rename-btn show" onclick="renameItem('${category}', ${index})" title="Rename">‚úèÔ∏è</button>` : '';
            
            return `
                <div class="expense-item">
                    <span class="expense-name">
                        ${expense.name}
                        ${renameBtn}
                        <span class="item-move-btns ${isEditMode ? 'show' : ''}">
                            ${moveUpBtn}
                            ${moveDownBtn}
                        </span>
                    </span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input 
                            type="number" 
                            class="expense-input" 
                            value="${expense.amount}"
                            onchange="updateExpense('${category}', ${index}, this.value)"
                            step="0.01"
                            min="0"
                        />
                        <span class="currency">${currency}</span>
                        ${deleteBtn}
                    </div>
                </div>
            `;
        }

        function updateExpense(category, index, value) {
            expenses[category][index].amount = parseFloat(value) || 0;
            saveExpenses();
        }

        function updateDisplay() {
            try {
                cleanupCategoryOrder();
                // Update income section visibility
                const incomeSection = document.getElementById('category-income');
                const incomeDisplaySection = document.getElementById('incomeDisplay');
                const remainingDisplaySection = document.getElementById('remainingDisplay');
                
                if (useIncome && expenses.income && incomeSection) {
                    incomeSection.style.display = 'block';
                    incomeDisplaySection.style.display = 'block';
                    remainingDisplaySection.style.display = 'block';
                } else if (incomeSection) {
                    incomeSection.style.display = 'none';
                    incomeDisplaySection.style.display = 'none';
                    remainingDisplaySection.style.display = 'none';
                }
                
                // Calculate totals
                const totalExpenses = calculateTotal();
                const totalIncome = calculateIncome();
                const remaining = totalIncome - totalExpenses;
                
                // Calculate remaining percentage
                const remainingPercentage = totalIncome > 0 ? ((remaining / totalIncome) * 100).toFixed(1) : 0;
                
                // Update displays
                document.getElementById('totalAmount').textContent = `${currency}${totalExpenses.toFixed(2)}`;
                document.getElementById('totalIncome').textContent = `${currency}${totalIncome.toFixed(2)}`;
                document.getElementById('remainingAmount').textContent = `${currency}${remaining.toFixed(2)}`;
                document.getElementById('remainingAmount').style.color = remaining >= 0 ? '#28a745' : '#dc3545';
                document.getElementById('remainingPercentage').textContent = `(${remainingPercentage}% of income)`;
        
                // First, hide ALL category sections
                const allSections = document.querySelectorAll('.category-section');
                allSections.forEach(section => {
                    section.style.display = 'none';
                });
        
                // Then, update ONLY categories that exist in expenses
                Object.keys(expenses).forEach(categoryKey => {
                    const section = document.getElementById(`category-${categoryKey}`);
                    if (!section) {
                        // Category exists in data but not in DOM - skip it
                        return;
                    }
                    
                    // Show the section
                    section.style.display = 'block';
                    
                    // Update stats
                    const stats = getCategoryStats(categoryKey);
                    const statsElement = document.getElementById(`${categoryKey}Stats`);
                    
                    if (statsElement) {
                        if (categoryKey === 'income') {
                            statsElement.innerHTML = stats.total > 0 ? 
                                `<span class="amount" style="color: #28a745;">${currency}${stats.total.toFixed(2)}</span>` : '';
                        } else {
                            // NOUVEAU : Ajouter la comparaison si le mode est activ√©
                            let statsHTML = stats.total > 0 ? 
                                `<span class="amount">${currency}${stats.total.toFixed(2)}</span><span class="percentage">(${stats.percentage}%)</span>` : '';
                            
                            // Ajouter les infos de comparaison
                            if (compareMode && stats.total > 0) {
                                statsHTML += renderComparisonInfo(categoryKey, stats.total);
                            }
                            
                            statsElement.innerHTML = statsHTML;
                        }
                    }
                    
                    // Update expenses items
                    const expensesElement = document.getElementById(`${categoryKey}Expenses`);
                    if (expensesElement && expenses[categoryKey]) {
                        expensesElement.innerHTML = expenses[categoryKey].map((exp, i) => 
                            renderExpenseItem(exp, categoryKey, i)).join('');
                    }
                });
        
                // Update chart
                updateChart();
            } catch (error) {
                console.error('Error updating display:', error);
            }
        }

        function updateChart() {
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js is not available');
                return;
            }
        
            const ctx = document.getElementById('expensesChart').getContext('2d');
            
            // Prepare data for chart - EXCLUDE income category
            const allLabels = [];
            const allData = [];
            const allBackgroundColors = [];
            
            Object.keys(expenses).forEach(categoryKey => {
                // Skip income category in charts
                if (categoryKey === 'income') return;
                
                expenses[categoryKey].forEach(expense => {
                    if (expense.amount > 0) {
                        allLabels.push(expense.name);
                        allData.push(expense.amount);
                        
                        // Use custom color if available
                        if (customColors[expense.name]) {
                            allBackgroundColors.push(customColors[expense.name]);
                        } else {
                            // Generate consistent color based on item name (hash)
                            const hash = expense.name.split('').reduce((acc, char) => {
                                return char.charCodeAt(0) + ((acc << 5) - acc);
                            }, 0);
                            const colorIdx = Math.abs(hash) % colors.length;
                            allBackgroundColors.push(colors[colorIdx]);
                        }
                    }
                });
            });
        
            // Sort data in descending order for both chart types
            const indices = allData.map((_, i) => i);
            indices.sort((a, b) => allData[b] - allData[a]);
            
            const sortedLabels = indices.map(i => allLabels[i]);
            const sortedData = indices.map(i => allData[i]);
            const sortedColors = indices.map(i => allBackgroundColors[i]);
        
            // Filter out hidden items for display
            const displayLabels = [];
            const displayData = [];
            const displayColors = [];
            
            sortedLabels.forEach((label, i) => {
                if (!hiddenItems[label]) {
                    displayLabels.push(label);
                    displayData.push(sortedData[i]);
                    displayColors.push(sortedColors[i]);
                }
            });
        
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: currentChartType === 'doughnut' ? {
                    duration: 400,
                    easing: 'easeOutQuart',
                    animateRotate: false, // D√©sactive la rotation pendant l'animation
                    animateScale: true    // Garde l'animation de taille
                } : {
                    duration: 750,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            padding: 10,
                            font: {
                                size: 11
                            },
                            boxWidth: 15,
                            boxHeight: 15,
                            generateLabels: function(chart) {
                                return sortedLabels.map((label, i) => {
                                    return {
                                        text: label,
                                        fillStyle: sortedColors[i],
                                        strokeStyle: sortedColors[i],
                                        lineWidth: 0,
                                        hidden: hiddenItems[label] || false,
                                        index: i,
                                        datasetIndex: 0
                                    };
                                });
                            }
                        },
                        onClick: function(e, legendItem, legend) {
                            const label = sortedLabels[legendItem.index];
                            hiddenItems[label] = !hiddenItems[label];
                            updateChart();
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = currentChartType === 'bar' ? context.parsed.y : context.parsed;
                                const total = displayData.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${currency}${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            };
        
            // SI le graphique existe d√©j√†, on met juste √† jour les donn√©es
            if (chart && chart.config.type === currentChartType) {
                // Mise √† jour des donn√©es existantes
                chart.data.labels = displayLabels;
                chart.data.datasets[0].data = displayData;
                chart.data.datasets[0].backgroundColor = displayColors;
                
                // Mise √† jour des options si n√©cessaire
                chart.options = currentChartType === 'bar' ? {
                    ...commonOptions,
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return currency + value;
                                }
                            }
                        }
                    }
                } : commonOptions;
                
                // Rafra√Æchir le graphique avec animation
                chart.update('active'); // 'active' permet une animation fluide
                
            } else {
                // Le graphique n'existe pas OU le type a chang√© : on le recr√©e
                if (chart) {
                    chart.destroy();
                }
                
                if (allLabels.length === 0) {
                    // Show placeholder when no data
                    chart = new Chart(ctx, {
                        type: currentChartType,
                        data: {
                            labels: ['No expenses yet'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#e9ecef'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                } else if (currentChartType === 'doughnut') {
                    chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: displayLabels,
                            datasets: [{
                                data: displayData,
                                backgroundColor: displayColors,
                                borderWidth: 2,
                                borderColor: '#fff'
                            }]
                        },
                        options: commonOptions
                    });
                } else {
                    chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: displayLabels,
                            datasets: [{
                                data: displayData,
                                backgroundColor: displayColors,
                                borderWidth: 0,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                x: {
                                    display: false
                                },
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return currency + value;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Update total to reflect visible items
            const visibleTotal = displayData.reduce((a, b) => a + b, 0);
            document.getElementById('totalAmount').textContent = `${currency}${visibleTotal.toFixed(2)}`;
        }
    
        function resetExpenses() {
            if (confirm('Are you sure you want to reset all expenses to 0?')) {
                expenses = JSON.parse(JSON.stringify(defaultExpenses));
                hiddenItems = {};
                saveUserData();
                updateDisplay();
            }
        }

        function openColorEditor() {
            const modal = document.getElementById('colorEditorModal');
            const body = document.getElementById('colorEditorBody');
            
            // Build list of all expenses with their current colors - EXCLUDE income
            body.innerHTML = '';
            let colorIndex = 0;
            
            Object.keys(expenses).forEach(categoryKey => {
                // Skip income category
                if (categoryKey === 'income') return;
                
                expenses[categoryKey].forEach(expense => {
                    const currentColor = customColors[expense.name] || colors[colorIndex % colors.length];
                    
                    const colorItem = document.createElement('div');
                    colorItem.className = 'color-item';
                    colorItem.innerHTML = `
                        <span class="color-item-name">${expense.name}</span>
                        <div class="color-picker-wrapper">
                            <input 
                                type="color" 
                                value="${currentColor}" 
                                onchange="updateColor('${expense.name}', this.value)"
                            />
                        </div>
                    `;
                    body.appendChild(colorItem);
                    colorIndex++;
                });
            });
            
            modal.classList.add('show');
        }

        function closeColorEditor() {
            const modal = document.getElementById('colorEditorModal');
            modal.classList.remove('show');
        }

        function updateColor(expenseName, color) {
            customColors[expenseName] = color;
            saveUserData();
            updateChart();
        }

        function resetColors() {
            if (confirm('Reset all colors to default?')) {
                customColors = {};
                saveUserData();
                closeColorEditor();
                updateChart();
            }
        }

        // Edit Mode Functions
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editBtn = document.getElementById('editModeBtn');
            const categoryControls = document.querySelectorAll('.category-controls');
            const renameButtons = document.querySelectorAll('.rename-btn');
            
            if (isEditMode) {
                if (editBtn) {
                    editBtn.classList.add('active');
                    editBtn.innerHTML = '‚úì Done Editing';
                }
                
                const addBtn = document.querySelector('button[onclick*="addNewCategory"]');
                if (addBtn) addBtn.style.display = 'block';
                
                categoryControls.forEach(c => c.classList.add('show'));
                renameButtons.forEach(btn => {
                    // Ne pas afficher le bouton pour Income
                    if (!btn.classList.contains('rename-btn-income')) {
                        btn.style.display = 'inline-block';
                    }
                });
            } else {
                if (editBtn) {
                    editBtn.classList.remove('active');
                    editBtn.innerHTML = '‚úèÔ∏è Edit Categories';
                }
                
                const addBtn = document.querySelector('button[onclick*="addNewCategory"]');
                if (addBtn) addBtn.style.display = 'none';
                
                categoryControls.forEach(c => c.classList.remove('show'));
                renameButtons.forEach(btn => btn.style.display = 'none');
            }
        }


        // ============================================
        // COMPARE MODE - Real Spending vs Budget
        // ============================================
        
        let compareMode = false;
        let realSpendingData = {};
        
        /**
         * Toggle compare mode on/off
         */
        function toggleCompareMode() {
            const compareBtn = document.getElementById('compareBtn');
            const monthSelect = document.getElementById('compareMonth');
            
            compareMode = !compareMode;
            
            // Update button style
            if (compareMode) {
                compareBtn.style.background = '#667eea';
                compareBtn.style.color = 'white';
                
                // IMPORTANT : Afficher AVANT de peupler
                if (monthSelect) {
                    monthSelect.style.display = 'inline-block';
                }
                
                // Populate month dropdown APR√àS avoir affich√©
                setTimeout(() => {
                    populateMonthDropdown();
                    loadRealSpending();
                }, 50);
                
            } else {
                compareBtn.style.background = 'white';
                compareBtn.style.color = '#667eea';
                compareBtn.style.borderColor = '#dee2e6';
                
                // Hide month selector
                if (monthSelect) monthSelect.style.display = 'none';
                
                // Clear real spending data
                realSpendingData = {};
                
                // Refresh display to remove comparison
                updateDisplay();
            }
        }
        
        /**
         * Populate month dropdown with last 12 months
         */
        function populateMonthDropdown() {
            const select = document.getElementById('compareMonth');
            if (!select) {
                console.error('compareMonth select not found');
                return;
            }
            
            select.innerHTML = ''; // Clear
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Generate last 12 months
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentYear, currentMonth - i, 1);
                const monthName = date.toLocaleString(currentLanguage || 'en', { month: 'long', year: 'numeric' });
                const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                const option = document.createElement('option');
                option.value = value;
                option.textContent = monthName;
                if (i === 0) option.selected = true; // Current month selected by default
                
                select.appendChild(option);
            }
            
            console.log('Month dropdown populated with', select.options.length, 'options');
        }
        
        /**
         * Load real spending data from transactions
         */
        async function loadRealSpending() {
            if (!firebase.functions || !currentUser) {
                console.log('Cannot load real spending: Firebase not initialized or user not logged in');
                return;
            }
            
            const monthKey = document.getElementById('compareMonth')?.value;
            if (!monthKey) return;
            
            const [year, month] = monthKey.split('-');
            
            // Calculate start and end dates for the month
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);
            
            try {
                const getTransactions = firebase.functions().httpsCallable('getTransactions');
                const result = await getTransactions({
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString(),
                    isLabeled: true, // Only labeled transactions
                    limit: 1000
                });
                
                const transactions = result.data.transactions || [];
                
                // Group by category and sum amounts
                realSpendingData = {};
                
                transactions.forEach(txn => {
                    if (txn.category && txn.category !== 'income') {
                        if (!realSpendingData[txn.category]) {
                            realSpendingData[txn.category] = 0;
                        }
                        // Prendre la valeur absolue (ignorer le signe n√©gatif)
                        // Et ignorer les montants positifs (remboursements/revenus)
                        if (txn.chargedAmount < 0) {
                            realSpendingData[txn.category] += Math.abs(txn.chargedAmount);
                        }
                    }
                });
                
                console.log('Real spending loaded:', realSpendingData);
                
                // Refresh display with comparison
                updateDisplay();
                
            } catch (error) {
                console.error('Error loading real spending:', error);
            }
        }
        
        /**
         * Get comparison info for a category
         */
        function getComparisonInfo(category, budget) {
            if (!compareMode || !realSpendingData[category]) {
                return null;
            }
            
            const real = realSpendingData[category];
            const diff = real - budget;
            const diffPercent = budget > 0 ? ((diff / budget) * 100).toFixed(0) : 0;
            
            let status = 'neutral';
            if (Math.abs(diffPercent) <= 10) {
                status = 'neutral'; // Within 10%
            } else if (diff > 0) {
                status = 'positive'; // Over budget (bad)
            } else {
                status = 'negative'; // Under budget (good)
            }
            
            return {
                real: real,
                budget: budget,
                diff: diff,
                diffPercent: diffPercent,
                status: status
            };
        }
        
        /**
         * Render comparison info HTML
         */
        function renderComparisonInfo(category, budget) {
            const info = getComparisonInfo(category, budget);
            if (!info) return '';
            
            const emoji = info.status === 'negative' ? 'üü¢' : info.status === 'positive' ? 'üî¥' : 'üü°';
            
            // Calculer le pourcentage utilis√©
            const usedPercent = budget > 0 ? Math.round((info.real / budget) * 100) : 0;
            
            // Message selon si over ou under budget
            let message;
            if (info.diff > 0) {
                // Over budget
                message = `Over by ${currency}${Math.abs(info.diff).toFixed(0)} (${usedPercent}% used)`;
            } else if (info.diff < 0) {
                // Under budget
                message = `Under by ${currency}${Math.abs(info.diff).toFixed(0)} (${usedPercent}% used)`;
            } else {
                // Exact
                message = `Exact match (100% used)`;
            }
            
            const progressPercent = Math.min((info.real / info.budget) * 100, 150);
            
            return `
                <div class="compare-info">
                    <div class="budget-label">Budget: ${currency}${info.budget.toFixed(0)}</div>
                    <div class="real-label">Real: ${currency}${info.real.toFixed(0)}</div>
                    <div class="diff ${info.status}">${message} ${emoji}</div>
                </div>
                <div class="compare-progress">
                    <div class="compare-progress-bar ${info.status === 'positive' ? 'over-budget' : info.status === 'negative' ? 'under-budget' : 'near-budget'}" 
                         style="width: ${progressPercent}%">
                    </div>
                </div>
            `;
        }









        

        function deleteExpenseItem(category, index) {
            if (!confirm('Delete this expense item?')) return;
            
            if (expenses[category] && expenses[category][index]) {
                expenses[category].splice(index, 1);
                
                // If category is now empty, ask if user wants to delete the whole category
                if (expenses[category].length === 0) {
                    if (confirm('This was the last item in this category. Delete the entire category?')) {
                        deleteCategory(category);
                        return; // NOUVEAU : Important pour arr√™ter l'ex√©cution ici
                    }
                }
                
                // S'il reste des items, sauvegarde simplement les changements
                saveUserData().then(() => {
                    updateDisplay();
                });
            }
        }

        function addNewCategory() {
            const categoryName = prompt('Enter category name:');
            if (!categoryName) return;
            
            const categoryKey = categoryName.toLowerCase().replace(/\s+/g, '_');
            
            if (expenses[categoryKey]) {
                alert('A category with this name already exists!');
                return;
            }
            
            const emoji = prompt('Enter emoji for this category (e.g., üéÆ):') || 'üìã';
            const itemName = prompt('Enter first expense item name:') || 'Item';
            
            // Create the new category with the first item
            expenses[categoryKey] = [{ name: itemName, amount: 0 }];
            categoryOrder.push(categoryKey);
            
            // Store metadata
            categoryMetadata[categoryKey] = {
                emoji: emoji,
                displayName: categoryName
            };
            
            // Generate the stats ID and expenses ID
            const statsId = `${categoryKey}Stats`;
            const expensesId = `${categoryKey}Expenses`;
            
            // Create the HTML structure
            const categorySection = document.createElement('div');
            categorySection.className = 'category-section';
            categorySection.id = `category-${categoryKey}`;
            categorySection.innerHTML = `
                <div class="category-title">
                    ${emoji} ${categoryName}
                    <button class="rename-btn" onclick="renameCategory('${categoryKey}')" style="display: ${isEditMode ? 'inline-block' : 'none'};">‚úèÔ∏è</button>
                </div>
                <div class="category-stats" id="${statsId}"></div>
                <div class="category-controls ${isEditMode ? 'show' : ''}">
                    <button class="category-btn" onclick="moveCategoryUp('${categoryKey}')">‚Üë Move Up</button>
                    <button class="category-btn" onclick="moveCategoryDown('${categoryKey}')">‚Üì Move Down</button>
                    <button class="category-btn" onclick="addItemToCategory('${categoryKey}')">‚ûï Add Item</button>
                    <button class="category-btn danger" onclick="deleteCategory('${categoryKey}')">üóëÔ∏è Delete Category</button>
                </div>
                <div id="${expensesId}"></div>
            `;
            
            // Add to the expenses list
            document.getElementById('expensesList').appendChild(categorySection);
            
            // IMPORTANT: Save to Firebase FIRST before calling updateDisplay
            // This ensures the data is persisted before any UI updates
            saveUserData().then(() => {
                // Now update the display which will populate the first item
                updateDisplay();
            }).catch(error => {
                console.error('Error saving new category:', error);
                alert('Error creating category. Please try again.');
            });
        }

        // ============================================
        // == D√âBUT DU CODE CORRIG√â ==
        // ============================================
        async function deleteCategory(categoryKey) {
            // Emp√™cher de supprimer les cat√©gories syst√®me
            const systemCategories = ['income', 'housing', 'tech', 'pet', 'subscriptions', 'groceries', 'other'];
            if (systemCategories.includes(categoryKey)) {
                alert('Cannot delete system categories. You can hide them in settings instead.');
                return;
            }
            
            const displayName = getCategoryDisplayName(categoryKey);
            const total = getCategoryStats(categoryKey).total;
            
            if (!confirm(`Delete category "${displayName}" (‚Ç™${total.toFixed(2)})?\n\nAll transactions labeled with this category will be unlabeled.`)) {
                return;
            }
            
            try {
                // Appeler la Cloud Function pour unlabel les transactions
                const deleteCategoryFunc = firebase.functions().httpsCallable('deleteCategory');
                const result = await deleteCategoryFunc({
                    categoryName: categoryKey
                });
                
                console.log(`Deleted category: ${result.data.message}`);
                
                // Supprimer localement
                delete expenses[categoryKey];
                delete categoryMetadata[categoryKey];
                
                // Retirer de l'ordre
                const index = categoryOrder.indexOf(categoryKey);
                if (index !== -1) {
                    categoryOrder.splice(index, 1);
                }
                
                // Sauvegarder dans Firebase
                await saveUserData();
                // Recharger depuis Firebase pour √™tre s√ªr
                await loadUserData();
                // Actualiser l'affichage
                updateDisplay();
                
                alert(`Category deleted! ${result.data.unlabeledCount} transaction(s) unlabeled.`);
                
            } catch (error) {
                console.error('Error deleting category:', error);
                alert('Error deleting category: ' + error.message);
            }
        }
        // ============================================
        // == FIN DU CODE CORRIG√â ==
        // ============================================

        function addItemToCategory(categoryKey) {
            const itemName = prompt('Enter new expense item name:');
            if (!itemName) return;
            
            if (!expenses[categoryKey]) {
                expenses[categoryKey] = [];
            }
            
            expenses[categoryKey].push({ name: itemName, amount: 0 });
            saveUserData();
            updateDisplay();
        }

        function moveCategoryUp(categoryKey) {
            const index = categoryOrder.indexOf(categoryKey);
            
            // Emp√™che de monter au-dessus de 'income' (qui est toujours en position 0)
            if (index > 1) { 
                // Swap in the order array
                [categoryOrder[index - 1], categoryOrder[index]] = [categoryOrder[index], categoryOrder[index - 1]];
                
                // Save to Firebase first
                saveUserData().then(() => {
                    // Then update the visual order
                    renderCategoriesInOrder();
                }).catch(error => {
                    console.error('Error moving category:', error);
                    alert('Error moving category. Please try again.');
                });
            } else if (index === 1) {
                // La cat√©gorie est juste apr√®s 'income' - on ne peut pas monter plus haut
                alert('This category is already at the top of the expenses list (after Income).');
            }
        }
        
        function moveCategoryDown(categoryKey) {
            const index = categoryOrder.indexOf(categoryKey);
        
            // Emp√™che 'income' de bouger
            if (categoryKey === 'income') {
                return;
            }
        
            if (index < categoryOrder.length - 1 && index !== -1) {
                // Swap in the order array
                [categoryOrder[index], categoryOrder[index + 1]] = [categoryOrder[index + 1], categoryOrder[index]];
                
                // Save to Firebase first
                saveUserData().then(() => {
                    // Then update the visual order
                    renderCategoriesInOrder();
                }).catch(error => {
                    console.error('Error moving category:', error);
                    alert('Error moving category. Please try again.');
                });
            }
        }

        function renderCategoriesInOrder() {
            const expensesList = document.getElementById('expensesList');
            
            // Log for debugging
            console.log('Rendering categories in order:', categoryOrder);
            console.log('Available categories in expenses:', Object.keys(expenses));
            
            // Create a document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Re-append categories in the correct order, but ONLY if they exist in expenses
            categoryOrder.forEach(categoryKey => {
                // Skip if category was deleted or doesn't exist
                if (!expenses[categoryKey]) {
                    console.log(`Skipping category ${categoryKey} - not in expenses`);
                    return;
                }
                
                const section = document.getElementById(`category-${categoryKey}`);
                if (section) {
                    // Remove from current position and add to fragment
                    section.parentNode.removeChild(section);
                    fragment.appendChild(section);
                    console.log(`Added category ${categoryKey} to fragment`);
                } else {
                    console.log(`Warning: Section not found for category ${categoryKey}`);
                }
            });
            
            // Append the fragment to the expenses list
            expensesList.appendChild(fragment);
            
            // Update the display to refresh stats
            updateDisplay();
        }

        // Clean Database Function - removes ghost categories
        function cleanDatabase() {
            let foundGhosts = false;
            const ghostCategories = [];
            
            // Check for categories that exist in data but not in DOM
            Object.keys(expenses).forEach(categoryKey => {
                const section = document.getElementById(`category-${categoryKey}`);
                if (!section) {
                    ghostCategories.push(categoryKey);
                    foundGhosts = true;
                }
            });
            
            if (foundGhosts) {
                const message = `Found ${ghostCategories.length} ghost categor${ghostCategories.length > 1 ? 'ies' : 'y'}: ${ghostCategories.join(', ')}\n\nDo you want to remove them?`;
                if (confirm(message)) {
                    // Remove ghost categories from expenses
                    ghostCategories.forEach(categoryKey => {
                        delete expenses[categoryKey];
                    });
                    
                    // Remove from categoryOrder
                    categoryOrder = categoryOrder.filter(c => !ghostCategories.includes(c));
                    
                    // Remove from categoryMetadata
                    ghostCategories.forEach(categoryKey => {
                        if (categoryMetadata[categoryKey]) {
                            delete categoryMetadata[categoryKey];
                        }
                    });
                    
                    // Save and update
                    saveUserData();
                    updateDisplay();
                    
                    alert(`Successfully removed ${ghostCategories.length} ghost categor${ghostCategories.length > 1 ? 'ies' : 'y'}!`);
                }
            } else {
                alert('No ghost categories found! Your database is clean. ‚úÖ');
            }
        }

        // Settings Functions
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const currencySelect = document.getElementById('currencySelect');
            const useIncomeCheckbox = document.getElementById('useIncomeCheckbox');
            const settingsUserEmail = document.getElementById('settingsUserEmail');
            const percentageModeSelect = document.getElementById('percentageModeSelect');
            const percentageModeSection = document.getElementById('percentageModeSection');
            
            // Set current values
            const currencyCode = Object.keys(currencyOptions).find(key => currencyOptions[key] === currency) || 'ILS';
            currencySelect.value = currencyCode;
            useIncomeCheckbox.checked = useIncome;
            percentageModeSelect.value = percentageMode;
            
            // Show/hide percentage mode section based on useIncome
            if (useIncome) {
                percentageModeSection.style.display = 'block';
            } else {
                percentageModeSection.style.display = 'none';
            }
            
            // Set user email
            if (currentUser) {
                settingsUserEmail.textContent = currentUser.email;
            }
            
            modal.classList.add('show');
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('show');
        }

        function updateCurrency(currencyCode) {
            currency = currencyOptions[currencyCode];
            saveUserData();
            updateDisplay();
        }

        function toggleIncomeFeature(enabled) {
            useIncome = enabled;
            
            // Show/hide percentage mode section
            const percentageModeSection = document.getElementById('percentageModeSection');
            if (percentageModeSection) {
                percentageModeSection.style.display = enabled ? 'block' : 'none';
            }
            
            saveUserData();
            updateDisplay();
        }


        /**
         * Clear all transactions
         */
        async function clearAllTransactions() {
            if (!currentUser) return;
            
            if (!confirm('Are you sure you want to delete ALL transactions? This cannot be undone!')) {
                return;
            }
            
            try {
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('transactions')
                    .get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                alert(`Deleted ${snapshot.size} transactions successfully`);
                
                // Reload if on transactions tab
                if (typeof loadTransactions === 'function') {
                    await loadTransactions();
                }
            } catch (error) {
                console.error('Error clearing transactions:', error);
                alert('Error: ' + error.message);
            }
        }


        function updatePercentageMode(mode) {
            percentageMode = mode;
            saveUserData();
            updateDisplay();
        }

        // Rename Functions
        async function renameCategory(categoryKey) {
            const currentDisplayName = getCategoryDisplayName(categoryKey);
            const newName = prompt(`Enter new name for "${currentDisplayName}":`, currentDisplayName);
            
            if (!newName || newName.trim() === '') return;
            if (newName.trim() === currentDisplayName) return;
            
            const newKey = newName.toLowerCase().replace(/\s+/g, '-');
            
            console.log('Renaming:', {
                oldKey: categoryKey,
                newKey: newKey,
                oldDisplayName: currentDisplayName,
                newDisplayName: newName
            });
            
            // V√©rifier les doublons
            if (expenses[newKey] && newKey !== categoryKey) {
                alert(`A category named "${newName}" already exists! Please choose a different name.`);
                return;
            }

            // Emp√™cher de renommer "income"
            if (categoryKey === 'income') {
                alert('Cannot rename the Income category.');
                return;
            }
            // Emp√™cher de renommer en cat√©gories syst√®me
            const systemCategories = ['income', 'housing', 'tech', 'pet', 'subscriptions', 'groceries', 'other'];
            if (systemCategories.includes(newKey) && newKey !== categoryKey) {
                alert(`Cannot use "${newName}" as it's a system category name.`);
                return;
            }
            
            try {
                // Appeler la Cloud Function pour mettre √† jour les transactions
                const renameCategoryFunc = firebase.functions().httpsCallable('renameCategory');
                const result = await renameCategoryFunc({
                    oldName: categoryKey,
                    newName: newKey
                });
                
                console.log(`Renamed category: ${result.data.message}`);
                
                // Cas 1 : Changement de cl√© (ex: "mina" ‚Üí "mina-the-poo")
                if (newKey !== categoryKey) {
                    // Copier les donn√©es
                    expenses[newKey] = expenses[categoryKey];
                    
                    // Copier les m√©tadonn√©es
                    if (!categoryMetadata[newKey]) {
                        categoryMetadata[newKey] = {};
                    }
                    
                    if (categoryMetadata[categoryKey]) {
                        Object.keys(categoryMetadata[categoryKey]).forEach(key => {
                            if (categoryMetadata[categoryKey][key] !== undefined) {
                                categoryMetadata[newKey][key] = categoryMetadata[categoryKey][key];
                            }
                        });
                    }
                    
                    // Ajouter le nouveau displayName
                    categoryMetadata[newKey].displayName = newName;
                    
                    // Supprimer l'ancien
                    delete expenses[categoryKey];
                    delete categoryMetadata[categoryKey];
                    
                    // Mettre √† jour l'ordre
                    const index = categoryOrder.indexOf(categoryKey);
                    if (index !== -1) {
                        categoryOrder[index] = newKey;
                    }
                } 
                // Cas 2 : Changement de displayName uniquement (ex: "Mina" ‚Üí "Mina the poo")
                else {
                    if (!categoryMetadata[categoryKey]) {
                        categoryMetadata[categoryKey] = {};
                    }
                    categoryMetadata[categoryKey].displayName = newName;
                }
                
                // Sauvegarder dans Firebase
                await saveUserData();
                // Recharger depuis Firebase pour √™tre s√ªr
                await loadUserData();
                // Actualiser l'affichage
                updateDisplay();
                
                alert(`Category renamed successfully! ${result.data.updatedCount} transaction(s) updated.`);
                
            } catch (error) {
                console.error('Error renaming category:', error);
                alert('Error renaming category: ' + error.message);
            }
        }

        function renameItem(category, index) {
            const newName = prompt('Enter new name for this item:', expenses[category][index].name);
            if (!newName) return;
            
            expenses[category][index].name = newName;
            saveUserData();
            updateDisplay();
        }

        // Item Movement Functions
        function moveItemUp(category, index) {
            if (index === 0) return; // Already at top
            
            const temp = expenses[category][index];
            expenses[category][index] = expenses[category][index - 1];
            expenses[category][index - 1] = temp;
            
            saveUserData();
            updateDisplay();
        }

        function moveItemDown(category, index) {
            if (index === expenses[category].length - 1) return; // Already at bottom
            
            const temp = expenses[category][index];
            expenses[category][index] = expenses[category][index + 1];
            expenses[category][index + 1] = temp;
            
            saveUserData();
            updateDisplay();
        }

        // Wait for Chart.js to load before initializing
        function initializeApp() {
            if (typeof Chart !== 'undefined') {
                // Set up chart type toggle buttons
                const toggleButtons = document.querySelectorAll('.chart-toggle-btn');
                toggleButtons.forEach(btn => {
                    // Set initial active state
                    if (btn.dataset.type === currentChartType) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                    
                    // Add click handler
                    btn.addEventListener('click', function() {
                        currentChartType = this.dataset.type;
                        saveUserData();
                        
                        // Update button states
                        toggleButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Redraw chart
                        updateChart();
                    });
                });
                
                // Close modal when clicking outside
                const modal = document.getElementById('colorEditorModal');
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeColorEditor();
                    }
                });
                
                const settingsModal = document.getElementById('settingsModal');
                settingsModal.addEventListener('click', function(e) {
                    if (e.target === settingsModal) {
                        closeSettings();
                    }
                });
                
                updateDisplay();
            } else {
                console.warn('Chart.js not loaded, waiting...');
                setTimeout(initializeApp, 100);
            }
        }

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

    </script>
    <script src="js/tabs-manager.js"></script>
    <script src="js/transactions-manager.js"></script>
</body>
</html>
