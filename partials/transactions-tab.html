<!-- Sticky Toolbar for Transactions with Integrated Filters -->
<div class="transactions-sticky-toolbar">
    <div class="toolbar-row">
        <button class="toolbar-btn" id="filtersToggleBtn" onclick="toggleFiltersRow()">
            <span data-translate="filters">Filters</span> <span id="filterToggleIcon">â–¼</span>
        </button>
        <button class="toolbar-btn" onclick="openBankAccountsModal()">
            <span data-translate="bankAccountsConfig">ğŸ¦ Bank Accounts</span>
        </button>
    </div>
    
    <!-- Filters Row (inside sticky toolbar, hidden by default) -->
    <div class="filters-row" id="filtersRow" style="display: none;">
        <!-- Label filter with radio buttons -->
        <div class="filter-radio-group" style="display: flex; gap: 12px; align-items: center;">
            <label class="filter-radio-label">
                <input type="radio" name="labelFilter" value="all" onchange="applyFilters()" checked>
                <span data-translate="showAll">All</span>
            </label>
            <label class="filter-radio-label">
                <input type="radio" name="labelFilter" value="unlabeled" onchange="applyFilters()">
                <span data-translate="showOnlyUnlabeled">Unlabeled only</span>
            </label>
            <label class="filter-radio-label">
                <input type="radio" name="labelFilter" value="labeled" onchange="applyFilters()">
                <span data-translate="showOnlyLabeled">Labeled only</span>
            </label>
        </div>
        
        <select id="monthFilter" onchange="applyFilters()" class="filter-select">
            <option value="" data-translate="allMonths">All months</option>
        </select>
        
        <!-- âœ… AJOUTE CE NOUVEAU SELECT -->
        <select id="sourceFilter" onchange="applyFilters()" class="filter-select">
            <option value="" data-translate="allSources">All sources</option>
            <option value="max">ğŸ¦ Max (Leumi)</option>
            <option value="isracard">ğŸ’³ Isracard</option>
            <!-- Les CSV seront ajoutÃ©s dynamiquement -->
        </select>
        
        <select id="categoryFilter" onchange="applyFilters()" class="filter-select">
            <option value="" data-translate="allCategories">All categories</option>
        </select>
        
        <input 
            type="text" 
            id="searchFilter" 
            data-translate-placeholder="search"
            placeholder="Search..." 
            oninput="applyFilters()"
            class="filter-search"
        />
        
        <button class="filter-clear-btn" onclick="clearFilters()">
            <span data-translate="clear">Clear</span>
        </button>
        <select id="sortFilter" onchange="changeSortOrder(this.value)" class="filter-select">
            <option value="date-desc" data-translate="sortDateNewest">ğŸ“… Date (newest)</option>
            <option value="date-asc" data-translate="sortDateOldest">ğŸ“… Date (oldest)</option>
            <option value="amount-desc" data-translate="sortAmountHighest">ğŸ’° Amount (highest)</option>
            <option value="amount-asc" data-translate="sortAmountLowest">ğŸ’° Amount (lowest)</option>
            <option value="frequency-desc" data-translate="sortFrequencyMost">ğŸ”„ Frequency (most)</option>
            <option value="frequency-asc" data-translate="sortFrequencyLeast">ğŸ”„ Frequency (least)</option>
        </select>
        
        <!-- âœ… AJOUTE CE NOUVEAU SELECT -->
        <select id="limitFilter" onchange="changeTransactionLimit(this.value)" class="filter-select">
            <option value="2000" data-translate="show2000">Show 2000</option>
            <option value="1000" data-translate="show1000">Show 1000</option>
            <option value="500" data-translate="show500">Show 500</option>
            <option value="50" data-translate="show50">Show 50</option>
        </select>
    </div>
</div>


<!-- All Transactions - Always visible -->
<div class="transactions-section" id="allTransactionsSection">
    <div class="section-title-trans" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
        <span><span data-translate="allTransactions">ğŸ“‹ All Transactions</span> (<span id="transactionCount">0</span>)</span>
        <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 12px; border-radius: 8px; font-weight: 600; white-space: nowrap; font-size: 0.9em;">
            ğŸ’° <span id="transactionTotal">â‚ª0</span>
        </span>
    </div>
    
    <!-- Loading state inside All Transactions -->
    <div id="transactionsLoading" style="display: none; text-align: center; padding: 40px;">
        <div class="spinner-trans"></div>
        <div style="margin-top: 15px; color: #6c757d;">
            <span data-translate="loadingTransactions">Loading transactions...</span>
        </div>
    </div>
    
    <!-- Transactions list -->
    <div id="allTransactionsList"></div>
    
    <!-- Empty state -->
    <div class="empty-state-trans" id="emptyState" style="display: none;">
        <div class="empty-state-icon">ğŸ“­</div>
        <div><span data-translate="noTransactionsYet">No transactions yet</span></div>
        <div style="margin-top: 10px; font-size: 0.9em;">
            <span data-translate="clickSyncToStart">Click "Sync All" to get started</span>
        </div>
    </div>
</div>

<!-- Credentials Modal (supports both Max and Isracard) -->
<div id="credentialsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="credentialsModalTitle"><span data-translate="bankCredentials">ğŸ” Bank Credentials</span></h2>
            <button class="modal-close" onclick="closeCredentialsModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <div class="alert-trans alert-info-trans">
                <span data-translate="credentialsSecure">Your credentials will be encrypted and stored securely in Firebase.</span>
            </div>
            <form id="credentialsForm" onsubmit="saveCredentials(event)">
                <input type="hidden" id="bankType" value="max" />
                
                <!-- Max fields (visible par dÃ©faut) -->
                <div id="maxFields">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="username">Username</span>
                        </label>
                        <input 
                            type="text" 
                            class="auth-input" 
                            id="maxUsername" 
                            data-translate-placeholder="yourUsername"
                            placeholder="Your username"
                        />
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="password">Password</span>
                        </label>
                        <input 
                            type="password" 
                            class="auth-input" 
                            id="maxPassword" 
                            data-translate-placeholder="yourPassword"
                            placeholder="Your password"
                        />
                    </div>
                </div>
                
                <!-- Isracard fields (cachÃ©s par dÃ©faut) -->
                <div id="isracardFields" style="display: none;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="idNumber">ID Number</span>
                        </label>
                        <input 
                            type="text" 
                            class="auth-input" 
                            id="isracardId" 
                            data-translate-placeholder="yourIsraeliId"
                            placeholder="Your Israeli ID"
                        />
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="cardLast6">Last 6 Digits of Card</span>
                        </label>
                        <input 
                            type="text" 
                            class="auth-input" 
                            id="isracardCard6" 
                            placeholder="123456"
                            maxlength="6"
                            pattern="[0-9]{6}"
                        />
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="password">Password</span>
                        </label>
                        <input 
                            type="password" 
                            class="auth-input" 
                            id="isracardPassword" 
                            data-translate-placeholder="yourPassword"
                            placeholder="Your password"
                        />
                    </div>
                </div>
                
                <div id="credentialsError"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="modal-button secondary" onclick="closeCredentialsModal()">
                <span data-translate="cancel">Cancel</span>
            </button>
            <button type="submit" form="credentialsForm" class="modal-button primary" id="saveCredentialsBtn">
                <span data-translate="saveCredentials">Save Credentials</span>
            </button>
        </div>
    </div>
</div>


<!-- Bank Accounts Modal -->
<div id="bankAccountsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ğŸ¦ <span data-translate="bankAccountsConfig">Bank Accounts</span></h2>
            <button class="modal-close" onclick="closeBankAccountsModal()">âœ•</button>
        </div>
        <div class="modal-body">
            <!-- Max.co.il Credentials -->
            <div class="bank-section">
                <h4><span data-translate="maxLeumi">ğŸ’³ Max.co.il (Leumi Card)</span></h4>
                <div class="alert-trans alert-info-trans" id="maxCredentialsAlertModal">
                    <span data-translate="configureCredentials">Configure your Max credentials to sync transactions.</span>
                </div>
                <button class="btn btn-primary" onclick="openCredentialsModal('max')">
                    <span data-translate="setupMaxCredentials">ğŸ” Setup Max Credentials</span>
                </button>
            </div>
            
            <!-- Isracard Credentials -->
            <div class="bank-section">
                <h4><span data-translate="isracard">ğŸ’³ Isracard</span></h4>
                <div class="alert-trans alert-info-trans" id="isracardCredentialsAlertModal">
                    <span data-translate="configureCredentials">Configure your Isracard credentials to sync transactions.</span>
                </div>
                <button class="btn btn-primary" onclick="openCredentialsModal('isracard')">
                    <span data-translate="setupIsracardCredentials">ğŸ” Setup Isracard Credentials</span>
                </button>
            </div>
            
            <!-- Sync Section -->
            <div class="bank-section">
                <h4><span data-translate="syncTransactions">ğŸ”„ Sync Transactions</span></h4>
                <div class="sync-status">
                    <div class="sync-info">
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <div>Max: <strong id="lastMaxSyncTimeModal" data-translate="never">Never</strong> <span id="lastMaxSyncCountModal"></span></div>
                            <div>Isracard: <strong id="lastIsracardSyncTimeModal" data-translate="never">Never</strong> <span id="lastIsracardSyncCountModal"></span></div>
                        </div>
                    </div>
                    <div class="sync-buttons">
                        <button class="btn btn-primary" onclick="syncAllTransactions()" id="syncAllBtnModal">
                            <span data-translate="syncAll">ğŸ”„ Sync All</span>
                        </button>
                        <button class="btn btn-success" onclick="autoLabelAll()" id="autoLabelBtnModal">
                            <span data-translate="autoLabel">ğŸ·ï¸ Auto-label</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- CSV Import Section -->
            <div class="bank-section">
                <h4>ğŸ“¥ <span data-translate="importCSV">Import CSV</span></h4>
                <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">
                    <span data-translate="importCSVDescription">Import transactions from CSV files (Revolut, N26, etc.)</span>
                </p>
                
                <!-- Bank name input -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em;">
                        <span data-translate="bankName">Bank Name</span>
                    </label>
                    <input 
                        type="text" 
                        id="csvBankName" 
                        class="auth-input" 
                        placeholder="e.g. Revolut, N26, Wise..."
                        list="bankSuggestions"
                        style="width: 100%;"
                    />
                    <datalist id="bankSuggestions">
                        <option value="Revolut">
                        <option value="N26">
                        <option value="Wise">
                        <option value="Monzo">
                        <option value="Starling">
                        <option value="Bunq">
                    </datalist>
                    <p style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                        <span data-translate="bankNameHelp">This helps you identify transactions from different banks</span>
                    </p>
                </div>
                
                <input type="file" id="csvFileInput" class="csv-file-input" accept=".csv" onchange="handleCSVUpload(event)" />
                <button class="csv-import-btn" onclick="triggerCSVUpload()">
                    ğŸ“¥ <span data-translate="chooseCSV">Choose CSV File</span>
                </button>
                
                <!-- Liste des CSV importÃ©s -->
                <div class="csv-list" id="csvList">
                    <!-- Les CSV importÃ©s apparaÃ®tront ici -->
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-button primary" onclick="closeBankAccountsModal()">
                <span data-translate="done">Done</span>
            </button>
        </div>
    </div>
</div>


<!-- Scroll to Top Button (APRÃˆS la modal) -->
<button class="scroll-to-top" id="scrollToTopBtn" onclick="scrollToTop()" title="Back to top">
    â†‘
</button>

<!-- Toast Notifications Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- âœ… AJOUTE ICI : Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="loading-overlay-content">
        <div class="loading-overlay-spinner"></div>
        <div class="loading-overlay-text" id="loadingOverlayText">Processing...</div>
        <div class="loading-overlay-subtext" id="loadingOverlaySubtext">Please wait</div>
    </div>
</div>
