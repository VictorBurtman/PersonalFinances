<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">


    <title>Monthly Expenses Tracker</title>
    <!-- ‚úÖ PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#ffffff">
    <meta name="theme-color" content="#1e1e2e" media="(prefers-color-scheme: dark)">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Finances">
    
    <!-- Icons pour iOS -->
    <link rel="apple-touch-icon" href="/icon-192.png">

    <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="translations.js"></script>
    <link rel="stylesheet" href="css/auth-screen.css">
    <script src="js/auth-manager.js"></script>
    <!-- ‚úÖ AJOUTE CES LIGNES ICI -->
    <script>
        // Instancier authManager globalement
        const authManager = new AuthManager();
        window.authManager = authManager;
    </script>


    <script>
    // ‚úÖ APP VERSION - Facile √† modifier
    const APP_VERSION = '0.0.1';
    </script>

    <style>
        /* ============================================
        RESET & BASE STYLES (Non g√©r√© par tabs.css)
        ============================================ */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            color: #333;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: -1;
        }
        
        /* ============================================
        DARK MODE GLOBAL
        ============================================ */
        
        body.dark-mode {
            color: #e0e0e0;
        }
        
        body.dark-mode::before {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }

        /* ‚úÖ Safe area Android - uniquement sur mobile natif */
        @supports (padding-top: env(safe-area-inset-top)) {
            .edit-mode-controls {
                padding-top: calc(10px + env(safe-area-inset-top));
            }
            
            .dashboard {
                padding-top: calc(80px + env(safe-area-inset-top));
                padding-bottom: calc(20px + env(safe-area-inset-bottom));
            }
            
            .footer-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }

        }

        /* ‚úÖ Android sp√©cifique - padding suppl√©mentaire si besoin */
        body.platform-android .dashboard {
            padding-top: 60px;
            padding-bottom: 20px;
        }

        body.platform-android .edit-mode-controls {
            padding-top: 12px;
        }

    </style>


    <link rel="stylesheet" href="css/tabs.css">
</head>
<body>
    <!-- ‚úÖ AUTO-UPDATE SYSTEM - Doit √™tre le premier script -->
    <script>
        (async function checkForUpdates() {
            const CURRENT_VERSION_KEY = 'app_version';
            const VERSION_CHECK_URL = '/version.json';
            
            try {
                // R√©cup√©rer la version locale
                const localVersion = localStorage.getItem(CURRENT_VERSION_KEY);
                console.log('üì± Version locale:', localVersion || 'Aucune');
                
                // Fetch la version serveur (bypass TOUS les caches)
                const response = await fetch(VERSION_CHECK_URL, {
                    method: 'GET',
                    cache: 'no-store',
                    headers: {
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    return;
                }
                
                const versionData = await response.json();
                const serverVersion = versionData.version;
                console.log('‚òÅÔ∏è Version serveur:', serverVersion);
                
                // Premi√®re installation (pas de version locale)
                if (!localVersion) {
                    console.log('üÜï Premi√®re installation, enregistrement de la version');
                    localStorage.setItem(CURRENT_VERSION_KEY, serverVersion);
                    window.APP_VERSION = serverVersion;
                    updateVersionDisplay();
                    return;
                }
                
                // Comparer les versions
                if (localVersion !== serverVersion) {
                    console.log('üîÑ Nouvelle version d√©tect√©e!');
                    console.log('üì¶ Mise √† jour:', localVersion, '‚Üí', serverVersion);
                    
                    // ‚úÖ R√©cup√©rer la langue depuis localStorage
                    const userLang = localStorage.getItem('language') || 'en';
                    
                    // ‚úÖ Mini dictionnaire de traductions pour le message
                    const updateMessages = {
                        en: { title: 'Update available', subtitle: 'Installing update...' },
                        fr: { title: 'Mise √† jour disponible', subtitle: 'Installation en cours...' },
                        he: { title: '◊¢◊ì◊õ◊ï◊ü ◊ñ◊û◊ô◊ü', subtitle: '◊û◊™◊ß◊ô◊ü ◊¢◊ì◊õ◊ï◊ü...' },
                        es: { title: 'Actualizaci√≥n disponible', subtitle: 'Instalando actualizaci√≥n...' },
                        ru: { title: '–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ', subtitle: '–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...' },
                        ar: { title: 'ÿ™ÿ≠ÿØŸäÿ´ ŸÖÿ™ÿßÿ≠', subtitle: 'ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ´ÿ®Ÿäÿ™...' }
                    };
                    
                    const msg = updateMessages[userLang] || updateMessages['en'];
                    
                    // Afficher un message temporaire (traduit)
                    const updateMsg = document.createElement('div');
                    updateMsg.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 20px 30px;
                        border-radius: 12px;
                        font-size: 1.1em;
                        font-weight: 600;
                        z-index: 999999;
                        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                        text-align: center;
                    `;
                    updateMsg.innerHTML = `
                        üîÑ ${msg.title}<br>
                        <span style="font-size: 0.9em; opacity: 0.9;">${msg.subtitle}</span>
                    `;
                    document.body.appendChild(updateMsg);
                    
                    // Attendre un peu pour que l'utilisateur voit le message
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    
                    try {
                        // 1. Vider tous les caches
                        
                        // Cache API
                        if ('caches' in window) {
                            const cacheNames = await caches.keys();
                            await Promise.all(
                                cacheNames.map(cacheName => caches.delete(cacheName))
                            );
                        }
                        
                        // Service Worker
                        if ('serviceWorker' in navigator) {
                            const registrations = await navigator.serviceWorker.getRegistrations();
                            await Promise.all(
                                registrations.map(registration => registration.unregister())
                            );
                        }
                        
                        // 2. Mettre √† jour la version locale
                        localStorage.setItem(CURRENT_VERSION_KEY, serverVersion);
                        console.log('‚úÖ Version mise √† jour dans localStorage');
                        
                        // 3. Recharger l'application
                        window.location.reload(true);
                        
                    } catch (error) {
                        console.error('‚ùå Erreur lors du nettoyage des caches:', error);
                        window.location.reload(true);
                    }
                } else {
                    console.log('‚úÖ Application √† jour (v' + serverVersion + ')');
                    window.APP_VERSION = serverVersion;
                    updateVersionDisplay();
                }
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Erreur lors de la v√©rification des mises √† jour:', error);
                
                // Si erreur, utiliser la version locale
                const localVersion = localStorage.getItem(CURRENT_VERSION_KEY);
                if (localVersion) {
                    window.APP_VERSION = localVersion;
                    updateVersionDisplay();
                }
            }
            
            // Fonction pour mettre √† jour l'affichage de la version
            function updateVersionDisplay() {
                const appVersionDisplay = document.getElementById('appVersionDisplay');
                if (appVersionDisplay && window.APP_VERSION) {
                    appVersionDisplay.textContent = 'v' + window.APP_VERSION;
                }
            }
        })();
        
        // Mettre √† jour la version quand le DOM est pr√™t
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                const appVersionDisplay = document.getElementById('appVersionDisplay');
                if (appVersionDisplay && window.APP_VERSION) {
                    appVersionDisplay.textContent = 'v' + window.APP_VERSION;
                }
            });
        }
    </script>

    
    <!-- ========== D√âBUT DE L'√âCRAN DE CONNEXION ========== -->
    <!-- Auth Screen -->
    <div id="auth-screen" style="display: block;">
        <!-- Language Selector -->
        <div class="language-selector">
            <button onclick="authManager.applyLanguage('en'); updateLanguageButtons('en')" data-lang="en">EN</button>
            <button onclick="authManager.applyLanguage('fr'); updateLanguageButtons('fr')" data-lang="fr">FR</button>
            <button onclick="authManager.applyLanguage('he'); updateLanguageButtons('he')" data-lang="he">◊¢◊ë</button>
            <button onclick="authManager.applyLanguage('es'); updateLanguageButtons('es')" data-lang="es">ES</button>
            <button onclick="authManager.applyLanguage('ru'); updateLanguageButtons('ru')" data-lang="ru">–†–£</button>
            <button onclick="authManager.applyLanguage('ar'); updateLanguageButtons('ar')" data-lang="ar">ÿπÿ±</button>
        </div>
        
        <div class="auth-container">
            <h2>Wise Budget</h2>
            
            <!-- Error message container -->
            <div id="authError" class="auth-error" style="display: none;"></div>
            
            <div class="auth-form">
                <input type="email" 
                    id="email" 
                    placeholder="Email" 
                    data-translate-placeholder="email"
                    autocomplete="email">
                
                <div style="position: relative; width: 100%;">
                    <input type="password" 
                        id="password" 
                        placeholder="Password (min 6 characters)" 
                        data-translate-placeholder="password"
                        autocomplete="current-password"
                        style="width: 100%; padding-right: 45px;">
                    <button type="button" id="togglePassword" 
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px; padding: 0;">
                        üëÅÔ∏è
                    </button>
                </div>
                
                <!-- ‚úÖ AJOUTE CE LIEN -->
                <div style="text-align: right; margin-top: -5px; margin-bottom: 10px;">
                    <a id="forgotPasswordLink" 
                    onclick="authManager.showForgotPasswordDialog()" 
                    style="font-size: 13px; color: var(--auth-link); cursor: pointer; text-decoration: none;"
                    data-translate="forgotPassword">
                        Forgot password?
                    </a>
                </div>

                <!-- Remember Me Checkbox -->
                <div class="remember-me-container">
                    <label for="rememberMe">
                        <input type="checkbox" id="rememberMe">
                        <span data-translate="rememberMe">Remember me</span>
                    </label>
                </div>
                
                <div class="auth-buttons">
                    <button id="signInBtn" 
                            onclick="handleSignIn()" 
                            data-translate="signIn">Sign In</button>
                    <button id="signUpBtn" 
                            onclick="handleSignUp()" 
                            data-translate="signUp">Sign Up</button>
                </div>
            </div>
            
            <div class="auth-switch">
                <span data-translate="noAccount">Don't have an account?</span>
                <a onclick="toggleAuthMode()" data-translate="signUp">Sign Up</a>
            </div>
        </div>
    </div>
    <!-- ========== FIN DE L'√âCRAN DE CONNEXION ========== -->

    <div id="appScreen">
        <div class="container">
            <!-- ‚úÖ HEADER STICKY UNIFI√â -->
            <div class="edit-mode-controls">
                <div class="header-title">Wise Budget</div>

                <div class="header-right-actions">
                    
                    <button class="edit-mode-btn budget-only icon-btn" id="editModeBtn" onclick="toggleEditMode()" title="Edit">
                        <img src="img/icons/pen.svg" alt="Edit">
                    </button>
                    
                    <button class="edit-mode-btn budget-only icon-btn" id="addCategoryBtn" onclick="addNewCategory()" title="Add">
                        <img src="img/icons/add.svg" alt="Add">
                    </button>
                    
                    <select id="compareMonth" class="budget-only" onchange="loadRealSpending()" style="display: inline-block;">
                    </select>
                    
                    <button id="filtersBtn" class="edit-mode-btn transactions-only icon-btn" onclick="openFiltersModal()" style="display: none;" title="Filters">
                        <img src="img/icons/loupe.svg" alt="Filters">
                    </button>
                    
                    <button class="edit-mode-btn transactions-only icon-btn" onclick="openBankAccountsModal()" style="display: none;" title="Import">
                        <img src="img/icons/import.svg" alt="Import">
                    </button>
                    
                    <button class="edit-mode-btn transactions-only icon-btn" onclick="openExcludedTransactionsModal()" style="display: none;" title="Excluded">
                        <img src="img/icons/exclude.svg" alt="Excluded">
                    </button>
                    
                </div>
            </div>
            
            <div class="dashboard">
                <!-- ========================================
                    ONGLET BUDGET
                    ======================================== -->
                <div id="budgetTab" class="tab-content active">
                    <div class="total-section">
                        
                        <div class="budget-mode-toggle">
                            <div class="toggle-wrapper">
                                <label class="toggle-label" data-translate="estimated">Estim√©</label>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="budgetModeToggle" onchange="toggleBudgetMode()">
                                    <span class="toggle-slider"></span>
                                </label>
                                <label class="toggle-label" data-translate="spent">D√©pens√©</label>
                            </div>
                        </div>
                        <div id="incomeDisplay" style="display: none; margin-bottom: 15px; opacity: 0.9;">
                            <h3 style="font-size: 1em; margin-bottom: 5px;" data-translate="totalIncome">Total Income</h3>
                            <div style="font-size: 1.8em; font-weight: 600;" id="totalIncome">‚Ç™0</div>
                        </div>
                        <h2 data-translate="totalExpenses">Total Monthly Expenses</h2>
                        <div class="total-amount" id="totalAmount">‚Ç™0</div>
                        <div id="remainingDisplay" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.3);">
                            <h3 style="font-size: 1em; margin-bottom: 5px;" data-translate="remaining">Remaining</h3>
                            <div style="font-size: 2em; font-weight: 700;" id="remainingAmount">‚Ç™0</div>
                            <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;" id="remainingPercentage"></div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <!-- Indicateur de graphique + bouton couleurs -->
                        <div class="chart-header">
                            <div class="chart-indicators">
                                <span class="chart-dot active" data-chart="doughnut"></span>
                                <span class="chart-dot" data-chart="bar"></span>
                            </div>
                            <button class="color-btn-mini" onclick="openColorEditor()" title="Customize colors">
                                üé®
                            </button>
                        </div>
                        
                        <!-- Conteneur du graphique (swipeable) -->
                        <div class="chart-container-wrapper" id="chartWrapper">
                            <div class="chart-container">
                                <canvas id="myChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Graphique des d√©penses mensuelles -->
                    <div class="chart-section">
                        <div class="chart-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <h3 style="font-size: 1em; color: #667eea; font-weight: 600; margin: 0;" data-translate="monthlySpendingTrend">Monthly Spending Trend</h3>
                            
                            <!-- Dropdown s√©lecteur de cat√©gories -->
                            <div style="position: relative;">
                                <button id="trendCategoriesBtn" class="trend-categories-btn" onclick="toggleTrendCategoriesDropdown()">
                                    <span data-translate="selectCategories">Select Categories</span>
                                    <span id="trendCategoriesCount" class="trend-count-badge">1</span>
                                    <span style="font-size: 0.7em;">‚ñº</span>
                                </button>
                                
                                <!-- Dropdown menu -->
                                <div id="trendCategoriesDropdown" class="trend-dropdown" style="display: none;">
                                    <div class="trend-dropdown-content">
                                        <label class="trend-checkbox-label">
                                            <input type="checkbox" id="totalTrendCheckbox" checked onchange="updateMonthlyTrendSelection()">
                                            <span style="font-weight: 600;" data-translate="total">Total</span>
                                        </label>
                                        <div class="trend-divider"></div>
                                        <div id="categoryTrendCheckboxes"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="monthlyTrendChart"></canvas>
                        </div>
                    </div>

                    <div class="expenses-list" id="expensesList">
                        <!-- Income Category -->
                        <div class="category-section income-category" id="category-income" style="display: none;">
                            
                            <div class="category-title" style="color: #28a745; border-color: #28a745; display: flex; align-items: center; gap: 10px;">
                                <img src="img/icons/income.svg" alt="Income" class="category-icon income-icon">
                                <span data-translate="income">Income</span>
                            </div>

                            <div class="category-stats" id="incomeStats" style="color: #28a745;"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="addItemToCategory('income')">‚ûï Add Item</button>
                            </div>
                            <div id="incomeExpenses"></div>
                        </div>
                    
                        <!-- Housing Category -->
                        <div class="category-section" id="category-housing">
                            <div class="category-title">
                                üè† Housing
                            </div>
                            <div class="category-stats" id="housingStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('housing')">
                                    <span data-translate="moveUp">‚Üë Move Up</span>
                                </button>
                                <button class="category-btn" onclick="moveCategoryDown('housing')">
                                    <span data-translate="moveDown">‚Üì Move Down</span>
                                </button>
                                <button class="category-btn" onclick="addItemToCategory('housing')">
                                    <span data-translate="addItem">‚ûï Add Item</span>
                                </button>
                                <button class="category-btn danger" onclick="deleteCategory('housing')">
                                    <img src="img/icons/trash.svg" alt="Delete" class="category-delete-icon">
                                    <span data-translate="deleteCategory">Delete Category</span>
                                </button>
                            </div>
                            <div id="housingExpenses"></div>
                        </div>
                    
                        <!-- Subscriptions Category -->
                        <div class="category-section" id="category-subscriptions">
                            <div class="category-title">
                                üé¨ Subscriptions
                            </div>
                            <div class="category-stats" id="subscriptionsStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('subscriptions')">
                                    <span data-translate="moveUp">‚Üë Move Up</span>
                                </button>
                                <button class="category-btn" onclick="moveCategoryDown('subscriptions')">
                                    <span data-translate="moveDown">‚Üì Move Down</span>
                                </button>
                                <button class="category-btn" onclick="addItemToCategory('subscriptions')">
                                    <span data-translate="addItem">‚ûï Add Item</span>
                                </button>
                                <button class="category-btn danger" onclick="deleteCategory('subscriptions')">
                                    <img src="img/icons/trash.svg" alt="Delete" class="category-delete-icon">
                                    <span data-translate="deleteCategory">Delete Category</span>
                                </button>
                            </div>
                            <div id="subscriptionsExpenses"></div>
                        </div>
                    
                        <!-- Groceries Category -->
                        <div class="category-section" id="category-groceries">
                            <div class="category-title">
                                üõí Groceries
                            </div>
                            <div class="category-stats" id="groceriesStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('groceries')">
                                    <span data-translate="moveUp">‚Üë Move Up</span>
                                </button>
                                <button class="category-btn" onclick="moveCategoryDown('groceries')">
                                    <span data-translate="moveDown">‚Üì Move Down</span>
                                </button>
                                <button class="category-btn" onclick="addItemToCategory('groceries')">
                                    <span data-translate="addItem">‚ûï Add Item</span>
                                </button>
                                <button class="category-btn danger" onclick="deleteCategory('groceries')">
                                    <img src="img/icons/trash.svg" alt="Delete" class="category-delete-icon">
                                    <span data-translate="deleteCategory">Delete Category</span>
                                </button>
                            </div>
                            <div id="groceriesExpenses"></div>
                        </div>
                    
                        <!-- Pet Care Category -->
                        <div class="category-section" id="category-pet">
                            <div class="category-title">
                                üê± Pet Care
                            </div>
                            <div class="category-stats" id="petStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('pet')">
                                    <span data-translate="moveUp">‚Üë Move Up</span>
                                </button>
                                <button class="category-btn" onclick="moveCategoryDown('pet')">
                                    <span data-translate="moveDown">‚Üì Move Down</span>
                                </button>
                                <button class="category-btn" onclick="addItemToCategory('pet')">
                                    <span data-translate="addItem">‚ûï Add Item</span>
                                </button>
                                <button class="category-btn danger" onclick="deleteCategory('pet')">
                                    <img src="img/icons/trash.svg" alt="Delete" class="category-delete-icon">
                                    <span data-translate="deleteCategory">Delete Category</span>
                                </button>
                            </div>
                            <div id="petExpenses"></div>
                        </div>
                    
                        <!-- Hobbies Category (NEW) -->
                        <div class="category-section" id="category-hobbies">
                            <div class="category-title">
                                üéÆ Hobbies
                            </div>
                            <div class="category-stats" id="hobbiesStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('hobbies')">
                                    <span data-translate="moveUp">‚Üë Move Up</span>
                                </button>
                                <button class="category-btn" onclick="moveCategoryDown('hobbies')">
                                    <span data-translate="moveDown">‚Üì Move Down</span>
                                </button>
                                <button class="category-btn" onclick="addItemToCategory('hobbies')">
                                    <span data-translate="addItem">‚ûï Add Item</span>
                                </button>
                                <button class="category-btn danger" onclick="deleteCategory('hobbies')">
                                    <img src="img/icons/trash.svg" alt="Delete" class="category-delete-icon">
                                    <span data-translate="deleteCategory">Delete Category</span>
                                </button>
                            </div>
                            <div id="hobbiesExpenses"></div>
                        </div>
                    
                        <!-- Other Expenses Category -->
                        <div class="category-section" id="category-other">
                            <div class="category-title">
                                üí∏ Other Expenses
                            </div>
                            <div class="category-stats" id="otherStats"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('other')">
                                    <span data-translate="moveUp">‚Üë Move Up</span>
                                </button>
                                <button class="category-btn" onclick="moveCategoryDown('other')">
                                    <span data-translate="moveDown">‚Üì Move Down</span>
                                </button>
                                <button class="category-btn" onclick="addItemToCategory('other')">
                                    <span data-translate="addItem">‚ûï Add Item</span>
                                </button>
                                <button class="category-btn danger" onclick="deleteCategory('other')">
                                    <img src="img/icons/trash.svg" alt="Delete" class="category-delete-icon">
                                    <span data-translate="deleteCategory">Delete Category</span>
                                </button>
                            </div>
                            <div id="otherExpenses"></div>
                        </div>
                    </div>

                    <button id="resetBtn" class="reset-button" onclick="resetExpenses()">
                        <span data-translate="resetAll">Reset All Expenses</span>
                    </button>
                </div>
                <!-- FIN DE L'ONGLET BUDGET -->

                <!-- ========================================
                    ONGLET TRANSACTIONS
                    ======================================== -->
                <div id="transactionsTab" class="tab-content">

                    <!-- All Transactions - Always visible -->
                    <div class="transactions-section" id="allTransactionsSection">
                        <div class="section-title-trans" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                            <span><span data-translate="allTransactions">üìã All Transactions</span> (<span id="transactionCount">0</span>)</span>
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 6px 12px; border-radius: 8px; font-weight: 600; white-space: nowrap; font-size: 0.9em;">
                                üí∞ <span id="transactionTotal">‚Ç™0</span>
                            </span>
                        </div>
                        
                        <!-- Loading state inside All Transactions -->
                        <div id="transactionsLoading" style="display: none; text-align: center; padding: 40px;">
                            <div class="spinner-trans"></div>
                            <div style="margin-top: 15px; color: #6c757d;">
                                <span data-translate="loadingTransactions">Loading transactions...</span>
                            </div>
                        </div>


                        <!-- Bulk select buttons -->
                        <div id="bulkSelectButtons" style="display: none; padding: 6px; background: var(--block-bg, #f8f9fa); border-radius: 6px; margin-bottom: 8px; gap: 6px; justify-content: center;">
                            <button 
                                onclick="selectAllTransactions()"
                                style="padding: 3px 8px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em; font-weight: 500; line-height: 1.2;"
                            >
                                ‚úì <span data-translate="selectAll">Select All</span>
                            </button>
                            <button 
                                onclick="deselectAllTransactions()"
                                style="padding: 3px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em; font-weight: 500; line-height: 1.2;"
                            >
                                ‚úó <span data-translate="deselectAll">Deselect All</span>
                            </button>
                        </div>
                        
                        <!-- Transactions list -->
                         <!-- ‚úÖ Loader pour le rendu des transactions -->
                        <div id="transactionsRenderLoader" style="display: none; text-align: center; padding: 40px;">
                            <img src="img/anims/Interwind@1x-1.0s-200px-200px.svg" 
                                alt="Loading" 
                                style="width: 60px; height: 60px; opacity: 0.6;">
                        </div>
                        <div id="allTransactionsList"></div>
                    </div>

                    <!-- ‚úÖ D√âPLAC√â ICI : Empty state HORS de la section -->
                    <div class="empty-state-trans" id="emptyState" style="display: none;">
                        <div class="empty-state-icon">üì≠</div>
                        <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px;">
                            <span data-translate="noTransactionsAdded">No transactions added yet</span>
                        </div>
                        <div style="font-size: 0.9em; opacity: 0.8;">
                            <span data-translate="addTransactionToStart">Add a transaction to get started</span>
                        </div>
                    </div>

                </div>
                <!-- FIN DE L'ONGLET TRANSACTIONS -->

            </div>
            <!-- FIN DE DASHBOARD -->
            <div class="footer-spacer"></div>

        </div> <!-- Fin container -->
    
        <!-- ============================================
            FOOTER NAVIGATION
            ============================================ -->
        <div class="app-footer">
            <!-- Budget Tab -->
            <button class="footer-nav-btn active" id="budgetTabBtn" onclick="switchTab('budget')">
                <img src="img/icons/budget_inactive.svg" alt="Budget" class="footer-nav-icon">
                <span class="footer-nav-label" data-translate="budgetTab">Budget</span>
            </button>
            
            <!-- Transactions Tab -->
            <button class="footer-nav-btn" id="transactionsTabBtn" onclick="switchTab('transactions')">
                <img src="img/icons/transactions-inactive.svg" alt="Transactions" class="footer-nav-icon">
                <span class="footer-nav-label" data-translate="transactionsTab">Transactions</span>
            </button>
            
            <!-- Settings Button -->
            <button class="footer-nav-btn" id="settingsTabBtn" onclick="openSettings()">
                <img src="img/icons/settings_inactive.svg" alt="Settings" class="footer-nav-icon-static">
                <span class="footer-nav-label" data-translate="settings">Settings</span>
            </button>
        </div>
        </div> <!-- Fin appScreen -->

    <!-- Modal Color Editor -->
    <div id="colorEditorModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 data-translate="customizeColors">Customize Colors</h3>
                <button class="modal-close" onclick="closeColorEditor()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Toggle entre vue Simple et Avanc√©e -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <button id="randomColorsBtn" class="secondary-btn" onclick="randomizeAllColors()">
                        üé≤ <span data-translate="randomColors">Random Colors</span>
                    </button>
                    <button id="toggleAdvancedBtn" class="secondary-btn" onclick="toggleAdvancedView()">
                        <span id="advancedBtnText" data-translate="advanced">Advanced</span> ‚Üí
                    </button>
                </div>
                
                <!-- Vue Simple : Cat√©gories uniquement -->
                <div id="categoryColorsView">
                    <h4 style="margin-bottom: 15px;" data-translate="categoryColors">Category Colors</h4>
                    <div id="categoryColorsList"></div>
                </div>
                 
                <!-- Vue Avanc√©e : Items d√©taill√©s -->
                <div id="itemColorsView" style="display: none;">
                    <button class="secondary-btn" onclick="toggleAdvancedView()" style="margin-bottom: 15px;">
                        ‚Üê <span data-translate="backToCategories">Back to Categories</span>
                    </button>
                    <h4 style="margin-bottom: 15px;" data-translate="itemColors">Item Colors</h4>
                    <div id="itemColorsList"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="primary-btn" onclick="saveColors()" data-translate="save">Save</button>
                <button class="secondary-btn" onclick="closeColorEditor()" data-translate="cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div id="emojiPickerModal" class="modal" style="display: none;">
        <div class="modal-content emoji-picker-content">
            <div class="modal-header">
                <h2 data-translate="selectEmoji">Select Emoji</h2>
                <button class="close-modal" onclick="closeEmojiPicker()">√ó</button>
            </div>
            <div class="modal-body emoji-picker-body">
                <!-- ‚úÖ Champ de texte pour entrer un emoji personnalis√© -->
                <div class="emoji-custom-input-container">
                    <input 
                        type="text" 
                        id="customEmojiInput" 
                        class="emoji-custom-input" 
                        placeholder="Or type/paste any emoji here..."
                        data-translate-placeholder="customEmojiPlaceholder"
                        maxlength="4"
                        oninput="this.value = Array.from(this.value)[0] || ''"
                    />
                    <button class="emoji-use-custom-btn" onclick="useCustomEmoji()">
                        <span data-translate="useCustomEmoji">Use</span>
                    </button>
                </div>
                
                <div class="emoji-divider">
                    <span data-translate="orChooseBelow">or choose below</span>
                </div>
                
                <div class="emoji-categories">
                    <button class="emoji-category-btn active" data-category="smileys">üòä</button>
                    <button class="emoji-category-btn" data-category="animals">üê∂</button>
                    <button class="emoji-category-btn" data-category="food">üçî</button>
                    <button class="emoji-category-btn" data-category="activities">‚öΩ</button>
                    <button class="emoji-category-btn" data-category="travel">‚úàÔ∏è</button>
                    <button class="emoji-category-btn" data-category="objects">üí°</button>
                    <button class="emoji-category-btn" data-category="symbols">‚ù§Ô∏è</button>
                </div>
                <div class="emoji-grid" id="emojiGrid">
                    <!-- Les emojis seront ins√©r√©s ici par JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-translate="settingsTitle">‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Account Section -->
                <div class="settings-section">
                    <h3 data-translate="account">Account</h3>
                    <p id="settingsUserEmail" style="color: #6c757d; margin-bottom: 10px;"></p>
                    <button class="modal-button secondary" onclick="handleLogout()">
                        <span data-translate="logout">Logout</span>
                    </button>
                </div>
                
                <!-- Language Section (pas besoin de traduire le titre) -->
                <div class="settings-section">
                    <h3>Language / Langue / Idioma / –Ø–∑—ã–∫ / ◊©◊§◊î / ŸÑÿ∫ÿ©</h3>
                    <select class="settings-select" id="languageSelect" onchange="changeLanguage(this.value)">
                        <option value="en">English</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="es">Espa√±ol</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="he">◊¢◊ë◊®◊ô◊™</option>
                        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    </select>
                </div>
                
                <!-- Currency Section -->
                <div class="settings-section">
                    <h3 data-translate="currency">Devise</h3>
                    <select class="settings-select" id="currencySelect" onchange="updateCurrency(this.value)">
                        <option value="ILS">Israeli Shekel (‚Ç™)</option>
                        <option value="USD">US Dollar ($)</option>
                        <option value="EUR">Euro (‚Ç¨)</option>
                        <option value="GBP">British Pound (¬£)</option>
                        <option value="JPY">Japanese Yen (¬•)</option>
                        <option value="RUB">Russian Ruble (‚ÇΩ)</option>
                        <option value="CNY">Chinese Yuan (¬•)</option>
                        <option value="EGP">Egyptian Pound (E¬£)</option>
                        <option value="SAR">Saudi Riyal (Ô∑º)</option>
                        <option value="AED">UAE Dirham (ÿØ.ÿ•)</option>
                        <option value="INR">Indian Rupee (‚Çπ)</option>
                        <option value="THB">Thai Baht (‡∏ø)</option>
                        <option value="CHF">Swiss Franc (CHF)</option>
                        <option value="CAD">Canadian Dollar (CA$)</option>
                        <option value="AUD">Australian Dollar (A$)</option>
                        <option value="MXN">Mexican Peso (MX$)</option>
                        <option value="BRL">Brazilian Real (R$)</option>
                        <option value="NZD">New Zealand Dollar (NZ$)</option>
                    </select>
                </div>
                
                <!-- Income Tracking Section -->
                <div class="settings-section">
                    <h3 data-translate="incomeTracking">Income Tracking</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="useIncomeCheckbox" onchange="toggleIncomeFeature(this.checked)" />
                        <span data-translate="trackIncome">Track monthly income</span>
                    </label>
                </div>
                
                <!-- Dark Mode Section -->
                <div class="settings-section">
                    <h3 data-translate="darkMode">üåô Dark Mode</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="darkModeCheckbox" onchange="toggleDarkMode(this.checked)" />
                        <span data-translate="enableDarkMode">Enable dark mode</span>
                    </label>
                </div>

                                
                <!-- Percentage Calculation Section -->
                <div class="settings-section" id="percentageModeSection" style="display: none;">
                    <h3 data-translate="percentageCalculation">Percentage Calculation</h3>
                    <select class="settings-select" id="percentageModeSelect" onchange="updatePercentageMode(this.value)">
                        <option value="expenses" data-translate="basedOnExpenses">Based on total expenses</option>
                        <option value="income" data-translate="basedOnIncome">Based on total income</option>
                    </select>
                    <p class="settings-description" data-translate="percentageDesc">Choose how category percentages are calculated</p>
                </div>
                
                <!-- Developer Tools Section (temporaire) -->
                <div class="settings-section" style="border-top: 2px solid #e9ecef; margin-top: 20px; padding-top: 20px;">
                    <h3>üõ†Ô∏è Developer Tools</h3>
                    <button class="modal-button secondary" onclick="window.location.reload(true)" style="width: 100%;">
                        üîÑ Force Reload App
                    </button>
                    <p style="font-size: 0.85em; color: #6c757d; margin-top: 8px;">
                        Reload the app and clear cache
                    </p>
                </div>
            
                <!-- Delete Account Section -->
                <div class="settings-section" style="border-top: 2px solid #dc3545; margin-top: 20px; padding-top: 20px;">
                    <h3 style="color: #dc3545;" data-translate="deleteAccount">üóëÔ∏è Delete Account</h3>
                    <p style="font-size: 0.9em; color: #dc3545; margin-bottom: 15px;" data-translate="deleteAccountWarning">
                        This action is irreversible. All your data will be permanently deleted.
                    </p>
                    <button class="modal-button" style="background: #dc3545; width: 100%;" onclick="confirmDeleteAccount()">
                        <span data-translate="deleteAccount" style="color: white !important;">Delete Account</span>
                    </button>
                </div>

                <!-- About Section -->
                <div class="settings-section" style="border-top: 2px solid #e9ecef; margin-top: 30px; padding-top: 20px; text-align: center; font-size: 0.85em; color: #6c757d;">
                    <p style="margin: 5px 0; font-weight: 600;" data-translate="madeBy">Made by Victor Burtman</p>
                    <p style="margin: 5px 0;"><span data-translate="contactInfo">For any bug report, ideas or suggestions:</span></p>
                    <a href="mailto:victorburtman@gmail.com" style="color: #667eea; text-decoration: none; font-weight: 600;">victorburtman@gmail.com</a>
                </div> 

                <!-- App Version Section -->
                <div class="settings-section">
                    <h3 data-translate="appVersion">‚ÑπÔ∏è App Version</h3>
                    <p style="font-size: 1.1em; font-weight: 600; color: #667eea;">
                        <span id="appVersionDisplay">Loading...</span>
                    </p>
                    <p style="font-size: 0.9em; color: #6c757d;">
                        <span data-translate="versionInfo">Current version of your Personal Finance app</span>
                    </p>
                </div>
                
            </div>
            <div class="modal-footer">
                <button class="modal-button primary" onclick="closeSettings()">
                    <span data-translate="done">Done</span>
                </button>
            </div>
        </div>
    </div>


    
    <script>

            /**
             * Ajuste la taille de la police du titre pour qu'il tienne sur une seule ligne.
             * Commence √† 28px et r√©duit progressivement si d√©bordement.
             */
            function fitAppTitle() {
                const h1 = document.querySelector('.header h1');
                if (!h1) return;
            
                // 1. D√©finir la taille maximale souhait√©e (en px)
                let size = 28; // On monte √† 28px pour les grands √©crans
                h1.style.fontSize = size + 'px';
                
                // 2. Boucle de r√©duction : tant que le texte d√©passe et que la taille est > 12px
                while (h1.scrollWidth > h1.clientWidth && size > 12) {
                    size -= 0.5; // On r√©duit de 0.5px (plus fin que 1px)
                    h1.style.fontSize = size + 'px';
                }
            }
            
            // Gestionnaire de redimensionnement simplifi√© (sans debounce externe)
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(fitAppTitle, 100);
            });


        /**
         * Emp√™che une fonction de s'ex√©cuter trop souvent.
         * @param {function} func - La fonction √† d√©bouncer.
         * @param {number} delay - Le d√©lai en ms (e.g., 100ms).
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }





        
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Error caught:', e.message);
            // Don't let errors break the app
            e.preventDefault();
        });

        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBQ817hUTznf99z7ZFhVla39rnyjGibTWo",
          authDomain: "expense-tracker-b086e.firebaseapp.com",
          projectId: "expense-tracker-b086e",
          storageBucket: "expense-tracker-b086e.firebasestorage.app",
          messagingSenderId: "958947625850",
          appId: "1:958947625850:web:a67c87046977c909bfa4c3"
        };

        // Initialize Firebase
        let app, auth, db, functions;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            functions = firebase.functions();
            window.functions = functions;
        } catch (error) {  // ‚Üê AJOUTE CETTE LIGNE
            console.error('Firebase initialization error:', error);
        }

        // Global variables
        let currentUser = null;
        window.currentUser = null; // ‚úÖ AJOUTER cette ligne
        let isEditMode = false;
        let categoryOrder = ['income', 'housing', 'subscriptions', 'groceries', 'pet', 'hobbies', 'other'];
        let useIncome = true;
        let currency = '‚Ç™'; // Default currency symbol
        let currencyOptions = {
            'ILS': '‚Ç™',
            'USD': '$',
            'EUR': '‚Ç¨',
            'GBP': '¬£',
            'JPY': '¬•',
            'RUB': '‚ÇΩ',
            'CNY': '¬•',
            'EGP': 'E¬£',
            'LBP': 'L¬£',
            'SYP': 'S¬£',
            'JOD': 'ÿØ.ÿß',
            'INR': '‚Çπ',
            'THB': '‡∏ø'
        };
        let percentageMode = 'expenses'; // 'expenses' or 'income'

        // Store category metadata (emoji, display name)
        let categoryMetadata = {};

        let currentLanguage = 'en'; // Variable pour la langue actuelle


        // ‚úÖ D√©tecter la plateforme (Android/iOS/Web)
        document.addEventListener('DOMContentLoaded', () => {
            if (window.Capacitor) {
                const platform = window.Capacitor.getPlatform();
                document.body.classList.add(`platform-${platform}`);
                console.log('üì± Plateforme d√©tect√©e:', platform);
            } else {
                document.body.classList.add('platform-web');
                console.log('üåê Plateforme: Web/PWA');
            }
        });


        // ========== D√âBUT DU CODE POUR L'√âCRAN DE CONNEXION ==========

        // Variables globales pour l'authentification
        let isSignUpMode = false;

        // V√©rifier que authManager existe
        if (typeof authManager === 'undefined') {
            console.error('‚ö†Ô∏è authManager not loaded! Check if auth-manager.js is included before this script');
        }


        async function handleSignIn() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const remember = document.getElementById('rememberMe').checked;
            
            if (!email || !password) {
                const lang = localStorage.getItem('language') || 'en';
                const trans = translations[lang] || translations['en'];
                alert(trans.pleaseEnterEmailAndPassword || 'Please enter email and password');
                return;
            }
            
            // R√©cup√©rer les boutons
            const signInBtn = document.getElementById('signInBtn');
            const signUpBtn = document.getElementById('signUpBtn');
            
            if (!signInBtn || !signUpBtn) {
                console.error('‚ùå Boutons introuvables');
                return;
            }
                        
            // Sauvegarder le texte original
            const originalSignInText = signInBtn.innerHTML;
            
            // D√©sactiver et afficher loading
            signInBtn.disabled = true;
            signUpBtn.disabled = true;
            
            const lang = localStorage.getItem('language') || 'en';
            const loadingText = translations[lang]?.loading || 'Loading...';
            signInBtn.innerHTML = '‚è≥ ' + loadingText;
            
            const result = await authManager.signIn(email, password, remember);
                        
            // ‚úÖ Si result est false ou undefined, c'est une erreur
            if (!result) {                
                // R√©activer les boutons
                signInBtn.disabled = false;
                signUpBtn.disabled = false;
                signInBtn.innerHTML = originalSignInText;
            } else {
                // Connexion r√©ussie, l'app va se recharger via onAuthStateChanged
            }
        }

        async function handleSignUp() {
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const remember = document.getElementById('rememberMe').checked;
            
            if (!email || !password) {
                const lang = localStorage.getItem('language') || 'en';
                const trans = translations[lang] || translations['en'];
                alert(trans.pleaseEnterEmailAndPassword || 'Please enter email and password');
                return;
            }
            
            const signInBtn = document.getElementById('signInBtn');
            const signUpBtn = document.getElementById('signUpBtn');
            
            if (!signInBtn || !signUpBtn) {
                console.error('‚ùå Boutons introuvables');
                return;
            }
                        
            const originalSignUpText = signUpBtn.innerHTML;
            
            signInBtn.disabled = true;
            signUpBtn.disabled = true;
            
            const lang = localStorage.getItem('language') || 'en';
            const loadingText = translations[lang]?.loading || 'Loading...';
            signUpBtn.innerHTML = '‚è≥ ' + loadingText;
            
            // ‚úÖ AJOUTER TRY/CATCH pour attraper les erreurs
            try {
                const result = await authManager.signUp(email, password, remember);
                                
                if (!result) {
                    
                    signInBtn.disabled = false;
                    signUpBtn.disabled = false;
                    signUpBtn.innerHTML = originalSignUpText;
                } else {
                    console.log('‚úÖ Inscription r√©ussie, l\'app va se recharger');
                }
            } catch (error) {
                // ‚úÖ Attraper les erreurs non g√©r√©es
                console.error('‚ùå Erreur handleSignUp:', error);
                
                signInBtn.disabled = false;
                signUpBtn.disabled = false;
                signUpBtn.innerHTML = originalSignUpText;
            }
        }

        // ========== TOGGLE PASSWORD VISIBILITY ==========
        document.addEventListener('DOMContentLoaded', function() {
            const togglePasswordBtn = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            const emailInput = document.getElementById('email');
            
            // Toggle password visibility
            if (togglePasswordBtn && passwordInput) {
                togglePasswordBtn.addEventListener('click', function() {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        togglePasswordBtn.textContent = 'üôà';
                    } else {
                        passwordInput.type = 'password';
                        togglePasswordBtn.textContent = 'üëÅÔ∏è';
                    }
                });
            }
            
            // Submit with Enter key on password field
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const signInBtn = document.getElementById('signInBtn');
                        if (signInBtn) signInBtn.click();
                    }
                });
            }
            
            // Focus password field when Enter is pressed on email
            if (emailInput && passwordInput) {
                emailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        passwordInput.focus();
                    }
                });
            }
        });








        // Afficher les erreurs d'authentification
        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                // Cacher l'erreur apr√®s 5 secondes
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Traduire les messages d'erreur Firebase
        function getAuthErrorMessage(error) {
            const errorMessages = {
                'auth/email-already-in-use': 'This email is already registered',
                'auth/invalid-email': 'Invalid email address',
                'auth/weak-password': 'Password is too weak',
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/network-request-failed': 'Network error, please try again',
                'auth/too-many-requests': 'Too many attempts, please try again later',
                'auth/user-disabled': 'This account has been disabled'
            };
            
            return errorMessages[error.code] || error.message || 'An error occurred';
        }

        // Mettre √† jour le bouton de langue actif
        function updateLanguageButtons(langCode) {
            document.querySelectorAll('.language-selector button').forEach(btn => {
                if (btn.dataset.lang === langCode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // G√©rer la touche Entr√©e pour soumettre le formulaire
        function setupAuthKeyboardHandlers() {
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            if (emailInput) {
                emailInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        passwordInput.focus();
                    }
                });
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (isSignUpMode) {
                            handleSignUp();
                        } else {
                            handleSignIn();
                        }
                    }
                });
            }
        }

        // ========== FIN DU CODE POUR L'√âCRAN DE CONNEXION ==========



        // Fonction pour obtenir une traduction
        function t(key) {
            return translations[currentLanguage][key] || key;
        }
        
        function changeLanguage(lang) {
            currentLanguage = lang;
            
            // Sauvegarder la langue choisie
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({
                    language: lang
                }, { merge: true });
            }
            
            // ‚úÖ Toujours sauvegarder dans localStorage aussi (pour sync entre √©cran de co et app)
            localStorage.setItem('language', lang);
            
            // Mettre √† jour l'attribut dir pour RTL (arabe et h√©breu)
            if (lang === 'ar' || lang === 'he') {
                document.documentElement.setAttribute('dir', 'rtl');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
            }
            
            // Recharger l'interface avec les nouvelles traductions
            updateUILanguage();
        }
        

        function updateUILanguage() {
            // Main app header
            const mainAppHeader = document.querySelector('.header h1');
            if (mainAppHeader) mainAppHeader.textContent = t('monthlyExpenses');
            
            // Total section
            const totalSection = document.querySelector('.total-section h2');
            if (totalSection) totalSection.textContent = t('totalExpenses');
            
            const incomeH3 = document.querySelector('#incomeDisplay h3');
            if (incomeH3) incomeH3.textContent = t('totalIncome');
            
            const remainingH3 = document.querySelector('#remainingDisplay h3');
            if (remainingH3) remainingH3.textContent = t('remaining');
            
            // Modals
            const colorModalTitle = document.querySelector('#colorEditorModal .modal-header h2');
            if (colorModalTitle) colorModalTitle.textContent = t('customizeColors');
            
            const colorModalReset = document.querySelector('#colorEditorModal .modal-footer .secondary');
            if (colorModalReset) colorModalReset.textContent = t('resetToDefault');
            
            const colorModalDone = document.querySelector('#colorEditorModal .modal-footer .primary');
            if (colorModalDone) colorModalDone.textContent = t('done');
            
            const settingsModalTitle = document.querySelector('#settingsModal .modal-header h2');
            if (settingsModalTitle) settingsModalTitle.textContent = t('settingsTitle');
            
            const settingsModalDone = document.querySelector('#settingsModal .modal-footer .primary');
            if (settingsModalDone) settingsModalDone.textContent = t('done');
            
            // Settings sections
            const accountTitle = document.getElementById('accountTitle');
            if (accountTitle) accountTitle.textContent = t('account');
            
            const currencyTitle = document.getElementById('currencyTitle');
            if (currencyTitle) currencyTitle.textContent = t('currency');
            
            const incomeTrackingTitle = document.getElementById('incomeTrackingTitle');
            if (incomeTrackingTitle) incomeTrackingTitle.textContent = t('incomeTracking');
            
            const darkModeTitle = document.getElementById('darkModeTitle');
            if (darkModeTitle) darkModeTitle.textContent = t('darkMode');
            
            const percentageTitle = document.getElementById('percentageTitle');
            if (percentageTitle) percentageTitle.textContent = t('percentageCalculation');
            
            const clearDataTitle = document.getElementById('clearDataTitle');
            if (clearDataTitle) clearDataTitle.textContent = t('clearData');
            
            // Settings button
            const logoutBtn = document.querySelector('#settingsModal .settings-section button');
            if (logoutBtn) logoutBtn.textContent = t('logout');
            
            // Settings descriptions
            const settingsDescriptions = document.querySelectorAll('.settings-description');
            if (settingsDescriptions[0]) settingsDescriptions[0].textContent = t('percentageDesc');
            
            const trackIncomeSpan = document.querySelector('#useIncomeCheckbox + span');
            if (trackIncomeSpan) {
                trackIncomeSpan.textContent = t('trackIncome');
            }
            
            // Percentage mode options
            const percentageOptions = document.querySelectorAll('#percentageModeSelect option');
            if (percentageOptions.length > 0) {
                percentageOptions[0].textContent = t('basedOnExpenses');
                percentageOptions[1].textContent = t('basedOnIncome');
            }
            
            // Update category controls if in edit mode
            if (isEditMode) {
                document.querySelectorAll('.category-controls').forEach(controls => {
                    const buttons = controls.querySelectorAll('.category-btn');
                    if (buttons.length >= 4) {
                        buttons[0].innerHTML = t('moveUp');
                        buttons[1].innerHTML = t('moveDown');
                        buttons[2].innerHTML = t('addItem');
                        buttons[3].innerHTML = t('deleteCategory');
                    }
                });
            }
            
            // Update display to refresh category names and stats
            updateDisplay();
            if (typeof updateTransactionsLanguage === 'function') {
                updateTransactionsLanguage();
            }
            
            // === AJUSTEMENT DU TITRE ===
            fitAppTitle();
            setTimeout(fitAppTitle, 50);
            
            // Traduire le footer
            const footerButtons = document.querySelectorAll('.footer-nav-btn [data-translate]');
            footerButtons.forEach(btn => {
                const key = btn.getAttribute('data-translate');
                if (t(key)) {
                    btn.textContent = t(key);
                }
            });
            
            // Traduction automatique des data-translate
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                const translation = t(key);
                
                if (translation) {
                    // Si c'est un input avec placeholder
                    if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                        el.placeholder = translation;
                    } 
                    // Si c'est un √©l√©ment normal
                    else {
                        // Ne remplacer que si ce n'est pas d√©j√† un parent avec du HTML complexe
                        if (el.children.length === 0) {
                            el.textContent = translation;
                        } else {
                            // Si l'√©l√©ment a des enfants, ne remplacer que le premier textNode
                            const textNode = Array.from(el.childNodes).find(node => node.nodeType === 3);
                            if (textNode) {
                                textNode.textContent = translation;
                            }
                        }
                    }
                }
            });
            
            // Traduction des placeholders sp√©cifiques
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                const translation = t(key);
                if (translation) {
                    el.placeholder = translation;
                }
            });
            
            // ‚úÖ AJOUTE : Mise √† jour de la version de l'app
            const appVersionDisplay = document.getElementById('appVersionDisplay');
            if (appVersionDisplay && window.APP_VERSION) {
                appVersionDisplay.textContent = 'v' + window.APP_VERSION;
            }      
        }

        // Fonction pour mettre √† jour l'√©cran de connexion uniquement
        function updateAuthScreenLanguage() {
            const authTitle = document.querySelector('.auth-title');
            if (!authTitle) return; // L'√©cran de connexion n'est pas visible
            
            document.querySelector('.auth-title').textContent = t('appTitle');
            document.querySelector('.auth-subtitle').textContent = t('authSubtitle');
            document.getElementById('authEmail').placeholder = t('email');
            document.getElementById('authPassword').placeholder = t('password');
            
            const submitBtn = document.getElementById('authSubmitBtn');
            const isSignUp = submitBtn.textContent.includes('Sign Up') || 
                            submitBtn.textContent.includes('S\'inscrire') ||
                            submitBtn.textContent.includes('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è') ||
                            submitBtn.textContent.includes('◊î◊ô◊®◊©◊ù') ||
                            submitBtn.textContent.includes('Registrarse') ||
                            submitBtn.textContent.includes('ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®');
            
            document.getElementById('authSubmitBtn').textContent = isSignUp ? t('signUp') : t('signIn');
            document.getElementById('authToggleText').textContent = isSignUp ? t('hasAccount') : t('noAccount');
            document.getElementById('authToggleBtn').textContent = isSignUp ? t('signIn') : t('signUp');
        }



        /**
         * Update translations for transactions tab
         */
        function updateTransactionsLanguage() {
            // Traduire les √©l√©ments avec data-translate
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });
            
            // Traduire les placeholders
            const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
            placeholderElements.forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.placeholder = translations[currentLanguage][key];
                }
            });
        }

        
        // NOUVELLE FONCTION - Cleanup category order
        function cleanupCategoryOrder() {
            // Enlever les cat√©gories qui n'existent plus dans expenses
            categoryOrder = categoryOrder.filter(categoryKey => expenses.hasOwnProperty(categoryKey));
            
            // Ajouter les cat√©gories manquantes
            Object.keys(expenses).forEach(categoryKey => {
                if (!categoryOrder.includes(categoryKey)) {
                    categoryOrder.push(categoryKey);
                }
            });
            
            // S'assurer qu'income est toujours en premier si elle existe
            if (categoryOrder.includes('income') && categoryOrder[0] !== 'income') {
                categoryOrder = ['income', ...categoryOrder.filter(c => c !== 'income')];
            }        
        }

        // Authentication functions
        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            const submitBtn = document.getElementById('authSubmitBtn');
            const toggleText = document.getElementById('authToggleText');
            const toggleBtn = document.getElementById('authToggleBtn');
            
            if (isSignUpMode) {
                submitBtn.textContent = 'Sign Up';
                toggleText.textContent = 'Already have an account?';
                toggleBtn.textContent = 'Sign In';
            } else {
                submitBtn.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account?";
                toggleBtn.textContent = 'Sign Up';
            }
        }


        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }


        function handleLogout() {
            const t = translations[currentLanguage] || translations['en'];
            if (confirm(t.logoutConfirm || 'Logout?')) {
                closeSettings();
                auth.signOut().then(() => {
                    // ‚úÖ AJOUT√â : Force un reload complet de la page
                    window.location.reload();
                });
            }
        }

        const defaultExpenses = {
            income: [
                { name: 'Salary', amount: 0 }
            ],
            housing: [
                { name: 'Rent', amount: 0 },
                { name: 'Residence tax', amount: 0 },
                { name: 'Electricity', amount: 0 },
                { name: 'Gas', amount: 0 },
                { name: 'Water', amount: 0 }
            ],
            subscriptions: [
                { name: 'Internet', amount: 0 },
                { name: 'Phone Plan', amount: 0 },
                { name: 'Spotify', amount: 0 },
                { name: 'Gym', amount: 0 }
            ],
            groceries: [
                { name: 'Food', amount: 0 },
                { name: 'Household Products', amount: 0 }
            ],
            pet: [
                { name: 'Pet Food and Litter', amount: 0 },
                { name: 'Vet', amount: 0 }
            ],
            hobbies: [
                { name: 'Restaurant', amount: 0 },
                { name: 'Cinema', amount: 0 },
                { name: 'Video Games', amount: 0 }
            ],
            other: [
                { name: 'Other Expenses', amount: 0 }
            ]
        };

        
        // Data variables
        let expenses = JSON.parse(JSON.stringify(defaultExpenses));
        let chart = null;
        let currentChartType = 'doughnut';
        let hiddenItems = {};
        let customColors = {};
        let categoryBaseColors = {}; // { categoryName: color } - Couleur de base de chaque cat√©gorie
        window.categoryBaseColors = categoryBaseColors; // ‚úÖ Rendre accessible globalement





        /**
         * G√©n√®re une variation de couleur pour un item bas√©e sur la couleur de sa cat√©gorie
         * @param {string} baseColor - Couleur de base en format HSL ou hex
         * @param {number} index - Index de l'item dans la cat√©gorie (pour la variation)
         * @param {number} total - Nombre total d'items dans la cat√©gorie
         */
        function generateColorVariation(baseColor, index, total) {
            // Convertir hex en HSL si n√©cessaire
            let hsl;
            if (baseColor.startsWith('#')) {
                hsl = hexToHSL(baseColor);
            } else if (baseColor.startsWith('hsl')) {
                const match = baseColor.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);
                hsl = { h: parseInt(match[1]), s: parseInt(match[2]), l: parseInt(match[3]) };
            } else {
                return baseColor; // Si format inconnu, retourner tel quel
            }
            
            // Cr√©er une variation l√©g√®re
            const hueShift = (index - total / 2) * 5; // Variation de teinte ¬±5 degr√©s
            const lightnessShift = (index % 2 === 0) ? 5 : -5; // Alternance de luminosit√©
            
            const newH = (hsl.h + hueShift + 360) % 360;
            const newL = Math.max(40, Math.min(70, hsl.l + lightnessShift));
            
            return `hsl(${newH}, ${hsl.s}%, ${newL}%)`;
        }

        /**
         * Convertit une couleur hexad√©cimale en HSL
         */
        function hexToHSL(hex) {
            // Retirer le #
            hex = hex.replace('#', '');
            
            // Convertir en RGB
            const r = parseInt(hex.substr(0, 2), 16) / 255;
            const g = parseInt(hex.substr(2, 2), 16) / 255;
            const b = parseInt(hex.substr(4, 2), 16) / 255;
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;
            
            if (max === min) {
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                
                switch (max) {
                    case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
                    case g: h = ((b - r) / d + 2) / 6; break;
                    case b: h = ((r - g) / d + 4) / 6; break;
                }
            }
            
            return {
                h: Math.round(h * 360),
                s: Math.round(s * 100),
                l: Math.round(l * 100)
            };
        }




        /**
         * Initialise les couleurs de base pour chaque cat√©gorie
         */
        function initializeCategoryColors() {
            const defaultCategoryColors = {
                housing: '#FF6B6B',
                transportation: '#4ECDC4',
                food: '#45B7D1',
                utilities: '#FFA07A',
                insurance: '#98D8C8',
                healthcare: '#F7DC6F',
                savings: '#BB8FCE',
                personal: '#85C1E2',
                entertainment: '#F8B739',
                other: '#95A5A6'
            };
            
            // Initialiser les couleurs de cat√©gories si elles n'existent pas
            Object.keys(expenses).forEach(categoryKey => {
                if (categoryKey !== 'income' && !categoryBaseColors[categoryKey]) {
                    categoryBaseColors[categoryKey] = defaultCategoryColors[categoryKey] || generateRandomColor();
                }
            });
            
            // Couleur sp√©ciale pour income
            if (!categoryBaseColors['income']) {
                categoryBaseColors['income'] = '#28a745';
            }
            window.categoryBaseColors = categoryBaseColors;
        }





        // Firestore functions



        
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const data = userDoc.data();
                    
                    // ‚úÖ D√âFINIR LA LANGUE EN PREMIER - AVANT TOUT
                    const firestoreLang = data.language;
                    const localStorageLang = localStorage.getItem('language');
                    
                    if (firestoreLang && translations[firestoreLang]) {
                        currentLanguage = firestoreLang;
                    } else if (localStorageLang && translations[localStorageLang]) {
                        currentLanguage = localStorageLang;
                        await db.collection('users').doc(currentUser.uid).set({
                            language: localStorageLang
                        }, { merge: true });
                    } else {
                        currentLanguage = 'en';
                    }
                                        
                    document.getElementById('languageSelect').value = currentLanguage;
                    
                    // Appliquer RTL imm√©diatement
                    if (currentLanguage === 'ar' || currentLanguage === 'he') {
                        document.documentElement.setAttribute('dir', 'rtl');
                    } else {
                        document.documentElement.setAttribute('dir', 'ltr');
                    }
                    
                    // ‚úÖ CHARGER DARK MODE (par d√©faut activ√© pour nouveaux utilisateurs)
                    const darkMode = data.darkMode !== undefined ? data.darkMode : true;
                    if (darkMode) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }

                    // ‚úÖ Cocher la checkbox
                    const darkModeCheckbox = document.getElementById('darkModeCheckbox');
                    if (darkModeCheckbox) {
                        darkModeCheckbox.checked = darkMode;
                    }
                    
                    // ‚úÖ AJOUT√â : Mettre √† jour la couleur iOS
                    updateThemeColor();
                    
                    // ‚úÖ MAINTENANT charger le reste des donn√©es
                    expenses = data.expenses || JSON.parse(JSON.stringify(defaultExpenses));
                    customColors = data.customColors || {};
                    categoryBaseColors = data.categoryBaseColors || {};
                    window.categoryBaseColors = categoryBaseColors; // ‚úÖ Synchroniser
                    currentChartType = data.chartType || 'doughnut';
                    
                    // ‚úÖ Initialiser les couleurs de cat√©gories
                    initializeCategoryColors();
                    
                    // ‚úÖ Mettre √† jour l'√©tat des boutons SEULEMENT apr√®s chargement Firebase
                    if (typeof window.updateChartButtonsState === 'function') {
                        window.updateChartButtonsState();
                    }
                    
                    categoryOrder = data.categoryOrder || ['income', 'housing', 'tech', 'pet', 'subscriptions', 'groceries', 'other'];
                    useIncome = data.useIncome !== undefined ? data.useIncome : true;
                    currency = data.currency || '‚Ç™';
                    percentageMode = data.percentageMode || 'expenses';
                    isRealSpendingMode = data.isRealSpendingMode || false;
                    console.log('üì• Loaded isRealSpendingMode:', isRealSpendingMode);
                    
                    categoryMetadata = data.categoryMetadata || {};
                    
                    // NOUVEAU : Nettoyer et synchroniser categoryOrder
                    cleanupCategoryOrder();
                    
                    // Hide default categories that were deleted by the user
                    const defaultCategories = ['income', 'housing', 'tech', 'pet', 'subscriptions', 'groceries', 'other'];
                    defaultCategories.forEach(categoryKey => {
                        const section = document.getElementById(`category-${categoryKey}`);
                        if (section) {
                            if (!expenses[categoryKey]) {
                                section.style.display = 'none';
                            } else {
                                section.style.display = 'block';
                            }
                        }
                    });
                    
                    // Recreate HTML for custom categories
                    const expensesList = document.getElementById('expensesList');
                    const t = translations[currentLanguage] || translations['en'];
                    
                    Object.keys(expenses).forEach(categoryKey => {
                        if (defaultCategories.includes(categoryKey)) return;
                        if (document.getElementById(`category-${categoryKey}`)) return;
                                                
                        const meta = categoryMetadata[categoryKey] || {
                            emoji: 'üìã',
                            displayName: categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1)
                        };
                        
                        const statsId = `${categoryKey}Stats`;
                        const expensesId = `${categoryKey}Expenses`;
                        
                        const categorySection = document.createElement('div');
                        categorySection.className = 'category-section';
                        categorySection.id = `category-${categoryKey}`;
                        categorySection.innerHTML = `
                            <div class="category-title">
                                ${meta.emoji} ${meta.displayName}
                            </div>
                            <div class="category-stats" id="${statsId}"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('${categoryKey}')">
                                    <span data-translate="moveUp">${t.moveUp || 'Move Up'}</span>
                                </button>
                                <button class="category-btn" onclick="moveCategoryDown('${categoryKey}')">
                                    <span data-translate="moveDown">${t.moveDown || 'Move Down'}</span>
                                </button>
                                <button class="category-btn" onclick="addItemToCategory('${categoryKey}')">
                                    <span data-translate="addItem">${t.addItem || 'Add Item'}</span>
                                </button>
                                <button class="category-btn danger" onclick="deleteCategory('${categoryKey}')">
                                    <img src="img/icons/trash.svg" alt="Delete" class="category-delete-icon">
                                    <span data-translate="deleteCategory">${t.deleteCategory || 'Delete Category'}</span>
                                </button>
                            </div>
                            <div id="${expensesId}"></div>
                        `;
                        
                        expensesList.appendChild(categorySection);
                    });
                    
                    // Reorder categories according to categoryOrder
                    renderCategoriesInOrder();
                    
                    // ‚úÖ NOUVEAU : Restaurer l'√©tat du toggle apr√®s chargement des donn√©es
                    setTimeout(() => {
                        const budgetToggle = document.getElementById('budgetModeToggle');
                        console.log('üîç Restoring toggle, budgetToggle:', budgetToggle);
                        console.log('üîç isRealSpendingMode:', isRealSpendingMode);
                        
                        if (budgetToggle) {
                            budgetToggle.checked = isRealSpendingMode;
                            console.log('‚úÖ Toggle set to:', budgetToggle.checked);
                            
                            if (isRealSpendingMode) {
                                loadRealSpendingForChart();
                            }
                        }
                    }, 300);
                    
                } else {
                    // First time user - use defaults
                    expenses = JSON.parse(JSON.stringify(defaultExpenses));
                    
                    const localStorageLang = localStorage.getItem('language');
                    if (localStorageLang && translations[localStorageLang]) {
                        currentLanguage = localStorageLang;
                    }
                    
                    await saveUserData();
                }
                
                // Mettre √† jour l'interface avec la langue charg√©e
                updateUILanguage();
                updateChartIndicators();
                updateDisplay();
                updateChartButtonsState();
                loadMonthlyTrendChart();
                
                // ‚úÖ Forcer l'affichage de l'onglet Budget au d√©marrage
                setTimeout(() => {
                    switchTab('budget');
                }, 100);
                
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }



        // AJOUTE ICI : Language change handler
        document.getElementById('languageSelect')?.addEventListener('change', async function(e) {
            currentLanguage = e.target.value;
            localStorage.setItem('preferredLanguage', currentLanguage);
            
            // Appliquer RTL si n√©cessaire
            if (currentLanguage === 'ar' || currentLanguage === 'he') {
                document.documentElement.setAttribute('dir', 'rtl');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
            }
            
            updateUILanguage();
            
            // Traduire l'onglet Transactions si visible
            if (typeof updateTransactionsLanguage === 'function') {
                updateTransactionsLanguage();
            }
            
            // Sauvegarder dans Firebase
            if (currentUser) {
                await saveUserData();
            }
        });


        
        async function saveUserData() {
            if (!currentUser) return;
            
            try {
                const dataToSave = {
                    expenses: expenses,
                    customColors: customColors,
                    chartType: currentChartType,
                    categoryOrder: categoryOrder,
                    categoryBaseColors: categoryBaseColors, // ‚úÖ Ajoute si pas d√©j√† pr√©sent
                    useIncome: useIncome,
                    currency: currency,
                    percentageMode: percentageMode,
                    categoryMetadata: categoryMetadata,
                    isRealSpendingMode: isRealSpendingMode, // ‚úÖ Ajoute cette ligne
                    language: currentLanguage,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log('üíæ Data to save:', dataToSave.isRealSpendingMode); // ‚úÖ Debug

                // IMPORTANT : Ne PAS utiliser merge pour que les cl√©s supprim√©es disparaissent vraiment
                await db.collection('users').doc(currentUser.uid).set(dataToSave, { merge: true });
            } catch (error) {
                console.error('Error saving user data:', error);
                throw error;
            }
        }

        function saveExpenses() {
            saveUserData();
            updateDisplay();
        }


        const colors = [
            '#667eea', '#764ba2', '#f093fb', '#4facfe',
            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
            '#a8edea', '#fed6e3', '#c471f5', '#12c2e9'
        ];

        function calculateTotal() {
            let total = 0;
            Object.keys(expenses).forEach(categoryKey => {
                // Skip income category when calculating expenses
                if (categoryKey === 'income') return;
                
                expenses[categoryKey].forEach(expense => {
                    total += parseFloat(expense.amount) || 0;
                });
            });
            return total;
        }

        function calculateIncome() {
            if (!expenses.income) return 0;
            let total = 0;
            expenses.income.forEach(item => {
                total += parseFloat(item.amount) || 0;
            });
            return total;
        }

        function calculateCategoryTotal(categoryKey) {
            let categoryTotal = 0;
            if (expenses[categoryKey]) {
                expenses[categoryKey].forEach(expense => {
                    categoryTotal += parseFloat(expense.amount) || 0;
                });
            }
            return categoryTotal;
        }

        function getCategoryStats(categoryKey) {
            const categoryTotal = calculateCategoryTotal(categoryKey);
            
            // Calculate base depending on percentage mode
            let base;
            if (percentageMode === 'income' && useIncome) {
                base = calculateIncome();
            } else {
                base = categoryKey === 'income' ? calculateIncome() : calculateTotal();
            }
            
            const percentage = base > 0 ? ((categoryTotal / base) * 100).toFixed(1) : 0;
            return {
                total: categoryTotal,
                percentage: percentage
            };
        }

        function calculateVisibleTotal(chartInstance) {
            if (!chartInstance || !chartInstance.data) return calculateTotal();
            
            let visibleTotal = 0;
            const data = chartInstance.data.datasets[0].data;
            const labels = chartInstance.data.labels;
            
            data.forEach((value, index) => {
                // Check if this data point is visible
                const meta = chartInstance.getDatasetMeta(0);
                if (meta.data[index] && !meta.data[index].hidden) {
                    visibleTotal += value;
                }
            });
            
            return visibleTotal;
        }

        function renderExpenseItem(expense, category, index) {
            const deleteBtn = isEditMode ? 
                `<button class="expense-delete-btn" onclick="deleteExpenseItem('${category}', ${index})" title="Delete item">
                    <img src="img/icons/trash.svg" alt="Delete" class="delete-icon">
                </button>` : '';
            
            // ‚úÖ Poign√©e de drag (visible uniquement en mode edit)
            const dragHandle = isEditMode ? 
                `<span class="drag-handle" title="Drag to reorder">‚ò∞</span>` : '';
            
            return `
                <div class="expense-item" ${isEditMode ? 'draggable="true" data-category="' + category + '" data-index="' + index + '"' : ''}>
                    ${dragHandle}
                    <span class="expense-name ${isEditMode ? 'editable' : ''}" 
                        ${isEditMode ? 'onclick="makeNameEditable(this, \'' + category + '\', ' + index + ')"' : ''}
                        title="${isEditMode ? 'Click to edit' : ''}">${expense.name}</span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input 
                            type="number" 
                            class="expense-input" 
                            value="${expense.amount}"
                            onchange="updateExpense('${category}', ${index}, this.value)"
                            step="0.01"
                            min="0"
                        />
                        <span class="currency">${currency}</span>
                        ${deleteBtn}
                    </div>
                </div>
            `;
        }


        function updateExpense(category, index, value) {
            expenses[category][index].amount = parseFloat(value) || 0;
            saveExpenses();
        }

        function updateDisplay() {
            try {
                cleanupCategoryOrder();
                // Update income section visibility
                const incomeSection = document.getElementById('category-income');
                const incomeDisplaySection = document.getElementById('incomeDisplay');
                const remainingDisplaySection = document.getElementById('remainingDisplay');
                
                if (useIncome && expenses.income && incomeSection) {
                    incomeSection.style.display = 'block';
                    incomeDisplaySection.style.display = 'block';
                    remainingDisplaySection.style.display = 'block';
                } else if (incomeSection) {
                    incomeSection.style.display = 'none';
                    incomeDisplaySection.style.display = 'none';
                    remainingDisplaySection.style.display = 'none';
                }
                
                // Calculate totals
                let totalExpenses, totalIncome;

                // ‚úÖ MODIFI√â : Utiliser isRealSpendingMode au lieu de compareMode
                if (isRealSpendingMode && realSpendingData) {
                    // Calculer le total des d√©penses depuis realSpendingData
                    totalExpenses = 0;
                    Object.keys(realSpendingData).forEach(key => {
                        if (key !== '_incomeTotal') { // Ignorer le revenu stock√©
                            totalExpenses += realSpendingData[key] || 0;
                        }
                    });
                    
                    // Utiliser le revenu total des transactions
                    totalIncome = realSpendingData._incomeTotal || 0;
                } else {
                    // Mode "Estim√©" : utiliser les valeurs manuelles
                    totalExpenses = calculateTotal();
                    totalIncome = calculateIncome();
                }

                const remaining = totalIncome - totalExpenses;
                
                // Calculate remaining percentage
                const remainingPercentage = totalIncome > 0 ? ((remaining / totalIncome) * 100).toFixed(1) : 0;
                
                // Update displays
                document.getElementById('totalAmount').textContent = `${currency}${totalExpenses.toFixed(2)}`;
                document.getElementById('totalIncome').textContent = `${currency}${totalIncome.toFixed(2)}`;
                document.getElementById('remainingAmount').textContent = `${currency}${remaining.toFixed(2)}`;
                document.getElementById('remainingAmount').style.color = remaining >= 0 ? '#28a745' : '#dc3545';
                const ofIncomeText = translations[currentLanguage]?.ofIncome || 'of income';
                document.getElementById('remainingPercentage').textContent = `(${remainingPercentage}% ${ofIncomeText})`;

                // First, hide ALL category sections
                const allSections = document.querySelectorAll('.category-section');
                allSections.forEach(section => {
                    section.style.display = 'none';
                });

                // Then, update ONLY categories that exist in expenses
                Object.keys(expenses).forEach(categoryKey => {
                    const section = document.getElementById(`category-${categoryKey}`);
                    if (!section) {
                        // Category exists in data but not in DOM - skip it
                        return;
                    }
                    
                    // Show the section
                    section.style.display = 'block';
                    
                    // ‚úÖ Mettre √† jour le titre avec l'emoji et le nom depuis les m√©tadonn√©es
                    const titleElement = section.querySelector('.category-title');
                    if (titleElement && categoryMetadata[categoryKey]) {
                        const meta = categoryMetadata[categoryKey];
                        
                        // ‚úÖ Pour Income : cas sp√©cial (NON √©ditable)
                        if (categoryKey === 'income') {
                            titleElement.innerHTML = `
                                <img src="img/icons/income.svg" alt="Income" class="category-icon income-icon">
                                <span data-translate="income">${meta.displayName}</span>
                            `;
                        } 
                        // ‚úÖ Pour les autres cat√©gories : cliquable en mode Edit
                        else {
                            const nameHTML = isEditMode 
                                ? `<span class="category-name-editable" onclick="renameCategory('${categoryKey}')" style="cursor: pointer;">${meta.displayName}</span>`
                                : meta.displayName;
                            
                            titleElement.innerHTML = `${meta.emoji} ${nameHTML}`;
                        }
                    }

                    // Update stats
                    const stats = getCategoryStats(categoryKey);
                    const statsElement = document.getElementById(`${categoryKey}Stats`);
                    
                    if (statsElement) {
                        if (categoryKey === 'income') {
                            statsElement.innerHTML = stats.total > 0 ? 
                                `<span class="amount" style="color: #28a745;">${currency}${stats.total.toFixed(2)}</span>` : '';
                        } else {
                            // Ajouter la comparaison si le mode est activ√©
                            let statsHTML = stats.total > 0 ? 
                                `<span class="amount">${currency}${stats.total.toFixed(2)}</span><span class="percentage">(${stats.percentage}%)</span>` : '';
                            
                            // ‚úÖ MODIFI√â : Utiliser isRealSpendingMode au lieu de compareMode
                            if (isRealSpendingMode && stats.total > 0) {
                                statsHTML += renderComparisonInfo(categoryKey, stats.total);
                            }
                            
                            statsElement.innerHTML = statsHTML;
                        }
                    }
                    
                    // Update expenses items
                    const expensesElement = document.getElementById(`${categoryKey}Expenses`);
                    if (expensesElement && expenses[categoryKey]) {
                        expensesElement.innerHTML = expenses[categoryKey].map((exp, i) => 
                            renderExpenseItem(exp, categoryKey, i)).join('');
                    }
                });

                // Update chart
                updateChart();
            } catch (error) {
                console.error('Error updating display:', error);
            }
            // ‚úÖ Initialiser le drag and drop en mode edit
            if (isEditMode) {
                initDragAndDrop();
            }
        }


        function updateChart() {
            // Mise √† jour visuelle des boutons (Bar/Doughnut)
            if (typeof window.updateChartButtonsState === 'function') {
                window.updateChartButtonsState();
            }
            
            // S√©curit√© : si Chart.js n'est pas charg√©
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js is not available');
                return;
            }

            const ctx = document.getElementById('myChart').getContext('2d');

            // --- 1. CONFIGURATION DU STYLE (Dark Mode) ---
            const isDarkMode = document.body.classList.contains('dark-mode');
            const textColor = isDarkMode ? '#e0e0e0' : '#666';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const placeholderColor = isDarkMode ? 'rgba(255, 255, 255, 0.05)' : '#e9ecef';
            
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;

            // --- 2. AGR√âGATION DES DONN√âES ---
            const aggregatedItems = {};

            // ‚úÖ MODE D√âPENS√â: Utiliser les vraies transactions par cat√©gorie
            if (isRealSpendingMode && realSpendingChartData && Object.keys(realSpendingChartData).length > 0) {
                Object.keys(realSpendingChartData).forEach(category => {
                    const amount = realSpendingChartData[category];
                    if (amount > 0) {
                        aggregatedItems[category] = {
                            amount: amount,
                            color: categoryBaseColors[category] || generateRandomColor()
                        };
                    }
                });
            } 
            // ‚úÖ MODE ESTIM√â: Utiliser les items comme avant
            else {
                Object.keys(expenses).forEach(categoryKey => {
                    if (categoryKey === 'income') return;

                    expenses[categoryKey].forEach(expense => {
                        const amount = parseFloat(expense.amount) || 0;
                        if (amount > 0) {
                            const name = expense.name;
                            
                            if (aggregatedItems[name]) {
                                aggregatedItems[name].amount += amount;
                            } else {
                                let color;
                                if (customColors[name]) {
                                    // L'utilisateur a d√©fini une couleur personnalis√©e pour cet item
                                    color = customColors[name];
                                } else {
                                    // Utiliser la couleur de la cat√©gorie avec variation
                                    const categoryColor = categoryBaseColors[categoryKey] || generateRandomColor();
                                    
                                    // Calculer l'index de cet item dans sa cat√©gorie
                                    const categoryItems = expenses[categoryKey];
                                    const itemIndex = categoryItems.findIndex(e => e.name === name);
                                    
                                    // G√©n√©rer une variation bas√©e sur la couleur de cat√©gorie
                                    color = generateColorVariation(categoryColor, itemIndex, categoryItems.length);
                                }

                                aggregatedItems[name] = {
                                    amount: amount,
                                    color: color
                                };
                            }
                        }
                    });
                });
            }

            // Conversion en tableaux
            const allLabels = Object.keys(aggregatedItems);
            const allData = allLabels.map(name => aggregatedItems[name].amount);
            const allBackgroundColors = allLabels.map(name => aggregatedItems[name].color);

            // --- 3. TRI DES DONN√âES (D√©croissant) ---
            const indices = allData.map((_, i) => i);
            indices.sort((a, b) => allData[b] - allData[a]);
            
            const sortedLabels = indices.map(i => allLabels[i]);
            const sortedData = indices.map(i => allData[i]);
            const sortedColors = indices.map(i => allBackgroundColors[i]);

            // --- 4. GESTION DE L'√âTAT VIDE ---
            const t = translations[currentLanguage] || translations['en'];
            const noExpensesText = t.noExpensesYet || "No expenses yet";
            
            let chartData;
            let isEmpty = false;

            // Si aucune donn√©e r√©elle n'existe
            if (sortedLabels.length === 0) {
                isEmpty = true;
                chartData = {
                    labels: ["max"], 
                    datasets: [{
                        data: [1],
                        backgroundColor: [placeholderColor],
                        borderWidth: 0,
                        borderRadius: currentChartType === 'bar' ? 8 : 0,
                        hoverBackgroundColor: [placeholderColor]
                    }]
                };
            } else {
                // ‚úÖ Donn√©es normales - TOUTES les donn√©es avec animation
                chartData = {
                    labels: sortedLabels, // ‚úÖ Tous les labels (pas filtr√©s)
                    datasets: [{
                        data: sortedData.map((value, i) => {
                            // ‚úÖ Si cach√©, la valeur devient 0 (anim√©)
                            return hiddenItems[sortedLabels[i]] ? 0 : value;
                        }),
                        backgroundColor: sortedColors,
                        borderWidth: 0,
                        borderRadius: currentChartType === 'bar' ? 8 : 0,
                        borderColor: isDarkMode ? '#2a2a3e' : '#fff'
                    }]
                };
            }

            // --- 5. PLUGIN TEXTE CENTR√â ---
            const centerTextPlugin = {
                id: 'centerText',
                afterDraw: function(chart) {
                    if (isEmpty) {
                        const ctx = chart.ctx;
                        const width = chart.width;
                        const height = chart.height;
                        
                        ctx.save();
                        ctx.font = "bold 1.1em sans-serif";
                        ctx.textAlign = "center";
                        ctx.textBaseline = "middle";
                        ctx.fillStyle = isDarkMode ? "#6c757d" : "#adb5bd";
                        ctx.fillText(noExpensesText, width / 2, height / 2);
                        ctx.restore();
                    }
                }
            };

            // --- 6. OPTIONS DU GRAPHIQUE ---
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        bottom: 20
                    }
                },
                animation: {
                    duration: 600,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: {
                        display: !isEmpty,
                        position: 'bottom',
                        align: 'center',
                        labels: {
                            padding: 10,
                            font: { size: 11 },
                            color: textColor,
                            boxWidth: 15,
                            boxHeight: 15,
                            generateLabels: function(chart) {
                                return sortedLabels.map((label, i) => ({
                                    text: label.charAt(0).toUpperCase() + label.slice(1),
                                    fillStyle: sortedColors[i],
                                    strokeStyle: sortedColors[i],
                                    lineWidth: 0,
                                    hidden: hiddenItems[label] || false,
                                    index: i,
                                    datasetIndex: 0,
                                    fontColor: textColor
                                }));
                            }
                        },
                        onClick: function(e, legendItem, legend) {
                            const label = sortedLabels[legendItem.index];
                            hiddenItems[label] = !hiddenItems[label];
                            updateChart();
                        }
                    },
                    tooltip: {
                        enabled: !isEmpty,
                        displayColors: false,
                        callbacks: {
                            title: function() {
                                return '';
                            },
                            label: function(context) {
                                const label = context.label || '';
                                const capitalizedLabel = label.charAt(0).toUpperCase() + label.slice(1);
                                const value = currentChartType === 'bar' ? context.parsed.y : context.parsed;
                                
                                // ‚úÖ Calculer le total des items visibles uniquement
                                const visibleTotal = sortedData.reduce((sum, val, i) => {
                                    return hiddenItems[sortedLabels[i]] ? sum : sum + val;
                                }, 0);
                                
                                const percentage = ((value / visibleTotal) * 100).toFixed(1);
                                return `${capitalizedLabel}: ${currency}${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            };

            // Options sp√©cifiques
            let finalOptions;
            if (currentChartType === 'bar') {
                finalOptions = {
                    ...commonOptions,
                    scales: isEmpty ? {
                        x: { display: false },
                        y: { display: false }
                    } : {
                        x: { display: false },
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: {
                                color: textColor,
                                callback: function(value) { return currency + value; }
                            }
                        }
                    }
                };
            } else {
                finalOptions = commonOptions;
            }

            // --- 7. CR√âATION / MISE √Ä JOUR ---
            if (chart) {
                const wasEmpty = chart.data.labels.length === 1 && chart.data.labels[0] === "max";
                const typeChanged = chart.config.type !== currentChartType;

                if (typeChanged || (wasEmpty !== isEmpty)) {
                    // ‚úÖ Seulement reconstruire si le type change ou si on passe de vide √† non-vide
                    chart.destroy();
                    createNewChart();
                } else {
                    // ‚úÖ Mise √† jour douce avec animation
                    chart.data.labels = chartData.labels;
                    chart.data.datasets[0].data = chartData.datasets[0].data;
                    chart.data.datasets[0].backgroundColor = chartData.datasets[0].backgroundColor;
                    chart.options = finalOptions;
                    
                    // ‚úÖ Mode 'default' avec la dur√©e d'animation d√©finie dans options
                    chart.update({
                        duration: 600,
                        easing: 'easeInOutQuart'
                    });
                }
            } else {
                createNewChart();
            }

            function createNewChart() {
                chart = new Chart(ctx, {
                    type: currentChartType,
                    data: chartData,
                    options: finalOptions,
                    plugins: [centerTextPlugin]
                });
            }
            
            // ‚úÖ MODIFI√â : Utiliser le total calcul√© dans updateDisplay() en mode "D√©pens√©"
            let displayTotal;
            if (isRealSpendingMode && realSpendingData) {
                // Mode "D√©pens√©" : calculer le total depuis realSpendingData
                displayTotal = 0;
                Object.keys(realSpendingData).forEach(key => {
                    if (key !== '_incomeTotal') {
                        displayTotal += realSpendingData[key] || 0;
                    }
                });
            } else {
                // Mode "Estim√©" : utiliser le total des items visibles
                displayTotal = isEmpty ? 0 : sortedData.reduce((sum, value, i) => {
                    return hiddenItems[sortedLabels[i]] ? sum : sum + value;
                }, 0);
            }
            
            document.getElementById('totalAmount').textContent = `${currency}${displayTotal.toFixed(2)}`;
        }

        // ============================================
        // MONTHLY TREND CHART
        // ============================================

        let monthlyTrendChart = null;
        let monthlyTrendData = {}; // Stocker toutes les donn√©es
        let selectedTrendCategories = new Set(['total']); // Cat√©gories s√©lectionn√©es

        /**
         * Charger et afficher le graphique d'√©volution mensuelle
         */
        async function loadMonthlyTrendChart() {
            if (!currentUser || !firebase.functions) {
                console.log('Cannot load monthly trend: Firebase not initialized');
                return;
            }
            
            try {
                // Charger les 6 derniers mois de transactions
                const months = [];
                const currentDate = new Date();
                
                for (let i = 5; i >= 0; i--) {
                    const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                    months.push({
                        year: date.getFullYear(),
                        month: date.getMonth() + 1,
                        label: date.toLocaleDateString(currentLanguage, { month: 'short', year: 'numeric' })
                    });
                }
                
                // Initialiser les donn√©es
                monthlyTrendData = {
                    labels: months.map(m => m.label),
                    total: [],
                    categories: {}
                };
                
                // Initialiser les cat√©gories
                Object.keys(expenses).forEach(categoryKey => {
                    if (categoryKey !== 'income') {
                        monthlyTrendData.categories[categoryKey] = [];
                    }
                });
                
                // Charger les transactions pour chaque mois
                const getTransactions = firebase.functions().httpsCallable('getTransactions');
                
                for (const monthInfo of months) {
                    const startDate = new Date(monthInfo.year, monthInfo.month - 1, 1);
                    const endDate = new Date(monthInfo.year, monthInfo.month, 0, 23, 59, 59);
                    
                    try {
                        const result = await getTransactions({
                            startDate: startDate.toISOString(),
                            endDate: endDate.toISOString(),
                            isLabeled: true,
                            limit: 10000
                        });
                        
                        const transactions = result.data.transactions || [];
                        
                        // Calculer le total et par cat√©gorie
                        let monthTotal = 0;
                        const categoryTotals = {};
                        
                        transactions.forEach(txn => {
                            if (txn.chargedAmount < 0 && txn.category !== 'income') {
                                const amount = Math.abs(txn.chargedAmount);
                                monthTotal += amount;
                                
                                if (!categoryTotals[txn.category]) {
                                    categoryTotals[txn.category] = 0;
                                }
                                categoryTotals[txn.category] += amount;
                            }
                        });
                        
                        monthlyTrendData.total.push(monthTotal);
                        
                        // Ajouter les totaux par cat√©gorie
                        Object.keys(monthlyTrendData.categories).forEach(categoryKey => {
                            monthlyTrendData.categories[categoryKey].push(categoryTotals[categoryKey] || 0);
                        });
                        
                    } catch (error) {
                        console.error('Error loading month:', monthInfo, error);
                        monthlyTrendData.total.push(0);
                        Object.keys(monthlyTrendData.categories).forEach(categoryKey => {
                            monthlyTrendData.categories[categoryKey].push(0);
                        });
                    }
                }
                
                // G√©n√©rer les checkboxes des cat√©gories
                populateCategoryTrendCheckboxes();
                
                // Afficher le graphique
                updateMonthlyTrendChart();
                
            } catch (error) {
                console.error('Error loading monthly trend:', error);
            }
        }

        /**
         * G√©n√©rer les checkboxes de s√©lection de cat√©gories
         */
        function populateCategoryTrendCheckboxes() {
            const container = document.getElementById('categoryTrendCheckboxes');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(monthlyTrendData.categories).forEach(categoryKey => {
                const meta = categoryMetadata[categoryKey] || {
                    emoji: 'üìã',
                    displayName: categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1)
                };
                
                const label = document.createElement('label');
                label.className = 'trend-checkbox-label'; // ‚úÖ Ajoute une classe
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `trend-${categoryKey}`;
                checkbox.onchange = updateMonthlyTrendSelection;
                
                const span = document.createElement('span');
                span.textContent = `${meta.emoji} ${meta.displayName}`;
                
                label.appendChild(checkbox);
                label.appendChild(span);
                container.appendChild(label);
            });
        }

        /**
         * Mettre √† jour la s√©lection des cat√©gories
         */
        function updateMonthlyTrendSelection() {
            selectedTrendCategories.clear();
            
            // V√©rifier le total
            const totalCheckbox = document.getElementById('totalTrendCheckbox');
            if (totalCheckbox && totalCheckbox.checked) {
                selectedTrendCategories.add('total');
            }
            
            // V√©rifier les cat√©gories
            Object.keys(monthlyTrendData.categories).forEach(categoryKey => {
                const checkbox = document.getElementById(`trend-${categoryKey}`);
                if (checkbox && checkbox.checked) {
                    selectedTrendCategories.add(categoryKey);
                }
            });
            
            // Mettre √† jour le compteur
            const countBadge = document.getElementById('trendCategoriesCount');
            if (countBadge) {
                countBadge.textContent = selectedTrendCategories.size;
            }
            
            updateMonthlyTrendChart();
        }

        /**
         * Mettre √† jour le graphique d'√©volution mensuelle
         */
        function updateMonthlyTrendChart() {
            const ctx = document.getElementById('monthlyTrendChart');
            if (!ctx) return;
            
            const isDarkMode = document.body.classList.contains('dark-mode');
            const textColor = isDarkMode ? '#e0e0e0' : '#666';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            // D√©truire le graphique existant
            if (monthlyTrendChart) {
                monthlyTrendChart.destroy();
            }
            
            // Pr√©parer les datasets
            const datasets = [];
            
            // Ajouter le total si s√©lectionn√©
            if (selectedTrendCategories.has('total')) {
                datasets.push({
                    label: translations[currentLanguage].total || 'Total',
                    data: monthlyTrendData.total,
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                });
            }
            
            // Ajouter les cat√©gories s√©lectionn√©es
            Object.keys(monthlyTrendData.categories).forEach(categoryKey => {
                if (selectedTrendCategories.has(categoryKey)) {
                    const color = categoryBaseColors[categoryKey] || generateRandomColor();
                    const meta = categoryMetadata[categoryKey] || {
                        displayName: categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1)
                    };
                    
                    datasets.push({
                        label: meta.displayName,
                        data: monthlyTrendData.categories[categoryKey],
                        borderColor: color,
                        backgroundColor: color + '20', // Ajoute transparence
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: color,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    });
                }
            });
            
            monthlyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyTrendData.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        intersect: false,
                        axis: 'x' // ‚úÖ Ajoute ceci
                    },
                    plugins: {
                        legend: {
                            display: datasets.length > 1,
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                padding: 10,
                                font: { size: 11 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${currency}${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor,
                                callback: function(value) {
                                    return currency + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        x: {
                            ticks: {
                                color: textColor
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
        }


        /**
         * Toggle du dropdown de s√©lection de cat√©gories
         */
        function toggleTrendCategoriesDropdown() {
            const dropdown = document.getElementById('trendCategoriesDropdown');
            if (!dropdown) return;
            
            const isVisible = dropdown.style.display === 'block';
            dropdown.style.display = isVisible ? 'none' : 'block';
            
            // Fermer si on clique ailleurs
            if (!isVisible) {
                setTimeout(() => {
                    document.addEventListener('click', closeTrendDropdownOutside);
                }, 0);
            }
        }

        /**
         * Fermer le dropdown si on clique √† l'ext√©rieur
         */
        function closeTrendDropdownOutside(e) {
            const dropdown = document.getElementById('trendCategoriesDropdown');
            const btn = document.getElementById('trendCategoriesBtn');
            
            if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.style.display = 'none';
                document.removeEventListener('click', closeTrendDropdownOutside);
            }
        }



        async function resetExpenses() {
            const t = translations[currentLanguage] || translations['en'];
            
            if (confirm(t.resetAllConfirm || 'Reset all to 0?')) {
                try {
                    // 1. On parcourt toutes les cat√©gories existantes (y compris les personnalis√©es)
                    Object.keys(expenses).forEach(categoryKey => {
                        // On parcourt chaque item de la cat√©gorie
                        if (Array.isArray(expenses[categoryKey])) {
                            expenses[categoryKey].forEach(item => {
                                // On met juste le montant √† 0
                                item.amount = 0;
                            });
                        }
                    });

                    // 2. Sauvegarde FORCEE dans Firebase
                    if (currentUser) {
                        // On utilise .update() pour sauvegarder l'√©tat actuel (avec les 0)
                        await db.collection('users').doc(currentUser.uid).update({
                            expenses: expenses,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }

                    // 3. Mettre √† jour l'affichage
                    updateDisplay();
                    
                } catch (error) {
                    console.error('Erreur lors du reset:', error);
                    alert('Erreur lors de la sauvegarde : ' + error.message);
                    
                    // En cas d'erreur, on recharge pour ne pas laisser l'interface incoh√©rente
                    loadUserData();
                }
            }
        }

        let isAdvancedView = false;

        /**
         * Ouvrir le modal de couleurs
         */
        function openColorEditor() {
            const modal = document.getElementById('colorEditorModal');
            modal.style.display = 'flex';
            isAdvancedView = false;
            populateCategoryColors();
        }


        /**
         * Fermer le modal
         */
        function closeColorEditor() {
            const modal = document.getElementById('colorEditorModal');
            modal.style.display = 'none';
        }


        /**
         * Toggle entre vue simple (cat√©gories) et avanc√©e (items)
         */
        function toggleAdvancedView() {
            isAdvancedView = !isAdvancedView;
            
            const categoryView = document.getElementById('categoryColorsView');
            const itemView = document.getElementById('itemColorsView');
            
            if (isAdvancedView) {
                categoryView.style.display = 'none';
                itemView.style.display = 'block';
                populateItemColors();
            } else {
                categoryView.style.display = 'block';
                itemView.style.display = 'none';
                populateCategoryColors();
            }
        }


        /**
         * Remplir la liste des couleurs de cat√©gories
         */
        function populateCategoryColors() {
            const container = document.getElementById('categoryColorsList');
            container.innerHTML = '';
            
            Object.keys(expenses).forEach(categoryKey => {
                if (categoryKey === 'income') return; // Skip income
                
                const categoryColor = categoryBaseColors[categoryKey] || generateRandomColor();
                const categoryName = categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1);
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'color-item';
                itemDiv.innerHTML = `
                    <div class="color-item-name">
                        <div class="color-input-wrapper">
                            <div class="color-preview" style="background: ${categoryColor}"></div>
                            <input type="color" value="${categoryColor}" onchange="updateCategoryColor('${categoryKey}', this.value)">
                        </div>
                        <span>${categoryName}</span>
                    </div>
                    <span style="font-size: 12px; color: #999;">${expenses[categoryKey].length} items</span>
                `;
                
                container.appendChild(itemDiv);
            });
        }

        /**
         * Remplir la liste des couleurs d'items (vue avanc√©e)
         */
        function populateItemColors() {
            const container = document.getElementById('itemColorsList');
            container.innerHTML = '';
            
            Object.keys(expenses).forEach(categoryKey => {
                if (categoryKey === 'income') return;
                
                const categoryColor = categoryBaseColors[categoryKey] || generateRandomColor();
                const categoryName = categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1);
                
                expenses[categoryKey].forEach((expense, index) => {
                    const itemName = expense.name;
                    const itemColor = customColors[itemName] || generateColorVariation(categoryColor, index, expenses[categoryKey].length);
                    
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'color-item';
                    itemDiv.innerHTML = `
                        <div class="color-item-name">
                            <div class="color-input-wrapper">
                                <div class="color-preview" style="background: ${itemColor}"></div>
                                <input type="color" value="${itemColor}" onchange="updateItemColor('${itemName}', this.value)">
                            </div>
                            <div>
                                <div>${itemName}</div>
                                <span class="item-category-badge">${categoryName}</span>
                            </div>
                        </div>
                        ${customColors[itemName] ? `<button class="reset-item-color-btn" onclick="resetItemColor('${itemName}')">Reset</button>` : ''}
                    `;
                    
                    container.appendChild(itemDiv);
                });
            });
        }


        /**
         * Mettre √† jour la couleur d'une cat√©gorie
         */
        function updateCategoryColor(categoryKey, color) {
            categoryBaseColors[categoryKey] = color;
            window.categoryBaseColors = categoryBaseColors; // ‚úÖ Synchroniser
            populateCategoryColors();
        }


        /**
         * Mettre √† jour la couleur d'un item
         */
        function updateItemColor(itemName, color) {
            customColors[itemName] = color;
            populateItemColors(); // Rafra√Æchir la vue
        }

        /**
         * R√©initialiser la couleur d'un item (retour √† la variation de cat√©gorie)
         */
        function resetItemColor(itemName) {
            delete customColors[itemName];
            populateItemColors();
        }

        /**
         * G√©n√©rer des couleurs al√©atoires pour toutes les cat√©gories
         */
        function randomizeAllColors() {
            Object.keys(expenses).forEach(categoryKey => {
                if (categoryKey !== 'income') {
                    categoryBaseColors[categoryKey] = generateRandomColor();
                }
            });
            
            if (isAdvancedView) {
                populateItemColors();
            } else {
                populateCategoryColors();
            }
        }

        /**
         * Sauvegarder les couleurs
         */
        async function saveColors() {
            try {
                await firebase.firestore()
                    .collection('users')
                    .doc(currentUser.uid)
                    .set({
                        categoryBaseColors: categoryBaseColors,
                        customColors: customColors
                    }, { merge: true });
                
                closeColorEditor();
                
                // ‚úÖ Forcer la destruction et recr√©ation du graphique
                if (chart) {
                    chart.destroy();
                    chart = null;
                }
                
                // ‚úÖ Petit d√©lai pour laisser le temps au DOM
                setTimeout(() => {
                    updateChart();
                    updateDisplay();
                }, 50);
                
                showToast('Colors saved!');
            } catch (error) {
                console.error('Error saving colors:', error);
                showToast('Error saving colors');
            }
        }

        // G√©n√©rer une teinte al√©atoire (hue)
        function generateRandomHue() {
            return Math.floor(Math.random() * 360);
        }

        // G√©n√©rer une couleur compl√®tement al√©atoire
        function generateRandomColor() {
            return '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
        }

        // G√©n√©rer une variation d'une teinte donn√©e
        function generateColorVariation(baseHue) {
            // Variation de ¬±30 degr√©s autour de la teinte de base
            const hue = (baseHue + (Math.random() * 60 - 30) + 360) % 360;
            const saturation = 60 + Math.random() * 30; // 60-90%
            const lightness = 45 + Math.random() * 20;  // 45-65%
            
            return hslToHex(hue, saturation, lightness);
        }

        // Convertir HSL en HEX
        function hslToHex(h, s, l) {
            l /= 100;
            const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }


        // Restore edit mode UI after updateDisplay()
        function restoreEditMode() {
            if (!isEditMode) return;
            
            const editBtn = document.getElementById('editModeBtn');
            const editBtnText = document.getElementById('editBtnText');
            const t = translations[currentLanguage] || translations['en'];
            
            if (editBtn) editBtn.classList.add('active');
            if (editBtnText) editBtnText.textContent = t.doneEditing || 'Done Editing';
            
            const categoryControls = document.querySelectorAll('.category-controls');
            const renameButtons = document.querySelectorAll('.rename-btn');
            const addBtn = document.querySelector('button[onclick*="addNewCategory"]');
            
            if (addBtn) addBtn.style.display = 'block';
            categoryControls.forEach(c => c.classList.add('show'));
            renameButtons.forEach(btn => {
                if (!btn.classList.contains('rename-btn-income')) {
                    btn.style.display = 'inline-block';
                }
            });
        }


        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            const editBtn = document.getElementById('editModeBtn');
            const categoryControls = document.querySelectorAll('.category-controls');
            const renameButtons = document.querySelectorAll('.rename-btn');
            const itemMoveBtns = document.querySelectorAll('.item-move-btns');
            const itemRenameBtns = document.querySelectorAll('.item-rename-btn');
            
            if (isEditMode) {
                // Mode Edit activ√©
                if (editBtn) editBtn.classList.add('active');
                
                // Afficher les contr√¥les
                categoryControls.forEach(c => c.classList.add('show'));
                renameButtons.forEach(btn => {
                    if (!btn.classList.contains('rename-btn-income')) {
                        btn.style.display = 'inline-block';
                    }
                });
                itemMoveBtns.forEach(btns => btns.classList.add('show'));
                itemRenameBtns.forEach(btn => btn.classList.add('show'));
                
            } else {
                // Mode Edit d√©sactiv√©
                if (editBtn) editBtn.classList.remove('active');
                
                // Cacher les contr√¥les
                categoryControls.forEach(c => c.classList.remove('show'));
                renameButtons.forEach(btn => btn.style.display = 'none');
                itemMoveBtns.forEach(btns => btns.classList.remove('show'));
                itemRenameBtns.forEach(btn => btn.classList.remove('show'));
            }
            
            // On reg√©n√®re l'affichage pour mettre √† jour les boutons supprimer/d√©placer dans la liste
            updateDisplay();
        }



        // ============================================
        // DRAG AND DROP - R√©organisation des items (Mobile + Desktop)
        // ============================================

        let draggedItem = null;
        let draggedCategory = null;
        let draggedIndex = null;
        let placeholder = null;

        // Initialiser les √©v√©nements de drag (appel√© apr√®s updateDisplay)
        function initDragAndDrop() {
            const items = document.querySelectorAll('.expense-item[draggable="true"]');
            
            items.forEach(item => {
                // Desktop events
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
                
                // Mobile/Touch events
                const handle = item.querySelector('.drag-handle');
                if (handle) {
                    handle.addEventListener('touchstart', handleTouchStart, { passive: false });
                    handle.addEventListener('touchmove', handleTouchMove, { passive: false });
                    handle.addEventListener('touchend', handleTouchEnd, { passive: false });
                }
            });
        }

        // ============================================
        // DESKTOP DRAG HANDLERS
        // ============================================

        function handleDragStart(e) {
            draggedItem = this;
            draggedCategory = this.dataset.category;
            draggedIndex = parseInt(this.dataset.index);
            
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            
            e.dataTransfer.dropEffect = 'move';
            
            if (!draggedItem) return;
            
            const targetItem = this;
            if (targetItem === draggedItem) return;
            
            const targetCategory = targetItem.dataset.category;
            if (targetCategory !== draggedCategory) return;
            
            // Cr√©er/d√©placer la barre d'insertion
            showInsertionBar(targetItem, e);
            
            return false;
        }

        function handleDrop(e) {

            if (e.stopPropagation) {
                e.stopPropagation();
            }
            if (e.preventDefault) {
                e.preventDefault();
            }
            
            const targetItem = this;
            if (!targetItem || !draggedItem) {
                removeInsertionBar();
                return false;
            }
            
            const targetCategory = targetItem.dataset.category;
            const targetIndex = parseInt(targetItem.dataset.index);
            const insertPosition = targetItem.dataset.insertPosition || 'after';
            
            if (draggedCategory !== targetCategory) {
                removeInsertionBar();
                return false;
            }
            
            if (draggedIndex === targetIndex) {
                removeInsertionBar();
                return false;
            }
            
            // Calculer le nouvel index selon la position d'insertion
            let newIndex = targetIndex;
            if (insertPosition === 'after') {
                newIndex = targetIndex + 1;
            }
            
            // Ajuster si on d√©place vers le bas
            if (draggedIndex < newIndex) {
                newIndex--;
            }
            
            // R√©organiser
            reorderItems(draggedCategory, draggedIndex, newIndex);
            
            removeInsertionBar();
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            removeInsertionBar();
            
            draggedItem = null;
            draggedCategory = null;
            draggedIndex = null;
        }

        // ============================================
        // MOBILE/TOUCH HANDLERS
        // ============================================

        let touchStartY = 0;
        let touchCurrentItem = null;

        function handleTouchStart(e) {
            e.preventDefault();
            
            const item = e.target.closest('.expense-item');
            if (!item) return;
            
            touchCurrentItem = item;
            draggedItem = item;
            draggedCategory = item.dataset.category;
            draggedIndex = parseInt(item.dataset.index);
            touchStartY = e.touches[0].clientY;
            
            item.classList.add('dragging');
        }

        function handleTouchMove(e) {
            e.preventDefault();
            
            if (!touchCurrentItem) return;
            
            const touch = e.touches[0];
            const currentY = touch.clientY;
            
            // Trouver l'item sous le doigt
            const elementAtPoint = document.elementFromPoint(touch.clientX, currentY);
            const targetItem = elementAtPoint?.closest('.expense-item');
            
            if (targetItem && targetItem !== touchCurrentItem && targetItem.dataset.category === draggedCategory) {
                showInsertionBar(targetItem, { clientY: currentY });
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            
            if (!touchCurrentItem) return;
            
            const touch = e.changedTouches[0];
            const elementAtPoint = document.elementFromPoint(touch.clientX, touch.clientY);
            const targetItem = elementAtPoint?.closest('.expense-item');
            
            if (targetItem && targetItem !== touchCurrentItem) {
                const targetCategory = targetItem.dataset.category;
                const targetIndex = parseInt(targetItem.dataset.index);
                const insertPosition = targetItem.dataset.insertPosition || 'after';
                
                if (draggedCategory === targetCategory && draggedIndex !== targetIndex) {
                    // Calculer le nouvel index
                    let newIndex = targetIndex;
                    if (insertPosition === 'after') {
                        newIndex = targetIndex + 1;
                    }
                    
                    // Ajuster si on d√©place vers le bas
                    if (draggedIndex < newIndex) {
                        newIndex--;
                    }
                    
                    reorderItems(draggedCategory, draggedIndex, newIndex);
                }
            }
            
            touchCurrentItem.classList.remove('dragging');
            removeInsertionBar();
            
            touchCurrentItem = null;
            draggedItem = null;
            draggedCategory = null;
            draggedIndex = null;
        }

        // ============================================
        // HELPERS
        // ============================================

        function showInsertionBar(targetItem, event) {
            removeInsertionBar();
            
            const rect = targetItem.getBoundingClientRect();
            const mouseY = event.clientY;
            const itemMiddle = rect.top + (rect.height / 2);
            
            // Stocker l'info sur o√π ins√©rer
            targetItem.dataset.insertPosition = mouseY < itemMiddle ? 'before' : 'after';
            
            // Ins√©rer avant ou apr√®s selon la position de la souris
            if (mouseY < itemMiddle) {
                targetItem.classList.add('insert-before');
            } else {
                targetItem.classList.add('insert-after');
            }
        }

        function removeInsertionBar() {
            document.querySelectorAll('.expense-item').forEach(item => {
                item.classList.remove('insert-before', 'insert-after');
            });
        }

        function reorderItems(category, fromIndex, toIndex) {
            const categoryItems = expenses[category];
            
            // S√©curit√© : v√©rifier les index
            if (fromIndex < 0 || fromIndex >= categoryItems.length) return;
            if (toIndex < 0 || toIndex > categoryItems.length) return;
            if (fromIndex === toIndex) return;
            
            const draggedItemData = categoryItems[fromIndex];
            
            // Retirer l'item de sa position d'origine
            categoryItems.splice(fromIndex, 1);
            
            // Ins√©rer √† la nouvelle position
            categoryItems.splice(toIndex, 0, draggedItemData);
            
            // Sauvegarder et rafra√Æchir
            saveExpenses();
            updateDisplay();
        }


        // ============================================
        // √âDITION INLINE DU NOM
        // ============================================

        function makeNameEditable(element, category, index) {
            // Emp√™cher le drag pendant l'√©dition
            const item = element.closest('.expense-item');
            if (item) {
                item.setAttribute('draggable', 'false');
            }
            
            const currentName = element.textContent;
            
            // Cr√©er un input
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'expense-name-input';
            
            // Remplacer le span par l'input
            element.replaceWith(input);
            input.focus();
            input.select();
            
            // Sauvegarder sur Enter ou perte de focus
            const saveEdit = () => {
                const newName = input.value.trim();
                
                if (newName && newName !== currentName) {
                    // Mettre √† jour le nom
                    expenses[category][index].name = newName;
                    saveExpenses();
                }
                
                // Restaurer l'affichage
                updateDisplay();
            };
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    updateDisplay(); // Annuler sans sauvegarder
                }
            });
        }





        // ============================================
        // COMPARE MODE - Real Spending vs Budget
        // ============================================
        
        let compareMode = false;
        let realSpendingData = {};
        
        /**
         * Toggle compare mode on/off
         */
        function toggleCompareMode() {
            const compareBtn = document.getElementById('compareBtn');
            const monthSelect = document.getElementById('compareMonth');
            
            compareMode = !compareMode;
            
            if (compareMode) {
                // On ajoute la classe active pour le style CSS
                if (compareBtn) compareBtn.classList.add('active');
                
                if (monthSelect) {
                    monthSelect.style.display = 'inline-block';
                }
                
                setTimeout(() => {
                    populateMonthDropdown();
                    loadRealSpending();
                }, 50);
                
            } else {
                // On retire la classe active
                if (compareBtn) compareBtn.classList.remove('active');
                
                if (monthSelect) monthSelect.style.display = 'none';
                
                realSpendingData = {};
                updateDisplay();
            }
            
            // Force hide item rename buttons based on edit mode
            setTimeout(() => {
                const itemRenameButtons = document.querySelectorAll('.item-rename-btn');
                itemRenameButtons.forEach(btn => {
                    btn.style.display = isEditMode ? 'inline-block' : 'none';
                });
            }, 100);
        }


        /**
         * Populate month dropdown with last 12 months
         */
        function populateMonthDropdown() {
            const select = document.getElementById('compareMonth');
            if (!select) {
                console.error('compareMonth select not found');
                return;
            }
            
            select.innerHTML = ''; // Clear
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Generate last 12 months
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentYear, currentMonth - i, 1);
                const monthName = date.toLocaleString(currentLanguage || 'en', { month: 'long', year: 'numeric' });
                const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                const option = document.createElement('option');
                option.value = value;
                option.textContent = monthName;
                if (i === 0) option.selected = true; // Current month selected by default
                
                select.appendChild(option);
            }
        }
        
        /**
         * Load real spending data from transactions
         */
        async function loadRealSpending() {
            if (!firebase.functions || !currentUser) {
                console.log('Cannot load real spending: Firebase not initialized or user not logged in');
                return;
            }
            
            const monthKey = document.getElementById('compareMonth')?.value;
            if (!monthKey) return;
            
            const [year, month] = monthKey.split('-');
            
            // Calculate start and end dates for the month
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);
            
            try {
                const getTransactions = firebase.functions().httpsCallable('getTransactions');
                const result = await getTransactions({
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString(),
                    isLabeled: true, // Only labeled transactions
                    limit: 1000
                });
                
                const transactions = result.data.transactions || [];
                
                // Group by category and sum amounts
                realSpendingData = {};
                let realIncomeTotal = 0; // ‚úÖ NOUVEAU : Calculer le revenu total
                
                transactions.forEach(txn => {
                    // ‚úÖ NOUVEAU : Traiter les revenus s√©par√©ment
                    if (txn.category === 'income' && txn.chargedAmount > 0) {
                        realIncomeTotal += Math.abs(txn.chargedAmount);
                    }
                    // Traiter les d√©penses
                    else if (txn.category && txn.category !== 'income') {
                        if (!realSpendingData[txn.category]) {
                            realSpendingData[txn.category] = 0;
                        }
                        // Prendre la valeur absolue (ignorer le signe n√©gatif)
                        // Et ignorer les montants positifs (remboursements/revenus)
                        if (txn.chargedAmount < 0) {
                            realSpendingData[txn.category] += Math.abs(txn.chargedAmount);
                        }
                    }
                });
                
                // ‚úÖ NOUVEAU : Stocker le revenu total pour l'affichage
                realSpendingData._incomeTotal = realIncomeTotal;
                                
                // Refresh display with comparison
                updateDisplay();
                
            } catch (error) {
                console.error('Error loading real spending:', error);
            }
        }

        // ============================================
        // BUDGET MODE: ESTIMATED VS REAL SPENDING
        // ============================================

        let isRealSpendingMode = false;
        let realSpendingChartData = {};

        function toggleBudgetMode() {
            const toggle = document.getElementById('budgetModeToggle');
            
            isRealSpendingMode = toggle.checked;
            console.log('üîÑ Toggle changed to:', isRealSpendingMode);
            
            if (isRealSpendingMode) {
                // Mode "D√©pens√©" activ√©
                loadRealSpendingForChart();
            } else {
                // Mode "Estim√©" activ√©
                realSpendingChartData = {};
                updateChart();
            }
            
            setTimeout(() => {
                console.log('üíæ Saving isRealSpendingMode:', isRealSpendingMode);
                saveUserData();
            }, 100);
        }

        /**
         * Load real spending data for chart
        */

        async function loadRealSpendingForChart() {
            try {
                console.log('üîç Step 1: Start');
                
                if (!firebase.functions || !currentUser) {
                    console.log('Cannot load real spending: Firebase not initialized or user not logged in');
                    return;
                }
                
                console.log('üîç Step 2: Firebase OK');
                
                const monthSelect = document.getElementById('compareMonth');
                console.log('üîç Step 3: monthSelect =', monthSelect);
                
                const monthKey = monthSelect ? monthSelect.value : null;
                console.log('üîç Step 4: monthKey =', monthKey);
                
                if (!monthKey) {
                    console.log('‚ö†Ô∏è No monthKey, returning');
                    return;
                }
                
                console.log('üîç Step 5: Splitting monthKey');
                const [year, month] = monthKey.split('-');
                console.log('üîç Step 6: year =', year, 'month =', month);
                
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59);
                console.log('üîç Step 7: Dates created');
                
                const getTransactions = firebase.functions().httpsCallable('getTransactions');
                console.log('üîç Step 8: Calling getTransactions');
                
                const result = await getTransactions({
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString(),
                    isLabeled: true,
                    limit: 1000
                });
                
                console.log('üîç Step 9: Got result');
                
                const transactions = result.data.transactions || [];
                console.log('üîç Step 10: transactions count =', transactions.length);
                
                realSpendingChartData = {};
                
                transactions.forEach(txn => {
                    if (txn.category && txn.category !== 'income') {
                        if (!realSpendingChartData[txn.category]) {
                            realSpendingChartData[txn.category] = 0;
                        }
                        if (txn.chargedAmount < 0) {
                            realSpendingChartData[txn.category] += Math.abs(txn.chargedAmount);
                        }
                    }
                });
                
                console.log('üîç Step 11: Data aggregated');
                
                Object.keys(realSpendingChartData).forEach(category => {
                    if (!categoryBaseColors[category]) {
                        categoryBaseColors[category] = generateRandomColor();
                    }
                });
                
                console.log('üîç Step 12: Colors assigned');
                
                updateChart();
                
                console.log('üîç Step 13: Chart updated ‚úÖ');
                
            } catch (error) {
                console.error('üí• Error at some step:', error);
                console.error('üí• Error stack:', error.stack);
            }
        }

        /**
         * Generate random color for category
         */
        function generateRandomColor() {
            const hue = Math.floor(Math.random() * 360);
            const saturation = 65 + Math.floor(Math.random() * 20); // 65-85%
            const lightness = 55 + Math.floor(Math.random() * 15);  // 55-70%
            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }




        /**
         * Get comparison info for a category
         */
        function getComparisonInfo(category, budget) {
            if (!compareMode || !realSpendingData[category]) {
                return null;
            }
            
            const real = realSpendingData[category];
            const diff = real - budget;
            const diffPercent = budget > 0 ? ((diff / budget) * 100).toFixed(0) : 0;
            
            let status = 'neutral';
            if (Math.abs(diffPercent) <= 10) {
                status = 'neutral'; // Within 10%
            } else if (diff > 0) {
                status = 'positive'; // Over budget (bad)
            } else {
                status = 'negative'; // Under budget (good)
            }
            
            return {
                real: real,
                budget: budget,
                diff: diff,
                diffPercent: diffPercent,
                status: status
            };
        }
        
        /**
         * Render comparison info HTML
         */
        function renderComparisonInfo(category, budget) {
            const info = getComparisonInfo(category, budget);
            if (!info) return '';
            
            // ‚úÖ AJOUT√â : R√©cup√©rer les traductions
            const t = translations[currentLanguage] || translations['en'];
            
            const emoji = info.status === 'negative' ? 'üü¢' : info.status === 'positive' ? 'üî¥' : 'üü°';
            
            // Calculer le pourcentage utilis√©
            const usedPercent = budget > 0 ? Math.round((info.real / budget) * 100) : 0;
            
            // Message selon si over ou under budget
            let message;
            if (info.diff > 0) {
                // Over budget
                message = `${t.overBy || 'Over by'} ${currency}${Math.abs(info.diff).toFixed(0)} (${usedPercent}% ${t.used || 'used'})`;
            } else if (info.diff < 0) {
                // Under budget
                message = `${t.underBy || 'Under by'} ${currency}${Math.abs(info.diff).toFixed(0)} (${usedPercent}% ${t.used || 'used'})`;
            } else {
                // Exact
                message = `${t.exactly || 'Exact match'} (100% ${t.used || 'used'})`;
            }
            
            const progressPercent = Math.min((info.real / info.budget) * 100, 150);
            
            return `
                <div class="compare-info">
                    <div class="budget-label">${t.budget || 'Budget'}: ${currency}${info.budget.toFixed(0)}</div>
                    <div class="real-label">${t.real || 'Real'}: ${currency}${info.real.toFixed(0)}</div>
                    <div class="diff ${info.status}">${message} ${emoji}</div>
                </div>
                <div class="compare-progress">
                    <div class="compare-progress-bar ${info.status === 'positive' ? 'over-budget' : info.status === 'negative' ? 'under-budget' : 'near-budget'}" 
                         style="width: ${progressPercent}%">
                    </div>
                </div>
            `;
        }


        async function deleteExpenseItem(category, index) {
            const t = translations[currentLanguage] || translations['en'];
            if (!confirm(t.deleteItemConfirm || 'Delete this item?')) return;
            
            if (!expenses[category] || !expenses[category][index]) return;
            
            try {
                // Afficher l'overlay
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingOverlayText');
                const subtextEl = document.getElementById('loadingOverlaySubtext');
                
                if (overlay) {
                    if (textEl) textEl.textContent = t.deletingItem || 'Deleting item...';
                    if (subtextEl) subtextEl.textContent = t.pleaseWait || 'Please wait';
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                expenses[category].splice(index, 1);
                
                // If category is now empty, ask if user wants to delete the whole category
                if (expenses[category].length === 0) {
                    // Cacher l'overlay avant de demander confirmation
                    if (overlay) {
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                    
                    if (confirm(t.lastItemConfirm || 'Delete entire category?')) {
                        deleteCategory(category);
                        return;
                    }
                }
                
                // S'il reste des items, sauvegarder simplement les changements
                await saveUserData();
                updateDisplay();
                setTimeout(() => restoreEditMode(), 50);
                
                // Cacher l'overlay
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            } catch (error) {
                // Cacher l'overlay en cas d'erreur
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                console.error('Error deleting item:', error);
                alert('Error deleting item: ' + error.message);
            }
        }


        async function addNewCategory() {
            const t = translations[currentLanguage] || translations['en'];
            
            const categoryName = prompt(t.enterCategoryName || 'Enter category name:');
            if (!categoryName) return;
            
            const categoryKey = categoryName.toLowerCase().replace(/\s+/g, '_');
            
            if (expenses[categoryKey]) {
                alert(t.categoryExistsAlert || 'Category already exists!');
                return;
            }
            
            const emoji = await showEmojiPicker('üìã');
            if (!emoji) return; // L'utilisateur a annul√©
            
            const itemName = prompt(t.enterFirstItem || 'Enter first item name:') || 'Item';
            
            // Create the new category with the first item
            expenses[categoryKey] = [{ name: itemName, amount: 0 }];
            categoryOrder.push(categoryKey);
            
            // Store metadata
            categoryMetadata[categoryKey] = {
                emoji: emoji,
                displayName: categoryName
            };
            
            // Generate the stats ID and expenses ID
            const statsId = `${categoryKey}Stats`;
            const expensesId = `${categoryKey}Expenses`;
            
            // ‚úÖ Rendre le nom cliquable uniquement en mode Edit
            const nameHTML = isEditMode 
                ? `<span class="category-name-editable" onclick="renameCategory('${categoryKey}')" style="cursor: pointer;">${categoryName}</span>`
                : categoryName;
            
            // Create the HTML structure
            const categorySection = document.createElement('div');
            categorySection.className = 'category-section';
            categorySection.id = `category-${categoryKey}`;
            categorySection.innerHTML = `
                <div class="category-title">
                    ${emoji} ${nameHTML}
                </div>
                <div class="category-stats" id="${statsId}"></div>
                <div class="category-controls ${isEditMode ? 'show' : ''}">
                    <button class="category-btn" onclick="moveCategoryUp('${categoryKey}')">
                        <span data-translate="moveUp">${t.moveUp || 'Move Up'}</span>
                    </button>
                    <button class="category-btn" onclick="moveCategoryDown('${categoryKey}')">
                        <span data-translate="moveDown">${t.moveDown || 'Move Down'}</span>
                    </button>
                    <button class="category-btn" onclick="addItemToCategory('${categoryKey}')">
                        <span data-translate="addItem">${t.addItem || 'Add Item'}</span>
                    </button>
                    <button class="category-btn danger" onclick="deleteCategory('${categoryKey}')">
                        <img src="img/icons/trash.svg" alt="Delete" class="category-delete-icon">
                        <span data-translate="deleteCategory">${t.deleteCategory || 'Delete Category'}</span>
                    </button>
                </div>
                <div id="${expensesId}"></div>
            `;
            
            // Add to the expenses list
            document.getElementById('expensesList').appendChild(categorySection);

            // Save to Firebase FIRST before calling updateDisplay
            saveUserData().then(() => {
                updateDisplay();
            }).catch(error => {
                console.error('Error saving new category:', error);
                alert(t.errorCreatingCategory || 'Error creating category. Please try again.');
            });
        }


        // ============================================
        // == D√âBUT DU CODE CORRIG√â ==
        // ============================================

        async function deleteCategory(categoryKey) {
            const t = translations[currentLanguage] || translations['en'];
            
            if (categoryKey === 'income') {
                showToast(t.cannotDeleteIncome || 'Cannot delete Income category.', 'error');
                return;
            }
            
            function getDisplayName(catKey) {
                if (categoryMetadata[catKey] && categoryMetadata[catKey].displayName) {
                    return categoryMetadata[catKey].displayName;
                }
                return catKey.charAt(0).toUpperCase() + catKey.slice(1);
            }
            
            const displayName = getDisplayName(categoryKey);
            const total = calculateCategoryTotal(categoryKey);
            
            const confirmMessage = t.deleteCategoryConfirm
                .replace('{name}', displayName)
                .replace('{amount}', `${currency}${total.toFixed(2)}`);
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // Afficher l'overlay
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingOverlayText');
                const subtextEl = document.getElementById('loadingOverlaySubtext');
                
                if (overlay) {
                    if (textEl) textEl.textContent = t.deletingCategory || 'Deleting category...';
                    if (subtextEl) subtextEl.textContent = t.updatingTransactions || 'Updating transactions...';
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                // Appeler la Cloud Function pour unlabel les transactions
                const deleteCategoryFunc = firebase.functions().httpsCallable('deleteCategory');
                const result = await deleteCategoryFunc({
                    categoryName: categoryKey
                });
                                
                // Supprimer localement
                delete expenses[categoryKey];
                delete categoryMetadata[categoryKey];
                
                // Retirer de l'ordre
                const index = categoryOrder.indexOf(categoryKey);
                if (index !== -1) {
                    categoryOrder.splice(index, 1);
                }
                
                // ‚úÖ D'abord supprimer explicitement dans Firebase
                await db.collection('users').doc(currentUser.uid).update({
                    [`expenses.${categoryKey}`]: firebase.firestore.FieldValue.delete(),
                    [`categoryMetadata.${categoryKey}`]: firebase.firestore.FieldValue.delete()
                });
                
                // ‚úÖ Utiliser saveUserData() qui pr√©serve TOUT (y compris credentials)
                await saveUserData();
                                
                // Actualiser l'affichage
                updateDisplay();
                setTimeout(() => restoreEditMode(), 50);

                // Cacher l'overlay
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                // ‚úÖ Toast avec le nombre de transactions unlabeled
                showToast(t.categoryDeletedSuccess.replace('{count}', result.data.unlabeledCount), 'success');
                
            } catch (error) {
                // Cacher l'overlay en cas d'erreur
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                console.error('Error deleting category:', error);
                showToast(t.errorDeletingCategory + ' ' + error.message, 'error');
            }
        }


        async function addItemToCategory(categoryKey) {
            const t = translations[currentLanguage] || translations['en'];
            const itemName = prompt(t.enterNewItemName || 'Enter new item name:');
            if (!itemName) return;
            
            try {
                // Afficher l'overlay
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingOverlayText');
                const subtextEl = document.getElementById('loadingOverlaySubtext');
                
                if (overlay) {
                    if (textEl) textEl.textContent = t.addingItem || 'Adding item...';
                    if (subtextEl) subtextEl.textContent = t.pleaseWait || 'Please wait';
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                if (!expenses[categoryKey]) {
                    expenses[categoryKey] = [];
                }
                
                expenses[categoryKey].push({ name: itemName, amount: 0 });
                await saveUserData();
                updateDisplay();
                setTimeout(() => restoreEditMode(), 50);
                
                // Cacher l'overlay
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            } catch (error) {
                // Cacher l'overlay en cas d'erreur
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                console.error('Error adding item:', error);
                alert('Error adding item: ' + error.message);
            }
        }

        function moveCategoryUp(categoryKey) {
            const index = categoryOrder.indexOf(categoryKey);
            
            // Emp√™che de monter au-dessus de 'income' (qui est toujours en position 0)
            if (index > 1) { 
                // Swap in the order array
                [categoryOrder[index - 1], categoryOrder[index]] = [categoryOrder[index], categoryOrder[index - 1]];
                
                // Save to Firebase first
                saveUserData().then(() => {
                    // Then update the visual order
                    renderCategoriesInOrder();
                }).catch(error => {
                    console.error('Error moving category:', error);
                    alert('Error moving category. Please try again.');
                });
            } else if (index === 1) {
                // La cat√©gorie est juste apr√®s 'income' - on ne peut pas monter plus haut
                alert('This category is already at the top of the expenses list (after Income).');
            }
        }
        
        function moveCategoryDown(categoryKey) {
            const index = categoryOrder.indexOf(categoryKey);
        
            // Emp√™che 'income' de bouger
            if (categoryKey === 'income') {
                return;
            }
        
            if (index < categoryOrder.length - 1 && index !== -1) {
                // Swap in the order array
                [categoryOrder[index], categoryOrder[index + 1]] = [categoryOrder[index + 1], categoryOrder[index]];
                
                // Save to Firebase first
                saveUserData().then(() => {
                    // Then update the visual order
                    renderCategoriesInOrder();
                }).catch(error => {
                    console.error('Error moving category:', error);
                    alert('Error moving category. Please try again.');
                });
            }
        }

        function renderCategoriesInOrder() {
            const expensesList = document.getElementById('expensesList');
            
            
            // Create a document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Re-append categories in the correct order, but ONLY if they exist in expenses
            categoryOrder.forEach(categoryKey => {
                // Skip if category was deleted or doesn't exist
                if (!expenses[categoryKey]) {
                    return;
                }
                
                const section = document.getElementById(`category-${categoryKey}`);
                if (section) {
                    // Remove from current position and add to fragment
                    section.parentNode.removeChild(section);
                    fragment.appendChild(section);
                } else {
                    console.log(`Warning: Section not found for category ${categoryKey}`);
                }
            });
            
            // Append the fragment to the expenses list
            expensesList.appendChild(fragment);
            
            // Update the display to refresh stats
            updateDisplay();
        }

        // Clean Database Function - removes ghost categories
        function cleanDatabase() {
            let foundGhosts = false;
            const ghostCategories = [];
            
            // Check for categories that exist in data but not in DOM
            Object.keys(expenses).forEach(categoryKey => {
                const section = document.getElementById(`category-${categoryKey}`);
                if (!section) {
                    ghostCategories.push(categoryKey);
                    foundGhosts = true;
                }
            });
            
            if (foundGhosts) {
                const message = `Found ${ghostCategories.length} ghost categor${ghostCategories.length > 1 ? 'ies' : 'y'}: ${ghostCategories.join(', ')}\n\nDo you want to remove them?`;
                if (confirm(message)) {
                    // Remove ghost categories from expenses
                    ghostCategories.forEach(categoryKey => {
                        delete expenses[categoryKey];
                    });
                    
                    // Remove from categoryOrder
                    categoryOrder = categoryOrder.filter(c => !ghostCategories.includes(c));
                    
                    // Remove from categoryMetadata
                    ghostCategories.forEach(categoryKey => {
                        if (categoryMetadata[categoryKey]) {
                            delete categoryMetadata[categoryKey];
                        }
                    });
                    
                    // Save and update
                    saveUserData();
                    updateDisplay();
                    
                    alert(`Successfully removed ${ghostCategories.length} ghost categor${ghostCategories.length > 1 ? 'ies' : 'y'}!`);
                }
            } else {
                alert('No ghost categories found! Your database is clean. ‚úÖ');
            }
        }

        // Settings Functions
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const currencySelect = document.getElementById('currencySelect');
            const useIncomeCheckbox = document.getElementById('useIncomeCheckbox');
            const settingsUserEmail = document.getElementById('settingsUserEmail');
            const percentageModeSelect = document.getElementById('percentageModeSelect');
            const percentageModeSection = document.getElementById('percentageModeSection');
            
            if (!modal) {
                console.error('Settings modal not found');
                return;
            }
            
            // Set current values
            const currencyCode = Object.keys(currencyOptions).find(key => currencyOptions[key] === currency) || 'ILS';
            if (currencySelect) currencySelect.value = currencyCode;
            if (useIncomeCheckbox) useIncomeCheckbox.checked = useIncome;
            if (percentageModeSelect) percentageModeSelect.value = percentageMode;
            
            // Show/hide percentage mode section based on useIncome
            if (percentageModeSection) {
                percentageModeSection.style.display = useIncome ? 'block' : 'none';
            }
            
            // Set user email
            if (currentUser && settingsUserEmail) {
                settingsUserEmail.textContent = currentUser.email;
            }
            
            // ‚úÖ Bloquer le scroll en arri√®re-plan
            document.body.classList.add('modal-open');
            
            // ‚úÖ Supprimer le style inline s'il existe
            modal.style.display = '';
            
            // ‚úÖ Utiliser la classe .show
            modal.classList.add('show');
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal'); 
            if (modal) {
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
        }



        function updateCurrency(currencyCode) {
            currency = currencyOptions[currencyCode];
            saveUserData();
            updateDisplay();
        }

        function toggleIncomeFeature(enabled) {
            useIncome = enabled;
            
            // Show/hide percentage mode section
            const percentageModeSection = document.getElementById('percentageModeSection');
            if (percentageModeSection) {
                percentageModeSection.style.display = enabled ? 'block' : 'none';
            }
            
            saveUserData();
            updateDisplay();
        }

        /**
         * Clear all transactions
         */
        async function clearAllTransactions() {
            if (!currentUser) return;
            
            const t = translations[currentLanguage] || translations['en'];
            if (!confirm(t.clearAllWarning1 || '‚ö†Ô∏è Delete ALL transactions?')) {
                return;
            }
            
            if (!confirm(t.clearAllWarning2 || '‚ö†Ô∏è FINAL WARNING! Continue?')) {
                return;
            }
            
            // ‚úÖ Utiliser le loading overlay global au lieu du loading dans le modal
            showLoadingOverlay(
                t.deletingAllTransactions || 'Deleting all transactions...', 
                t.pleaseWait || 'This may take a moment'
            );
            
            try {
                // Delete all transactions
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('transactions')
                    .get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Delete all imported CSVs metadata
                const csvSnapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('importedCSVs')
                    .get();
                
                const csvBatch = db.batch();
                csvSnapshot.docs.forEach(doc => {
                    csvBatch.delete(doc.ref);
                });
                
                await csvBatch.commit();
                
                // ‚úÖ Cacher le loading overlay
                hideLoadingOverlay();
                
                const message = t.transactionsCleared
                    .replace('{count}', snapshot.size)
                    .replace('{csvCount}', csvSnapshot.size);
                
                showToast(message, 'success', 5000);
                
                // Reload if on transactions tab
                if (typeof loadTransactions === 'function') {
                    await loadTransactions();
                }
                
                // Reload CSV list
                if (typeof loadImportedCSVsList === 'function') {
                    await loadImportedCSVsList();
                }
                
            } catch (error) {
                // ‚úÖ Cacher le loading overlay en cas d'erreur
                hideLoadingOverlay();
                
                console.error('Error clearing transactions:', error);
                showToast('Error: ' + error.message, 'error');
            }
        }

        // ============================================
        // EMOJI PICKER
        // ============================================

        const emojiCategories = {
            smileys: ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÖ', 'üòÇ', 'ü§£', 'üòä', 'üòá', 'üôÇ', 'üôÉ', 'üòâ', 'üòå', 'üòç', 'ü•∞', 'üòò', 'üòó', 'üòô', 'üòö', 'üòã', 'üòõ', 'üòù', 'üòú', 'ü§™', 'ü§®', 'üßê', 'ü§ì', 'üòé', 'ü•∏', 'ü§©', 'ü•≥', 'üòè', 'üòí', 'üòû', 'üòî', 'üòü', 'üòï', 'üôÅ', '‚òπÔ∏è', 'üò£', 'üòñ', 'üò´', 'üò©', 'ü•∫', 'üò¢', 'üò≠', 'üò§', 'üò†', 'üò°', 'ü§¨', 'ü§Ø', 'üò≥', 'ü•µ', 'ü•∂', 'üò±', 'üò®', 'üò∞', 'üò•', 'üòì', 'ü§ó', 'ü§î', 'ü§≠', 'ü§´', 'ü§•', 'üò∂', 'üòê', 'üòë', 'üò¨', 'üôÑ', 'üòØ', 'üò¶', 'üòß', 'üòÆ', 'üò≤', 'ü•±', 'üò¥', 'ü§§', 'üò™', 'üòµ', 'ü§ê', 'ü•¥', 'ü§¢', 'ü§Æ', 'ü§ß', 'üò∑', 'ü§í', 'ü§ï'],
            animals: ['üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üêΩ', 'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêí', 'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'üê•', 'ü¶Ü', 'ü¶Ö', 'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü¶ü', 'ü¶ó', 'üï∑Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä', 'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß', 'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè', 'üêë', 'ü¶ô', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêï‚Äçü¶∫', 'üêà', 'üêì', 'ü¶É', 'ü¶ö', 'ü¶ú', 'ü¶¢', 'ü¶©', 'üïäÔ∏è', 'üêá', 'ü¶ù', 'ü¶®', 'ü¶°', 'ü¶¶', 'ü¶•', 'üêÅ', 'üêÄ', 'üêøÔ∏è', 'ü¶î'],
            food: ['üçè', 'üçé', 'üçê', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••', 'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'üåΩ', 'ü•ï', 'üßÑ', 'üßÖ', 'ü•î', 'üç†', 'ü•ê', 'ü•Ø', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'üßá', 'ü•ì', 'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî', 'üçü', 'üçï', 'ü•™', 'ü•ô', 'üßÜ', 'üåÆ', 'üåØ', 'ü•ó', 'ü•ò', 'ü•´', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'ü¶™', 'üç§', 'üçô', 'üçö', 'üçò', 'üç•', 'ü•†', 'ü•Æ', 'üç¢', 'üç°', 'üçß', 'üç®', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞', 'üéÇ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç©', 'üç™', 'üå∞', 'ü•ú', 'üçØ', 'ü•õ', 'üçº', '‚òï', 'üçµ', 'üßÉ', 'ü•§', 'üç∂', 'üç∫', 'üçª', 'ü•Ç', 'üç∑', 'ü•É', 'üç∏', 'üçπ', 'üßâ', 'üçæ', 'üßä'],
            activities: ['‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏', 'üèí', 'üèë', 'ü•ç', 'üèè', 'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ', 'üõπ', 'üõº', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç', 'üèãÔ∏è', 'ü§º', 'ü§∏', 'ü§∫', '‚õπÔ∏è', 'ü§æ', 'üèåÔ∏è', 'üèá', 'üßò', 'üèä', 'ü§Ω', 'üö£', 'üßó', 'üöµ', 'üö¥', 'üèÜ', 'ü•á', 'ü•à', 'ü•â', 'üèÖ', 'üéñÔ∏è', 'üèµÔ∏è', 'üéóÔ∏è', 'üé´', 'üéüÔ∏è', 'üé™', 'ü§π', 'üé≠', 'ü©∞', 'üé®', 'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'üé∑', 'üé∫', 'üé∏', 'ü™ï', 'üéª', 'üé≤', '‚ôüÔ∏è', 'üéØ', 'üé≥', 'üéÆ', 'üé∞', 'üß©'],
            travel: ['üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö', 'üöõ', 'üöú', 'ü¶Ø', 'ü¶Ω', 'ü¶º', 'üõ¥', 'üö≤', 'üõµ', 'üèçÔ∏è', 'üõ∫', 'üö®', 'üöî', 'üöç', 'üöò', 'üöñ', 'üö°', 'üö†', 'üöü', 'üöÉ', 'üöã', 'üöû', 'üöù', 'üöÑ', 'üöÖ', 'üöà', 'üöÇ', 'üöÜ', 'üöá', 'üöä', 'üöâ', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'üõ©Ô∏è', 'üí∫', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üöÅ', 'üõ∂', '‚õµ', 'üö§', 'üõ•Ô∏è', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üö¢', '‚öì', '‚õΩ', 'üöß', 'üö¶', 'üö•', 'üöè', 'üó∫Ô∏è', 'üóø', 'üóΩ', 'üóº', 'üè∞', 'üèØ', 'üèüÔ∏è', 'üé°', 'üé¢', 'üé†', '‚õ≤', '‚õ±Ô∏è', 'üèñÔ∏è', 'üèùÔ∏è', 'üèúÔ∏è', 'üåã', '‚õ∞Ô∏è', 'üèîÔ∏è', 'üóª', 'üèïÔ∏è', '‚õ∫', 'üè†', 'üè°', 'üèòÔ∏è', 'üèöÔ∏è', 'üèóÔ∏è', 'üè≠', 'üè¢', 'üè¨', 'üè£', 'üè§', 'üè•', 'üè¶', 'üè®', 'üè™', 'üè´', 'üè©', 'üíí', 'üèõÔ∏è', '‚õ™', 'üïå', 'üïç', 'üõï', 'üïã'],
            objects: ['‚åö', 'üì±', 'üì≤', 'üíª', '‚å®Ô∏è', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üïπÔ∏è', 'üóúÔ∏è', 'üíæ', 'üíø', 'üìÄ', 'üìº', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìΩÔ∏è', 'üéûÔ∏è', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üì∫', 'üìª', 'üéôÔ∏è', 'üéöÔ∏è', 'üéõÔ∏è', 'üß≠', '‚è±Ô∏è', '‚è≤Ô∏è', '‚è∞', 'üï∞Ô∏è', '‚åõ', '‚è≥', 'üì°', 'üîã', 'üîå', 'üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'üí∞', 'üí≥', 'üíé', '‚öñÔ∏è', 'üß∞', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'üî©', '‚öôÔ∏è', 'üß±', '‚õìÔ∏è', 'üß≤', 'üî´', 'üí£', 'üß®', 'ü™ì', 'üî™', 'üó°Ô∏è', '‚öîÔ∏è', 'üõ°Ô∏è', 'üö¨', '‚ö∞Ô∏è', '‚ö±Ô∏è', 'üè∫', 'üîÆ', 'üìø', 'üßø', 'üíà', '‚öóÔ∏è', 'üî≠', 'üî¨', 'üï≥Ô∏è', 'üíä', 'üíâ', 'ü©∏', 'ü©π', 'ü©∫', 'üå°Ô∏è', 'üß¨', 'ü¶†', 'üß´', 'üß™', 'üåê', 'üó∫Ô∏è', 'üß≠', 'üóø'],
            symbols: ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû', 'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ', 'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê', '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏', 'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è', 'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢', '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è', '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ', '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', '‚ìÇÔ∏è', 'üåÄ', 'üí§', 'üèß', 'üöæ', '‚ôø', 'üÖøÔ∏è', 'üà≥', 'üàÇÔ∏è', 'üõÇ', 'üõÉ', 'üõÑ', 'üõÖ', 'üöπ', 'üö∫', 'üöº', 'üöª', 'üöÆ', 'üé¶', 'üì∂', 'üàÅ', 'üî£', '‚ÑπÔ∏è', 'üî§', 'üî°', 'üî†', 'üÜñ', 'üÜó', 'üÜô', 'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£', 'üîü']
        };

        let emojiPickerResolve = null;

        function showEmojiPicker(currentEmoji = 'üìã') {
            return new Promise((resolve) => {
                emojiPickerResolve = resolve;
                
                const modal = document.getElementById('emojiPickerModal');
                modal.style.display = 'flex';
                
                // ‚úÖ Pr√©-remplir l'input avec l'emoji actuel
                const input = document.getElementById('customEmojiInput');
                if (input) {
                    input.value = currentEmoji; // ‚úÖ Remplir avec l'emoji actuel
                    setTimeout(() => input.focus(), 100);
                }
                
                // ‚úÖ G√©rer la touche Enter dans l'input
                const handleEnter = (e) => {
                    if (e.key === 'Enter') {
                        useCustomEmoji();
                    }
                };
                input.addEventListener('keydown', handleEnter);
                
                // Afficher la premi√®re cat√©gorie par d√©faut
                renderEmojiCategory('smileys');
                
                // G√©rer les clics sur les cat√©gories
                document.querySelectorAll('.emoji-category-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.emoji-category-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        renderEmojiCategory(this.dataset.category);
                    });
                });
            });
        }

        function renderEmojiCategory(category) {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = '';
            
            emojiCategories[category].forEach(emoji => {
                const btn = document.createElement('button');
                btn.className = 'emoji-item';
                btn.textContent = emoji;
                btn.onclick = () => selectEmoji(emoji);
                grid.appendChild(btn);
            });
        }

        function selectEmoji(emoji) {
            if (emojiPickerResolve) {
                emojiPickerResolve(emoji);
                emojiPickerResolve = null;
            }
            closeEmojiPicker();
        }


        function useCustomEmoji() {
            const input = document.getElementById('customEmojiInput');
            let emoji = input.value.trim();
            
            if (!emoji) {
                const t = translations[currentLanguage] || translations['en'];
                showToast(t.pleaseEnterEmoji || 'Please enter an emoji', 'error');
                return;
            }
            
            // ‚úÖ Prendre seulement le premier caract√®re/emoji
            // Les emojis complexes peuvent prendre 2+ caract√®res UTF-16
            const emojiArray = Array.from(emoji);
            emoji = emojiArray[0];
            
            selectEmoji(emoji);
        }

        // ‚úÖ Ajoute aussi le support de la touche Enter
        function showEmojiPicker(currentEmoji = 'üìã') {
            return new Promise((resolve) => {
                emojiPickerResolve = resolve;
                
                const modal = document.getElementById('emojiPickerModal');
                modal.style.display = 'flex';
                
                // Vider et focus sur l'input
                const input = document.getElementById('customEmojiInput');
                if (input) {
                    input.value = currentEmoji; // ‚úÖ Pr√©-remplir avec l'emoji actuel
                    setTimeout(() => input.focus(), 100);
                }
                
                // ‚úÖ G√©rer la touche Enter dans l'input
                const handleEnter = (e) => {
                    if (e.key === 'Enter') {
                        useCustomEmoji();
                    }
                };
                input.addEventListener('keydown', handleEnter);
                
                // Afficher la premi√®re cat√©gorie par d√©faut
                renderEmojiCategory('smileys');
                
                // G√©rer les clics sur les cat√©gories
                document.querySelectorAll('.emoji-category-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        document.querySelectorAll('.emoji-category-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        renderEmojiCategory(this.dataset.category);
                    });
                });
            });
        }


        function closeEmojiPicker() {
            const modal = document.getElementById('emojiPickerModal');
            modal.style.display = 'none';
            if (emojiPickerResolve) {
                emojiPickerResolve(null); // L'utilisateur a annul√©
                emojiPickerResolve = null;
            }
        }

        function updatePercentageMode(mode) {
            percentageMode = mode;
            saveUserData();
            updateDisplay();
        }

        /**
         * Toggle dark mode
         */
        function toggleDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            // === MISE A JOUR IMMEDIATE DU GRAPHIQUE ===
            // On force le graphique √† se redessiner avec les nouvelles couleurs
            if (typeof updateChart === 'function') {
                updateChart();
            }
            // ==========================================
        
            // Save preference to Firebase
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({
                    darkMode: enabled
                }, { merge: true }).then(() => {
                    console.log('Dark mode preference saved:', enabled);
                }).catch(error => {
                    console.error('Error saving dark mode preference:', error);
                });
            }
            updateThemeColor();
        }

        // ============================================
        // Met √† jour la couleur du theme iOS (safe-area)
        // ============================================
        function updateThemeColor() {
            const isDark = document.body.classList.contains('dark-mode');
            let metaTheme = document.querySelector('meta[name="theme-color"]');
            
            // Cr√©er la meta si elle n'existe pas
            if (!metaTheme) {
                metaTheme = document.createElement('meta');
                metaTheme.name = 'theme-color';
                document.head.appendChild(metaTheme);
            }
            
            metaTheme.setAttribute('content', isDark ? '#1e1e2e' : '#ffffff');
        }
        
        // Appeler au chargement
        document.addEventListener('DOMContentLoaded', updateThemeColor);
        

        /**
         * Load dark mode preference
         */
        function loadDarkModePreference() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists && doc.data().darkMode !== undefined) {
                    const darkModeEnabled = doc.data().darkMode;
                    
                    // Apply dark mode
                    if (darkModeEnabled) {
                        document.body.classList.add('dark-mode');
                    }
                    
                    // Update checkbox
                    const darkModeCheckbox = document.getElementById('darkModeCheckbox');
                    if (darkModeCheckbox) {
                        darkModeCheckbox.checked = darkModeEnabled;
                    }
                    
                    // === MISE A JOUR DU GRAPHIQUE AVEC LES COULEURS DARK MODE ===
                    if (typeof updateChart === 'function') {
                        updateChart();
                    }
                }
            }).catch(error => {
                console.error('Error loading dark mode preference:', error);
            });
        }

        /**
         * D√©tecte automatiquement la langue et la devise
         * - Langue : depuis les param√®tres du t√©l√©phone/navigateur
         * - Devise : depuis la g√©olocalisation (IP)
         */
        async function detectUserLocale() {
            // ========================================
            // 1. D√âTECTER LA LANGUE (navigateur/t√©l√©phone)
            // ========================================
            const browserLang = navigator.language || navigator.userLanguage;
            const langCode = browserLang.split('-')[0].toLowerCase();
                        
            // Langues support√©es par l'app
            const supportedLanguages = ['en', 'fr', 'he', 'es', 'ru', 'ar'];
            
            // Si la langue est support√©e, l'utiliser, sinon anglais par d√©faut
            const detectedLanguage = supportedLanguages.includes(langCode) ? langCode : 'en';
                        
            // ========================================
            // 2. D√âTECTER LA DEVISE (g√©olocalisation IP)
            // ========================================
            let detectedCurrency = 'USD'; // D√©faut
            
            try {
                
                const response = await fetch('https://ipapi.co/json/', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const geoData = await response.json();
                    const countryCode = geoData.country_code;
                                        
                    // Mapping pays ‚Üí devise
                    const currencyMap = {
                        // Europe
                        'FR': 'EUR', 'DE': 'EUR', 'IT': 'EUR', 'ES': 'EUR', 'PT': 'EUR',
                        'BE': 'EUR', 'NL': 'EUR', 'AT': 'EUR', 'IE': 'EUR', 'GR': 'EUR',
                        'FI': 'EUR', 'LU': 'EUR', 'SI': 'EUR', 'SK': 'EUR', 'EE': 'EUR',
                        'LV': 'EUR', 'LT': 'EUR', 'CY': 'EUR', 'MT': 'EUR',
                        
                        // Moyen-Orient
                        'IL': 'ILS',
                        'SA': 'SAR',
                        'AE': 'AED',
                        'EG': 'EGP',
                        'LB': 'LBP',
                        'SY': 'SYP',
                        'JO': 'JOD',
                        
                        // Am√©riques
                        'US': 'USD',
                        'CA': 'CAD',
                        'MX': 'MXN',
                        'BR': 'BRL',
                        'AR': 'ARS',
                        
                        // Royaume-Uni
                        'GB': 'GBP',
                        
                        // Asie
                        'JP': 'JPY',
                        'CN': 'CNY',
                        'IN': 'INR',
                        'TH': 'THB',
                        'KR': 'KRW',
                        'SG': 'SGD',
                        
                        // Russie
                        'RU': 'RUB',
                        
                        // Suisse
                        'CH': 'CHF',
                        
                        // Australie
                        'AU': 'AUD',
                        'NZ': 'NZD',
                    };
                    
                    detectedCurrency = currencyMap[countryCode] || 'USD';
                    
                } else {
                    console.warn('‚ö†Ô∏è G√©olocalisation IP √©chou√©e, devise par d√©faut: USD');
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erreur g√©olocalisation IP:', error.message);
            }
            
            return {
                language: detectedLanguage,
                currency: detectedCurrency
            };
        }

        async function renameCategory(categoryKey) {
            const currentDisplayName = getCategoryDisplayName(categoryKey);
            const t = translations[currentLanguage] || translations['en'];
            const promptMessage = t.enterNewCategoryName
                .replace('{current}', currentDisplayName);
            const newName = prompt(promptMessage, currentDisplayName);
            
            if (!newName || newName.trim() === '') return;
            
            // Demander l'emoji avec le nouveau picker
            const currentEmoji = categoryMetadata[categoryKey]?.emoji || 'üìã';
            const newEmoji = await showEmojiPicker(currentEmoji);
            if (!newEmoji) {
                // L'utilisateur a annul√©
                return;
            }
            
            // ‚úÖ V√©rifier si quelque chose a chang√©
            if (newName.trim() === currentDisplayName && newEmoji === currentEmoji) {
                return; // Rien n'a chang√©
            }
            
            const newKey = newName.toLowerCase().replace(/\s+/g, '-');   
            
            // Emp√™cher de renommer "income"
            if (categoryKey === 'income') {
                showToast(t.cannotRenameIncome || 'Cannot rename Income.', 'error');
                return;
            }
            
            // Emp√™cher de renommer en "income" uniquement
            if (newKey === 'income' && categoryKey !== 'income') {
                showToast(t.cannotUseSystemName || 'Cannot use system name.', 'error');
                return;
            }
            
            // V√©rifier les doublons
            if (newKey !== categoryKey && expenses[newKey]) {
                showToast(t.categoryExistsAlert || 'Category already exists!', 'error');
                return;
            }
            
            try {
                // Afficher l'overlay
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingOverlayText');
                const subtextEl = document.getElementById('loadingOverlaySubtext');
                
                if (overlay) {
                    if (textEl) textEl.textContent = t.renamingCategory || 'Renaming category...';
                    if (subtextEl) subtextEl.textContent = t.updatingTransactions || 'Updating transactions...';
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                // Appeler Cloud Function pour transactions SEULEMENT si le nom a chang√©
                let result = null;
                
                if (newKey !== categoryKey) {
                    const renameCategoryFunc = firebase.functions().httpsCallable('renameCategory');
                    result = await renameCategoryFunc({
                        oldName: categoryKey,
                        newName: newKey
                    });
                } else {
                    console.log('Only emoji changed, skipping Cloud Function');
                }
                
                // ‚úÖ LOGIQUE SIMPLE : Tout faire localement
                if (newKey !== categoryKey) {
                    // Copier vers nouvelle cl√©
                    expenses[newKey] = expenses[categoryKey] || [];
                    categoryMetadata[newKey] = {
                        emoji: newEmoji,
                        displayName: newName
                    };
                    
                    // Copier la couleur seulement si elle existe
                    if (categoryMetadata[categoryKey]?.color) {
                        categoryMetadata[newKey].color = categoryMetadata[categoryKey].color;
                    }
                    
                    // Mettre √† jour l'ordre
                    const index = categoryOrder.indexOf(categoryKey);
                    if (index !== -1) {
                        categoryOrder[index] = newKey;
                    } else {
                        categoryOrder.push(newKey);
                    }
                    
                    // Supprimer l'ancienne
                    delete expenses[categoryKey];
                    delete categoryMetadata[categoryKey];
                    
                    // ‚úÖ Supprimer l'ancienne cat√©gorie explicitement de Firestore
                    await db.collection('users').doc(currentUser.uid).update({
                        [`expenses.${categoryKey}`]: firebase.firestore.FieldValue.delete(),
                        [`categoryMetadata.${categoryKey}`]: firebase.firestore.FieldValue.delete()
                    });
                } else {
                    // ‚úÖ Juste mettre √† jour le displayName/emoji
                    if (!categoryMetadata[categoryKey]) categoryMetadata[categoryKey] = {};
                    categoryMetadata[categoryKey].displayName = newName;
                    categoryMetadata[categoryKey].emoji = newEmoji;
                    
                }
                
                // ‚úÖ Sauvegarder dans Firebase
                await saveUserData();
                
                // ‚úÖ NOUVEAU : Recharger depuis Firebase pour avoir l'ordre correct
                await loadUserData();
                
                // ‚úÖ Forcer la recr√©ation du HTML si changement de cl√©
                if (newKey !== categoryKey) {
                    const oldSection = document.getElementById(`category-${categoryKey}`);
                    if (oldSection) {
                        oldSection.remove();
                    }
                }
                
                // Actualiser l'affichage
                updateDisplay();
                setTimeout(() => restoreEditMode(), 50);
                
                // Cacher l'overlay
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                // ‚úÖ Toast adapt√© : seulement si des transactions ont √©t√© mises √† jour
                if (result && result.data.updatedCount > 0) {
                    showToast(t.categoryRenamedSuccess.replace('{count}', result.data.updatedCount), 'success');
                } else if (newKey === categoryKey) {
                    // Juste l'emoji a chang√©
                    showToast(t.categoryUpdated || 'Category updated successfully!', 'success');
                } else {
                    // Renommage mais pas de transactions
                    showToast(t.categoryRenamedSuccess.replace('{count}', 0), 'success');
                }
                
            } catch (error) {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                console.error('Error renaming category:', error);
                showToast('Error renaming category: ' + error.message, 'error');
            }
        }

        async function renameItem(category, index) {
            const t = translations[currentLanguage] || translations['en'];
            const newName = prompt(t.enterNewName || 'Enter new name:', expenses[category][index].name);
            if (!newName) return;
            
            try {
                // Afficher l'overlay
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingOverlayText');
                const subtextEl = document.getElementById('loadingOverlaySubtext');
                
                if (overlay) {
                    if (textEl) textEl.textContent = t.renamingItem || 'Renaming item...';
                    if (subtextEl) subtextEl.textContent = t.pleaseWait || 'Please wait';
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                expenses[category][index].name = newName;
                await saveUserData();
                updateDisplay();
                setTimeout(() => restoreEditMode(), 50);
                
                // Cacher l'overlay
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            } catch (error) {
                // Cacher l'overlay en cas d'erreur
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                console.error('Error renaming item:', error);
                alert('Error renaming item: ' + error.message);
            }
        }

        // Item Movement Functions
        function moveItemUp(category, index) {
            if (index === 0) return; // Already at top
            
            const temp = expenses[category][index];
            expenses[category][index] = expenses[category][index - 1];
            expenses[category][index - 1] = temp;
            
            saveUserData();
            updateDisplay();
        }

        function moveItemDown(category, index) {
            if (index === expenses[category].length - 1) return; // Already at bottom
            
            const temp = expenses[category][index];
            expenses[category][index] = expenses[category][index + 1];
            expenses[category][index + 1] = temp;
            
            saveUserData();
            updateDisplay();
        }

        // Close modals on click outside and restore scroll
        document.addEventListener('click', function(e) {
            const colorModal = document.getElementById('colorEditorModal');
            const settingsModal = document.getElementById('settingsModal');
            
            if (e.target === colorModal) {
                closeColorEditor();
            }
            if (e.target === settingsModal) {
                closeSettings();
            }
        });

        // Fonction pour mettre √† jour l'√©tat visuel des boutons de graphique
        function updateChartButtonsState() {
            const toggleButtons = document.querySelectorAll('.chart-toggle-btn');
            toggleButtons.forEach(btn => {
                if (btn.dataset.type === currentChartType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        
        // ‚úÖ UNIQUE onAuthStateChanged fusionn√©
        auth.onAuthStateChanged(async (user) => {

            // ‚úÖ Initialiser Eruda pour les d√©veloppeurs
            if (user) {
                const devEmails = ['victorburtman@gmail.com'];
                if (devEmails.includes(user.email)) {
                    
                    // Initialiser Eruda
                    if (typeof eruda !== 'undefined') {
                        eruda.init();
                        
                        // ‚úÖ Cr√©er un onglet personnalis√© "Actions"
                        setTimeout(() => {
                            try {
                                eruda.add({
                                    name: 'actions',
                                    init: function($el) {
                                        const style = `
                                            padding: 15px; 
                                            background: #2196F3; 
                                            color: white; 
                                            border: none; 
                                            border-radius: 8px; 
                                            margin: 10px; 
                                            width: calc(100% - 20px);
                                            font-size: 16px;
                                            font-weight: bold;
                                            cursor: pointer;
                                            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                                        `;
                                        
                                        this._$el = $el;
                                        $el.html(`
                                            <div style="padding:10px; height:100%; overflow:auto;">
                                                <h2 style="color:#888; padding:10px; margin:0; font-size:18px;">üõ†Ô∏è Outils D√©veloppeur</h2>
                                                <button id="btn-copy-logs" style="${style}">üìã Copier tous les logs</button>
                                                <button id="btn-clear-logs" style="${style.replace('#2196F3', '#f44336')}">üßπ Vider la console</button>
                                                <div id="log-count" style="color:#888; padding:10px; font-size:14px;">Aucun log copi√©</div>
                                            </div>
                                        `);
                                        
                                        // Bouton COPIER
                                        const btnCopy = $el.get(0).querySelector('#btn-copy-logs');
                                        const logCount = $el.get(0).querySelector('#log-count');
                                        
                                        btnCopy.addEventListener('click', function() {
                                            const erudaRoot = document.querySelector('#eruda');
                                            if (!erudaRoot || !erudaRoot.shadowRoot) {
                                                alert('‚ùå Eruda Shadow DOM non accessible');
                                                return;
                                            }
                                            
                                            // S√©lectionner tous les logs
                                            const logElements = erudaRoot.shadowRoot.querySelectorAll('.luna-console-log-item');
                                            
                                            if (logElements.length === 0) {
                                                alert('‚ö†Ô∏è Aucun log trouv√© dans la console');
                                                logCount.textContent = 'Aucun log trouv√©';
                                                return;
                                            }
                                            
                                            const logs = [];
                                            logElements.forEach(el => {
                                                const text = el.innerText || el.textContent;
                                                if (text && text.trim()) {
                                                    logs.push(text.trim());
                                                }
                                            });
                                            
                                            const allLogs = logs.join('\n---\n');
                                            
                                            // Cr√©er textarea pour copier
                                            const textarea = document.createElement('textarea');
                                            textarea.value = allLogs;
                                            textarea.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:80vh;z-index:999999;background:white;color:black;padding:20px;font-size:11px;font-family:monospace;border:3px solid #2196F3;overflow:auto;';
                                            
                                            document.body.appendChild(textarea);
                                            textarea.focus();
                                            textarea.select();
                                            
                                            try {
                                                document.execCommand('copy');
                                                logCount.textContent = '‚úÖ ' + logs.length + ' logs copi√©s !';
                                                logCount.style.color = '#4CAF50';
                                            } catch (err) {
                                                logCount.textContent = '‚ùå Erreur de copie';
                                                logCount.style.color = '#f44336';
                                            }
                                            
                                            const closeBtn = document.createElement('button');
                                            closeBtn.textContent = '‚ùå Fermer';
                                            closeBtn.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999999;background:#f44336;color:white;padding:15px 30px;font-size:18px;border:none;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);cursor:pointer;';
                                            closeBtn.onclick = () => {
                                                document.body.removeChild(textarea);
                                                document.body.removeChild(closeBtn);
                                            };
                                            
                                            document.body.appendChild(closeBtn);
                                            
                                            alert('üìã ' + logs.length + ' logs affich√©s ! Appui long pour copier.');
                                        });
                                        
                                        // Bouton VIDER
                                        const btnClear = $el.get(0).querySelector('#btn-clear-logs');
                                        btnClear.addEventListener('click', function() {
                                            console.clear();
                                            logCount.textContent = 'üßπ Console vid√©e';
                                            logCount.style.color = '#888';
                                            setTimeout(() => {
                                                logCount.textContent = 'Aucun log copi√©';
                                            }, 2000);
                                        });
                                    },
                                    show: function() { 
                                        this._$el.show(); 
                                    },
                                    hide: function() { 
                                        this._$el.hide(); 
                                    },
                                    destroy: function() {}
                                });
                                
                                
                            } catch (error) {
                                console.error('‚ùå Erreur lors de l\'ajout de l\'onglet Actions:', error);
                            }
                        }, 1000); // Attendre 1 seconde qu'Eruda soit pr√™t
                        
                    } else {
                        console.error('‚ùå Eruda non charg√©');
                    }
                }
            }



            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('appScreen');
            
            if (user) {
                currentUser = user;
                window.currentUser = user;
                
                if (authScreen) {
                    authScreen.style.display = 'none';
                }
                
                // ‚úÖ V√©rifier si premier lancement
                const isFirst = await authManager.checkFirstLaunch(user.uid);
                
                if (isFirst) {
                    await authManager.setupInitialConfig(user.uid);
                }
                                
                // ‚úÖ NOUVEAU : Charger les donn√©es avec d√©tection automatique pour nouveaux utilisateurs
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const data = userDoc.data();
                    
                    // ‚úÖ V√©rifier si c'est le premier login (pas de langue/devise)
                    const isFirstLogin = !data.language || !data.currency;
                    
                    if (isFirstLogin) {
                        
                        // D√©tecter langue et devise
                        const detectedLocale = await detectUserLocale();
                        
                        // Sauvegarder dans Firestore
                        await db.collection('users').doc(user.uid).set({
                            language: detectedLocale.language,
                            currency: detectedLocale.currency,
                            firstLoginDate: firebase.firestore.FieldValue.serverTimestamp()
                        }, { merge: true });
                        
                        // Appliquer
                        currentLanguage = detectedLocale.language;
                        window.currentCurrency = detectedLocale.currency;
                        
                    } else {
                        // Utilisateur existant, charger ses pr√©f√©rences
                        currentLanguage = data.language || 'en';
                        window.currentCurrency = data.currency || 'USD';
                        
                    }
                    
                    // Mettre √† jour les selects
                    document.getElementById('languageSelect').value = currentLanguage;
                    document.getElementById('currencySelect').value = window.currentCurrency;
                    
                    // Charger dark mode (par d√©faut activ√©)
                    const darkMode = data.darkMode !== undefined ? data.darkMode : true;
                    if (darkMode) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                    
                    const darkModeCheckbox = document.getElementById('darkModeCheckbox');
                    if (darkModeCheckbox) {
                        darkModeCheckbox.checked = darkMode;
                    }
                    
                    // Charger le reste des donn√©es utilisateur
                    await loadUserData();
                }
                                
                // ‚úÖ Appliquer la langue et RTL
                updateUILanguage();
                
                if (currentLanguage === 'ar' || currentLanguage === 'he') {
                    document.documentElement.setAttribute('dir', 'rtl');
                } else {
                    document.documentElement.setAttribute('dir', 'ltr');
                }
                       
                // ‚úÖ AJOUT 1 : Initialiser le header Budget au d√©marrage
                if (typeof updateHeaderForTab === 'function') {
                    updateHeaderForTab('budget');
                }
                
                // ‚úÖ Initialiser les fonctionnalit√©s
                setTimeout(() => {
                    initScrollToTopButton();
                    initSwipeNavigation();
                    initPullToRefresh(); // ‚úÖ AJOUT 2 : Pull-to-refresh pour Transactions
                }, 1000);
                
                if (mainApp) {
                    mainApp.style.display = 'block';
                }
                
            } else {
                currentUser = null;
                
                if (mainApp) {
                    mainApp.style.display = 'none';
                }
                if (authScreen) {
                    authScreen.style.display = 'flex';
                    authManager.initAuthScreen();
                }
            }
        });

        // ‚úÖ AJOUTE apr√®s auth.onAuthStateChanged ou dans DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            // G√©rer les clics sur les boutons footer avec pr√©vention du double-tap
            const budgetBtn = document.getElementById('budgetTabBtn');
            const transactionsBtn = document.getElementById('transactionsTabBtn');
            
            if (budgetBtn) {
                budgetBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!isTabSwitching) switchTab('budget');
                }, { passive: false });
            }
            
            if (transactionsBtn) {
                transactionsBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (!isTabSwitching) switchTab('transactions');
                }, { passive: false });
            }
        });

        // === GESTION DU BOUTON "SCROLL TO TOP" ===
        function initScrollToTopButton() {
            
            const scrollBtn = document.getElementById('scrollToTopBtn');
            const dashboard = document.querySelector('.dashboard');
            
            if (!scrollBtn) {
                return;
            }
            
            if (!dashboard) {
                return;
            }
                        
            // ‚úÖ AJOUTER L'EVENT LISTENER POUR LE CLIC
            scrollBtn.addEventListener('click', (e) => {
                e.preventDefault();
                dashboard.scrollTo({ 
                    top: 0, 
                    behavior: 'smooth' 
                });
            });
            
            // Supprimer l'ancien listener de scroll s'il existe
            if (dashboard._scrollListener) {
                dashboard.removeEventListener('scroll', dashboard._scrollListener);
            }
            
            // Cr√©er le listener de scroll
            const scrollListener = () => {
                if (dashboard.scrollTop > 300) {
                    scrollBtn.classList.add('visible');
                } else {
                    scrollBtn.classList.remove('visible');
                }
            };
            
            dashboard._scrollListener = scrollListener;
            dashboard.addEventListener('scroll', scrollListener, { passive: true });
            
        }

        // === GESTION DU SWIPE ENTRE ONGLETS AVEC FEEDBACK VISUEL ===
        function initSwipeNavigation() {
            
            const dashboard = document.querySelector('.dashboard');
            const budgetTab = document.getElementById('budgetTab');
            const transactionsTab = document.getElementById('transactionsTab');
            
            if (!dashboard || !budgetTab || !transactionsTab) {
                return;
            }
            
            let touchStartX = 0;
            let touchStartY = 0;
            let currentX = 0;
            let isSwiping = false;
            let swipeDetected = false;
            let scrollPositionSaved = false;
            
            const minSwipeDistance = 100;
            const swipeThreshold = 40;
            const verticalTolerance = 30;
            
            dashboard.addEventListener('touchstart', (e) => {
                
                // ‚úÖ BLOQUER si mode Edit actif
                if (isEditMode) {
                    return;
                }
                
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = false;
                swipeDetected = false;
                scrollPositionSaved = false;
                
                // V√©rifier si le touch est sur le canvas du graphique
                const target = e.target;
                if (target.tagName === 'CANVAS') {
                    isSwiping = false;
                    return;
                }
            }, { passive: false });
            
            dashboard.addEventListener('touchmove', (e) => {
                // ‚úÖ BLOQUER si mode Edit actif
                if (isEditMode) {
                    return;
                }
                
                // V√©rifier si le touch est sur le canvas du graphique
                const target = e.target;
                if (target.tagName === 'CANVAS') {
                    return;
                }
                
                const currentTouchX = e.touches[0].clientX;
                const currentTouchY = e.touches[0].clientY;
                const diffX = currentTouchX - touchStartX;
                const diffY = currentTouchY - touchStartY;
                
                // ‚úÖ BLOQUER le scroll vertical d√®s qu'un mouvement horizontal est d√©tect√©
                const isMovingHorizontally = Math.abs(diffX) > Math.abs(diffY);
                
                if (isMovingHorizontally && Math.abs(diffX) > 10) {
                    e.preventDefault();
                }
                
                // D√©cision : Swipe horizontal ou Scroll vertical ?
                if (!swipeDetected && !isSwiping) {
                    const isHorizontal = Math.abs(diffX) > swipeThreshold;
                    const isVertical = Math.abs(diffY) > swipeThreshold;
                    const isPureHorizontal = Math.abs(diffX) > Math.abs(diffY) * 2;
                    
                    if (isHorizontal && isPureHorizontal && Math.abs(diffY) < verticalTolerance) {
                        swipeDetected = true;
                        isSwiping = true;
                        
                        // ‚úÖ SAUVEGARDER UNE SEULE FOIS
                        if (!scrollPositionSaved) {
                            const currentScrollPos = dashboard.scrollTop;
                            
                            
                            if (currentActiveTab === 'budget') {
                                budgetScrollPosition = currentScrollPos;
                            } else if (currentActiveTab === 'transactions') {
                                transactionsScrollPosition = currentScrollPos;
                            } else {
                                console.error('‚ùå currentActiveTab invalide:', currentActiveTab);
                            }
                                    
                            scrollPositionSaved = true;
                        } else {
                            console.log('‚ö†Ô∏è Sauvegarde d√©j√† effectu√©e, skip');
                        }
                    } else if (isVertical) {
                        swipeDetected = false;
                        isSwiping = false;
                        return;
                    }
                }
                
                // Si on est en mode swipe, bloquer le scroll et g√©rer le swipe
                if (isSwiping) {
                    e.preventDefault();
                    
                    currentX = diffX;
                    
                    // Limiter le mouvement selon l'onglet actif
                    const budgetActive = budgetTab.classList.contains('active');
                    const transactionsActive = transactionsTab.classList.contains('active');
                    
                    // Budget actif : on peut swiper que vers la gauche (vers Transactions)
                    if (budgetActive && currentX < 0) {
                        const progress = Math.min(Math.abs(currentX) / window.innerWidth, 1);
                        
                        const resistance = currentX < -window.innerWidth * 0.7 ? 0.3 : 1;
                        const adjustedX = currentX * resistance;
                        
                        budgetTab.style.transform = `translateX(${adjustedX}px)`;
                        budgetTab.style.opacity = 1 - (progress * 0.3);
                        
                        transactionsTab.style.display = 'block';
                        transactionsTab.style.transform = `translateX(${window.innerWidth + adjustedX}px)`;
                        transactionsTab.style.opacity = progress;
                    }
                    // Budget actif : bloquer le swipe vers la droite
                    else if (budgetActive && currentX > 0) {
                        const resistance = 0.2;
                        budgetTab.style.transform = `translateX(${currentX * resistance}px)`;
                    }
                    // Transactions actif : on peut swiper que vers la droite (vers Budget)
                    else if (transactionsActive && currentX > 0) {
                        const progress = Math.min(currentX / window.innerWidth, 1);
                        
                        const resistance = currentX > window.innerWidth * 0.7 ? 0.3 : 1;
                        const adjustedX = currentX * resistance;
                        
                        transactionsTab.style.transform = `translateX(${adjustedX}px)`;
                        transactionsTab.style.opacity = 1 - (progress * 0.3);
                        
                        budgetTab.style.display = 'block';
                        budgetTab.style.transform = `translateX(${-window.innerWidth + adjustedX}px)`;
                        budgetTab.style.opacity = progress;
                    }
                    // Transactions actif : bloquer le swipe vers la gauche
                    else if (transactionsActive && currentX < 0) {
                        const resistance = 0.2;
                        transactionsTab.style.transform = `translateX(${currentX * resistance}px)`;
                    }
                }
            }, { passive: false });
            
            dashboard.addEventListener('touchend', (e) => {
                
                // ‚úÖ BLOQUER si mode Edit actif
                if (isEditMode) {
                    isSwiping = false;
                    swipeDetected = false;
                    currentX = 0;
                    scrollPositionSaved = false;
                    return;
                }
                
                if (isSwiping) {
                    
                    const budgetActive = budgetTab.classList.contains('active');
                    const transactionsActive = transactionsTab.classList.contains('active');
                    
                    
                    const shouldSwitch = Math.abs(currentX) > minSwipeDistance;

                    if (shouldSwitch) {
                        // Swipe vers la gauche depuis Budget ‚Üí aller √† Transactions
                        if (budgetActive && currentX < 0) {
                            animateTabTransition(budgetTab, transactionsTab, 'left');
                            setTimeout(() => {
                                switchTab('transactions');
                                // ‚úÖ PAS d'appel √† updateHeaderForTab (g√©r√© par switchTab)
                            }, 350);
                        }
                        // Swipe vers la droite depuis Transactions ‚Üí aller √† Budget
                        else if (transactionsActive && currentX > 0) {
                            animateTabTransition(transactionsTab, budgetTab, 'right');
                            setTimeout(() => {
                                switchTab('budget');
                                // ‚úÖ PAS d'appel √† updateHeaderForTab (g√©r√© par switchTab)
                            }, 350);
                        }
                        else {
                            resetTabPositions(budgetTab, transactionsTab);
                        }
                    } else {
                        resetTabPositions(budgetTab, transactionsTab);
                    }
                    
                    isSwiping = false;
                    swipeDetected = false;
                    currentX = 0;
                    scrollPositionSaved = false;
                } else {
                    console.log('üî¥ isSwiping = false, aucun traitement');
                }
            }, { passive: false });
            
            // Annuler le swipe si on quitte l'√©cran
            dashboard.addEventListener('touchcancel', () => {
                // ‚úÖ BLOQUER si mode Edit actif
                if (isEditMode) {
                    isSwiping = false;
                    swipeDetected = false;
                    currentX = 0;
                    scrollPositionSaved = false;
                    return;
                }
                
                if (isSwiping) {
                    resetTabPositions(budgetTab, transactionsTab);
                    isSwiping = false;
                    swipeDetected = false;
                    currentX = 0;
                    scrollPositionSaved = false;
                }
            }, { passive: true });
            
            // Animation de transition finale
            function animateTabTransition(fromTab, toTab, direction) {
                const distance = direction === 'left' ? -window.innerWidth : window.innerWidth;
                
                toTab.classList.remove('swipe-preview');
                fromTab.classList.remove('swipe-preview');
                
                fromTab.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                fromTab.style.transform = `translateX(${distance}px)`;
                fromTab.style.opacity = '0';
                
                toTab.style.opacity = '0';
                toTab.style.transition = 'transform 0.3s ease-out';
                toTab.style.transform = 'translateX(0)';
                
                setTimeout(() => {
                    
                    if (toTab.id === 'budgetTab') {
                        dashboard.scrollTop = budgetScrollPosition;
                    } else if (toTab.id === 'transactionsTab') {
                        dashboard.scrollTop = transactionsScrollPosition;
                    }
                    
                    toTab.style.transition = 'opacity 0.15s ease';
                    toTab.style.opacity = '1';
                }, 100);
                
                setTimeout(() => {
                    fromTab.style.transition = '';
                    fromTab.style.transform = '';
                    fromTab.style.opacity = '';
                    fromTab.style.display = '';
                    
                    toTab.style.transition = '';
                    toTab.style.transform = '';
                    toTab.style.opacity = '';
                }, 450);
            }

            function resetTabPositions(tab1, tab2) {
                [tab1, tab2].forEach(tab => {
                    tab.classList.remove('swipe-preview');
                    
                    tab.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                    tab.style.transform = '';
                    tab.style.opacity = '';
                    
                    setTimeout(() => {
                        tab.style.transition = '';
                        tab.style.transform = '';
                        tab.style.opacity = '';
                        
                        if (!tab.classList.contains('active')) {
                            tab.style.display = 'none';
                        }
                    }, 350);
                });
            }     
        }

        /**
         * Copier les logs depuis le Shadow DOM d'Eruda
         */
        function copyErudaLogs() {
            try {
                const erudaRoot = document.querySelector('#eruda');
                
                if (!erudaRoot || !erudaRoot.shadowRoot) {
                    alert('‚ùå Eruda Shadow DOM non accessible');
                    return;
                }
                
                // ‚úÖ Chercher les logs individuels dans le shadow DOM
                const possibleSelectors = [
                    '.luna-console-log-item',
                    '.luna-console-log',
                    '.eruda-log-item',
                    '.luna-console .log-item',
                    '.eruda-logs-container .luna-console-log-item',
                    '.luna-console-logs .log-item'
                ];
                
                let logs = [];
                let foundSelector = null;
                
                for (const selector of possibleSelectors) {
                    const elements = erudaRoot.shadowRoot.querySelectorAll(selector);
                    if (elements.length > 0) {
                        foundSelector = selector;
                        
                        elements.forEach(el => {
                            const text = el.innerText || el.textContent;
                            if (text && text.trim()) {
                                logs.push(text.trim());
                            }
                        });
                        
                        break;
                    }
                }
                
                if (logs.length === 0) {
                    console.error('‚ùå Aucun log trouv√©');
                    
                    // Debug : afficher les classes disponibles
                    const allElements = erudaRoot.shadowRoot.querySelectorAll('*');
                    const classes = new Set();
                    allElements.forEach(el => {
                        if (el.className && typeof el.className === 'string') {
                            el.className.split(' ').forEach(cls => {
                                if (cls.includes('log')) {
                                    classes.add(cls);
                                }
                            });
                        }
                    });
                    
                    alert('‚ùå Aucun log trouv√©. V√©rifie la console pour les classes disponibles.');
                    return;
                }
                
                const allLogs = logs.join('\n\n');
                
                
                // Tenter la copie
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(allLogs)
                        .then(() => {
                            alert('‚úÖ ' + logs.length + ' logs copi√©s dans le clipboard !');
                        })
                        .catch(err => {
                            console.error('‚ùå Clipboard √©chou√©:', err);
                            showLogsInTextarea(allLogs);
                        });
                } else {
                    showLogsInTextarea(allLogs);
                }
                
            } catch (error) {
                console.error('‚ùå Erreur:', error);
                alert('‚ùå Erreur: ' + error.message);
            }
        }


        async function copyAllErudaLogsForce() {
            const erudaRoot = document.querySelector('#eruda');
            
            if (!erudaRoot || !erudaRoot.shadowRoot) {
                alert('‚ùå Shadow DOM non accessible');
                return;
            }
                        
            // Essayer d'acc√©der √† l'API interne via window
            if (window.eruda) {                
                // Tester plusieurs m√©thodes d'acc√®s
                const methods = [
                    () => window.eruda._devTools?.get('console')?._logs,
                    () => window.eruda.get?.('console')?._logs,
                    () => window.eruda.Console?._logs,
                    () => window.eruda._plugins?.console?._logs
                ];
                
                for (const method of methods) {
                    try {
                        const logs = method();
                        if (logs && logs.length > 0) {                            
                            const allLogs = logs.map(log => {
                                if (typeof log === 'string') return log;
                                if (log.text) return log.text;
                                if (log.message) return log.message;
                                if (log.content) return log.content;
                                return JSON.stringify(log);
                            }).join('\n\n');
                            
                            // Copier
                            if (navigator.clipboard && navigator.clipboard.writeText) {
                                await navigator.clipboard.writeText(allLogs);
                                alert('‚úÖ ' + logs.length + ' logs copi√©s !');
                            } else {
                                showLogsInTextarea(allLogs);
                            }
                            return;
                        }
                    } catch (e) {
                        // Continue
                    }
                }
            }
            
            alert('‚ùå Impossible d\'acc√©der aux logs. Utilise des screenshots.');
        }

        window.copyAllErudaLogsForce = copyAllErudaLogsForce;

        /**
         * Afficher dans un textarea (fallback)
         */
        function showLogsInTextarea(logs) {
            const textarea = document.createElement('textarea');
            textarea.value = logs;
            textarea.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 80vh;
                z-index: 999999;
                background: white;
                color: black;
                padding: 20px;
                font-size: 11px;
                font-family: monospace;
                border: 3px solid #f44336;
                overflow: auto;
                line-height: 1.4;
            `;
            
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            
            try {
                document.execCommand('copy');
            } catch (err) {
                console.log('‚ö†Ô∏è execCommand √©chou√©');
            }
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '‚ùå Fermer';
            closeBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 9999999;
                background: #f44336;
                color: white;
                padding: 15px 30px;
                font-size: 18px;
                font-weight: bold;
                border: none;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                cursor: pointer;
            `;
            closeBtn.onclick = () => {
                document.body.removeChild(textarea);
                document.body.removeChild(closeBtn);
            };
            
            document.body.appendChild(closeBtn);
            
            alert('üìã Logs affich√©s ! Fais un appui long pour s√©lectionner et copier.');
        }

        /**
         * Vider la console
         */
        function clearConsole() {
            console.clear();
        }

        /**
         * Inspection compl√®te (debug)
         */
        function inspectErudaDeep() {
            
            const erudaRoot = document.querySelector('#eruda');
            
            if (!erudaRoot || !erudaRoot.shadowRoot) {
                console.error('‚ùå Shadow DOM non accessible');
                return;
            }
                        
            // Chercher toutes les classes contenant "log"
            const allElements = erudaRoot.shadowRoot.querySelectorAll('*');
            const logClasses = new Set();
            
            allElements.forEach(el => {
                if (el.className && typeof el.className === 'string') {
                    el.className.split(' ').forEach(cls => {
                        if (cls.includes('log') || cls.includes('console')) {
                            logClasses.add(cls);
                        }
                    });
                }
            });
                        
            // Tester les s√©lecteurs
            const testSelectors = [
                '.luna-console-log-item',
                '.luna-console-log',
                '[class*="log-item"]',
                '[class*="console-log"]'
            ];
            
            testSelectors.forEach(sel => {
                const els = erudaRoot.shadowRoot.querySelectorAll(sel);
                if (els.length > 0) {
                    console.log('  Premier:', els[0]);
                }
            });
        }

        // Rendre accessible globalement
        window.copyErudaLogs = copyErudaLogs;
        window.inspectErudaDeep = inspectErudaDeep;
        window.clearConsole = clearConsole;

        /**
         * Pull-to-refresh pour recharger les transactions
         */
        function initPullToRefresh() {
            
            const dashboard = document.querySelector('.dashboard');
            const transactionsTab = document.getElementById('transactionsTab');
            
            if (!dashboard || !transactionsTab) {
                return;
            }
            
            let touchStartY = 0;
            let touchStartTime = 0; // ‚úÖ Nouveau : moment o√π le pull commence
            let pulling = false;
            let pullDistance = 0;
            let scrollAtStart = 0;
            let thresholdReachedTime = 0; // ‚úÖ Nouveau : moment o√π le seuil est atteint
            
            const pullThreshold = 150; // ‚úÖ Augment√© encore plus : 150px
            const maxPullDistance = 180; // ‚úÖ Augment√© √† 180px
            const minPullStart = 30; // ‚úÖ Augment√© de 20 √† 30px
            const minHoldTime = 300; // ‚úÖ Nouveau : doit tenir 300ms au-dessus du seuil
            
            // Cr√©er l'indicateur
            const refreshIndicator = document.createElement('div');
            refreshIndicator.id = 'refreshIndicator';
            refreshIndicator.style.cssText = `
                position: absolute;
                top: -80px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: top 0.3s ease, opacity 0.3s ease;
                z-index: 1000;
                opacity: 0;
            `;
            
            refreshIndicator.innerHTML = `
                <img src="img/anims/Interwind@1x-1.0s-200px-200px.svg" 
                    alt="Loading" 
                    style="width: 100%; height: 100%;">
            `;
            
            transactionsTab.style.position = 'relative';
            transactionsTab.insertBefore(refreshIndicator, transactionsTab.firstChild);
            
            dashboard.addEventListener('touchstart', (e) => {
                if (currentActiveTab !== 'transactions') return;
                
                // ‚úÖ Plus strict : doit √™tre exactement √† 0 (ou tr√®s proche)
                if (dashboard.scrollTop > 5) return;
                
                touchStartY = e.touches[0].clientY;
                touchStartTime = Date.now(); // ‚úÖ Enregistrer le moment
                scrollAtStart = dashboard.scrollTop;
                pulling = false;
                pullDistance = 0;
                thresholdReachedTime = 0;
            }, { passive: true });
            
            dashboard.addEventListener('touchmove', (e) => {
                if (currentActiveTab !== 'transactions') return;
                
                // ‚úÖ Si on commence √† scroller vers le bas, annuler
                if (dashboard.scrollTop > scrollAtStart + 5) {
                    pulling = false;
                    refreshIndicator.style.top = '-80px';
                    refreshIndicator.style.opacity = '0';
                    thresholdReachedTime = 0;
                    return;
                }
                
                // ‚úÖ Doit √™tre compl√®tement en haut
                if (dashboard.scrollTop > 5) {
                    pulling = false;
                    refreshIndicator.style.top = '-80px';
                    refreshIndicator.style.opacity = '0';
                    thresholdReachedTime = 0;
                    return;
                }
                
                const currentY = e.touches[0].clientY;
                const diff = currentY - touchStartY;
                
                // ‚úÖ N√©cessite un mouvement minimum avant de commencer
                if (diff > minPullStart) {
                    pulling = true;
                    pullDistance = Math.min(diff - minPullStart, maxPullDistance);
                    
                    // ‚úÖ Enregistrer quand le seuil est atteint pour la premi√®re fois
                    if (pullDistance >= pullThreshold && thresholdReachedTime === 0) {
                        thresholdReachedTime = Date.now();
                    }
                    
                    // ‚úÖ R√©initialiser si on redescend sous le seuil
                    if (pullDistance < pullThreshold) {
                        thresholdReachedTime = 0;
                    }
                    
                    const progress = Math.min(pullDistance / pullThreshold, 1);
                    
                    const indicatorTop = -80 + (pullDistance * 0.5);
                    refreshIndicator.style.top = `${indicatorTop}px`;
                    refreshIndicator.style.opacity = progress;
                    
                    // ‚úÖ Changer la couleur de l'indicateur quand le seuil est atteint ET tenu assez longtemps
                    if (thresholdReachedTime > 0 && (Date.now() - thresholdReachedTime) >= minHoldTime) {
                        refreshIndicator.style.filter = 'brightness(1.2)'; // Indicateur visuel
                    } else {
                        refreshIndicator.style.filter = 'none';
                    }
                }
            }, { passive: true });
            
            dashboard.addEventListener('touchend', async (e) => {
                if (!pulling) return;
                if (currentActiveTab !== 'transactions') return;
                
                // ‚úÖ CACHER IMM√âDIATEMENT d√®s qu'on rel√¢che
                refreshIndicator.style.top = '-80px';
                refreshIndicator.style.opacity = '0';
                refreshIndicator.style.filter = 'none';
                
                // ‚úÖ V√©rifier que le seuil est atteint ET tenu assez longtemps
                const heldTime = thresholdReachedTime > 0 ? (Date.now() - thresholdReachedTime) : 0;
                
                if (pullDistance >= pullThreshold && heldTime >= minHoldTime) {
                    
                    try {
                        if (typeof loadTransactions === 'function') {
                            await loadTransactions();
                        }
                    } catch (error) {
                        console.error('‚ùå Erreur lors du refresh:', error);
                    }
                } else if (pullDistance >= pullThreshold) {
                    console.log(`‚è±Ô∏è Pull-to-refresh annul√© (pas tenu assez longtemps: ${heldTime}ms < ${minHoldTime}ms)`);
                }
                
                pulling = false;
                pullDistance = 0;
                thresholdReachedTime = 0;
            }, { passive: true });      
        }



        /**
         * Scroll vers le haut de la page (smooth)
         */
        function scrollToTop() {
            
            const dashboard = document.querySelector('.dashboard');
            
            if (dashboard) {
                dashboard.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            } else {
                console.error('‚ùå .dashboard introuvable !');
            }
        }

        /**
         * Met √† jour le header selon l'onglet actif
         * @param {string} tabName - 'budget' ou 'transactions'
         */
        function updateHeaderForTab(tabName) {
            
            if (tabName === 'budget') {
                // Cacher les boutons Transactions
                document.querySelectorAll('.transactions-only').forEach(btn => {
                    btn.style.display = 'none';
                });
                
                // Afficher les boutons Budget
                document.querySelectorAll('.budget-only').forEach(btn => {
                    // ‚úÖ Cas sp√©cial : s√©lecteur de mois Compare (toujours visible maintenant)
                    if (btn.id === 'compareMonth') {
                        btn.style.display = 'inline-block';
                        window.compareMode = true; // Toujours actif
                    }
                    // ‚úÖ Tous les autres boutons Budget (Edit, Add Category, Compare, etc.)
                    else {
                        btn.style.display = 'inline-flex';
                    }
                });
                
            } else if (tabName === 'transactions') {
                // Cacher les boutons Budget
                document.querySelectorAll('.budget-only').forEach(btn => {
                    btn.style.display = 'none';
                });
                
                // Afficher les boutons Transactions
                document.querySelectorAll('.transactions-only').forEach(btn => {
                    btn.style.display = 'inline-flex';
                });
            }
        }

        let isTabSwitching = false;
        let currentActiveTab = null;
        let lastTabSwitchTime = 0;

        // ‚úÖ Variables pour m√©moriser la position de scroll
        let budgetScrollPosition = 0;
        let transactionsScrollPosition = 0;

        function switchTab(tabName) {
            
            // Bloquer si un switch est d√©j√† en cours
            if (isTabSwitching) {
                return;
            }
            
            // ‚úÖ Si on clique sur l'onglet d√©j√† actif, scroll to top
            if (tabName === currentActiveTab) {
                
                // Feedback visuel
                const activeBtn = document.getElementById(tabName + 'TabBtn');
                if (activeBtn) {
                    activeBtn.classList.add('tap-feedback');
                    setTimeout(() => activeBtn.classList.remove('tap-feedback'), 300);
                }
                
                // Scroll to top
                const dashboard = document.querySelector('.dashboard');
                if (dashboard) {
                    dashboard.scrollTo({ top: 0, behavior: 'smooth' });
                    
                    // R√©initialiser la position m√©moris√©e
                    if (tabName === 'budget') budgetScrollPosition = 0;
                    else if (tabName === 'transactions') transactionsScrollPosition = 0;
                }
                return;
            }
            
            // Verrouillage
            isTabSwitching = true;
            
            // ‚úÖ Cacher le bouton reset pendant la transition pour √©viter le flash
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) resetBtn.style.opacity = '0';
            
            // ‚úÖ PAS DE SAUVEGARDE ICI (d√©j√† faite dans initSwipeNavigation)
            const dashboard = document.querySelector('.dashboard');
            
            try {
                // Gestion des classes actives sur le footer
                const activeBtn = document.getElementById(tabName + 'TabBtn');
                document.querySelectorAll('.footer-nav-btn').forEach(btn => {
                    if (btn === activeBtn) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
                
                currentActiveTab = tabName;
                
                // ========================================
                // ONGLET BUDGET
                // ========================================
                if (tabName === 'budget') {
                    
                    // 1. GESTION DES BOUTONS DU HEADER
                    document.querySelectorAll('.transactions-only').forEach(btn => {
                        btn.style.display = 'none';
                    });
                    
                    // ‚úÖ Afficher compareMonth (toujours visible maintenant)
                    const compareMonth = document.getElementById('compareMonth');
                    if (compareMonth) {
                        compareMonth.style.display = 'inline-block';
                    }
                    
                    document.querySelectorAll('.budget-only').forEach(btn => {
                        // Afficher tous les boutons budget par d√©faut (sauf compareMonth d√©j√† g√©r√©)
                        if (btn.id !== 'compareMonth') {
                            btn.style.display = 'inline-flex';
                        }
                    });
                    
                    // 2. Gestion du contenu
                    const budgetTab = document.getElementById('budgetTab');
                    const transactionsTab = document.getElementById('transactionsTab');
                    const expensesList = document.getElementById('expensesList');
                    const floatingAddBtn = document.getElementById('floatingAddBtn');
                    
                    if (budgetTab) {
                        budgetTab.style.opacity = '0';
                        budgetTab.style.display = 'block';
                        budgetTab.classList.add('active');
                    }
                    if (expensesList) expensesList.style.display = 'block';
                    
                    if (transactionsTab) {
                        transactionsTab.style.display = 'none';
                        transactionsTab.classList.remove('active');
                    }
                    if (floatingAddBtn) floatingAddBtn.style.display = 'none';
                    
                    // ‚úÖ Restaurer le scroll imm√©diatement
                    if (dashboard) {
                        dashboard.scrollTop = budgetScrollPosition;
                    }
                    
                    // Fade in
                    requestAnimationFrame(() => {
                        if (budgetTab) {
                            budgetTab.style.transition = 'opacity 0.15s ease';
                            budgetTab.style.opacity = '1';
                        }
                        
                        // ‚úÖ R√©afficher le bouton reset apr√®s le fade in
                        setTimeout(() => {
                            if (resetBtn) {
                                resetBtn.style.transition = 'opacity 0.2s ease';
                                resetBtn.style.opacity = '1';
                            }
                        }, 150);
                    });
                    
                    // ‚úÖ Synchroniser les boutons du header en fonction de l'√©tat r√©el
                    setTimeout(() => {
                        updateHeaderForTab('budget');
                    }, 50);
                    
                // ========================================
                // ONGLET TRANSACTIONS
                // ========================================
                } else if (tabName === 'transactions') {
                    
                    // 1. GESTION DES BOUTONS DU HEADER
                    document.querySelectorAll('.budget-only').forEach(btn => {
                        btn.style.display = 'none';
                    });
                    
                    document.querySelectorAll('.transactions-only').forEach(btn => {
                        btn.style.display = 'inline-flex';
                    });
                    
                    // 2. Gestion du contenu
                    const budgetTab = document.getElementById('budgetTab');
                    const transactionsTab = document.getElementById('transactionsTab');
                    const expensesList = document.getElementById('expensesList');
                    const floatingAddBtn = document.getElementById('floatingAddBtn');
                    
                    if (budgetTab) {
                        budgetTab.style.display = 'none';
                        budgetTab.classList.remove('active');
                    }
                    if (expensesList) expensesList.style.display = 'none';
                    
                    if (transactionsTab) {
                        transactionsTab.style.display = 'block';
                        transactionsTab.classList.add('active');
                    }
                    
                    // ‚úÖ Chargement lazy des transactions (uniquement au premier acc√®s)
                    if (typeof loadTransactions === 'function' && !window.transactionsLoaded) {
                        
                        // ‚úÖ Afficher le loader existant
                        const transactionsLoading = document.getElementById('transactionsLoading');
                        const allTransactionsList = document.getElementById('allTransactionsList');
                        const emptyState = document.getElementById('emptyState');
                        const allTransactionsSection = document.getElementById('allTransactionsSection');
                        
                        if (transactionsLoading) transactionsLoading.style.display = 'block';
                        if (allTransactionsList) allTransactionsList.style.display = 'none';
                        if (emptyState) emptyState.style.display = 'none';
                        if (allTransactionsSection) allTransactionsSection.style.display = 'block';
                        if (allTransactionsList) allTransactionsList.style.display = 'block'; // ‚úÖ AJOUTER CETTE LIGNE

                        
                        // ‚úÖ Fade in l'onglet imm√©diatement avec le loader
                        requestAnimationFrame(() => {
                            if (transactionsTab) {
                                transactionsTab.style.transition = 'opacity 0.15s ease';
                                transactionsTab.style.opacity = '1';
                            }
                        });
                        
                        // ‚úÖ Charger les transactions
                        loadTransactions().then(() => {
                            window.transactionsLoaded = true;
                            
                            // ‚úÖ Le loader sera cach√© par renderTransactions()
                            
                            // ‚úÖ Restaurer le scroll
                            if (dashboard) {
                                dashboard.scrollTop = transactionsScrollPosition;
                            }
                        });
                    } else {
                        
                        // ‚úÖ Restaurer le scroll imm√©diatement si pas de chargement
                        if (dashboard) {
                            dashboard.scrollTop = transactionsScrollPosition;
                        }
                        
                        // Fade in
                        requestAnimationFrame(() => {
                            if (transactionsTab) {
                                transactionsTab.style.transition = 'opacity 0.15s ease';
                                transactionsTab.style.opacity = '1';
                            }
                        });
                    }
                    
                    if (floatingAddBtn) floatingAddBtn.style.display = 'flex';
                    
                    // ‚úÖ Synchroniser les boutons du header
                    setTimeout(() => {
                        updateHeaderForTab('transactions');
                    }, 50);
                }
                
            } finally {
                // D√©blocage
                setTimeout(() => {
                    isTabSwitching = false;
                }, 200);
            }
        }


        // ‚úÖ Fermer tous les modals ouverts
        function closeAllModals() {
            document.querySelectorAll('.modal.show').forEach(modal => {
                modal.classList.remove('show');
            });
            document.body.classList.remove('modal-open');
        }


        async function openFiltersModal() {
            closeAllModals();
            const modal = document.getElementById('filtersModal');
            if (modal) {
                // Remplir les menus d√©roulants avant d'ouvrir le modal
                if (typeof populateMonthFilter === 'function') {
                    populateMonthFilter();
                }
                if (typeof populateCategoryFilter === 'function') {
                    populateCategoryFilter();
                }
                if (typeof populateSourceFilter === 'function') {
                    populateSourceFilter();
                }
                
                // ‚úÖ AJOUTE : Restaurer les valeurs depuis Firebase
                if (window.currentUser && db) {
                    try {
                        const userDoc = await db.collection('users').doc(window.currentUser.uid).get();
                        
                        if (userDoc.exists && userDoc.data().transactionFilters) {
                            const savedFilters = userDoc.data().transactionFilters;
                            
                            // Restaurer label filter
                            if (savedFilters.labelFilter) {
                                const radio = document.querySelector(`input[name="labelFilter"][value="${savedFilters.labelFilter}"]`);
                                if (radio) radio.checked = true;
                            }
                            
                            // ‚úÖ Restaurer month filter
                            const monthSelect = document.getElementById('monthFilter');
                            if (monthSelect && savedFilters.monthFilter !== undefined) {
                                monthSelect.value = savedFilters.monthFilter;
                            }
                            
                            // ‚úÖ Restaurer source filter
                            const sourceSelect = document.getElementById('sourceFilter');
                            if (sourceSelect && savedFilters.sourceFilter !== undefined) {
                                sourceSelect.value = savedFilters.sourceFilter;
                            }
                            
                            // ‚úÖ Restaurer category filter
                            const categorySelect = document.getElementById('categoryFilter');
                            if (categorySelect && savedFilters.categoryFilter !== undefined) {
                                categorySelect.value = savedFilters.categoryFilter;
                            }
                            
                            // ‚úÖ Restaurer search filter
                            const searchInput = document.getElementById('searchFilter');
                            if (searchInput && savedFilters.searchFilter !== undefined) {
                                searchInput.value = savedFilters.searchFilter;
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå Erreur restauration filtres:', error);
                    }
                }
                
                document.body.classList.add('modal-open');
                modal.classList.add('show');
                
                // Appliquer les traductions
                setTimeout(() => {
                    updateUILanguage();
                }, 100);
            }
        }
        function closeFiltersModal() {
            const modal = document.getElementById('filtersModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.classList.remove('modal-open');
            }
        }

        /**
         * Confirmer la suppression du compte
         */
        function confirmDeleteAccount() {
            const confirmMessage = t('confirmDelete');
            const cancelText = t('cancel');
            const confirmText = t('confirmDeleteButton');
            
            // Cr√©er une modal de confirmation personnalis√©e
            const confirmModal = document.createElement('div');
            confirmModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 999999;
                padding: 20px;
            `;
            
            confirmModal.innerHTML = `
                <div style="
                    background: white;
                    border-radius: 12px;
                    padding: 30px;
                    max-width: 400px;
                    width: 100%;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                ">
                    <h3 style="margin: 0 0 15px 0; color: #dc3545; font-size: 1.3em;">‚ö†Ô∏è ${t('deleteAccount')}</h3>
                    <p style="margin: 0 0 25px 0; color: #333; font-size: 1em; line-height: 1.5;">${confirmMessage}</p>
                    <div style="display: flex; gap: 10px;">
                        <button id="cancelDeleteBtn" style="
                            flex: 1;
                            padding: 12px;
                            background: #6c757d;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 1em;
                            cursor: pointer;
                            font-weight: 600;
                        ">${cancelText}</button>
                        <button id="confirmDeleteBtn" style="
                            flex: 1;
                            padding: 12px;
                            background: #dc3545;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 1em;
                            cursor: pointer;
                            font-weight: 600;
                        ">${confirmText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmModal);
            
            // Bouton Annuler
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                document.body.removeChild(confirmModal);
            });
            
            // Bouton Confirmer
            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                document.body.removeChild(confirmModal);
                await deleteUserAccount();
            });
        }


        /**
         * Supprimer le compte utilisateur COMPL√àTEMENT
         */
        async function deleteUserAccount() {
            try {
                const lang = localStorage.getItem('language') || 'en';
                const trans = translations[lang] || translations['en'];
                
                showToast('‚è≥ ' + (trans.loading || 'Loading...'), 'info');
                
                const user = firebase.auth().currentUser;
                
                if (!user) {
                    console.error('‚ùå Aucun utilisateur connect√©');
                    showToast('‚ùå ' + (trans.errorDeletingAccount || 'Error'), 'error');
                    return;
                }
                
                const userId = user.uid;
                const userEmail = user.email;
                     
                // ========================================
                // 1. R√âAUTHENTIFIER L'UTILISATEUR D'ABORD
                // ========================================
                
                // Demander le mot de passe
                const password = prompt(trans.enterPasswordToConfirm || 'Enter your password to confirm:');
                
                if (!password) {
                    return;
                }
                
                try {
                    const credential = firebase.auth.EmailAuthProvider.credential(
                        user.email,
                        password
                    );
                    
                    await user.reauthenticateWithCredential(credential);
                    
                } catch (reauthError) {
                    console.error('‚ùå Erreur r√©authentification:', reauthError);
                    
                    if (reauthError.code === 'auth/wrong-password') {
                        showToast('‚ùå ' + (trans.wrongPassword || 'Incorrect password'), 'error');
                    } else {
                        showToast('‚ùå ' + (trans.errorDeletingAccount || 'Error'), 'error');
                    }
                    return;
                }
                
                // ========================================
                // 2. Supprimer les donn√©es Firestore
                // ========================================
                
                try {
                    await db.collection('users').doc(userId).delete();
                    
                    // Supprimer sous-collections
                    const subcollections = ['transactions', 'budgets', 'categories', 'settings'];
                    
                    for (const subcol of subcollections) {
                        try {
                            const snapshot = await db.collection('users').doc(userId).collection(subcol).get();
                            
                            if (!snapshot.empty) {
                                const batch = db.batch();
                                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                                await batch.commit();
                            }
                        } catch (subError) {
                            console.warn(`‚ö†Ô∏è Erreur ${subcol}:`, subError);
                        }
                    }
                    
                } catch (firestoreError) {
                    console.error('‚ùå Erreur Firestore:', firestoreError);
                }
                
                // ========================================
                // 3. Supprimer le compte Auth (APR√àS r√©auth)
                // ========================================
                
                try {
                    await user.delete();
                    
                } catch (authError) {
                    console.error('‚ùå ERREUR Auth:', authError.code);
                    showToast('‚ùå ' + (trans.errorDeletingAccount || 'Error') + ': ' + authError.code, 'error');
                    return;
                }
                
                // ========================================
                // 4. Nettoyer localStorage
                // ========================================
                localStorage.clear();
                
                // ========================================
                // 5. Succ√®s !
                // ========================================
                showToast('‚úÖ ' + (trans.accountDeleted || 'Account deleted'), 'success');
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå ERREUR G√âN√âRALE:', error);
                showToast('‚ùå Error', 'error');
            }
        }

        function initializeApp() {
            setTimeout(() => {
                document.body.scrollIntoView({ behavior: 'auto', block: 'start' });
            }, 50);
            
            updateTransactionsLanguage(); 
            
            if (typeof Chart !== 'undefined') {
                // Set up chart type toggle buttons
                const toggleButtons = document.querySelectorAll('.chart-toggle-btn');
                toggleButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        currentChartType = this.dataset.type;
                        saveUserData();
                        
                        toggleButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        updateChart();
                    });
                });

                // Function to update button states based on current chart type
                window.updateChartButtonsState = function() {
                    const buttons = document.querySelectorAll('.chart-toggle-btn');
                    buttons.forEach(btn => {
                        if (btn.dataset.type === currentChartType) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                };
                
                // Close modal when clicking outside
                const modal = document.getElementById('colorEditorModal');
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeColorEditor();
                    }
                });
                
                const settingsModal = document.getElementById('settingsModal');
                settingsModal.addEventListener('click', function(e) {
                    if (e.target === settingsModal) {
                        closeSettings();
                    }
                });
                
                updateDisplay();
                
                // ‚úÖ Initialiser le s√©lecteur de mois
                populateMonthDropdown();
                loadRealSpending();
                loadMonthlyTrendChart();


                // ‚ú® Ajustement du titre
                setTimeout(fitAppTitle, 100); 

            } else {
                console.warn('Chart.js not loaded, waiting...');
                setTimeout(initializeApp, 100);
            }
        }



        // Initialize on load (Bloc final simplifi√© et corrig√©)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        // Note : L'appel √† fitAppTitle est maintenant g√©r√© DANS initializeApp (voir point 1).

        // ‚úÖ AJOUT√â : Display app version
        window.addEventListener('DOMContentLoaded', () => {
            const versionEl = document.getElementById('appVersionDisplay');
            if (versionEl) {
                versionEl.textContent = `v${APP_VERSION}`;
            }
        });


        // ============================================
        // CHART SWIPE FUNCTIONALITY
        // ============================================

        let startX = 0;
        let currentX = 0;
        let isDragging = false;

        function initChartSwipe() {
            const wrapper = document.getElementById('chartWrapper');
            if (!wrapper) return;
            
            // Touch events
            wrapper.addEventListener('touchstart', handleSwipeStart);
            wrapper.addEventListener('touchmove', handleSwipeMove);
            wrapper.addEventListener('touchend', handleSwipeEnd);
            
            // Mouse events (pour desktop)
            wrapper.addEventListener('mousedown', handleSwipeStart);
            wrapper.addEventListener('mousemove', handleSwipeMove);
            wrapper.addEventListener('mouseup', handleSwipeEnd);
            wrapper.addEventListener('mouseleave', handleSwipeEnd);
        }

        function handleSwipeStart(e) {
            isDragging = true;
            startX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            currentX = startX;
        }

        function handleSwipeMove(e) {
            if (!isDragging) return;
            
            currentX = e.type.includes('mouse') ? e.pageX : e.touches[0].pageX;
            const diff = currentX - startX;
            
            // Visual feedback (optionnel)
            const container = document.querySelector('.chart-container');
            if (container && Math.abs(diff) > 10) {
                container.style.transform = `translateX(${diff * 0.3}px)`;
            }
        }

        function handleSwipeEnd(e) {
            if (!isDragging) return;
            isDragging = false;
            
            const diff = currentX - startX;
            const container = document.querySelector('.chart-container');
            
            // Reset visual
            if (container) {
                container.style.transform = '';
            }
            
            // Swipe threshold: 50px
            if (Math.abs(diff) > 50) {
                if (diff > 0) {
                    // Swipe right ‚Üí graphique pr√©c√©dent
                    switchToChart('doughnut');
                } else {
                    // Swipe left ‚Üí graphique suivant
                    switchToChart('bar');
                }
            }
        }

        function switchToChart(type) {
            if (type === currentChartType) return;
            
            currentChartType = type;
            updateChart();
            updateChartIndicators();
            
            // ‚úÖ Sauvegarder la pr√©f√©rence
            if (currentUser) {
                saveUserData();
            }
        }

        function updateChartIndicators() {
            const dots = document.querySelectorAll('.chart-dot');
            dots.forEach(dot => {
                const chartType = dot.getAttribute('data-chart');
                if (chartType === currentChartType) {
                    dot.classList.add('active');
                } else {
                    dot.classList.remove('active');
                }
            });
        }

        // Permettre de cliquer sur les dots pour changer
        document.querySelectorAll('.chart-dot').forEach(dot => {
            dot.addEventListener('click', function() {
                const chartType = this.getAttribute('data-chart');
                switchToChart(chartType);
            });
        });

        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', function() {
            initChartSwipe();
            updateChartIndicators();
        });

    </script>
    <script src="js/transactions-manager.js"></script>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-overlay-content">
            <div class="loading-overlay-spinner"></div>
            <div class="loading-overlay-text" id="loadingOverlayText">Processing...</div>
            <div class="loading-overlay-subtext" id="loadingOverlaySubtext">Please wait</div>
        </div>
    </div>

    <!-- Filters Modal -->
    <div id="filtersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üîç <span data-translate="filters">Filters</span></h2>
                <button class="modal-close" onclick="closeFiltersModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Label filter -->
                <div style="margin-bottom: 20px;">
                    <h4 style="margin-bottom: 10px;" data-translate="labelStatus">Label Status</h4>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <label class="filter-radio-label">
                            <input type="radio" name="labelFilter" value="all" onchange="applyFilters()" checked>
                            <span data-translate="showAll">All</span>
                        </label>
                        <label class="filter-radio-label">
                            <input type="radio" name="labelFilter" value="unlabeled" onchange="applyFilters()">
                            <span data-translate="showOnlyUnlabeled">Unlabeled only</span>
                        </label>
                        <label class="filter-radio-label">
                            <input type="radio" name="labelFilter" value="labeled" onchange="applyFilters()">
                            <span data-translate="showOnlyLabeled">Labeled only</span>
                        </label>
                    </div>
                </div>

                <!-- Type Filter -->
                <div class="filter-group">
                    <label data-translate="type">Type</label>
                    <select id="typeFilter" onchange="applyFilters()">
                        <option value="all" data-translate="all">All</option>
                        <option value="expenses" data-translate="expenses">Expenses</option>
                        <option value="income" data-translate="income">Income</option>
                    </select>
                </div>

                <!-- Month filter -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                        <span data-translate="month">Month</span>
                    </label>
                    <select id="monthFilter" onchange="applyFilters()" class="settings-select" style="width: 100%;">
                        <option value="" data-translate="allMonths">All months</option>
                    </select>
                </div>
                
                <!-- Source filter -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                        <span data-translate="source">Source</span>
                    </label>
                    <select id="sourceFilter" onchange="applyFilters()" class="settings-select" style="width: 100%;">
                        <option value="" data-translate="allSources">All sources</option>
                        <option value="max">üè¶ Max (Leumi)</option>
                        <option value="isracard">üí≥ Isracard</option>
                    </select>
                </div>
                
                <!-- Category filter -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                        <span data-translate="category">Category</span>
                    </label>
                    <select id="categoryFilter" onchange="applyFilters()" class="settings-select" style="width: 100%;">
                        <option value="" data-translate="allCategories">All categories</option>
                    </select>
                </div>
                
                <!-- Search -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                        <span data-translate="search">Search</span>
                    </label>
                    <div style="position: relative; width: 100%;">
                        <input 
                            type="text" 
                            id="searchFilter" 
                            data-translate-placeholder="search"
                            placeholder="Search..." 
                            oninput="applyFilters()"
                            class="auth-input"
                            style="width: 100%; padding: 12px 40px 12px 12px; font-size: 1em;"
                        />
                        <button 
                            id="clearSearchBtn"
                            onclick="clearSearchFilter()"
                            style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #6c757d; cursor: pointer; font-size: 1.2em; padding: 5px; display: none;"
                            title="Clear search"
                        >‚úï</button>
                    </div>
                </div>
                
                <!-- Sort -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                        <span data-translate="sortBy">Sort by</span>
                    </label>
                    <select id="sortFilter" onchange="changeSortOrder(this.value)" class="settings-select" style="width: 100%;">
                        <option value="date-desc" data-translate="sortDateNewest">üìÖ Date (newest)</option>
                        <option value="date-asc" data-translate="sortDateOldest">üìÖ Date (oldest)</option>
                        <option value="amount-desc" data-translate="sortAmountHighest">üí∞ Amount (highest)</option>
                        <option value="amount-asc" data-translate="sortAmountLowest">üí∞ Amount (lowest)</option>
                        <option value="frequency-desc" data-translate="sortFrequencyMost">üîÑ Frequency (most)</option>
                        <option value="frequency-asc" data-translate="sortFrequencyLeast">üîÑ Frequency (least)</option>
                    </select>
                </div>
                
                <!-- Limit -->
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                        <span data-translate="showTransactions">Show transactions</span>
                    </label>
                    <select id="limitFilter" onchange="changeTransactionLimit(this.value)" class="settings-select" style="width: 100%;">
                        <option value="2000" data-translate="show2000">Show 2000</option>
                        <option value="1000" data-translate="show1000">Show 1000</option>
                        <option value="500" data-translate="show500">Show 500</option>
                        <option value="50" data-translate="show50">Show 50</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: space-between;">
                <button class="modal-button secondary" onclick="clearFilters()">
                    <span data-translate="clear">Clear</span>
                </button>
                <button class="modal-button primary" onclick="closeFiltersModal()">
                    <span data-translate="done">Done</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Credentials Modal (supports both Max and Isracard) -->
    <div id="credentialsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="credentialsModalTitle"><span data-translate="bankCredentials">üîê Bank Credentials</span></h2>
                <button class="modal-close" onclick="closeCredentialsModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="alert-trans alert-info-trans">
                    <span data-translate="credentialsSecure">Your credentials will be encrypted and stored securely in Firebase.</span>
                </div>
                <form id="credentialsForm" onsubmit="saveCredentials(event)">
                    <input type="hidden" id="bankType" value="max" />
                    
                    <!-- Max fields (visible par d√©faut) -->
                    <div id="maxFields">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <span data-translate="username">Username</span>
                            </label>
                            <input 
                                type="text" 
                                class="auth-input" 
                                id="maxUsername" 
                                data-translate-placeholder="yourUsername"
                                placeholder="Your username"
                            />
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <span data-translate="password">Password</span>
                            </label>
                            <input 
                                type="password" 
                                class="auth-input" 
                                id="maxPassword" 
                                data-translate-placeholder="yourPassword"
                                placeholder="Your password"
                            />
                        </div>
                    </div>
                    
                    <!-- Isracard fields (cach√©s par d√©faut) -->
                    <div id="isracardFields" style="display: none;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <span data-translate="idNumber">ID Number</span>
                            </label>
                            <input 
                                type="text" 
                                class="auth-input" 
                                id="isracardId" 
                                data-translate-placeholder="yourIsraeliId"
                                placeholder="Your Israeli ID"
                            />
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <span data-translate="cardLast6">Last 6 Digits of Card</span>
                            </label>
                            <input 
                                type="text" 
                                class="auth-input" 
                                id="isracardCard6" 
                                placeholder="123456"
                                maxlength="6"
                                pattern="[0-9]{6}"
                            />
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                                <span data-translate="password">Password</span>
                            </label>
                            <input 
                                type="password" 
                                class="auth-input" 
                                id="isracardPassword" 
                                data-translate-placeholder="yourPassword"
                                placeholder="Your password"
                            />
                        </div>
                    </div>
                    
                    <div id="credentialsError"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="modal-button secondary" onclick="closeCredentialsModal()">
                    <span data-translate="cancel">Cancel</span>
                </button>
                <button type="submit" form="credentialsForm" class="modal-button primary" id="saveCredentialsBtn">
                    <span data-translate="saveCredentials">Save Credentials</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Bank Accounts Modal -->
    <div id="bankAccountsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè¶ <span data-translate="bankAccountsConfig">Bank Accounts</span></h2>
                <button class="modal-close" onclick="closeBankAccountsModal()">‚úï</button>
            </div>
            <div class="modal-body">
                
                <!-- CSV Import Section -->
                <div class="bank-section">
                    <h4>üì• <span data-translate="importCSV">Import CSV / Excel</span></h4>
                    <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">
                        <span data-translate="importCSVDescription">Import transactions from CSV or Excel files (Revolut, N26, etc.)</span>
                    </p>
                    
                    <!-- Bank name input -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em;">
                            <span data-translate="bankName">Bank Name</span>
                        </label>
                        <input 
                            type="text" 
                            id="csvBankName" 
                            class="auth-input" 
                            placeholder="e.g. Revolut, N26, Wise..."
                            list="bankSuggestions"
                            style="width: 100%; padding: 10px; font-size: 1em;"
                        />
                        <datalist id="bankSuggestions">
                            <option value="Revolut">
                            <option value="N26">
                            <option value="Wise">
                            <option value="Monzo">
                            <option value="Starling">
                            <option value="Bunq">
                        </datalist>
                        <p style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                            <span data-translate="bankNameHelp">This helps you identify transactions from different banks</span>
                        </p>
                    </div>
                    
                    <!-- ‚úÖ S√©lecteur de p√©riode d'import -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em;">
                            <span data-translate="importPeriod">Import transactions from</span>
                        </label>
                        <select id="csvImportMonths" class="auth-input" style="width: 100%; padding: 10px; font-size: 1em;">
                            <option value="1" data-translate="oneMonthAgo">1 month ago</option>
                            <option value="3" data-translate="threeMonthsAgo">3 months ago</option>
                            <option value="6" data-translate="sixMonthsAgo">6 months ago</option>
                            <option value="12" data-translate="twelveMonthsAgo" selected>12 months ago</option>
                            <option value="18" data-translate="eighteenMonthsAgo">18 months ago</option>
                            <option value="24" data-translate="twentyFourMonthsAgo">24 months ago</option>
                            <option value="36" data-translate="thirtySixMonthsAgo">36 months ago</option>
                        </select>
                        <p style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                            <span data-translate="importPeriodHelp">Only transactions within this period will be imported</span>
                        </p>
                    </div>
                    
                    <input type="file" id="csvFileInput" class="csv-file-input" accept=".csv,.xlsx,.xls" multiple onchange="handleCSVUpload(event)" />
                    <button class="csv-import-btn" onclick="triggerCSVUpload()">
                        üì• <span data-translate="chooseCSV">Choose CSV/Excel File</span>
                    </button>
                    
                    <!-- Liste des CSV import√©s -->
                    <div class="csv-list" id="csvList">
                        <!-- Les CSV import√©s appara√Ætront ici -->
                    </div>
                    
                    <!-- ‚úÖ NOUVEAU : Bouton Auto-label sorti du menu Bank Sync -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                        <h4 style="margin-bottom: 10px;">üè∑Ô∏è <span data-translate="autoLabelTitle">Automatic Labeling</span></h4>
                        <p style="font-size: 0.9em; color: #6c757d; margin-bottom: 15px;">
                            <span data-translate="autoLabelDescription">Automatically label unlabeled transactions based on existing patterns</span>
                        </p>
                        <button class="btn btn-success" onclick="autoLabelAll()" id="autoLabelBtn" style="width: 100%; padding: 12px; font-size: 1em;">
                            üè∑Ô∏è <span data-translate="autoLabel">Auto-label</span>
                        </button>
                    </div>
                </div>

                <!-- Bank Synchronization (Collapsible) -->
                <div id="bankSyncSection" class="bank-section" style="border-top: 2px solid #e0e0e0; margin-top: 20px; padding-top: 20px; display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;" onclick="toggleBankSync()">
                        <h4>
                            <span id="bankSyncToggle" style="margin-right: 8px;">‚ñ∂</span>
                            <span data-translate="bankSynchronization">üîÑ Bank Synchronization</span>
                        </h4>
                    </div>
                    
                    <div id="bankSyncContent" style="display: none; margin-top: 20px;">
                        <!-- Max.co.il Credentials -->
                        <div style="background: var(--block-bg, #f8f9fa); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--block-border, #dee2e6);">
                            <h5 style="margin: 0 0 12px 0; font-size: 1em;"><span data-translate="maxLeumi">üí≥ Max.co.il (Leumi Card)</span></h5>
                            <div class="alert-trans alert-info-trans" id="maxCredentialsAlertModal" style="margin-bottom: 12px;">
                                <span data-translate="configureCredentials">Configure your Max credentials to sync transactions.</span>
                            </div>
                            <button class="btn btn-primary" onclick="openCredentialsModal('max')">
                                <span data-translate="setupMaxCredentials">üîê Setup Max Credentials</span>
                            </button>
                        </div>
                        
                        <!-- Isracard Credentials -->
                        <div style="background: var(--block-bg, #f8f9fa); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--block-border, #dee2e6);">
                            <h5 style="margin: 0 0 12px 0; font-size: 1em;"><span data-translate="isracard">üí≥ Isracard</span></h5>
                            <div class="alert-trans alert-info-trans" id="isracardCredentialsAlertModal" style="margin-bottom: 12px;">
                                <span data-translate="configureCredentials">Configure your Isracard credentials to sync transactions.</span>
                            </div>
                            <button class="btn btn-primary" onclick="openCredentialsModal('isracard')">
                                <span data-translate="setupIsracardCredentials">üîê Setup Isracard Credentials</span>
                            </button>
                        </div>
                        
                        <!-- Sync Section -->
                        <div style="background: var(--block-bg, #f8f9fa); padding: 15px; border-radius: 8px; border: 1px solid var(--block-border, #dee2e6);">
                            <h5 style="margin: 0 0 12px 0; font-size: 1em;"><span data-translate="syncStatus">Sync Status</span></h5>
                            <div style="margin-bottom: 15px; padding: 10px; background: var(--inner-block-bg, white); border-radius: 6px; border: 1px solid var(--block-border, #e9ecef);">
                                <div style="display: flex; flex-direction: column; gap: 8px; font-size: 0.9em;">
                                    <div><strong>Max:</strong> <span id="lastMaxSyncTimeModal" data-translate="never">Never</span> <span id="lastMaxSyncCountModal"></span></div>
                                    <div><strong>Isracard:</strong> <span id="lastIsracardSyncTimeModal" data-translate="never">Never</span> <span id="lastIsracardSyncCountModal"></span></div>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="syncAllTransactions()" id="syncAllBtnModal" style="width: 100%;">
                                <span data-translate="syncAll">üîÑ Sync All</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Clear All Transactions -->
                <div class="bank-section" style="margin-top: 20px; padding-top: 20px; text-align: center;">
                    <h4 data-translate="clearData" style="text-align: center;">üóëÔ∏è Clear Data</h4>
                    <button class="settings-btn danger" onclick="clearAllTransactions()" style="max-width: 400px; width: 100%; padding: 12px; font-size: 1em; margin: 0 auto; display: block;">
                        <span data-translate="clearAllTransactions">Clear All Transactions</span>
                    </button>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #6c757d; text-align: center;" data-translate="clearTransactionsWarning">
                        Remove all synced transactions from the database. This cannot be undone.
                    </p>
                </div>

            </div>
            <div class="modal-footer">
                <button class="modal-button primary" onclick="closeBankAccountsModal()">
                    <span data-translate="done">Done</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Manual Transaction Modal -->
    <div id="addManualTransactionModal" class="modal">
        <div class="modal-content" style="max-width: 500px; margin: 10vh auto;">
            <div class="modal-header">
                <h2>‚ûï <span data-translate="addManualTransaction">Add Transaction</span></h2>
                <button class="modal-close" onclick="closeAddManualTransactionModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Message si pas autoris√© -->
                <div id="bankSyncNotAllowed" style="display: none; background: #fff3cd; border: 1px solid #ffc107; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                    <h4 style="color: #856404; margin: 0 0 10px 0;">üîí Bank Synchronization Restricted</h4>
                    <p style="color: #856404; margin: 0;">
                        <span data-translate="bankSyncRestricted">This feature is currently restricted. Please contact the administrator for access.</span>
                    </p>
                </div>

                <form id="manualTransactionForm" onsubmit="saveManualTransaction(event)">
                    <!-- Name -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="transactionName">Name</span> <span style="color: #dc3545;">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="manualTxnName" 
                            class="auth-input" 
                            required
                            style="width: 100%;"
                            placeholder="e.g. Rent, Groceries..."
                        />
                    </div>

                    <!-- Date -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="date">Date</span> <span style="color: #dc3545;">*</span>
                        </label>
                        <input 
                            type="date" 
                            id="manualTxnDate" 
                            class="auth-input" 
                            required
                            style="width: 100%;"
                        />
                    </div>

                    <!-- Amount and Currency -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="amount">Amount</span> <span style="color: #dc3545;">*</span>
                        </label>
                        <div style="display: flex; gap: 10px;">
                            <input 
                                type="number" 
                                id="manualTxnAmount" 
                                class="auth-input" 
                                required
                                step="0.01"
                                min="0"
                                style="flex: 1;"
                                placeholder="0.00"
                            />
                            <select id="manualTxnCurrency" class="auth-input" style="width: 100px;">
                                <option value="‚Ç™">‚Ç™ ILS</option>
                                <option value="‚Ç¨">‚Ç¨ EUR</option>
                                <option value="$">$ USD</option>
                                <option value="¬£">¬£ GBP</option>
                            </select>
                        </div>
                    </div>

                    <!-- Memo (optional) -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="memo">Memo</span> <span style="font-size: 0.8em; color: #6c757d;" data-translate="optional">(optional)</span>
                        </label>
                        <textarea 
                            id="manualTxnMemo" 
                            class="auth-input" 
                            rows="3"
                            style="width: 100%; resize: vertical;"
                            placeholder="Additional notes..."
                        ></textarea>
                    </div>

                    <!-- Bank Name -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="bankName">Bank Name</span> <span style="font-size: 0.8em; color: #6c757d;" data-translate="optional">(optional)</span>
                        </label>
                        <input 
                            type="text" 
                            id="manualTxnBankName" 
                            class="auth-input" 
                            style="width: 100%;"
                            placeholder="e.g. Cash, Check, Wire Transfer..."
                        />
                        <p style="font-size: 0.8em; color: #6c757d; margin-top: 5px;">
                            <span data-translate="bankNameHelp">This helps you identify the source of this transaction</span>
                        </p>
                    </div>
                    
                    <!-- Category (optional) -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">
                            <span data-translate="category">Category</span> <span style="font-size: 0.8em; color: #6c757d;" data-translate="optional">(optional)</span>
                        </label>
                        <select id="manualTxnCategory" class="auth-input" style="width: 100%;">
                            <option value="" data-translate="selectCategory">Select category</option>
                            <!-- Categories will be populated dynamically -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
                <button class="modal-button" onclick="closeAddManualTransactionModal()">
                    <span data-translate="cancel">Cancel</span>
                </button>
                <button class="modal-button primary" onclick="document.getElementById('manualTransactionForm').requestSubmit()">
                    <span data-translate="save">Save</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Exclude Transaction Modal -->
    <div id="excludeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üö´ <span data-translate="excludeTransaction">Exclude Transaction</span></h2>
                <button class="modal-close" onclick="closeExcludeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <p id="excludeTransactionName" style="font-weight: 600; margin-bottom: 20px; color: #667eea;"></p>
                
                <button 
                    class="modal-button primary" 
                    style="width: 100%; margin-bottom: 10px; background: #dc3545; border-color: #dc3545;"
                    onclick="confirmExclude(false)"
                >
                    üö´ <span data-translate="excludeThisOnly">Exclude this transaction only</span>
                </button>
                
                <button 
                    class="modal-button primary" 
                    style="width: 100%; background: #bd2130; border-color: #bd2130;"
                    onclick="confirmExclude(true)"
                    id="excludeAllSimilarBtn"
                >
                    üö´üö´ <span id="excludeAllSimilarText">Exclude all similar transactions</span>
                </button>
            </div>
            <div class="modal-footer">
                <button class="modal-button secondary" onclick="closeExcludeModal()">
                    <span data-translate="cancel">Cancel</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Excluded Transactions Modal -->
    <div id="excludedTransactionsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üö´ <span data-translate="excludedTransactions">Excluded Transactions</span> <span id="excludedCount" style="color: #6c757d; font-size: 0.85em;"></span></h2>
                <button class="modal-close" onclick="closeExcludedTransactionsModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Options en haut -->
                <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #dee2e6;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9em;">
                        <input type="checkbox" id="restoreSimilarCheckbox" style="width: 18px; height: 18px; cursor: pointer;">
                        <span data-translate="restoreSimilarTransactions">Restore similar transactions</span>
                    </label>
                    <button 
                        onclick="restoreAllTransactions()"
                        style="padding: 10px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em; font-weight: 600; align-self: flex-start;"
                    >
                        ‚Ü©Ô∏è <span data-translate="restoreAll">Restore All</span>
                    </button>
                </div>
                
                <!-- Liste des transactions -->
                <div id="excludedTransactionsList"></div>
                <div id="noExcludedTransactions" style="display: none; text-align: center; padding: 40px; color: #6c757d;">
                    <div style="font-size: 3em; margin-bottom: 10px;">‚úÖ</div>
                    <div><span data-translate="noExcludedTransactions">No excluded transactions</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-button primary" onclick="closeExcludedTransactionsModal()">
                    <span data-translate="done">Done</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button class="scroll-to-top" id="scrollToTopBtn" onclick="scrollToTop()" title="Back to top">
        ‚Üë
    </button>
    <button class="floating-add-btn" id="floatingAddBtn" onclick="openAddManualTransactionModal()" title="Add transaction">
        +
    </button>
    <!-- Toast Notifications Container -->
    <div class="toast-container" id="toastContainer"></div>
    
</body>
</html>
