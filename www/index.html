<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Monthly Expenses Tracker</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-functions-compat.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="translations.js"></script>
    <link rel="stylesheet" href="css/auth-screen.css">
    <script src="js/auth-manager.js"></script>

    <script>
    // ‚úÖ APP VERSION - Facile √† modifier
    const APP_VERSION = '0.0.1';
    </script>

    <style>
        /* ============================================
           RESET & BASE STYLES
           ============================================ */
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            min-height: 100vh;
            padding: 10px;
            color: #333;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: -1;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        
        /* ============================================
           HEADER
           ============================================ */
        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            position: relative;
            
            /* === AJOUTS POUR L'ALIGNEMENT VERTICAL === */
            display: flex;        /* Active le mode Flexbox */
            align-items: center;  /* Centre les √©l√©ments enfants (h1 et bouton) verticalement */
            /* Assurez-vous d'avoir un padding vertical ici si n√©cessaire */
            
            min-height: 50px; 
            overflow: hidden; 
        }
                
        /* Modification du bloc .header h1 dans votre <style> */
        .header h1 {
            text-align: left;
            margin: 0;
            /* IMPORTANT : Le bouton "Settings" doit probablement √™tre en position: absolute;
               pour que le h1 puisse prendre la largeur maximale restante avec Flexbox. */
            padding-right: 60px;
            white-space: nowrap;
            overflow: visible;
            
            /* Taille g√©r√©e par le JS pour s'adapter */
            font-size: 24px;
            line-height: 1.2;
            width: 100%;
            /* display: block; n'est plus n√©cessaire mais peut √™tre laiss√© */
            
            /* === AJUSTEMENT MICRO-FIN === */
            /* Utilisez 1px, 2px, ou 3px pour le dernier ajustement visuel. */
            transform: translateY(2px);
        }
        
        /* Support RTL (Arabe/H√©breu) */
        html[dir="rtl"] .header h1 {
            text-align: right;
            padding-right: 0;
            padding-left: 60px;
        }
        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5em;
            }
        }
        
        @media (max-width: 400px) {
            .header h1 {
                font-size: 1.3em;
            }
        }
        
        .header p {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .settings-btn-header {
            position: absolute;
            right: 15px;
            top: 50%;
            
            /* === MODIFICATION CL√â ICI : Ajustement du Transform === */
            /* top: 50% d√©place le point d'ancrage au milieu du header.
               transform: translateY(calc(-50% + 1px)) d√©place l'√©l√©ment de -50% (centrage)
               puis ajoute 1px vers le bas pour l'alignement final. */
            transform: translateY(calc(-50% + 4px)); 
            
            background: transparent;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0;
            line-height: 1;
        }
        
        .settings-btn-header:hover {
            /* Mise √† jour du hover pour inclure le d√©calage d'alignement */
            transform: translateY(calc(-50% + 4px)) scale(1.15);
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.5));
        }

        /* ============================================
           AJOUT POUR LE SUPPORT RTL (H√©breu/Arabe)
           ============================================ */
        
        /* 1. D√©place le bouton Settings de droite √† gauche */
        html[dir="rtl"] .settings-btn-header {
            right: auto;  /* Annule la propri√©t√© 'right' par d√©faut */
            left: 15px;   /* Le place √† gauche */
        }
        
        /* 2. Ajuste l'espace de s√©curit√© du Titre pour ne pas chevaucher le bouton */
        html[dir="rtl"] .header h1 {
            padding-right: 0;    /* Enl√®ve l'espace √† droite (puisqu'il n'y a plus de bouton) */
            padding-left: 50px;  /* Ajoute l'espace √† gauche (l√† o√π est le bouton maintenant) */
            text-align: right;   /* S'assure que le texte est bien align√© √† droite */
        }

        
        /* ============================================
           DASHBOARD & TOTAL SECTION
           ============================================ */
        
        .dashboard {
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }
        
        .total-section {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            margin-bottom: 20px;
        }
        
        .total-section h2 {
            font-size: 1.2em;
            margin-bottom: 10px;
            opacity: 0.9;
            font-weight: 500;
        }
        
        .total-amount {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        /* ============================================
           CHART SECTION
           ============================================ */
        
        .chart-section {
            margin-bottom: 20px;
        }
        
        .chart-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            justify-content: center;
        }
        
        .chart-toggle-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chart-toggle-btn:hover {
            background: #f0f0f0;
        }
        
        .chart-toggle-btn.active {
            background: #667eea;
            color: white;
        }
        
        .color-customize-btn {
            padding: 10px 20px;
            border: 2px solid #28a745;
            background: white;
            color: #28a745;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .color-customize-btn:hover {
            background: #28a745;
            color: white;
        }
        
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 20px;
        }
        
        /* ============================================
           EXPENSES LIST
           ============================================ */
        
        .expenses-list {
            display: grid;
            gap: 10px;
        }
        
        .category-section {
            margin-bottom: 15px;
        }
        
        .category-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .category-stats {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .category-stats .amount {
            color: #667eea;
            font-weight: 600;
        }
        
        .category-stats .percentage {
            color: #999;
            margin-left: 8px;
        }
        
        .expense-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .expense-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .expense-name {
            font-weight: 500;
            color: #495057;
            flex: 1;
        }
        
        .expense-input {
            width: 120px;
            padding: 8px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            text-align: right;
            transition: all 0.3s ease;
            background: white;
        }
        
        .expense-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .expense-delete-btn {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: 5px;
            opacity: 0.6;
            transition: all 0.3s ease;
            border-radius: 5px;
        }
        
        .expense-delete-btn:hover {
            opacity: 1;
            background: #fee;
        }
        
        .currency {
            margin-left: 8px;
            color: #667eea;
            font-weight: 600;
        }
        
        .reset-button {
            width: 100%;
            padding: 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }
        
        .reset-button:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        /* ============================================
           AUTH SCREEN
           ============================================ */
        
        #authScreen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        
        .auth-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
        }
        
        .auth-title {
            text-align: center;
            color: #667eea;
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .auth-subtitle {
            text-align: center;
            color: #6c757d;
            margin-bottom: 30px;
        }
        
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .auth-input {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .auth-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .auth-button {
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #6c757d;
        }
        
        .auth-toggle button {
            background: none;
            border: none;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            text-decoration: underline;
        }
        
        .auth-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-bottom: 15px;
            display: none;
        }
        
        .auth-error.show {
            display: block;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            font-size: 0.9em;
        }
        
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 5px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* ============================================
           EDIT MODE
           ============================================ */
        
        .edit-mode-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            margin-left: -20px;
            margin-right: -20px;
            margin-top: -20px;
            padding: 12px 20px;
            flex-wrap: wrap;
            position: sticky;
            top: 0;
            background: white;
            border-bottom: 2px solid #f0f0f0;
            z-index: 100;
            align-items: center;
        }
        
        .edit-mode-btn {
            padding: 8px 16px;
            border: 2px solid #fd7e14;
            background: white;
            color: #fd7e14;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .edit-mode-btn:hover {
            background: #fd7e14;
            color: white;
        }
        
        .edit-mode-btn.active {
            background: #fd7e14;
            color: white;
        }
        
        .category-controls {
            display: none;
            margin-top: 10px;
            gap: 5px;
        }
        
        .category-controls.show {
            display: flex;
        }
        
        .category-btn {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            background: white;
            color: #495057;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .category-btn:hover {
            background: #f8f9fa;
        }
        
        .category-btn.danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .category-btn.danger:hover {
            background: #dc3545;
            color: white;
        }
        
        .rename-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 0.9em;
            padding: 2px 6px;
            margin-left: 8px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .rename-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .item-move-btns {
            display: none;
            gap: 5px;
            margin-left: 8px;
        }
        
        .item-move-btns.show {
            display: flex;
        }
        
        .item-move-btn {
            background: none;
            border: 1px solid #dee2e6;
            color: #495057;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }
        
        .item-move-btn:hover {
            background: #f8f9fa;
        }
        
        .item-rename-btn {
            background: none;
            border: none;
            color: #667eea;
            cursor: pointer;
            font-size: 1em;
            padding: 2px 6px;
            margin-left: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
            display: none;
        }
        
        .item-rename-btn.show {
            display: inline-block;
        }
        
        .item-rename-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        /* ============================================
           MODAL STYLES
           ============================================ */
        
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 15px;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 75vh;
            max-height: 75dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 12px 15px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .modal-header h2 {
            font-size: 1.2em;
            color: #667eea;
            margin: 0;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.3em;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .modal-close:hover {
            background: #f0f0f0;
            color: #333;
        }
        
        .modal-body {
            padding: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            min-height: 0;
        }
        
        .modal-footer {
            padding: 12px 15px;
            border-top: 2px solid #f0f0f0;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            flex-shrink: 0;
        }
        
        .modal-button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-button.primary {
            background: #667eea;
            color: white;
        }
        
        .modal-button.primary:hover {
            background: #5568d3;
        }
        
        .modal-button.secondary {
            background: #e9ecef;
            color: #495057;
        }
        
        .modal-button.secondary:hover {
            background: #dee2e6;
        }
        
        /* Color Editor Specific */
        .color-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .color-item:hover {
            background: #e9ecef;
        }
        
        .color-item-name {
            font-weight: 500;
            color: #495057;
            flex: 1;
            font-size: 0.9em;
        }
        
        .color-picker-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .color-preview {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid #dee2e6;
            cursor: pointer;
        }
        
        input[type="color"] {
            width: 40px;
            height: 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
                
        /* ============================================
           SETTINGS
           ============================================ */
        
        .settings-section {
            margin-bottom: 25px;
        }
        
        .settings-section h3 {
            color: #667eea;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        
        .settings-select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s ease;
        }
        
        .settings-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .settings-checkbox {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1em;
        }
        
        .settings-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .settings-description {
            margin-top: 8px;
            font-size: 0.9em;
            color: #6c757d;
            line-height: 1.4;
        }
        
        .settings-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .settings-btn.danger {
            background: #dc3545;
            color: white;
        }
        
        .settings-btn.danger:hover {
            background: #c82333;
        }
        
        /* ============================================
           APP SCREEN VISIBILITY
           ============================================ */
        
        #appScreen {
            display: none;
        }
        
        
        /* ============================================
           MOBILE RESPONSIVE (ALL IN ONE PLACE)
           ============================================ */
        
        @media (max-width: 600px) {
            /* Header */
            .header h1 {
                font-size: 2em;
            }
            
            .settings-btn-header {
                font-size: 1.5em;
                right: 10px;
            }
            
            /* Total */
            .total-amount {
                font-size: 2.5em;
            }
            
            /* Dashboard */
            .dashboard {
                padding: 20px;
            }
            
            /* Expenses */
            .expense-input {
                width: 100px;
            }
            
            /* Edit Mode */
            .edit-mode-controls {
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 6px;
                padding: 10px 15px;
            }
            
            .edit-mode-btn {
                padding: 6px 12px;
                font-size: 0.75em;
                white-space: nowrap;
            }
            
           /* Modals */
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                width: 95%;
                max-width: 95%;
                max-height: 70vh;
                max-height: 70dvh;
            }
            
            .modal-header {
                padding: 10px 12px;
            }
            
            .modal-header h2 {
                font-size: 1.1em;
            }
            
            .modal-body {
                padding: 12px;
            }
            
            .modal-footer {
                padding: 10px 12px;
                flex-direction: column;
                gap: 6px;
            }
            
            .modal-button {
                width: 100%;
                padding: 10px;
                font-size: 0.9em;
            }
        }
        
        @media (max-width: 480px) {
            .edit-mode-btn {
                padding: 5px 8px;
                font-size: 0.7em;
            }
            
            .edit-mode-controls {
                gap: 4px;
                padding: 8px 10px;
            }
            
        }
            /* Compare month selector */
        #compareMonth {
            display: none;
            padding: 10px 14px;
            border: 2px solid #667eea;
            border-radius: 10px;
            font-size: 0.85em;
            cursor: pointer;
            font-weight: 600;
            color: #667eea;
            background: white;
        }
    
        @media (max-width: 600px) {
            #compareMonth {
                font-size: 0.75em;
                padding: 6px 8px;
                max-width: 120px;
                min-width: 0; /* Permet de shrink */
                width: auto;
            }
            
            .edit-mode-controls {
                gap: 8px;
            }
        }
        /* ============================================
           DARK MODE
           ============================================ */
        
        body.dark-mode {
            color: #e0e0e0;
        }
        
        body.dark-mode::before {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        body.dark-mode .dashboard,
        body.dark-mode .category-section,
        body.dark-mode .transactions-section {
            background: #2a2a3e;
            color: #e0e0e0;
        }
        
        body.dark-mode .category-header,
        body.dark-mode .transaction-item,
        body.dark-mode .category-header-trans,
        body.dark-mode .sync-status {
            background: #1f1f2e;
            color: #e0e0e0;
        }
        
        body.dark-mode .toolbar-btn,
        body.dark-mode .filter-select,
        body.dark-mode .filter-search {
            background: #1f1f2e;
            color: #e0e0e0;
            border-color: #3a3a4e;
        }
        
        body.dark-mode .toolbar-btn:hover,
        body.dark-mode .filter-select:hover,
        body.dark-mode .filter-search:hover {
            background: #2a2a3e;
            border-color: #667eea;
        }
        
        body.dark-mode .transactions-sticky-toolbar {
            background: rgba(42, 42, 62, 0.98);
        }
        
        body.dark-mode .filter-clear-btn {
            background: #3a3a4e;
            color: #e0e0e0;
        }
        
        body.dark-mode .filter-clear-btn:hover {
            background: #4a4a5e;
        }
        
        body.dark-mode .modal-content {
            background: #2a2a3e;
            color: #e0e0e0;
        }
        
        body.dark-mode .modal-header {
            border-bottom-color: #3a3a4e;
        }
        
        body.dark-mode .modal-footer {
            border-top-color: #3a3a4e;
        }
        
        body.dark-mode .auth-input,
        body.dark-mode .settings-select,
        body.dark-mode .transaction-category-select {
            background: #1f1f2e;
            color: #e0e0e0;
            border-color: #3a3a4e;
        }
        
        body.dark-mode .category-btn,
        body.dark-mode .category-btn-trans {
            background: #1f1f2e;
            color: #e0e0e0;
            border-color: #3a3a4e;
        }
        
        body.dark-mode .category-btn:hover,
        body.dark-mode .category-btn-trans:hover {
            background: #2a2a3e;
            border-color: #667eea;
        }
        
        body.dark-mode .transaction-desc,
        body.dark-mode .category-name,
        body.dark-mode .category-name-trans {
            color: #e0e0e0;
        }
        
        body.dark-mode .transaction-date,
        body.dark-mode .sync-info {
            color: #a0a0b0;
        }
        
        body.dark-mode .empty-state-trans {
            color: #a0a0b0;
        }
        
        body.dark-mode .alert-trans {
            background: #1f1f2e;
            border-left-width: 4px;
        }
        
        body.dark-mode .alert-info-trans {
            border-left-color: #17a2b8;
            color: #5dccdc;
        }
        
        body.dark-mode .alert-success-trans {
            border-left-color: #28a745;
            color: #6cd386;
        }
        
        body.dark-mode .alert-error-trans {
            border-left-color: #dc3545;
            color: #ff6b7a;
        }
        
        /* Comparison info in dark mode */
        body.dark-mode .compare-info {
            background: #1f1f2e;
        }
        
        body.dark-mode .budget-label,
        body.dark-mode .real-label,
        body.dark-mode .diff {
            color: #e0e0e0;
        }
        
        body.dark-mode .compare-progress {
            background: #3a3a4e;
        }
        
        /* Settings in dark mode */
        body.dark-mode .settings-section {
            border-bottom-color: #3a3a4e;
        }
        
        body.dark-mode .edit-mode-controls {
            background: #2a2a3e;
            border-bottom-color: #3a3a4e;
        }
        
        body.dark-mode .edit-mode-btn {
            background: #1f1f2e;
            color: #e0e0e0;
            border-color: #3a3a4e;
        }
        
        body.dark-mode .edit-mode-btn:hover {
            background: #2a2a3e;
            border-color: #667eea;
        }
        
        body.dark-mode .edit-mode-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* Chart legend labels in dark mode */
        body.dark-mode .chartjs-legend,
        body.dark-mode .chartjs-legend span {
            color: #e0e0e0 !important;
        }


        /* Expense items in dark mode (same style as transactions) */
        body.dark-mode .expense-item {
            background: #1f1f2e;
            color: #e0e0e0;
        }
        
        body.dark-mode .expense-item:hover {
            background: #2a2a3e;
        }
        
        body.dark-mode .expense-name {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode .expense-input {
            background: #2a2a3e;
            color: #e0e0e0;
            border-color: #3a3a4e;
        }
        
        /* Fix centrage et espacement mobile */
        #auth-screen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 20px !important;
            box-sizing: border-box !important;
        }
        
        #auth-screen:not([style*="display: none"]) {
            display: flex !important;
        }
        
        .auth-container {
            width: 100%;
            max-width: 400px;
            margin: auto;
        }

        /* Espacement des √©l√©ments du formulaire */
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;  /* Espace entre les √©l√©ments */
        }

        .auth-form input {
            margin-bottom: 10px;
        }

        .remember-me-container {
            margin: 10px 0;
        }

        .remember-me-container {
            display: flex;
            align-items: center;
        }

        .remember-me-container input[type="checkbox"] {
            margin: 0;
            margin-right: 8px;
        }


        /* ============================================
        RESPONSIVE AUTH SCREEN - FIX MOBILE
        ============================================ */


    </style>
    <link rel="stylesheet" href="css/tabs.css">
</head>
<body>
    <!-- ========== D√âBUT DE L'√âCRAN DE CONNEXION ========== -->
    <!-- Auth Screen -->
    <div id="auth-screen" style="display: block;">
        <!-- Language Selector -->
        <div class="language-selector">
            <button onclick="authManager.applyLanguage('en'); updateLanguageButtons('en')" data-lang="en">EN</button>
            <button onclick="authManager.applyLanguage('fr'); updateLanguageButtons('fr')" data-lang="fr">FR</button>
            <button onclick="authManager.applyLanguage('he'); updateLanguageButtons('he')" data-lang="he">◊¢◊ë</button>
            <button onclick="authManager.applyLanguage('es'); updateLanguageButtons('es')" data-lang="es">ES</button>
            <button onclick="authManager.applyLanguage('ru'); updateLanguageButtons('ru')" data-lang="ru">–†–£</button>
            <button onclick="authManager.applyLanguage('ar'); updateLanguageButtons('ar')" data-lang="ar">ÿπÿ±</button>
        </div>
        
        <div class="auth-container">
            <h2 data-translate="appTitle">üí∞ Expense Tracker</h2>
            <p data-translate="authSubtitle">Sign in to sync your expenses</p>
            
            <!-- Error message container -->
            <div id="authError" class="auth-error" style="display: none;"></div>
            
            <div class="auth-form">
                <input type="email" 
                    id="email" 
                    placeholder="Email" 
                    data-translate-placeholder="email"
                    autocomplete="email">
                
                <div style="position: relative; width: 100%;">
                    <input type="password" 
                        id="password" 
                        placeholder="Password (min 6 characters)" 
                        data-translate-placeholder="password"
                        autocomplete="current-password"
                        style="width: 100%; padding-right: 45px;">
                    <button type="button" id="togglePassword" 
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 20px; padding: 0;">
                        üëÅÔ∏è
                    </button>
                </div>
                
                <!-- ‚úÖ AJOUTE CE LIEN -->
                <div style="text-align: right; margin-top: -5px; margin-bottom: 10px;">
                    <a id="forgotPasswordLink" 
                    onclick="showForgotPasswordDialog()" 
                    style="font-size: 13px; color: var(--auth-link); cursor: pointer; text-decoration: none;"
                    data-translate="forgotPassword">
                        Forgot password?
                    </a>
                </div>

                <!-- Remember Me Checkbox -->
                <div class="remember-me-container">
                    <label for="rememberMe">
                        <input type="checkbox" id="rememberMe">
                        <span data-translate="rememberMe">Remember me</span>
                    </label>
                </div>
                
                <div class="auth-buttons">
                    <button id="signInBtn" 
                            onclick="handleSignIn()" 
                            data-translate="signIn">Sign In</button>
                    <button id="signUpBtn" 
                            onclick="handleSignUp()" 
                            data-translate="signUp">Sign Up</button>
                </div>
            </div>
            
            <div class="auth-switch">
                <span data-translate="noAccount">Don't have an account?</span>
                <a onclick="toggleAuthMode()" data-translate="signUp">Sign Up</a>
            </div>
        </div>
    </div>
    <!-- ========== FIN DE L'√âCRAN DE CONNEXION ========== -->

    <div id="appScreen">
    <div class="container">
        <div class="header">
            <h1 id="appTitle">Monthly Expenses</h1>
            <button class="settings-btn-header" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
        </div>
        
        <!-- ONGLETS -->
        <div class="app-tabs">
            <button class="app-tab active" data-tab="budget" onclick="switchTab('budget')">
                <span data-translate="budgetTab">Budget</span>
            </button>
            <button class="app-tab" data-tab="transactions" onclick="switchTab('transactions')">
                <span data-translate="transactionsTab">Transactions</span>
            </button>
        </div>

            <div class="dashboard">
                <!-- ========================================
                    ONGLET BUDGET
                    ======================================== -->
                <div id="budgetTab" class="tab-content active">
                    <div class="edit-mode-controls">
                        <button class="edit-mode-btn" id="editModeBtn" onclick="toggleEditMode()">
                            <span id="editBtnText" data-translate="editCategories">Edit Categories</span>
                        </button>
                        <button class="edit-mode-btn" id="compareBtn" onclick="toggleCompareMode()" style="background: white; border-color: #667eea; color: #667eea;">
                            <span data-translate="compare">Compare</span>
                        </button>
                        
                        <!-- ‚úÖ AJOUTE CE BOUTON ICI -->
                        <button class="edit-mode-btn" onclick="addNewCategory()" style="display: none; border-color: #28a745; color: #28a745;">
                            <span data-translate="addCategory">‚ûï Add Category</span>
                        </button>
                        
                        <select id="compareMonth" onchange="loadRealSpending()">
                        </select>
                    </div>

                    <div class="total-section">
                        <div id="incomeDisplay" style="display: none; margin-bottom: 15px; opacity: 0.9;">
                            <h3 style="font-size: 1em; margin-bottom: 5px;" data-translate="totalIncome">Total Income</h3>
                            <div style="font-size: 1.8em; font-weight: 600;" id="totalIncome">‚Ç™0</div>
                        </div>
                        <h2 data-translate="totalExpenses">Total Monthly Expenses</h2>
                        <div class="total-amount" id="totalAmount">‚Ç™0</div>
                        <div id="remainingDisplay" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 2px solid rgba(255,255,255,0.3);">
                            <h3 style="font-size: 1em; margin-bottom: 5px;" data-translate="remaining">Remaining</h3>
                            <div style="font-size: 2em; font-weight: 700;" id="remainingAmount">‚Ç™0</div>
                            <div style="font-size: 0.9em; margin-top: 5px; opacity: 0.9;" id="remainingPercentage"></div>
                        </div>
                    </div>

                    <div class="chart-section">
                        <div class="chart-controls">
                            <button id="pieChartBtn" class="chart-toggle-btn active" data-type="doughnut">
                                <span data-translate="pieChart">Pie Chart</span>
                            </button>
                            <button id="barChartBtn" class="chart-toggle-btn" data-type="bar">
                                <span data-translate="barChart">Bar Chart</span>
                            </button>
                            <button id="colorsBtn" class="color-customize-btn" onclick="openColorEditor()">
                                <span data-translate="colors">Colors</span>
                            </button>
                        </div>
                        <div class="chart-container">
                            <canvas id="expensesChart"></canvas>
                        </div>
                    </div>

                     <div class="expenses-list" id="expensesList">
                    <!-- Income Category -->
                    <div class="category-section income-category" id="category-income" style="display: none;">
                        <div class="category-title" style="color: #28a745; border-color: #28a745;">
                            <span data-translate="income">Income</span>
                            <button class="rename-btn rename-btn-income" onclick="renameCategory('income')" style="display: none;">‚úèÔ∏è</button>
                        </div>
                        <div class="category-stats" id="incomeStats" style="color: #28a745;"></div>
                        <div class="category-controls">
                            <button class="category-btn" onclick="addItemToCategory('income')">‚ûï Add Item</button>
                        </div>
                        <div id="incomeExpenses"></div>
                    </div>
                
                    <!-- Housing Category -->
                    <div class="category-section" id="category-housing">
                        <div class="category-title">
                            üè† Housing
                            <button class="rename-btn" onclick="renameCategory('housing')" style="display: none;">‚úèÔ∏è</button>
                        </div>
                        <div class="category-stats" id="housingStats"></div>
                        <div class="category-controls">
                            <button class="category-btn" onclick="moveCategoryUp('housing')">
                                <span data-translate="moveUp">‚Üë Move Up</span>
                            </button>
                            <button class="category-btn" onclick="moveCategoryDown('housing')">
                                <span data-translate="moveDown">‚Üì Move Down</span>
                            </button>
                            <button class="category-btn" onclick="addItemToCategory('housing')">
                                <span data-translate="addItem">‚ûï Add Item</span>
                            </button>
                            <button class="category-btn danger" onclick="deleteCategory('housing')">
                                <span data-translate="deleteCategory">üóëÔ∏è Delete Category</span>
                            </button>
                        </div>
                        <div id="housingExpenses"></div>
                    </div>
                
                    <!-- Subscriptions Category -->
                    <div class="category-section" id="category-subscriptions">
                        <div class="category-title">
                            üé¨ Subscriptions
                            <button class="rename-btn" onclick="renameCategory('subscriptions')" style="display: none;">‚úèÔ∏è</button>
                        </div>
                        <div class="category-stats" id="subscriptionsStats"></div>
                        <div class="category-controls">
                            <button class="category-btn" onclick="moveCategoryUp('subscriptions')">
                                <span data-translate="moveUp">‚Üë Move Up</span>
                            </button>
                            <button class="category-btn" onclick="moveCategoryDown('subscriptions')">
                                <span data-translate="moveDown">‚Üì Move Down</span>
                            </button>
                            <button class="category-btn" onclick="addItemToCategory('subscriptions')">
                                <span data-translate="addItem">‚ûï Add Item</span>
                            </button>
                            <button class="category-btn danger" onclick="deleteCategory('subscriptions')">
                                <span data-translate="deleteCategory">üóëÔ∏è Delete Category</span>
                            </button>
                        </div>
                        <div id="subscriptionsExpenses"></div>
                    </div>
                
                    <!-- Groceries Category -->
                    <div class="category-section" id="category-groceries">
                        <div class="category-title">
                            üõí Groceries
                            <button class="rename-btn" onclick="renameCategory('groceries')" style="display: none;">‚úèÔ∏è</button>
                        </div>
                        <div class="category-stats" id="groceriesStats"></div>
                        <div class="category-controls">
                            <button class="category-btn" onclick="moveCategoryUp('groceries')">
                                <span data-translate="moveUp">‚Üë Move Up</span>
                            </button>
                            <button class="category-btn" onclick="moveCategoryDown('groceries')">
                                <span data-translate="moveDown">‚Üì Move Down</span>
                            </button>
                            <button class="category-btn" onclick="addItemToCategory('groceries')">
                                <span data-translate="addItem">‚ûï Add Item</span>
                            </button>
                            <button class="category-btn danger" onclick="deleteCategory('groceries')">
                                <span data-translate="deleteCategory">üóëÔ∏è Delete Category</span>
                            </button>
                        </div>
                        <div id="groceriesExpenses"></div>
                    </div>
                
                    <!-- Pet Care Category -->
                    <div class="category-section" id="category-pet">
                        <div class="category-title">
                            üê± Pet Care
                            <button class="rename-btn" onclick="renameCategory('pet')" style="display: none;">‚úèÔ∏è</button>
                        </div>
                        <div class="category-stats" id="petStats"></div>
                        <div class="category-controls">
                            <button class="category-btn" onclick="moveCategoryUp('pet')">
                                <span data-translate="moveUp">‚Üë Move Up</span>
                            </button>
                            <button class="category-btn" onclick="moveCategoryDown('pet')">
                                <span data-translate="moveDown">‚Üì Move Down</span>
                            </button>
                            <button class="category-btn" onclick="addItemToCategory('pet')">
                                <span data-translate="addItem">‚ûï Add Item</span>
                            </button>
                            <button class="category-btn danger" onclick="deleteCategory('pet')">
                                <span data-translate="deleteCategory">üóëÔ∏è Delete Category</span>
                            </button>
                        </div>
                        <div id="petExpenses"></div>
                    </div>
                
                    <!-- Hobbies Category (NEW) -->
                    <div class="category-section" id="category-hobbies">
                        <div class="category-title">
                            üéÆ Hobbies
                            <button class="rename-btn" onclick="renameCategory('hobbies')" style="display: none;">‚úèÔ∏è</button>
                        </div>
                        <div class="category-stats" id="hobbiesStats"></div>
                        <div class="category-controls">
                            <button class="category-btn" onclick="moveCategoryUp('hobbies')">
                                <span data-translate="moveUp">‚Üë Move Up</span>
                            </button>
                            <button class="category-btn" onclick="moveCategoryDown('hobbies')">
                                <span data-translate="moveDown">‚Üì Move Down</span>
                            </button>
                            <button class="category-btn" onclick="addItemToCategory('hobbies')">
                                <span data-translate="addItem">‚ûï Add Item</span>
                            </button>
                            <button class="category-btn danger" onclick="deleteCategory('hobbies')">
                                <span data-translate="deleteCategory">üóëÔ∏è Delete Category</span>
                            </button>
                        </div>
                        <div id="hobbiesExpenses"></div>
                    </div>
                
                    <!-- Other Expenses Category -->
                    <div class="category-section" id="category-other">
                        <div class="category-title">
                            üí∏ Other Expenses
                            <button class="rename-btn" onclick="renameCategory('other')" style="display: none;">‚úèÔ∏è</button>
                        </div>
                        <div class="category-stats" id="otherStats"></div>
                        <div class="category-controls">
                            <button class="category-btn" onclick="moveCategoryUp('other')">
                                <span data-translate="moveUp">‚Üë Move Up</span>
                            </button>
                            <button class="category-btn" onclick="moveCategoryDown('other')">
                                <span data-translate="moveDown">‚Üì Move Down</span>
                            </button>
                            <button class="category-btn" onclick="addItemToCategory('other')">
                                <span data-translate="addItem">‚ûï Add Item</span>
                            </button>
                            <button class="category-btn danger" onclick="deleteCategory('other')">
                                <span data-translate="deleteCategory">üóëÔ∏è Delete Category</span>
                            </button>
                        </div>
                        <div id="otherExpenses"></div>
                    </div>
                </div>

                    <button id="resetBtn" class="reset-button" onclick="resetExpenses()">
                        <span data-translate="resetAll">Reset All Expenses</span>
                    </button>
                </div>
                <!-- FIN DE L'ONGLET BUDGET -->

                <!-- ========================================
                    ONGLET TRANSACTIONS
                    ======================================== -->
                <div id="transactionsTab" class="tab-content">
                    <!-- Charg√© dynamiquement depuis partials/transactions-tab.html -->
                </div>
                <!-- FIN DE L'ONGLET TRANSACTIONS -->

            </div>
            <!-- FIN DE DASHBOARD -->

                
        </div> <!-- Fin container -->
    </div> <!-- Fin appScreen -->

    <!-- Color Editor Modal -->
    <div id="colorEditorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé® Customize Colors</h2>
                <button class="modal-close" onclick="closeColorEditor()">‚úï</button>
            </div>
            <div class="modal-body" id="colorEditorBody">
                <!-- Color items will be generated here -->
            </div>
            <div class="modal-footer">
                <button class="modal-button secondary" onclick="resetColors()">Reset to Default</button>
                <button class="modal-button primary" onclick="closeColorEditor()">Done</button>
            </div>
        </div>
    </div>
    
     <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 data-translate="settingsTitle">‚öôÔ∏è Settings</h2>
                <button class="modal-close" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Account Section -->
                <div class="settings-section">
                    <h3 data-translate="account">Account</h3>
                    <p id="settingsUserEmail" style="color: #6c757d; margin-bottom: 10px;"></p>
                    <button class="modal-button secondary" onclick="handleLogout()">
                        <span data-translate="logout">Logout</span>
                    </button>
                </div>
                
                <!-- Language Section (pas besoin de traduire le titre) -->
                <div class="settings-section">
                    <h3>Language / Langue / Idioma / –Ø–∑—ã–∫ / ◊©◊§◊î / ŸÑÿ∫ÿ©</h3>
                    <select class="settings-select" id="languageSelect" onchange="changeLanguage(this.value)">
                        <option value="en">English</option>
                        <option value="fr">Fran√ßais</option>
                        <option value="es">Espa√±ol</option>
                        <option value="ru">–†—É—Å—Å–∫–∏–π</option>
                        <option value="he">◊¢◊ë◊®◊ô◊™</option>
                        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                    </select>
                </div>
                
                <!-- Currency Section -->
                <div class="settings-section">
                    <h3 data-translate="currency">Currency</h3>
                    <select class="settings-select" id="currencySelect" onchange="updateCurrency(this.value)">
                        <option value="ILS">Israeli Shekel (‚Ç™)</option>
                        <option value="USD">US Dollar ($)</option>
                        <option value="EUR">Euro (‚Ç¨)</option>
                        <option value="GBP">British Pound (¬£)</option>
                        <option value="JPY">Japanese Yen (¬•)</option>
                        <option value="RUB">Russian Ruble (‚ÇΩ)</option>
                        <option value="CNY">Chinese Yuan (¬•)</option>
                        <option value="EGP">Egyptian Pound (E¬£)</option>
                        <option value="LBP">Lebanese Pound (L¬£)</option>
                        <option value="SYP">Syrian Pound (S¬£)</option>
                        <option value="JOD">Jordanian Dinar (ÿØ.ÿß)</option>
                        <option value="INR">Indian Rupee (‚Çπ)</option>
                        <option value="THB">Thai Baht (‡∏ø)</option>
                    </select>
                </div>
                
                <!-- Income Tracking Section -->
                <div class="settings-section">
                    <h3 data-translate="incomeTracking">Income Tracking</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="useIncomeCheckbox" onchange="toggleIncomeFeature(this.checked)" />
                        <span data-translate="trackIncome">Track monthly income</span>
                    </label>
                </div>
                
                <!-- Dark Mode Section -->
                <div class="settings-section">
                    <h3 data-translate="darkMode">üåô Dark Mode</h3>
                    <label class="settings-checkbox">
                        <input type="checkbox" id="darkModeCheckbox" onchange="toggleDarkMode(this.checked)" />
                        <span data-translate="enableDarkMode">Enable dark mode</span>
                    </label>
                </div>

                                
                <!-- Percentage Calculation Section -->
                <div class="settings-section" id="percentageModeSection" style="display: none;">
                    <h3 data-translate="percentageCalculation">Percentage Calculation</h3>
                    <select class="settings-select" id="percentageModeSelect" onchange="updatePercentageMode(this.value)">
                        <option value="expenses" data-translate="basedOnExpenses">Based on total expenses</option>
                        <option value="income" data-translate="basedOnIncome">Based on total income</option>
                    </select>
                    <p class="settings-description" data-translate="percentageDesc">Choose how category percentages are calculated</p>
                </div>
               
                <!-- About Section -->
                <div class="settings-section" style="border-top: 2px solid #e9ecef; margin-top: 30px; padding-top: 20px; text-align: center; font-size: 0.85em; color: #6c757d;">
                    <p style="margin: 5px 0; font-weight: 600;" data-translate="madeBy">Made by Victor Burtman</p>
                    <p style="margin: 5px 0;"><span data-translate="contactInfo">For any bug report, ideas or suggestions:</span></p>
                    <a href="mailto:victorburtman@gmail.com" style="color: #667eea; text-decoration: none; font-weight: 600;">victorburtman@gmail.com</a>
                </div> 

                <!-- App Version Section -->
                <div class="settings-section">
                    <h3 data-translate="appVersion">‚ÑπÔ∏è App Version</h3>
                    <p style="font-size: 1.1em; font-weight: 600; color: #667eea;">
                        <span id="appVersionDisplay">Loading...</span>
                    </p>
                    <p style="font-size: 0.9em; color: #6c757d;">
                        <span data-translate="versionInfo">Current version of your Personal Finance app</span>
                    </p>
                </div>
                
            </div>
            <div class="modal-footer">
                <button class="modal-button primary" onclick="closeSettings()">
                    <span data-translate="done">Done</span>
                </button>
            </div>
        </div>
    </div>


    
    <script>

            /**
             * Ajuste la taille de la police du titre pour qu'il tienne sur une seule ligne.
             * Commence √† 28px et r√©duit progressivement si d√©bordement.
             */
            function fitAppTitle() {
                const h1 = document.querySelector('.header h1');
                if (!h1) return;
            
                // 1. D√©finir la taille maximale souhait√©e (en px)
                let size = 28; // On monte √† 28px pour les grands √©crans
                h1.style.fontSize = size + 'px';
                
                // 2. Boucle de r√©duction : tant que le texte d√©passe et que la taille est > 12px
                while (h1.scrollWidth > h1.clientWidth && size > 12) {
                    size -= 0.5; // On r√©duit de 0.5px (plus fin que 1px)
                    h1.style.fontSize = size + 'px';
                }
            }
            
            // Gestionnaire de redimensionnement simplifi√© (sans debounce externe)
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(fitAppTitle, 100);
            });


        /**
         * Emp√™che une fonction de s'ex√©cuter trop souvent.
         * @param {function} func - La fonction √† d√©bouncer.
         * @param {number} delay - Le d√©lai en ms (e.g., 100ms).
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }





        
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Error caught:', e.message);
            // Don't let errors break the app
            e.preventDefault();
        });

        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyBQ817hUTznf99z7ZFhVla39rnyjGibTWo",
          authDomain: "expense-tracker-b086e.firebaseapp.com",
          projectId: "expense-tracker-b086e",
          storageBucket: "expense-tracker-b086e.firebasestorage.app",
          messagingSenderId: "958947625850",
          appId: "1:958947625850:web:a67c87046977c909bfa4c3"
        };

        // Initialize Firebase
        let app, auth, db, functions;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            functions = firebase.functions();
            window.functions = functions;
        } catch (error) {  // ‚Üê AJOUTE CETTE LIGNE
            console.error('Firebase initialization error:', error);
        }

        // Global variables
        let currentUser = null;
        let isEditMode = false;
        let categoryOrder = ['income', 'housing', 'subscriptions', 'groceries', 'pet', 'hobbies', 'other'];
        let useIncome = true;
        let currency = '‚Ç™'; // Default currency symbol
        let currencyOptions = {
            'ILS': '‚Ç™',
            'USD': '$',
            'EUR': '‚Ç¨',
            'GBP': '¬£',
            'JPY': '¬•',
            'RUB': '‚ÇΩ',
            'CNY': '¬•',
            'EGP': 'E¬£',
            'LBP': 'L¬£',
            'SYP': 'S¬£',
            'JOD': 'ÿØ.ÿß',
            'INR': '‚Çπ',
            'THB': '‡∏ø'
        };
        let percentageMode = 'expenses'; // 'expenses' or 'income'

        // Store category metadata (emoji, display name)
        let categoryMetadata = {};

        let currentLanguage = 'en'; // Variable pour la langue actuelle


        // ========== D√âBUT DU CODE POUR L'√âCRAN DE CONNEXION ==========

        // Variables globales pour l'authentification
        let isSignUpMode = false;

        // V√©rifier que authManager existe
        if (typeof authManager === 'undefined') {
            console.error('‚ö†Ô∏è authManager not loaded! Check if auth-manager.js is included before this script');
        }

        async function handleSignIn() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const remember = document.getElementById('rememberMe').checked;
            
            // ‚úÖ Validation STRICTE avant tout
            const validationError = authManager.validateAuthForm(email, password);
            if (validationError) {
                authManager.showAuthError(validationError);
                return; // STOP ICI - Ne pas appeler Firebase
            }
            
            const signInBtn = document.getElementById('signInBtn');
            const signUpBtn = document.getElementById('signUpBtn');
            
            try {
                signInBtn.disabled = true;
                signUpBtn.disabled = true;
                
                await authManager.signIn(email, password, remember);
                
            } catch (error) {
                console.error('Sign in error:', error);
                const errorMessage = authManager.getErrorMessage(error.code);
                authManager.showAuthError(errorMessage);
                
                signInBtn.disabled = false;
                signUpBtn.disabled = false;
            }
        }

        async function handleSignUp() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const remember = document.getElementById('rememberMe').checked;
            
            // ‚úÖ Validation STRICTE avant tout
            const validationError = authManager.validateAuthForm(email, password);
            if (validationError) {
                authManager.showAuthError(validationError);
                return; // STOP ICI - Ne pas appeler Firebase
            }
            
            const signInBtn = document.getElementById('signInBtn');
            const signUpBtn = document.getElementById('signUpBtn');
            
            try {
                signInBtn.disabled = true;
                signUpBtn.disabled = true;
                
                await authManager.signUp(email, password, remember);
                
            } catch (error) {
                console.error('Sign up error:', error);
                const errorMessage = authManager.getErrorMessage(error.code);
                authManager.showAuthError(errorMessage);
                
                signInBtn.disabled = false;
                signUpBtn.disabled = false;
            }
        }

        // ========== TOGGLE PASSWORD VISIBILITY ==========
        document.addEventListener('DOMContentLoaded', function() {
            const togglePasswordBtn = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            const emailInput = document.getElementById('email');
            
            // Toggle password visibility
            if (togglePasswordBtn && passwordInput) {
                togglePasswordBtn.addEventListener('click', function() {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        togglePasswordBtn.textContent = 'üôà';
                    } else {
                        passwordInput.type = 'password';
                        togglePasswordBtn.textContent = 'üëÅÔ∏è';
                    }
                });
            }
            
            // Submit with Enter key on password field
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const signInBtn = document.getElementById('signInBtn');
                        if (signInBtn) signInBtn.click();
                    }
                });
            }
            
            // Focus password field when Enter is pressed on email
            if (emailInput && passwordInput) {
                emailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        passwordInput.focus();
                    }
                });
            }
        });








        // Afficher les erreurs d'authentification
        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                // Cacher l'erreur apr√®s 5 secondes
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        // Traduire les messages d'erreur Firebase
        function getAuthErrorMessage(error) {
            const errorMessages = {
                'auth/email-already-in-use': 'This email is already registered',
                'auth/invalid-email': 'Invalid email address',
                'auth/weak-password': 'Password is too weak',
                'auth/user-not-found': 'No account found with this email',
                'auth/wrong-password': 'Incorrect password',
                'auth/network-request-failed': 'Network error, please try again',
                'auth/too-many-requests': 'Too many attempts, please try again later',
                'auth/user-disabled': 'This account has been disabled'
            };
            
            return errorMessages[error.code] || error.message || 'An error occurred';
        }

        // Mettre √† jour le bouton de langue actif
        function updateLanguageButtons(langCode) {
            document.querySelectorAll('.language-selector button').forEach(btn => {
                if (btn.dataset.lang === langCode) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }

        // G√©rer la touche Entr√©e pour soumettre le formulaire
        function setupAuthKeyboardHandlers() {
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            
            if (emailInput) {
                emailInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        passwordInput.focus();
                    }
                });
            }
            
            if (passwordInput) {
                passwordInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        if (isSignUpMode) {
                            handleSignUp();
                        } else {
                            handleSignIn();
                        }
                    }
                });
            }
        }

        // ========== FIN DU CODE POUR L'√âCRAN DE CONNEXION ==========



        // Fonction pour obtenir une traduction
        function t(key) {
            return translations[currentLanguage][key] || key;
        }
        
        function changeLanguage(lang) {
            currentLanguage = lang;
            
            // Sauvegarder la langue choisie
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({
                    language: lang
                }, { merge: true });
            }
            
            // ‚úÖ Toujours sauvegarder dans localStorage aussi (pour sync entre √©cran de co et app)
            localStorage.setItem('language', lang);
            
            // Mettre √† jour l'attribut dir pour RTL (arabe et h√©breu)
            if (lang === 'ar' || lang === 'he') {
                document.documentElement.setAttribute('dir', 'rtl');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
            }
            
            // Recharger l'interface avec les nouvelles traductions
            updateUILanguage();
        }
        
        // Fonction pour mettre √† jour toute l'interface
        function updateUILanguage() {
            // Main app header
            const mainAppHeader = document.querySelector('.header h1');
            if (mainAppHeader) mainAppHeader.textContent = t('monthlyExpenses');
            
            // Total section
            const totalSection = document.querySelector('.total-section h2');
            if (totalSection) totalSection.textContent = t('totalExpenses');
            
            const incomeH3 = document.querySelector('#incomeDisplay h3');
            if (incomeH3) incomeH3.textContent = t('totalIncome');
            
            const remainingH3 = document.querySelector('#remainingDisplay h3');
            if (remainingH3) remainingH3.textContent = t('remaining');
            
            // Modals
            const colorModalTitle = document.querySelector('#colorEditorModal .modal-header h2');
            if (colorModalTitle) colorModalTitle.textContent = t('customizeColors');
            
            const colorModalReset = document.querySelector('#colorEditorModal .modal-footer .secondary');
            if (colorModalReset) colorModalReset.textContent = t('resetToDefault');
            
            const colorModalDone = document.querySelector('#colorEditorModal .modal-footer .primary');
            if (colorModalDone) colorModalDone.textContent = t('done');
            
            const settingsModalTitle = document.querySelector('#settingsModal .modal-header h2');
            if (settingsModalTitle) settingsModalTitle.textContent = t('settingsTitle');
            
            const settingsModalDone = document.querySelector('#settingsModal .modal-footer .primary');
            if (settingsModalDone) settingsModalDone.textContent = t('done');
            
            // Settings sections
            const accountTitle = document.getElementById('accountTitle');
            if (accountTitle) accountTitle.textContent = t('account');
            
            const currencyTitle = document.getElementById('currencyTitle');
            if (currencyTitle) currencyTitle.textContent = t('currency');
            
            const incomeTrackingTitle = document.getElementById('incomeTrackingTitle');
            if (incomeTrackingTitle) incomeTrackingTitle.textContent = t('incomeTracking');
            
            const darkModeTitle = document.getElementById('darkModeTitle');
            if (darkModeTitle) darkModeTitle.textContent = t('darkMode');
            
            const percentageTitle = document.getElementById('percentageTitle');
            if (percentageTitle) percentageTitle.textContent = t('percentageCalculation');
            
            const clearDataTitle = document.getElementById('clearDataTitle');
            if (clearDataTitle) clearDataTitle.textContent = t('clearData');
            
            // Settings button
            const logoutBtn = document.querySelector('#settingsModal .settings-section button');
            if (logoutBtn) logoutBtn.textContent = t('logout');
            
            // Settings descriptions
            const settingsDescriptions = document.querySelectorAll('.settings-description');
            if (settingsDescriptions[0]) settingsDescriptions[0].textContent = t('percentageDesc');
            
            const trackIncomeSpan = document.querySelector('#useIncomeCheckbox + span');
            if (trackIncomeSpan) {
                trackIncomeSpan.textContent = t('trackIncome');
            }
            
            // Percentage mode options
            const percentageOptions = document.querySelectorAll('#percentageModeSelect option');
            if (percentageOptions.length > 0) {
                percentageOptions[0].textContent = t('basedOnExpenses');
                percentageOptions[1].textContent = t('basedOnIncome');
            }
            
            // Update category controls if in edit mode
            if (isEditMode) {
                document.querySelectorAll('.category-controls').forEach(controls => {
                    const buttons = controls.querySelectorAll('.category-btn');
                    if (buttons.length >= 4) {
                        buttons[0].innerHTML = t('moveUp');
                        buttons[1].innerHTML = t('moveDown');
                        buttons[2].innerHTML = t('addItem');
                        buttons[3].innerHTML = t('deleteCategory');
                    }
                });
            }
            
            // Update display to refresh category names and stats
            updateDisplay();
            if (typeof updateTransactionsLanguage === 'function') {
                updateTransactionsLanguage();
            }
            
            // === AJUSTEMENT DU TITRE ===
            fitAppTitle();
            setTimeout(fitAppTitle, 50);
        }

        // Fonction pour mettre √† jour l'√©cran de connexion uniquement
        function updateAuthScreenLanguage() {
            const authTitle = document.querySelector('.auth-title');
            if (!authTitle) return; // L'√©cran de connexion n'est pas visible
            
            document.querySelector('.auth-title').textContent = t('appTitle');
            document.querySelector('.auth-subtitle').textContent = t('authSubtitle');
            document.getElementById('authEmail').placeholder = t('email');
            document.getElementById('authPassword').placeholder = t('password');
            
            const submitBtn = document.getElementById('authSubmitBtn');
            const isSignUp = submitBtn.textContent.includes('Sign Up') || 
                            submitBtn.textContent.includes('S\'inscrire') ||
                            submitBtn.textContent.includes('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è') ||
                            submitBtn.textContent.includes('◊î◊ô◊®◊©◊ù') ||
                            submitBtn.textContent.includes('Registrarse') ||
                            submitBtn.textContent.includes('ÿ•ŸÜÿ¥ÿßÿ° ÿ≠ÿ≥ÿßÿ®');
            
            document.getElementById('authSubmitBtn').textContent = isSignUp ? t('signUp') : t('signIn');
            document.getElementById('authToggleText').textContent = isSignUp ? t('hasAccount') : t('noAccount');
            document.getElementById('authToggleBtn').textContent = isSignUp ? t('signIn') : t('signUp');
        }



        /**
         * Update translations for transactions tab
         */
        function updateTransactionsLanguage() {
            // Traduire les √©l√©ments avec data-translate
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.textContent = translations[currentLanguage][key];
                }
            });
            
            // Traduire les placeholders
            const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
            placeholderElements.forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    el.placeholder = translations[currentLanguage][key];
                }
            });
        }

        
        // NOUVELLE FONCTION - Cleanup category order
        function cleanupCategoryOrder() {
            // Enlever les cat√©gories qui n'existent plus dans expenses
            categoryOrder = categoryOrder.filter(categoryKey => expenses.hasOwnProperty(categoryKey));
            
            // Ajouter les cat√©gories manquantes
            Object.keys(expenses).forEach(categoryKey => {
                if (!categoryOrder.includes(categoryKey)) {
                    categoryOrder.push(categoryKey);
                }
            });
            
            // S'assurer qu'income est toujours en premier si elle existe
            if (categoryOrder.includes('income') && categoryOrder[0] !== 'income') {
                categoryOrder = ['income', ...categoryOrder.filter(c => c !== 'income')];
            }        
        }

        // Authentication functions
        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            const submitBtn = document.getElementById('authSubmitBtn');
            const toggleText = document.getElementById('authToggleText');
            const toggleBtn = document.getElementById('authToggleBtn');
            
            if (isSignUpMode) {
                submitBtn.textContent = 'Sign Up';
                toggleText.textContent = 'Already have an account?';
                toggleBtn.textContent = 'Sign In';
            } else {
                submitBtn.textContent = 'Sign In';
                toggleText.textContent = "Don't have an account?";
                toggleBtn.textContent = 'Sign Up';
            }
        }


        function showAuthError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
            setTimeout(() => {
                errorDiv.classList.remove('show');
            }, 5000);
        }


        function handleLogout() {
            const t = translations[currentLanguage] || translations['en'];
            if (confirm(t.logoutConfirm || 'Logout?')) {
                closeSettings();
                auth.signOut().then(() => {
                    // ‚úÖ AJOUT√â : Force un reload complet de la page
                    window.location.reload();
                });
            }
        }

        const defaultExpenses = {
            income: [
                { name: 'Salary', amount: 0 }
            ],
            housing: [
                { name: 'Rent', amount: 0 },
                { name: 'Residence tax', amount: 0 },
                { name: 'Electricity', amount: 0 },
                { name: 'Gas', amount: 0 },
                { name: 'Water', amount: 0 }
            ],
            subscriptions: [
                { name: 'Internet', amount: 0 },
                { name: 'Phone Plan', amount: 0 },
                { name: 'Spotify', amount: 0 },
                { name: 'Gym', amount: 0 }
            ],
            groceries: [
                { name: 'Food', amount: 0 },
                { name: 'Household Products', amount: 0 }
            ],
            pet: [
                { name: 'Pet Food and Litter', amount: 0 },
                { name: 'Vet', amount: 0 }
            ],
            hobbies: [
                { name: 'Restaurant', amount: 0 },
                { name: 'Cinema', amount: 0 },
                { name: 'Video Games', amount: 0 }
            ],
            other: [
                { name: 'Other Expenses', amount: 0 }
            ]
        };

        
        // Data variables
        let expenses = JSON.parse(JSON.stringify(defaultExpenses));
        let chart = null;
        let currentChartType = 'doughnut';
        let hiddenItems = {};
        let customColors = {};

        // Firestore functions
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const data = userDoc.data();
                    
                    // ‚úÖ D√âFINIR LA LANGUE EN PREMIER - AVANT TOUT
                    const firestoreLang = data.language;
                    const localStorageLang = localStorage.getItem('language');
                    
                    console.log('üîç LANGUE DEBUG:');
                    console.log('  Firestore lang:', firestoreLang);
                    console.log('  localStorage lang:', localStorageLang);
                    
                    if (firestoreLang && translations[firestoreLang]) {
                        currentLanguage = firestoreLang;
                        console.log('  ‚úÖ Utilise Firestore:', firestoreLang);
                    } else if (localStorageLang && translations[localStorageLang]) {
                        currentLanguage = localStorageLang;
                        console.log('  ‚úÖ Utilise localStorage:', localStorageLang);
                        await db.collection('users').doc(currentUser.uid).set({
                            language: localStorageLang
                        }, { merge: true });
                    } else {
                        currentLanguage = 'en';
                        console.log('  ‚úÖ Utilise d√©faut: en');
                    }
                    
                    console.log('  ‚Üí currentLanguage final:', currentLanguage);
                    
                    document.getElementById('languageSelect').value = currentLanguage;
                    
                    // Appliquer RTL imm√©diatement
                    if (currentLanguage === 'ar' || currentLanguage === 'he') {
                        document.documentElement.setAttribute('dir', 'rtl');
                    } else {
                        document.documentElement.setAttribute('dir', 'ltr');
                    }
                    
                    // ‚úÖ MAINTENANT charger le reste des donn√©es
                    expenses = data.expenses || JSON.parse(JSON.stringify(defaultExpenses));
                    customColors = data.customColors || {};
                    currentChartType = data.chartType || 'doughnut';
                    
                    // ‚úÖ Mettre √† jour l'√©tat des boutons SEULEMENT apr√®s chargement Firebase
                    if (typeof window.updateChartButtonsState === 'function') {
                        window.updateChartButtonsState();
                    }
                    
                    categoryOrder = data.categoryOrder || ['income', 'housing', 'tech', 'pet', 'subscriptions', 'groceries', 'other'];
                    useIncome = data.useIncome !== undefined ? data.useIncome : true;
                    currency = data.currency || '‚Ç™';
                    percentageMode = data.percentageMode || 'expenses';
                    categoryMetadata = data.categoryMetadata || {};
                    
                    // NOUVEAU : Nettoyer et synchroniser categoryOrder
                    cleanupCategoryOrder();
                    
                    // Hide default categories that were deleted by the user
                    const defaultCategories = ['income', 'housing', 'tech', 'pet', 'subscriptions', 'groceries', 'other'];
                    defaultCategories.forEach(categoryKey => {
                        const section = document.getElementById(`category-${categoryKey}`);
                        if (section) {
                            if (!expenses[categoryKey]) {
                                // Category was deleted - hide it
                                console.log(`Hiding deleted default category: ${categoryKey}`);
                                section.style.display = 'none';
                            } else {
                                // Category exists - show it
                                section.style.display = 'block';
                            }
                        }
                    });
                    
                    // Recreate HTML for custom categories that don't exist in the default list
                    const expensesList = document.getElementById('expensesList');
                    
                    Object.keys(expenses).forEach(categoryKey => {
                        // Skip default categories - they already have HTML
                        if (defaultCategories.includes(categoryKey)) return;
                        
                        // Check if HTML element exists
                        if (document.getElementById(`category-${categoryKey}`)) return;
                        
                        console.log(`Creating HTML for custom category: ${categoryKey}`);
                        
                        // Get metadata for this category
                        const meta = categoryMetadata[categoryKey] || {
                            emoji: 'üìã',
                            displayName: categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1)
                        };
                        
                        // Create HTML for this custom category
                        const statsId = `${categoryKey}Stats`;
                        const expensesId = `${categoryKey}Expenses`;
                        
                        const categorySection = document.createElement('div');
                        categorySection.className = 'category-section';
                        categorySection.id = `category-${categoryKey}`;
                        categorySection.innerHTML = `
                            <div class="category-title">
                                ${meta.emoji} ${meta.displayName}
                                <button class="rename-btn" onclick="renameCategory('${categoryKey}')" style="display: none;">‚úèÔ∏è</button>
                            </div>
                            <div class="category-stats" id="${statsId}"></div>
                            <div class="category-controls">
                                <button class="category-btn" onclick="moveCategoryUp('${categoryKey}')">‚Üë Move Up</button>
                                <button class="category-btn" onclick="moveCategoryDown('${categoryKey}')">‚Üì Move Down</button>
                                <button class="category-btn" onclick="addItemToCategory('${categoryKey}')">‚ûï Add Item</button>
                                <button class="category-btn danger" onclick="deleteCategory('${categoryKey}')">üóëÔ∏è Delete Category</button>
                            </div>
                            <div id="${expensesId}"></div>
                        `;
                        
                        expensesList.appendChild(categorySection);
                    });
                    
                    // Reorder categories according to categoryOrder
                    renderCategoriesInOrder();
                } else {
                    // First time user - use defaults
                    expenses = JSON.parse(JSON.stringify(defaultExpenses));
                    
                    // ‚úÖ Pour nouveau compte : utiliser langue de localStorage si existe
                    const localStorageLang = localStorage.getItem('language');
                    if (localStorageLang && translations[localStorageLang]) {
                        currentLanguage = localStorageLang;
                    }
                    
                    await saveUserData();
                }
                
                // Mettre √† jour l'interface avec la langue charg√©e
                updateUILanguage();
                updateDisplay();
                updateChartButtonsState();
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        // AJOUTE ICI : Language change handler
        document.getElementById('languageSelect')?.addEventListener('change', async function(e) {
            currentLanguage = e.target.value;
            localStorage.setItem('preferredLanguage', currentLanguage);
            
            // Appliquer RTL si n√©cessaire
            if (currentLanguage === 'ar' || currentLanguage === 'he') {
                document.documentElement.setAttribute('dir', 'rtl');
            } else {
                document.documentElement.setAttribute('dir', 'ltr');
            }
            
            updateUILanguage();
            
            // Traduire l'onglet Transactions si visible
            if (typeof updateTransactionsLanguage === 'function') {
                updateTransactionsLanguage();
            }
            
            // Sauvegarder dans Firebase
            if (currentUser) {
                await saveUserData();
            }
        });


        
        async function saveUserData() {
            if (!currentUser) return;
            
            try {
                const dataToSave = {
                    expenses: expenses,
                    customColors: customColors,
                    chartType: currentChartType,
                    categoryOrder: categoryOrder,
                    useIncome: useIncome,
                    currency: currency,
                    percentageMode: percentageMode,
                    categoryMetadata: categoryMetadata,
                    language: currentLanguage,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                
                // IMPORTANT : Ne PAS utiliser merge pour que les cl√©s supprim√©es disparaissent vraiment
                await db.collection('users').doc(currentUser.uid).set(dataToSave, { merge: true });
            } catch (error) {
                console.error('Error saving user data:', error);
                throw error;
            }
        }

        function saveExpenses() {
            saveUserData();
            updateDisplay();
        }


        const colors = [
            '#667eea', '#764ba2', '#f093fb', '#4facfe',
            '#43e97b', '#fa709a', '#fee140', '#30cfd0',
            '#a8edea', '#fed6e3', '#c471f5', '#12c2e9'
        ];

        function calculateTotal() {
            let total = 0;
            Object.keys(expenses).forEach(categoryKey => {
                // Skip income category when calculating expenses
                if (categoryKey === 'income') return;
                
                expenses[categoryKey].forEach(expense => {
                    total += parseFloat(expense.amount) || 0;
                });
            });
            return total;
        }

        function calculateIncome() {
            if (!expenses.income) return 0;
            let total = 0;
            expenses.income.forEach(item => {
                total += parseFloat(item.amount) || 0;
            });
            return total;
        }

        function calculateCategoryTotal(categoryKey) {
            let categoryTotal = 0;
            if (expenses[categoryKey]) {
                expenses[categoryKey].forEach(expense => {
                    categoryTotal += parseFloat(expense.amount) || 0;
                });
            }
            return categoryTotal;
        }

        function getCategoryStats(categoryKey) {
            const categoryTotal = calculateCategoryTotal(categoryKey);
            
            // Calculate base depending on percentage mode
            let base;
            if (percentageMode === 'income' && useIncome) {
                base = calculateIncome();
            } else {
                base = categoryKey === 'income' ? calculateIncome() : calculateTotal();
            }
            
            const percentage = base > 0 ? ((categoryTotal / base) * 100).toFixed(1) : 0;
            return {
                total: categoryTotal,
                percentage: percentage
            };
        }

        function calculateVisibleTotal(chartInstance) {
            if (!chartInstance || !chartInstance.data) return calculateTotal();
            
            let visibleTotal = 0;
            const data = chartInstance.data.datasets[0].data;
            const labels = chartInstance.data.labels;
            
            data.forEach((value, index) => {
                // Check if this data point is visible
                const meta = chartInstance.getDatasetMeta(0);
                if (meta.data[index] && !meta.data[index].hidden) {
                    visibleTotal += value;
                }
            });
            
            return visibleTotal;
        }

        function renderExpenseItem(expense, category, index) {
            const deleteBtn = isEditMode ? 
                `<button class="expense-delete-btn" onclick="deleteExpenseItem('${category}', ${index})" title="Delete item">üóëÔ∏è</button>` : '';
            
            const moveUpBtn = isEditMode ? 
                `<button class="item-move-btn" onclick="moveItemUp('${category}', ${index})" title="Move up">‚Üë</button>` : '';
            
            const moveDownBtn = isEditMode ? 
                `<button class="item-move-btn" onclick="moveItemDown('${category}', ${index})" title="Move down">‚Üì</button>` : '';
            
            const renameBtn = isEditMode ? 
                `<button class="item-rename-btn show" onclick="renameItem('${category}', ${index})" title="Rename">‚úèÔ∏è</button>` : '';
            
            return `
                <div class="expense-item">
                    <span class="expense-name">
                        ${expense.name}
                        ${renameBtn}
                        <span class="item-move-btns ${isEditMode ? 'show' : ''}">
                            ${moveUpBtn}
                            ${moveDownBtn}
                        </span>
                    </span>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input 
                            type="number" 
                            class="expense-input" 
                            value="${expense.amount}"
                            onchange="updateExpense('${category}', ${index}, this.value)"
                            step="0.01"
                            min="0"
                        />
                        <span class="currency">${currency}</span>
                        ${deleteBtn}
                    </div>
                </div>
            `;
        }

        function updateExpense(category, index, value) {
            expenses[category][index].amount = parseFloat(value) || 0;
            saveExpenses();
        }

        function updateDisplay() {
            try {
                cleanupCategoryOrder();
                // Update income section visibility
                const incomeSection = document.getElementById('category-income');
                const incomeDisplaySection = document.getElementById('incomeDisplay');
                const remainingDisplaySection = document.getElementById('remainingDisplay');
                
                if (useIncome && expenses.income && incomeSection) {
                    incomeSection.style.display = 'block';
                    incomeDisplaySection.style.display = 'block';
                    remainingDisplaySection.style.display = 'block';
                } else if (incomeSection) {
                    incomeSection.style.display = 'none';
                    incomeDisplaySection.style.display = 'none';
                    remainingDisplaySection.style.display = 'none';
                }
                
                // Calculate totals
                const totalExpenses = calculateTotal();
                const totalIncome = calculateIncome();
                const remaining = totalIncome - totalExpenses;
                
                // Calculate remaining percentage
                const remainingPercentage = totalIncome > 0 ? ((remaining / totalIncome) * 100).toFixed(1) : 0;
                
                // Update displays
                document.getElementById('totalAmount').textContent = `${currency}${totalExpenses.toFixed(2)}`;
                document.getElementById('totalIncome').textContent = `${currency}${totalIncome.toFixed(2)}`;
                document.getElementById('remainingAmount').textContent = `${currency}${remaining.toFixed(2)}`;
                document.getElementById('remainingAmount').style.color = remaining >= 0 ? '#28a745' : '#dc3545';
                const ofIncomeText = translations[currentLanguage]?.ofIncome || 'of income';
                document.getElementById('remainingPercentage').textContent = `(${remainingPercentage}% ${ofIncomeText})`;
        
                // First, hide ALL category sections
                const allSections = document.querySelectorAll('.category-section');
                allSections.forEach(section => {
                    section.style.display = 'none';
                });
        
                // Then, update ONLY categories that exist in expenses
                Object.keys(expenses).forEach(categoryKey => {
                    const section = document.getElementById(`category-${categoryKey}`);
                    if (!section) {
                        // Category exists in data but not in DOM - skip it
                        return;
                    }
                    
                    // Show the section
                    section.style.display = 'block';
                    
                    // Update stats
                    const stats = getCategoryStats(categoryKey);
                    const statsElement = document.getElementById(`${categoryKey}Stats`);
                    
                    if (statsElement) {
                        if (categoryKey === 'income') {
                            statsElement.innerHTML = stats.total > 0 ? 
                                `<span class="amount" style="color: #28a745;">${currency}${stats.total.toFixed(2)}</span>` : '';
                        } else {
                            // NOUVEAU : Ajouter la comparaison si le mode est activ√©
                            let statsHTML = stats.total > 0 ? 
                                `<span class="amount">${currency}${stats.total.toFixed(2)}</span><span class="percentage">(${stats.percentage}%)</span>` : '';
                            
                            // Ajouter les infos de comparaison
                            if (compareMode && stats.total > 0) {
                                statsHTML += renderComparisonInfo(categoryKey, stats.total);
                            }
                            
                            statsElement.innerHTML = statsHTML;
                        }
                    }
                    
                    // Update expenses items
                    const expensesElement = document.getElementById(`${categoryKey}Expenses`);
                    if (expensesElement && expenses[categoryKey]) {
                        expensesElement.innerHTML = expenses[categoryKey].map((exp, i) => 
                            renderExpenseItem(exp, categoryKey, i)).join('');
                    }
                });
        
                // Update chart
                updateChart();
            } catch (error) {
                console.error('Error updating display:', error);
            }
        }

        function updateChart() {
            // Mettre √† jour l'√©tat des boutons
            if (typeof window.updateChartButtonsState === 'function') {
                window.updateChartButtonsState();
            }
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js is not available');
                return;
            }
        
            const ctx = document.getElementById('expensesChart').getContext('2d');
        
            // === CORRECTION DARK MODE ===
            // On d√©clare les variables de couleur UNE SEULE FOIS ici
            const isDarkMode = document.body.classList.contains('dark-mode');
            const textColor = isDarkMode ? '#ffffff' : '#666';
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            // On applique les d√©fauts globaux pour que la l√©gende change imm√©diatement
            Chart.defaults.color = textColor;
            Chart.defaults.borderColor = gridColor;
            // ===========================
            
            // Prepare data for chart - EXCLUDE income category
            const allLabels = [];
            const allData = [];
            const allBackgroundColors = [];
            
            Object.keys(expenses).forEach(categoryKey => {
                // Skip income category in charts
                if (categoryKey === 'income') return;
                
                expenses[categoryKey].forEach(expense => {
                    if (expense.amount > 0) {
                        allLabels.push(expense.name);
                        allData.push(expense.amount);
                        
                        // Use custom color if available
                        if (customColors[expense.name]) {
                            allBackgroundColors.push(customColors[expense.name]);
                        } else {
                            // Generate consistent color based on item name (hash)
                            const hash = expense.name.split('').reduce((acc, char) => {
                                return char.charCodeAt(0) + ((acc << 5) - acc);
                            }, 0);
                            const colorIdx = Math.abs(hash) % colors.length;
                            allBackgroundColors.push(colors[colorIdx]);
                        }
                    }
                });
            });
        
            // Sort data in descending order for both chart types
            const indices = allData.map((_, i) => i);
            indices.sort((a, b) => allData[b] - allData[a]);
            
            const sortedLabels = indices.map(i => allLabels[i]);
            const sortedData = indices.map(i => allData[i]);
            const sortedColors = indices.map(i => allBackgroundColors[i]);
        
            // Filter out hidden items for display
            const displayLabels = [];
            const displayData = [];
            const displayColors = [];
            
            sortedLabels.forEach((label, i) => {
                if (!hiddenItems[label]) {
                    displayLabels.push(label);
                    displayData.push(sortedData[i]);
                    displayColors.push(sortedColors[i]);
                }
            });
        
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: currentChartType === 'doughnut' ? {
                    duration: 400,
                    easing: 'easeOutQuart',
                    animateRotate: false, 
                    animateScale: true
                } : {
                    duration: 750,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            padding: 10,
                            font: {
                                size: 11
                            },
                            color: textColor,
                            // Pas besoin de d√©finir color ici car Chart.defaults.color s'en occupe
                            boxWidth: 15,
                            boxHeight: 15,
                            generateLabels: function(chart) {
                                return sortedLabels.map((label, i) => {
                                    return {
                                        text: label,
                                        fillStyle: sortedColors[i],
                                        strokeStyle: sortedColors[i],
                                        lineWidth: 0,
                                        hidden: hiddenItems[label] || false,
                                        index: i,
                                        datasetIndex: 0,
                                        fontColor: textColor
                                    };
                                });
                            }
                        },
                        onClick: function(e, legendItem, legend) {
                            const label = sortedLabels[legendItem.index];
                            hiddenItems[label] = !hiddenItems[label];
                            updateChart();
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = currentChartType === 'bar' ? context.parsed.y : context.parsed;
                                const total = displayData.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${currency}${value.toFixed(2)} (${percentage}%)`;
                            }
                        }
                    }
                }
            };
        
            // SI le graphique existe d√©j√†, on met juste √† jour les donn√©es
            if (chart && chart.config.type === currentChartType) {
                // Mise √† jour des donn√©es existantes
                chart.data.labels = displayLabels;
                chart.data.datasets[0].data = displayData;
                chart.data.datasets[0].backgroundColor = displayColors;
                
                // Mise √† jour des options si n√©cessaire
                chart.options = currentChartType === 'bar' ? {
                    ...commonOptions,
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: gridColor
                            },
                            ticks: {
                                color: textColor, // Utilise la variable d√©finie en haut
                                callback: function(value) {
                                    return currency + value;
                                }
                            }
                        }
                    }
                } : commonOptions;
                
                // Force la mise √† jour des couleurs globales
                chart.options.color = textColor;
                if (chart.options.plugins.legend) {
                     chart.options.plugins.legend.labels.color = textColor;
                }
        
                // Rafra√Æchir le graphique avec animation
                chart.update(); 
                
            } else {
                // Le graphique n'existe pas OU le type a chang√© : on le recr√©e
                if (chart) {
                    chart.destroy();
                }
                
                if (allLabels.length === 0) {
                    // Show placeholder when no data
                    chart = new Chart(ctx, {
                        type: currentChartType,
                        data: {
                            labels: ['No expenses yet'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#e9ecef'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                } else if (currentChartType === 'doughnut') {
                    chart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: displayLabels,
                            datasets: [{
                                data: displayData,
                                backgroundColor: displayColors,
                                borderWidth: 0,
                                borderColor: isDarkMode ? '#2a2a3e' : '#fff'
                            }]
                        },
                        options: commonOptions
                    });
                } else {
                    chart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: displayLabels,
                            datasets: [{
                                data: displayData,
                                backgroundColor: displayColors,
                                borderWidth: 0,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            ...commonOptions,
                            scales: {
                                x: {
                                    display: false
                                },
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: gridColor
                                    },
                                    ticks: {
                                        color: textColor,
                                        callback: function(value) {
                                            return currency + value;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }
            
            // Update total to reflect visible items
            const visibleTotal = displayData.reduce((a, b) => a + b, 0);
            document.getElementById('totalAmount').textContent = `${currency}${visibleTotal.toFixed(2)}`;
        }
    
        function resetExpenses() {
            const t = translations[currentLanguage] || translations['en'];
            if (confirm(t.resetAllConfirm || 'Reset all to 0?')) {
                expenses = JSON.parse(JSON.stringify(defaultExpenses));
                hiddenItems = {};
                saveUserData();
                updateDisplay();
            }
        }

        function openColorEditor() {
            const modal = document.getElementById('colorEditorModal');
            const body = document.getElementById('colorEditorBody');
            
            // Build list of all expenses with their current colors - EXCLUDE income
            body.innerHTML = '';
            
            Object.keys(expenses).forEach(categoryKey => {
                // Skip income category
                if (categoryKey === 'income') return;
                
                expenses[categoryKey].forEach(expense => {
                    // Use the same hash-based color calculation as the chart
                    let currentColor;
                    if (customColors[expense.name]) {
                        currentColor = customColors[expense.name];
                    } else {
                        // Generate consistent color based on item name (hash) - same as chart
                        const hash = expense.name.split('').reduce((acc, char) => {
                            return char.charCodeAt(0) + ((acc << 5) - acc);
                        }, 0);
                        const colorIdx = Math.abs(hash) % colors.length;
                        currentColor = colors[colorIdx];
                    }
                    
                    const colorItem = document.createElement('div');
                    colorItem.className = 'color-item';
                    colorItem.innerHTML = `
                        <span class="color-item-name">${expense.name}</span>
                        <div class="color-picker-wrapper">
                            <input 
                                type="color" 
                                value="${currentColor}" 
                                onchange="updateColor('${expense.name}', this.value)"
                            />
                        </div>
                    `;
                    body.appendChild(colorItem);
                });
            });
            
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';
            
            modal.classList.add('show');
        }

        function closeColorEditor() {
            const modal = document.getElementById('colorEditorModal');
            modal.classList.remove('show');
            
            // Restore background scrolling
            document.body.style.overflow = '';
        }

        function updateColor(expenseName, color) {
            customColors[expenseName] = color;
            saveUserData();
            updateChart();
        }

        function resetColors() {
            const t = translations[currentLanguage] || translations['en'];
            if (confirm(t.resetColorsConfirm || 'Reset colors?')) {
                customColors = {};
                saveUserData();
                closeColorEditor();
                updateChart();
            }
        }

        // Restore edit mode UI after updateDisplay()
        function restoreEditMode() {
            if (!isEditMode) return;
            
            const editBtn = document.getElementById('editModeBtn');
            const editBtnText = document.getElementById('editBtnText');
            const t = translations[currentLanguage] || translations['en'];
            
            if (editBtn) editBtn.classList.add('active');
            if (editBtnText) editBtnText.textContent = t.doneEditing || 'Done Editing';
            
            const categoryControls = document.querySelectorAll('.category-controls');
            const renameButtons = document.querySelectorAll('.rename-btn');
            const addBtn = document.querySelector('button[onclick*="addNewCategory"]');
            
            if (addBtn) addBtn.style.display = 'block';
            categoryControls.forEach(c => c.classList.add('show'));
            renameButtons.forEach(btn => {
                if (!btn.classList.contains('rename-btn-income')) {
                    btn.style.display = 'inline-block';
                }
            });
        }




        
        // Edit Mode Functions
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const editBtn = document.getElementById('editModeBtn');
            const editBtnText = document.getElementById('editBtnText');
            const categoryControls = document.querySelectorAll('.category-controls');
            const renameButtons = document.querySelectorAll('.rename-btn');
            
            // R√©cup√©rer les traductions
            const t = translations[currentLanguage] || translations['en'];
            
            if (isEditMode) {
                // Mode Edit activ√©
                if (editBtn) editBtn.classList.add('active');
                if (editBtnText) editBtnText.textContent = t.doneEditing || 'Done Editing';
                
                const addBtn = document.querySelector('button[onclick*="addNewCategory"]');
                if (addBtn) addBtn.style.display = 'block';
                
                categoryControls.forEach(c => c.classList.add('show'));
                renameButtons.forEach(btn => {
                    if (!btn.classList.contains('rename-btn-income')) {
                        btn.style.display = 'inline-block';
                    }
                });
            } else {
                // Mode Edit d√©sactiv√©
                if (editBtn) editBtn.classList.remove('active');
                if (editBtnText) editBtnText.textContent = t.editCategories || 'Edit Categories';
                
                const addBtn = document.querySelector('button[onclick*="addNewCategory"]');
                if (addBtn) addBtn.style.display = 'none';
                
                categoryControls.forEach(c => c.classList.remove('show'));
                renameButtons.forEach(btn => btn.style.display = 'none');
            }
            
            // Force refresh to update item buttons
            // ‚úÖ MODIFI√â : Ne pas appeler updateDisplay() - juste mettre √† jour les boutons des items
            const itemBtns = document.querySelectorAll('.item-controls button');
            itemBtns.forEach(btn => {
                if (isEditMode) {
                    btn.style.display = 'inline-block';
                } else {
                    btn.style.display = 'none';
                }
            }); 
        }
        
        // ============================================
        // COMPARE MODE - Real Spending vs Budget
        // ============================================
        
        let compareMode = false;
        let realSpendingData = {};
        
        /**
         * Toggle compare mode on/off
         */
        function toggleCompareMode() {
            const compareBtn = document.getElementById('compareBtn');
            const monthSelect = document.getElementById('compareMonth');
            
            compareMode = !compareMode;
            
            if (compareMode) {
                compareBtn.style.background = '#667eea';
                compareBtn.style.color = 'white';
                
                if (monthSelect) {
                    monthSelect.style.display = 'inline-block';
                }
                
                setTimeout(() => {
                    populateMonthDropdown();
                    loadRealSpending();
                }, 50);
                
            } else {
                compareBtn.style.background = 'white';
                compareBtn.style.color = '#667eea';
                compareBtn.style.borderColor = '#dee2e6';
                
                if (monthSelect) monthSelect.style.display = 'none';
                
                realSpendingData = {};
                updateDisplay();
            }
            
            // Force hide item rename buttons based on edit mode
            setTimeout(() => {
                const itemRenameButtons = document.querySelectorAll('.item-rename-btn');
                itemRenameButtons.forEach(btn => {
                    btn.style.display = isEditMode ? 'inline-block' : 'none';
                });
            }, 100);
        }
        /**
         * Populate month dropdown with last 12 months
         */
        function populateMonthDropdown() {
            const select = document.getElementById('compareMonth');
            if (!select) {
                console.error('compareMonth select not found');
                return;
            }
            
            select.innerHTML = ''; // Clear
            
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Generate last 12 months
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentYear, currentMonth - i, 1);
                const monthName = date.toLocaleString(currentLanguage || 'en', { month: 'long', year: 'numeric' });
                const value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                const option = document.createElement('option');
                option.value = value;
                option.textContent = monthName;
                if (i === 0) option.selected = true; // Current month selected by default
                
                select.appendChild(option);
            }
        }
        
        /**
         * Load real spending data from transactions
         */
        async function loadRealSpending() {
            if (!firebase.functions || !currentUser) {
                console.log('Cannot load real spending: Firebase not initialized or user not logged in');
                return;
            }
            
            const monthKey = document.getElementById('compareMonth')?.value;
            if (!monthKey) return;
            
            const [year, month] = monthKey.split('-');
            
            // Calculate start and end dates for the month
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);
            
            try {
                const getTransactions = firebase.functions().httpsCallable('getTransactions');
                const result = await getTransactions({
                    startDate: startDate.toISOString(),
                    endDate: endDate.toISOString(),
                    isLabeled: true, // Only labeled transactions
                    limit: 1000
                });
                
                const transactions = result.data.transactions || [];
                
                // Group by category and sum amounts
                realSpendingData = {};
                
                transactions.forEach(txn => {
                    if (txn.category && txn.category !== 'income') {
                        if (!realSpendingData[txn.category]) {
                            realSpendingData[txn.category] = 0;
                        }
                        // Prendre la valeur absolue (ignorer le signe n√©gatif)
                        // Et ignorer les montants positifs (remboursements/revenus)
                        if (txn.chargedAmount < 0) {
                            realSpendingData[txn.category] += Math.abs(txn.chargedAmount);
                        }
                    }
                });
                                
                // Refresh display with comparison
                updateDisplay();
                
            } catch (error) {
                console.error('Error loading real spending:', error);
            }
        }
        
        /**
         * Get comparison info for a category
         */
        function getComparisonInfo(category, budget) {
            if (!compareMode || !realSpendingData[category]) {
                return null;
            }
            
            const real = realSpendingData[category];
            const diff = real - budget;
            const diffPercent = budget > 0 ? ((diff / budget) * 100).toFixed(0) : 0;
            
            let status = 'neutral';
            if (Math.abs(diffPercent) <= 10) {
                status = 'neutral'; // Within 10%
            } else if (diff > 0) {
                status = 'positive'; // Over budget (bad)
            } else {
                status = 'negative'; // Under budget (good)
            }
            
            return {
                real: real,
                budget: budget,
                diff: diff,
                diffPercent: diffPercent,
                status: status
            };
        }
        
        /**
         * Render comparison info HTML
         */
        function renderComparisonInfo(category, budget) {
            const info = getComparisonInfo(category, budget);
            if (!info) return '';
            
            // ‚úÖ AJOUT√â : R√©cup√©rer les traductions
            const t = translations[currentLanguage] || translations['en'];
            
            const emoji = info.status === 'negative' ? 'üü¢' : info.status === 'positive' ? 'üî¥' : 'üü°';
            
            // Calculer le pourcentage utilis√©
            const usedPercent = budget > 0 ? Math.round((info.real / budget) * 100) : 0;
            
            // Message selon si over ou under budget
            let message;
            if (info.diff > 0) {
                // Over budget
                message = `${t.overBy || 'Over by'} ${currency}${Math.abs(info.diff).toFixed(0)} (${usedPercent}% ${t.used || 'used'})`;
            } else if (info.diff < 0) {
                // Under budget
                message = `${t.underBy || 'Under by'} ${currency}${Math.abs(info.diff).toFixed(0)} (${usedPercent}% ${t.used || 'used'})`;
            } else {
                // Exact
                message = `${t.exactly || 'Exact match'} (100% ${t.used || 'used'})`;
            }
            
            const progressPercent = Math.min((info.real / info.budget) * 100, 150);
            
            return `
                <div class="compare-info">
                    <div class="budget-label">${t.budget || 'Budget'}: ${currency}${info.budget.toFixed(0)}</div>
                    <div class="real-label">${t.real || 'Real'}: ${currency}${info.real.toFixed(0)}</div>
                    <div class="diff ${info.status}">${message} ${emoji}</div>
                </div>
                <div class="compare-progress">
                    <div class="compare-progress-bar ${info.status === 'positive' ? 'over-budget' : info.status === 'negative' ? 'under-budget' : 'near-budget'}" 
                         style="width: ${progressPercent}%">
                    </div>
                </div>
            `;
        }


        async function deleteExpenseItem(category, index) {
            const t = translations[currentLanguage] || translations['en'];
            if (!confirm(t.deleteItemConfirm || 'Delete this item?')) return;
            
            if (!expenses[category] || !expenses[category][index]) return;
            
            try {
                // Afficher l'overlay
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingOverlayText');
                const subtextEl = document.getElementById('loadingOverlaySubtext');
                
                if (overlay) {
                    if (textEl) textEl.textContent = t.deletingItem || 'Deleting item...';
                    if (subtextEl) subtextEl.textContent = t.pleaseWait || 'Please wait';
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                expenses[category].splice(index, 1);
                
                // If category is now empty, ask if user wants to delete the whole category
                if (expenses[category].length === 0) {
                    // Cacher l'overlay avant de demander confirmation
                    if (overlay) {
                        overlay.classList.remove('active');
                        document.body.style.overflow = '';
                    }
                    
                    if (confirm(t.lastItemConfirm || 'Delete entire category?')) {
                        deleteCategory(category);
                        return;
                    }
                }
                
                // S'il reste des items, sauvegarder simplement les changements
                await saveUserData();
                updateDisplay();
                setTimeout(() => restoreEditMode(), 50);
                
                // Cacher l'overlay
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            } catch (error) {
                // Cacher l'overlay en cas d'erreur
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                console.error('Error deleting item:', error);
                alert('Error deleting item: ' + error.message);
            }
        }

        function addNewCategory() {
            const t = translations[currentLanguage] || translations['en'];
            
            const categoryName = prompt(t.enterCategoryName || 'Enter category name:');
            if (!categoryName) return;
            
            // ‚úÖ CETTE LIGNE MANQUAIT !
            const categoryKey = categoryName.toLowerCase().replace(/\s+/g, '_');
            
            if (expenses[categoryKey]) {
                alert(t.categoryExistsAlert || 'Category already exists!');
                return;
            }
            
            const emoji = prompt(t.enterEmoji || 'Enter emoji (e.g., üéÆ):') || 'üìã';
            const itemName = prompt(t.enterFirstItem || 'Enter first item name:') || 'Item';
            
            // Create the new category with the first item
            expenses[categoryKey] = [{ name: itemName, amount: 0 }];
            categoryOrder.push(categoryKey);
            
            // Store metadata
            categoryMetadata[categoryKey] = {
                emoji: emoji,
                displayName: categoryName
            };
            
            // Generate the stats ID and expenses ID
            const statsId = `${categoryKey}Stats`;
            const expensesId = `${categoryKey}Expenses`;
            
            // Create the HTML structure
            const categorySection = document.createElement('div');
            categorySection.className = 'category-section';
            categorySection.id = `category-${categoryKey}`;
            categorySection.innerHTML = `
                <div class="category-title">
                    ${emoji} ${categoryName}
                    <button class="rename-btn" onclick="renameCategory('${categoryKey}')" style="display: ${isEditMode ? 'inline-block' : 'none'};">‚úèÔ∏è</button>
                </div>
                <div class="category-stats" id="${statsId}"></div>
                <div class="category-controls ${isEditMode ? 'show' : ''}">
                    <button class="category-btn" onclick="moveCategoryUp('${categoryKey}')">
                        <span data-translate="moveUp">‚Üë Move Up</span>
                    </button>
                    <button class="category-btn" onclick="moveCategoryDown('${categoryKey}')">
                        <span data-translate="moveDown">‚Üì Move Down</span>
                    </button>
                    <button class="category-btn" onclick="addItemToCategory('${categoryKey}')">
                        <span data-translate="addItem">‚ûï Add Item</span>
                    </button>
                    <button class="category-btn danger" onclick="deleteCategory('${categoryKey}')">
                        <span data-translate="deleteCategory">üóëÔ∏è Delete Category</span>
                    </button>
                </div>
                <div id="${expensesId}"></div>
            `;
            
            // Add to the expenses list
            document.getElementById('expensesList').appendChild(categorySection);
            
            // Save to Firebase FIRST before calling updateDisplay
            saveUserData().then(() => {
                updateDisplay();
            }).catch(error => {
                console.error('Error saving new category:', error);
                alert(t.errorCreatingCategory || 'Error creating category. Please try again.');
            });
        }

        // ============================================
        // == D√âBUT DU CODE CORRIG√â ==
        // ============================================
        async function deleteCategory(categoryKey) {
            const t = translations[currentLanguage] || translations['en'];
            
            if (categoryKey === 'income') {
                alert(t.cannotDeleteIncome || 'Cannot delete Income category.');
                return;
            }
            
            function getDisplayName(catKey) {
                if (categoryMetadata[catKey] && categoryMetadata[catKey].displayName) {
                    return categoryMetadata[catKey].displayName;
                }
                return catKey.charAt(0).toUpperCase() + catKey.slice(1);
            }
            
            const displayName = getDisplayName(categoryKey);
            const total = calculateCategoryTotal(categoryKey);
            
            const confirmMessage = t.deleteCategoryConfirm
                .replace('{name}', displayName)
                .replace('{amount}', `${currency}${total.toFixed(2)}`);
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                // Afficher l'overlay
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingOverlayText');
                const subtextEl = document.getElementById('loadingOverlaySubtext');
                
                if (overlay) {
                    if (textEl) textEl.textContent = t.deletingCategory || 'Deleting category...';
                    if (subtextEl) subtextEl.textContent = t.updatingTransactions || 'Updating transactions...';
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                // Appeler la Cloud Function pour unlabel les transactions
                const deleteCategoryFunc = firebase.functions().httpsCallable('deleteCategory');
                const result = await deleteCategoryFunc({
                    categoryName: categoryKey
                });
                
                console.log(`Deleted category: ${result.data.message}`);
                
                // Supprimer localement
                delete expenses[categoryKey];
                delete categoryMetadata[categoryKey];
                
                // Retirer de l'ordre
                const index = categoryOrder.indexOf(categoryKey);
                if (index !== -1) {
                    categoryOrder.splice(index, 1);
                }
                
                // ‚úÖ D'abord supprimer explicitement dans Firebase
                await db.collection('users').doc(currentUser.uid).update({
                    [`expenses.${categoryKey}`]: firebase.firestore.FieldValue.delete(),
                    [`categoryMetadata.${categoryKey}`]: firebase.firestore.FieldValue.delete()
                });
                
                // ‚úÖ Utiliser saveUserData() qui pr√©serve TOUT (y compris credentials)
                await saveUserData();
                
                console.log(`Category ${categoryKey} deleted from Firebase`);
                
                // Actualiser l'affichage
                updateDisplay();
                setTimeout(() => restoreEditMode(), 50); // ‚úÖ D√©lai plus long

                // Cacher l'overlay
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                alert(t.categoryDeletedSuccess.replace('{count}', result.data.unlabeledCount));
                
            } catch (error) {
                // Cacher l'overlay en cas d'erreur
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                console.error('Error deleting category:', error);
                alert(t.errorDeletingCategory + ' ' + error.message);
            }
        }

        
        async function addItemToCategory(categoryKey) {
            const t = translations[currentLanguage] || translations['en'];
            const itemName = prompt(t.enterNewItemName || 'Enter new item name:');
            if (!itemName) return;
            
            try {
                // Afficher l'overlay
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingOverlayText');
                const subtextEl = document.getElementById('loadingOverlaySubtext');
                
                if (overlay) {
                    if (textEl) textEl.textContent = t.addingItem || 'Adding item...';
                    if (subtextEl) subtextEl.textContent = t.pleaseWait || 'Please wait';
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                if (!expenses[categoryKey]) {
                    expenses[categoryKey] = [];
                }
                
                expenses[categoryKey].push({ name: itemName, amount: 0 });
                await saveUserData();
                updateDisplay();
                setTimeout(() => restoreEditMode(), 50);
                
                // Cacher l'overlay
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            } catch (error) {
                // Cacher l'overlay en cas d'erreur
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                console.error('Error adding item:', error);
                alert('Error adding item: ' + error.message);
            }
        }

        function moveCategoryUp(categoryKey) {
            const index = categoryOrder.indexOf(categoryKey);
            
            // Emp√™che de monter au-dessus de 'income' (qui est toujours en position 0)
            if (index > 1) { 
                // Swap in the order array
                [categoryOrder[index - 1], categoryOrder[index]] = [categoryOrder[index], categoryOrder[index - 1]];
                
                // Save to Firebase first
                saveUserData().then(() => {
                    // Then update the visual order
                    renderCategoriesInOrder();
                }).catch(error => {
                    console.error('Error moving category:', error);
                    alert('Error moving category. Please try again.');
                });
            } else if (index === 1) {
                // La cat√©gorie est juste apr√®s 'income' - on ne peut pas monter plus haut
                alert('This category is already at the top of the expenses list (after Income).');
            }
        }
        
        function moveCategoryDown(categoryKey) {
            const index = categoryOrder.indexOf(categoryKey);
        
            // Emp√™che 'income' de bouger
            if (categoryKey === 'income') {
                return;
            }
        
            if (index < categoryOrder.length - 1 && index !== -1) {
                // Swap in the order array
                [categoryOrder[index], categoryOrder[index + 1]] = [categoryOrder[index + 1], categoryOrder[index]];
                
                // Save to Firebase first
                saveUserData().then(() => {
                    // Then update the visual order
                    renderCategoriesInOrder();
                }).catch(error => {
                    console.error('Error moving category:', error);
                    alert('Error moving category. Please try again.');
                });
            }
        }

        function renderCategoriesInOrder() {
            const expensesList = document.getElementById('expensesList');
            
            
            // Create a document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Re-append categories in the correct order, but ONLY if they exist in expenses
            categoryOrder.forEach(categoryKey => {
                // Skip if category was deleted or doesn't exist
                if (!expenses[categoryKey]) {
                    console.log(`Skipping category ${categoryKey} - not in expenses`);
                    return;
                }
                
                const section = document.getElementById(`category-${categoryKey}`);
                if (section) {
                    // Remove from current position and add to fragment
                    section.parentNode.removeChild(section);
                    fragment.appendChild(section);
                    console.log(`Added category ${categoryKey} to fragment`);
                } else {
                    console.log(`Warning: Section not found for category ${categoryKey}`);
                }
            });
            
            // Append the fragment to the expenses list
            expensesList.appendChild(fragment);
            
            // Update the display to refresh stats
            updateDisplay();
        }

        // Clean Database Function - removes ghost categories
        function cleanDatabase() {
            let foundGhosts = false;
            const ghostCategories = [];
            
            // Check for categories that exist in data but not in DOM
            Object.keys(expenses).forEach(categoryKey => {
                const section = document.getElementById(`category-${categoryKey}`);
                if (!section) {
                    ghostCategories.push(categoryKey);
                    foundGhosts = true;
                }
            });
            
            if (foundGhosts) {
                const message = `Found ${ghostCategories.length} ghost categor${ghostCategories.length > 1 ? 'ies' : 'y'}: ${ghostCategories.join(', ')}\n\nDo you want to remove them?`;
                if (confirm(message)) {
                    // Remove ghost categories from expenses
                    ghostCategories.forEach(categoryKey => {
                        delete expenses[categoryKey];
                    });
                    
                    // Remove from categoryOrder
                    categoryOrder = categoryOrder.filter(c => !ghostCategories.includes(c));
                    
                    // Remove from categoryMetadata
                    ghostCategories.forEach(categoryKey => {
                        if (categoryMetadata[categoryKey]) {
                            delete categoryMetadata[categoryKey];
                        }
                    });
                    
                    // Save and update
                    saveUserData();
                    updateDisplay();
                    
                    alert(`Successfully removed ${ghostCategories.length} ghost categor${ghostCategories.length > 1 ? 'ies' : 'y'}!`);
                }
            } else {
                alert('No ghost categories found! Your database is clean. ‚úÖ');
            }
        }

        // Settings Functions
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const currencySelect = document.getElementById('currencySelect');
            const useIncomeCheckbox = document.getElementById('useIncomeCheckbox');
            const settingsUserEmail = document.getElementById('settingsUserEmail');
            const percentageModeSelect = document.getElementById('percentageModeSelect');
            const percentageModeSection = document.getElementById('percentageModeSection');
            
            // ‚úÖ V√©rifications ajout√©es
            if (!modal) {
                console.error('Settings modal not found');
                return;
            }
            
            // Set current values
            const currencyCode = Object.keys(currencyOptions).find(key => currencyOptions[key] === currency) || 'ILS';
            if (currencySelect) currencySelect.value = currencyCode;
            if (useIncomeCheckbox) useIncomeCheckbox.checked = useIncome;
            if (percentageModeSelect) percentageModeSelect.value = percentageMode;
            
            // Show/hide percentage mode section based on useIncome
            if (percentageModeSection) {
                percentageModeSection.style.display = useIncome ? 'block' : 'none';
            }
            
            // Set user email
            if (currentUser && settingsUserEmail) {
                settingsUserEmail.textContent = currentUser.email;
            }
            
            // Prevent background scrolling
            document.body.style.overflow = 'hidden';
            
            modal.classList.add('show');
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.remove('show');
            
            // Restore background scrolling
            document.body.style.overflow = '';
        }

        function updateCurrency(currencyCode) {
            currency = currencyOptions[currencyCode];
            saveUserData();
            updateDisplay();
        }

        function toggleIncomeFeature(enabled) {
            useIncome = enabled;
            
            // Show/hide percentage mode section
            const percentageModeSection = document.getElementById('percentageModeSection');
            if (percentageModeSection) {
                percentageModeSection.style.display = enabled ? 'block' : 'none';
            }
            
            saveUserData();
            updateDisplay();
        }


        /**
         * Clear all transactions
         */
        async function clearAllTransactions() {
            if (!currentUser) return;
            
            const t = translations[currentLanguage] || translations['en'];
            if (!confirm(t.clearAllWarning1 || '‚ö†Ô∏è Delete ALL transactions?')) {
                return;
            }
            
            if (!confirm(t.clearAllWarning2 || '‚ö†Ô∏è FINAL WARNING! Continue?')) {
                return;
            }
            
            // Create a simple loading overlay for settings modal
            const settingsModalBody = document.querySelector('#settingsModal .modal-body');
            const originalContent = settingsModalBody ? settingsModalBody.innerHTML : '';
            
            if (settingsModalBody) {
                settingsModalBody.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 60px 20px;">
                        <div style="width: 60px; height: 60px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div style="margin-top: 20px; color: #667eea; font-weight: 600; font-size: 1.1em;">Deleting all transactions...</div>
                        <div style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">This may take a moment</div>
                    </div>
                `;
            }
            
            try {
                // Delete all transactions
                const snapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('transactions')
                    .get();
                
                const batch = db.batch();
                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Delete all imported CSVs metadata
                const csvSnapshot = await db.collection('users')
                    .doc(currentUser.uid)
                    .collection('importedCSVs')
                    .get();
                
                const csvBatch = db.batch();
                csvSnapshot.docs.forEach(doc => {
                    csvBatch.delete(doc.ref);
                });
                
                await csvBatch.commit();
                
                const t = translations[currentLanguage] || translations['en'];
                alert(t.transactionsCleared
                    .replace('{count}', snapshot.size)
                    .replace('{csvCount}', csvSnapshot.size));
                
                // Reload if on transactions tab
                if (typeof loadTransactions === 'function') {
                    await loadTransactions();
                }
            } catch (error) {
                console.error('Error clearing transactions:', error);
                const t = translations[currentLanguage] || translations['en'];
                alert('‚ùå ' + t.errorClearingTransactions + ' ' + error.message);
            } finally {
                // Restore modal content
                if (settingsModalBody) {
                    settingsModalBody.innerHTML = originalContent;
                }
            }
        }


        function updatePercentageMode(mode) {
            percentageMode = mode;
            saveUserData();
            updateDisplay();
        }

        /**
         * Toggle dark mode
         */
        function toggleDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            
            // === MISE A JOUR IMMEDIATE DU GRAPHIQUE ===
            // On force le graphique √† se redessiner avec les nouvelles couleurs
            if (typeof updateChart === 'function') {
                updateChart();
            }
            // ==========================================
        
            // Save preference to Firebase
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).set({
                    darkMode: enabled
                }, { merge: true }).then(() => {
                    console.log('Dark mode preference saved:', enabled);
                }).catch(error => {
                    console.error('Error saving dark mode preference:', error);
                });
            }
        }
        
        /**
         * Load dark mode preference
         */
        function loadDarkModePreference() {
            if (!currentUser) return;
            
            db.collection('users').doc(currentUser.uid).get().then(doc => {
                if (doc.exists && doc.data().darkMode !== undefined) {
                    const darkModeEnabled = doc.data().darkMode;
                    
                    // Apply dark mode
                    if (darkModeEnabled) {
                        document.body.classList.add('dark-mode');
                    }
                    
                    // Update checkbox
                    const darkModeCheckbox = document.getElementById('darkModeCheckbox');
                    if (darkModeCheckbox) {
                        darkModeCheckbox.checked = darkModeEnabled;
                    }
                    
                    // === MISE A JOUR DU GRAPHIQUE AVEC LES COULEURS DARK MODE ===
                    if (typeof updateChart === 'function') {
                        updateChart();
                    }
                }
            }).catch(error => {
                console.error('Error loading dark mode preference:', error);
            });
        }

// Rename Functions
        async function renameCategory(categoryKey) {
            const currentDisplayName = getCategoryDisplayName(categoryKey);
            const t = translations[currentLanguage] || translations['en'];
            const promptMessage = t.enterNewCategoryName
                .replace('{current}', currentDisplayName);
            const newName = prompt(promptMessage, currentDisplayName);
            
            if (!newName || newName.trim() === '') return;
            if (newName.trim() === currentDisplayName) return;
            
            // Demander l'emoji
            const currentEmoji = categoryMetadata[categoryKey]?.emoji || 'üìã';
            const newEmoji = prompt(t.enterEmoji || 'Enter emoji for this category:', currentEmoji);
            if (!newEmoji || newEmoji.trim() === '') {
                alert(t.emojiRequired || 'Emoji is required');
                return;
            }
            
            const newKey = newName.toLowerCase().replace(/\s+/g, '-');   
            
            // Emp√™cher de renommer "income"
            if (categoryKey === 'income') {
                alert(t.cannotRenameIncome || 'Cannot rename Income.');
                return;
            }
            
            // Emp√™cher de renommer en "income" uniquement
            if (newKey === 'income' && categoryKey !== 'income') {
                alert(t.cannotUseSystemName || 'Cannot use system name.');
                return;
            }
            
            // V√©rifier les doublons
            if (newKey !== categoryKey && expenses[newKey]) {
                alert(t.categoryExistsAlert || 'Category already exists!');
                return;
            }
            
            try {
                // Afficher l'overlay
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingOverlayText');
                const subtextEl = document.getElementById('loadingOverlaySubtext');
                
                if (overlay) {
                    if (textEl) textEl.textContent = t.renamingCategory || 'Renaming category...';
                    if (subtextEl) subtextEl.textContent = t.updatingTransactions || 'Updating transactions...';
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                // Appeler Cloud Function pour transactions
                const renameCategoryFunc = firebase.functions().httpsCallable('renameCategory');
                const result = await renameCategoryFunc({
                    oldName: categoryKey,
                    newName: newKey
                });
                
                console.log(`Renamed category: ${result.data.message}`);
                
                // ‚úÖ LOGIQUE SIMPLE : Tout faire localement
                if (newKey !== categoryKey) {
                    // Copier vers nouvelle cl√©
                    expenses[newKey] = expenses[categoryKey] || [];
                    categoryMetadata[newKey] = {
                        emoji: newEmoji,
                        displayName: newName
                    };
                    
                    // Copier la couleur seulement si elle existe
                    if (categoryMetadata[categoryKey]?.color) {
                        categoryMetadata[newKey].color = categoryMetadata[categoryKey].color;
                    }
                    
                    // Mettre √† jour l'ordre
                    const index = categoryOrder.indexOf(categoryKey);
                    if (index !== -1) {
                        categoryOrder[index] = newKey;
                    } else {
                        categoryOrder.push(newKey);
                    }
                    
                    // Supprimer l'ancienne
                    delete expenses[categoryKey];
                    delete categoryMetadata[categoryKey];
                } else {
                    // Juste mettre √† jour le displayName/emoji
                    if (!categoryMetadata[categoryKey]) categoryMetadata[categoryKey] = {};
                    categoryMetadata[categoryKey].displayName = newName;
                    categoryMetadata[categoryKey].emoji = newEmoji;
                }
                
                // ‚úÖ D'abord supprimer l'ancienne cat√©gorie explicitement
                if (newKey !== categoryKey) {
                    await db.collection('users').doc(currentUser.uid).update({
                        [`expenses.${categoryKey}`]: firebase.firestore.FieldValue.delete(),
                        [`categoryMetadata.${categoryKey}`]: firebase.firestore.FieldValue.delete()
                    });
                }
                
                // ‚úÖ Utiliser saveUserData() qui pr√©serve TOUT (y compris credentials)
                await saveUserData();
                
                // ‚úÖ Forcer la recr√©ation du HTML
                if (newKey !== categoryKey) {
                    // Supprimer l'ancien HTML
                    const oldSection = document.getElementById(`category-${categoryKey}`);
                    if (oldSection) {
                        oldSection.remove();
                    }
                }
                
                // Actualiser l'affichage
                updateDisplay();
                setTimeout(() => restoreEditMode(), 50); // ‚úÖ D√©lai plus long
                // ‚úÖ S'assurer que la nouvelle cat√©gorie a son HTML
                if (newKey !== categoryKey && !document.getElementById(`category-${newKey}`)) {
                    // Forcer un reload complet depuis Firebase pour recr√©er le HTML
                    await loadUserData();
                }
                
                // Cacher l'overlay
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                alert(t.categoryRenamedSuccess.replace('{count}', result.data.updatedCount));
                
            } catch (error) {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                console.error('Error renaming category:', error);
                alert('Error renaming category: ' + error.message);
            }
        }

        
        async function renameItem(category, index) {
            const t = translations[currentLanguage] || translations['en'];
            const newName = prompt(t.enterNewName || 'Enter new name:', expenses[category][index].name);
            if (!newName) return;
            
            try {
                // Afficher l'overlay
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingOverlayText');
                const subtextEl = document.getElementById('loadingOverlaySubtext');
                
                if (overlay) {
                    if (textEl) textEl.textContent = t.renamingItem || 'Renaming item...';
                    if (subtextEl) subtextEl.textContent = t.pleaseWait || 'Please wait';
                    overlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                
                expenses[category][index].name = newName;
                await saveUserData();
                updateDisplay();
                setTimeout(() => restoreEditMode(), 50);
                
                // Cacher l'overlay
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            } catch (error) {
                // Cacher l'overlay en cas d'erreur
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                console.error('Error renaming item:', error);
                alert('Error renaming item: ' + error.message);
            }
        }

        // Item Movement Functions
        function moveItemUp(category, index) {
            if (index === 0) return; // Already at top
            
            const temp = expenses[category][index];
            expenses[category][index] = expenses[category][index - 1];
            expenses[category][index - 1] = temp;
            
            saveUserData();
            updateDisplay();
        }

        function moveItemDown(category, index) {
            if (index === expenses[category].length - 1) return; // Already at bottom
            
            const temp = expenses[category][index];
            expenses[category][index] = expenses[category][index + 1];
            expenses[category][index + 1] = temp;
            
            saveUserData();
            updateDisplay();
        }

        // Close modals on click outside and restore scroll
        document.addEventListener('click', function(e) {
            const colorModal = document.getElementById('colorEditorModal');
            const settingsModal = document.getElementById('settingsModal');
            
            if (e.target === colorModal) {
                closeColorEditor();
            }
            if (e.target === settingsModal) {
                closeSettings();
            }
        });

        // Fonction pour mettre √† jour l'√©tat visuel des boutons de graphique
        function updateChartButtonsState() {
            const toggleButtons = document.querySelectorAll('.chart-toggle-btn');
            toggleButtons.forEach(btn => {
                if (btn.dataset.type === currentChartType) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }


        /**
         * Force le d√©filement de la page au sommet.
         */
        function scrollToTop() {
            // Un petit d√©lai est crucial pour laisser le temps √† l'interface de l'application de s'afficher
            setTimeout(() => {
                // M√©thode 1 : Scroll vers le haut du body (souvent la plus efficace sur mobile)
                document.body.scrollIntoView({ behavior: 'auto', block: 'start' });
                
                // M√©thode 2 : Fallback pour les navigateurs r√©calcitrants
                window.scrollTo(0, 0); 
            }, 100); // 100ms pour √™tre s√ªr
        }

        // Global variables
        // ... (toutes vos variables globales) ...
        // let currentLanguage = 'en'; 
        
        // === GESTION DE L'√âTAT D'AUTHENTIFICATION FIREBASE ===
        // Cet √©couteur est appel√© au chargement de la page et √† chaque connexion/d√©connexion.

        auth.onAuthStateChanged(async (user) => {
            console.log('üî¥ onAuthStateChanged triggered');
            console.log('üë§ User:', user ? user.email : 'null');
            
            const authScreen = document.getElementById('auth-screen');
            const mainApp = document.getElementById('appScreen');
            
            console.log('üñ•Ô∏è authScreen:', authScreen);
            console.log('üì± mainApp:', mainApp);
            
            if (user) {
                console.log('‚úÖ User is logged in - showing main app');
                currentUser = user;
                
                console.log('üîÑ Hiding auth screen, showing main app...');
                if (authScreen) {
                    authScreen.style.display = 'none';
                }
                
                const isFirst = await authManager.checkFirstLaunch(user.uid);
                console.log('üìã First launch:', isFirst);
                
                if (isFirst) {
                    await authManager.setupInitialConfig(user.uid);
                }
                
                console.log('üì• Loading user data...');
                await loadUserData();
                console.log('‚úÖ User data loaded');
                
                // ‚úÖ FORCE la mise √† jour de l'interface avec la bonne langue
                console.log('üåç Applying language:', currentLanguage);
                updateUILanguage();
                
                // ‚úÖ Appliquer aussi la direction RTL si n√©cessaire
                if (currentLanguage === 'ar' || currentLanguage === 'he') {
                    document.documentElement.setAttribute('dir', 'rtl');
                } else {
                    document.documentElement.setAttribute('dir', 'ltr');
                }
                
                console.log('üì± Showing main app...');
                if (mainApp) {
                    mainApp.style.display = 'block';
                }
                
            } else {
                console.log('‚ùå User is logged out - showing auth screen');
                currentUser = null;
                
                console.log('üîÑ Hiding main app, showing auth screen...');
                if (mainApp) {
                    mainApp.style.display = 'none';
                }
                if (authScreen) {
                    authScreen.style.display = 'flex';
                    console.log('üé® Initializing auth screen...');
                    authManager.initAuthScreen();
                    console.log('‚úÖ Auth screen initialized');
                }
            }
        });
                                
        
        
        
        // Wait for Chart.js to load before initializing
        function initializeApp() {
            setTimeout(() => {
                document.body.scrollIntoView({ behavior: 'auto', block: 'start' });
            }, 50); // Petit d√©lai de 50ms pour laisser le temps au rendu initial
            updateTransactionsLanguage(); 
            if (typeof Chart !== 'undefined') {
                // Set up chart type toggle buttons
                const toggleButtons = document.querySelectorAll('.chart-toggle-btn');
                toggleButtons.forEach(btn => {
                    // Add click handler
                    btn.addEventListener('click', function() {
                        currentChartType = this.dataset.type;
                        saveUserData();
                        
                        // Update button states
                        toggleButtons.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Redraw chart
                        updateChart();
                    });
                });
        
                // Function to update button states based on current chart type
                window.updateChartButtonsState = function() {
                    const buttons = document.querySelectorAll('.chart-toggle-btn');
                    buttons.forEach(btn => {
                        if (btn.dataset.type === currentChartType) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                };
                
                // Close modal when clicking outside
                const modal = document.getElementById('colorEditorModal');
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeColorEditor();
                    }
                });
                
                const settingsModal = document.getElementById('settingsModal');
                settingsModal.addEventListener('click', function(e) {
                    if (e.target === settingsModal) {
                        closeSettings();
                    }
                });
                
                updateDisplay();
                
                // ‚ú® AJOUT CRITIQUE ICI ‚ú®
                // On lance l'ajustement du titre apr√®s que tout soit charg√© et affich√©
                setTimeout(fitAppTitle, 100); 
        
            } else {
                console.warn('Chart.js not loaded, waiting...');
                setTimeout(initializeApp, 100);
            }
        }

        // Initialize on load (Bloc final simplifi√© et corrig√©)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
        // Note : L'appel √† fitAppTitle est maintenant g√©r√© DANS initializeApp (voir point 1).

        // ‚úÖ AJOUT√â : Display app version
        window.addEventListener('DOMContentLoaded', () => {
            const versionEl = document.getElementById('appVersionDisplay');
            if (versionEl) {
                versionEl.textContent = `v${APP_VERSION}`;
            }
        });
    </script>
    <script src="js/tabs-manager.js"></script>
    <script src="js/transactions-manager.js"></script>
        <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-overlay-content">
            <div class="loading-overlay-spinner"></div>
            <div class="loading-overlay-text" id="loadingOverlayText">Processing...</div>
            <div class="loading-overlay-subtext" id="loadingOverlaySubtext">Please wait</div>
        </div>
    </div>
</body>
</html>
